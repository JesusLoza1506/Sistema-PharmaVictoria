<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UsuarioRepository.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">proyectopharmavictoria</a> &gt; <a href="index.source.html" class="el_package">com.farmaciavictoria.proyectopharmavictoria.repository.Usuario</a> &gt; <span class="el_source">UsuarioRepository.java</span></div><h1>UsuarioRepository.java</h1><pre class="source lang-java linenums">package com.farmaciavictoria.proyectopharmavictoria.repository.Usuario;

import com.farmaciavictoria.proyectopharmavictoria.config.DatabaseConfig;
import com.farmaciavictoria.proyectopharmavictoria.model.Usuario.Usuario;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import java.sql.*;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;
import java.util.Optional;

public class UsuarioRepository {

    public Usuario buscarPorTokenRecuperacion(String token) {
<span class="nc" id="L16">        String sql = &quot;SELECT * FROM usuarios WHERE recovery_token = ?&quot;;</span>
<span class="nc" id="L17">        try (Connection conn = databaseConfig.getConnection();</span>
<span class="nc" id="L18">                PreparedStatement stmt = conn.prepareStatement(sql)) {</span>
<span class="nc" id="L19">            stmt.setString(1, token);</span>
<span class="nc" id="L20">            try (ResultSet rs = stmt.executeQuery()) {</span>
<span class="nc bnc" id="L21" title="All 2 branches missed.">                if (rs.next()) {</span>
<span class="nc" id="L22">                    return mapResultSetToUsuario(rs);</span>
                }
<span class="nc bnc" id="L24" title="All 2 branches missed.">            }</span>
<span class="nc bnc" id="L25" title="All 4 branches missed.">        } catch (SQLException e) {</span>
<span class="nc" id="L26">            logger.error(&quot;Error al buscar usuario por token de recuperación: {}&quot;, token, e);</span>
<span class="nc" id="L27">        }</span>
<span class="nc" id="L28">        return null;</span>
    }

    public boolean actualizarPasswordYLimpiarToken(Long id, String passwordHash) {
<span class="nc" id="L32">        String sql = &quot;UPDATE usuarios SET password_hash = ?, recovery_token = NULL, recovery_token_expiry = NULL WHERE id = ?&quot;;</span>
<span class="nc" id="L33">        try (Connection conn = databaseConfig.getConnection();</span>
<span class="nc" id="L34">                PreparedStatement stmt = conn.prepareStatement(sql)) {</span>
<span class="nc" id="L35">            stmt.setString(1, passwordHash);</span>
<span class="nc" id="L36">            stmt.setLong(2, id);</span>
<span class="nc" id="L37">            int affectedRows = stmt.executeUpdate();</span>
<span class="nc bnc" id="L38" title="All 2 branches missed.">            return affectedRows &gt; 0;</span>
<span class="nc" id="L39">        } catch (SQLException e) {</span>
<span class="nc" id="L40">            logger.error(&quot;Error al actualizar password y limpiar token para usuario con id: {}&quot;, id, e);</span>
<span class="nc" id="L41">            return false;</span>
        }
    }

    public boolean setRecoveryToken(Long id, String token, LocalDateTime expiry) {
<span class="nc" id="L46">        String sql = &quot;UPDATE usuarios SET recovery_token = ?, recovery_token_expiry = ? WHERE id = ?&quot;;</span>
<span class="nc" id="L47">        try (Connection conn = databaseConfig.getConnection();</span>
<span class="nc" id="L48">                PreparedStatement stmt = conn.prepareStatement(sql)) {</span>
<span class="nc" id="L49">            stmt.setString(1, token);</span>
<span class="nc" id="L50">            stmt.setTimestamp(2, Timestamp.valueOf(expiry));</span>
<span class="nc" id="L51">            stmt.setLong(3, id);</span>
<span class="nc" id="L52">            int affectedRows = stmt.executeUpdate();</span>
<span class="nc bnc" id="L53" title="All 2 branches missed.">            return affectedRows &gt; 0;</span>
<span class="nc" id="L54">        } catch (SQLException e) {</span>
<span class="nc" id="L55">            logger.error(&quot;Error al guardar token de recuperación para usuario con id: {}&quot;, id, e);</span>
<span class="nc" id="L56">            return false;</span>
        }
    }

    /**
     * Busca y retorna el usuario por email
     */
    public Usuario findByEmail(String email) {
<span class="nc" id="L64">        String sql = &quot;SELECT * FROM usuarios WHERE email = ?&quot;;</span>
<span class="nc" id="L65">        try (Connection conn = databaseConfig.getConnection();</span>
<span class="nc" id="L66">                PreparedStatement stmt = conn.prepareStatement(sql)) {</span>
<span class="nc" id="L67">            stmt.setString(1, email);</span>
<span class="nc" id="L68">            try (ResultSet rs = stmt.executeQuery()) {</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">                if (rs.next()) {</span>
<span class="nc" id="L70">                    return mapResultSetToUsuario(rs);</span>
                }
<span class="nc bnc" id="L72" title="All 2 branches missed.">            }</span>
<span class="nc bnc" id="L73" title="All 4 branches missed.">        } catch (SQLException e) {</span>
<span class="nc" id="L74">            logger.error(&quot;Error al buscar usuario por email: {}&quot;, email, e);</span>
<span class="nc" id="L75">        }</span>
<span class="nc" id="L76">        return null;</span>
    }

    /**
     * Busca un usuario por su ID
     */
    public Optional&lt;Usuario&gt; findById(Long id) {
<span class="nc" id="L83">        String sql = &quot;SELECT * FROM usuarios WHERE id = ?&quot;;</span>
<span class="nc" id="L84">        try (Connection conn = databaseConfig.getConnection();</span>
<span class="nc" id="L85">                PreparedStatement stmt = conn.prepareStatement(sql)) {</span>
<span class="nc" id="L86">            stmt.setLong(1, id);</span>
<span class="nc" id="L87">            try (ResultSet rs = stmt.executeQuery()) {</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">                if (rs.next()) {</span>
<span class="nc" id="L89">                    return Optional.of(mapResultSetToUsuario(rs));</span>
                }
<span class="nc bnc" id="L91" title="All 2 branches missed.">            }</span>
<span class="nc bnc" id="L92" title="All 4 branches missed.">        } catch (SQLException e) {</span>
<span class="nc" id="L93">            logger.error(&quot;Error al buscar usuario por id: {}&quot;, id, e);</span>
<span class="nc" id="L94">        }</span>
<span class="nc" id="L95">        return Optional.empty();</span>
    }

    /**
     * Verifica si existe un usuario con el email dado
     */
    public boolean existsByEmail(String email) {
<span class="nc" id="L102">        String sql = &quot;SELECT COUNT(*) FROM usuarios WHERE email = ?&quot;;</span>
<span class="nc" id="L103">        try (Connection conn = databaseConfig.getConnection();</span>
<span class="nc" id="L104">                PreparedStatement stmt = conn.prepareStatement(sql)) {</span>
<span class="nc" id="L105">            stmt.setString(1, email);</span>
<span class="nc" id="L106">            try (ResultSet rs = stmt.executeQuery()) {</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">                if (rs.next()) {</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">                    return rs.getInt(1) &gt; 0;</span>
                }
<span class="nc bnc" id="L110" title="All 2 branches missed.">            }</span>
<span class="nc bnc" id="L111" title="All 4 branches missed.">        } catch (SQLException e) {</span>
<span class="nc" id="L112">            logger.error(&quot;Error al verificar existencia de email: {}&quot;, email, e);</span>
<span class="nc" id="L113">        }</span>
<span class="nc" id="L114">        return false;</span>
    }

    /**
     * Verifica si existe un usuario con el DNI dado
     */
    public boolean existsByDni(String dni) {
<span class="nc" id="L121">        String sql = &quot;SELECT COUNT(*) FROM usuarios WHERE dni = ?&quot;;</span>
<span class="nc" id="L122">        try (Connection conn = databaseConfig.getConnection();</span>
<span class="nc" id="L123">                PreparedStatement stmt = conn.prepareStatement(sql)) {</span>
<span class="nc" id="L124">            stmt.setString(1, dni);</span>
<span class="nc" id="L125">            try (ResultSet rs = stmt.executeQuery()) {</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">                if (rs.next()) {</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">                    return rs.getInt(1) &gt; 0;</span>
                }
<span class="nc bnc" id="L129" title="All 2 branches missed.">            }</span>
<span class="nc bnc" id="L130" title="All 4 branches missed.">        } catch (SQLException e) {</span>
<span class="nc" id="L131">            logger.error(&quot;Error al verificar existencia de DNI: {}&quot;, dni, e);</span>
<span class="nc" id="L132">        }</span>
<span class="nc" id="L133">        return false;</span>
    }

<span class="fc" id="L136">    private static final Logger logger = LoggerFactory.getLogger(UsuarioRepository.class);</span>
    private final DatabaseConfig databaseConfig;

<span class="fc" id="L139">    public UsuarioRepository() {</span>
<span class="fc" id="L140">        this.databaseConfig = DatabaseConfig.getInstance();</span>
<span class="fc" id="L141">    }</span>

    /**
     * Actualiza los datos de un usuario existente
     */
    public boolean update(Usuario usuario) {
<span class="nc" id="L147">        String sql = &quot;UPDATE usuarios SET username = ?, password_hash = ?, rol = ?, nombres = ?, apellidos = ?, dni = ?, telefono = ?, email = ?, activo = ? WHERE id = ?&quot;;</span>
<span class="nc" id="L148">        try (Connection conn = databaseConfig.getConnection();</span>
<span class="nc" id="L149">                PreparedStatement stmt = conn.prepareStatement(sql)) {</span>
<span class="nc" id="L150">            stmt.setString(1, usuario.getUsername());</span>
<span class="nc" id="L151">            stmt.setString(2, usuario.getPasswordHash());</span>
<span class="nc" id="L152">            stmt.setString(3, usuario.getRol().name());</span>
<span class="nc" id="L153">            stmt.setString(4, usuario.getNombres());</span>
<span class="nc" id="L154">            stmt.setString(5, usuario.getApellidos());</span>
<span class="nc" id="L155">            stmt.setString(6, usuario.getDni());</span>
<span class="nc" id="L156">            stmt.setString(7, usuario.getTelefono());</span>
<span class="nc" id="L157">            stmt.setString(8, usuario.getEmail());</span>
<span class="nc" id="L158">            stmt.setBoolean(9, usuario.isActivo());</span>
<span class="nc" id="L159">            stmt.setLong(10, usuario.getId());</span>
<span class="nc" id="L160">            int affectedRows = stmt.executeUpdate();</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">            return affectedRows &gt; 0;</span>
<span class="nc" id="L162">        } catch (SQLException e) {</span>
<span class="nc" id="L163">            logger.error(&quot;Error al actualizar usuario: {}&quot;, usuario.getUsername(), e);</span>
<span class="nc" id="L164">            return false;</span>
        }
    }

    /**
     * Elimina un usuario por su ID
     */
    public boolean delete(Long id) {
<span class="nc" id="L172">        String sql = &quot;DELETE FROM usuarios WHERE id = ?&quot;;</span>
<span class="nc" id="L173">        try (Connection conn = databaseConfig.getConnection();</span>
<span class="nc" id="L174">                PreparedStatement stmt = conn.prepareStatement(sql)) {</span>
<span class="nc" id="L175">            stmt.setLong(1, id);</span>
<span class="nc" id="L176">            int affectedRows = stmt.executeUpdate();</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">            return affectedRows &gt; 0;</span>
<span class="nc" id="L178">        } catch (SQLException e) {</span>
<span class="nc" id="L179">            logger.error(&quot;Error al eliminar usuario con id: {}&quot;, id, e);</span>
<span class="nc" id="L180">            return false;</span>
        }
    }

    /**
     * Cambia el estado activo/inactivo de un usuario
     */
    public boolean setActivo(Long id, boolean activo) {
<span class="nc" id="L188">        String sql = &quot;UPDATE usuarios SET activo = ? WHERE id = ?&quot;;</span>
<span class="nc" id="L189">        try (Connection conn = databaseConfig.getConnection();</span>
<span class="nc" id="L190">                PreparedStatement stmt = conn.prepareStatement(sql)) {</span>
<span class="nc" id="L191">            stmt.setBoolean(1, activo);</span>
<span class="nc" id="L192">            stmt.setLong(2, id);</span>
<span class="nc" id="L193">            int affectedRows = stmt.executeUpdate();</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">            return affectedRows &gt; 0;</span>
<span class="nc" id="L195">        } catch (SQLException e) {</span>
<span class="nc" id="L196">            logger.error(&quot;Error al cambiar estado activo para usuario con id: {}&quot;, id, e);</span>
<span class="nc" id="L197">            return false;</span>
        }
    }

    /**
     * Cambia la contraseña de un usuario
     */
    public boolean setPassword(Long id, String passwordHash) {
<span class="nc" id="L205">        String sql = &quot;UPDATE usuarios SET password_hash = ? WHERE id = ?&quot;;</span>
<span class="nc" id="L206">        try (Connection conn = databaseConfig.getConnection();</span>
<span class="nc" id="L207">                PreparedStatement stmt = conn.prepareStatement(sql)) {</span>
<span class="nc" id="L208">            stmt.setString(1, passwordHash);</span>
<span class="nc" id="L209">            stmt.setLong(2, id);</span>
<span class="nc" id="L210">            int affectedRows = stmt.executeUpdate();</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">            return affectedRows &gt; 0;</span>
<span class="nc" id="L212">        } catch (SQLException e) {</span>
<span class="nc" id="L213">            logger.error(&quot;Error al cambiar contraseña para usuario con id: {}&quot;, id, e);</span>
<span class="nc" id="L214">            return false;</span>
        }
    }

    /**
     * Busca un usuario por username
     */
    public Optional&lt;Usuario&gt; findByUsername(String username) {
<span class="nc" id="L222">        String sql = &quot;SELECT * FROM usuarios WHERE username = ? AND activo = true&quot;;</span>

<span class="nc" id="L224">        try (Connection conn = databaseConfig.getConnection();</span>
<span class="nc" id="L225">                PreparedStatement stmt = conn.prepareStatement(sql)) {</span>

<span class="nc" id="L227">            stmt.setString(1, username);</span>

<span class="nc" id="L229">            try (ResultSet rs = stmt.executeQuery()) {</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">                if (rs.next()) {</span>
<span class="nc" id="L231">                    return Optional.of(mapResultSetToUsuario(rs));</span>
                }
<span class="nc bnc" id="L233" title="All 2 branches missed.">            }</span>

<span class="nc bnc" id="L235" title="All 4 branches missed.">        } catch (SQLException e) {</span>
<span class="nc" id="L236">            logger.error(&quot;Error al buscar usuario por username: {}&quot;, username, e);</span>
<span class="nc" id="L237">        }</span>

<span class="nc" id="L239">        return Optional.empty();</span>
    }

    /**
     * Obtiene todos los usuarios activos
     */
    public List&lt;Usuario&gt; findAll() {
<span class="nc" id="L246">        List&lt;Usuario&gt; usuarios = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L247">        String sql = &quot;SELECT * FROM usuarios ORDER BY nombres, apellidos&quot;;</span>

<span class="nc" id="L249">        try (Connection conn = databaseConfig.getConnection();</span>
<span class="nc" id="L250">                PreparedStatement stmt = conn.prepareStatement(sql);</span>
<span class="nc" id="L251">                ResultSet rs = stmt.executeQuery()) {</span>

<span class="nc bnc" id="L253" title="All 2 branches missed.">            while (rs.next()) {</span>
<span class="nc" id="L254">                usuarios.add(mapResultSetToUsuario(rs));</span>
            }

<span class="nc" id="L257">        } catch (SQLException e) {</span>
<span class="nc" id="L258">            logger.error(&quot;Error al obtener todos los usuarios&quot;, e);</span>
<span class="nc" id="L259">        }</span>

<span class="nc" id="L261">        return usuarios;</span>
    }

    /**
     * Guarda un nuevo usuario
     */
    public Usuario save(Usuario usuario) {
<span class="nc" id="L268">        String sql = &quot;INSERT INTO usuarios (username, password_hash, rol, nombres, apellidos, dni, telefono, email, activo) &quot;</span>
                +
                &quot;VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)&quot;;

<span class="nc" id="L272">        try (Connection conn = databaseConfig.getConnection();</span>
<span class="nc" id="L273">                PreparedStatement stmt = conn.prepareStatement(sql, Statement.RETURN_GENERATED_KEYS)) {</span>

<span class="nc" id="L275">            stmt.setString(1, usuario.getUsername());</span>
<span class="nc" id="L276">            stmt.setString(2, usuario.getPasswordHash());</span>
<span class="nc" id="L277">            stmt.setString(3, usuario.getRol().name());</span>
<span class="nc" id="L278">            stmt.setString(4, usuario.getNombres());</span>
<span class="nc" id="L279">            stmt.setString(5, usuario.getApellidos());</span>
<span class="nc" id="L280">            stmt.setString(6, usuario.getDni());</span>
<span class="nc" id="L281">            stmt.setString(7, usuario.getTelefono());</span>
<span class="nc" id="L282">            stmt.setString(8, usuario.getEmail());</span>
<span class="nc" id="L283">            stmt.setBoolean(9, usuario.isActivo());</span>

<span class="nc" id="L285">            int affectedRows = stmt.executeUpdate();</span>

<span class="nc bnc" id="L287" title="All 2 branches missed.">            if (affectedRows &gt; 0) {</span>
<span class="nc" id="L288">                try (ResultSet generatedKeys = stmt.getGeneratedKeys()) {</span>
<span class="nc bnc" id="L289" title="All 2 branches missed.">                    if (generatedKeys.next()) {</span>
<span class="nc" id="L290">                        usuario.setId(generatedKeys.getLong(1));</span>
<span class="nc" id="L291">                        logger.info(&quot;Usuario creado exitosamente: {}&quot;, usuario.getUsername());</span>
<span class="nc" id="L292">                        return usuario;</span>
                    }
<span class="nc bnc" id="L294" title="All 2 branches missed.">                }</span>
            }

<span class="nc bnc" id="L297" title="All 4 branches missed.">        } catch (SQLException e) {</span>
<span class="nc" id="L298">            logger.error(&quot;Error al guardar usuario: {}&quot;, usuario.getUsername(), e);</span>
<span class="nc" id="L299">        }</span>

<span class="nc" id="L301">        return null;</span>
    }

    /**
     * Actualiza el último login del usuario
     */
    public void updateLastLogin(String username) {
<span class="nc" id="L308">        String sql = &quot;UPDATE usuarios SET last_login = CURRENT_TIMESTAMP WHERE username = ?&quot;;</span>

<span class="nc" id="L310">        try (Connection conn = databaseConfig.getConnection();</span>
<span class="nc" id="L311">                PreparedStatement stmt = conn.prepareStatement(sql)) {</span>

<span class="nc" id="L313">            stmt.setString(1, username);</span>
<span class="nc" id="L314">            int affectedRows = stmt.executeUpdate();</span>

<span class="nc bnc" id="L316" title="All 2 branches missed.">            if (affectedRows &gt; 0) {</span>
<span class="nc" id="L317">                logger.debug(&quot;Último login actualizado para usuario: {}&quot;, username);</span>
            }

<span class="nc" id="L320">        } catch (SQLException e) {</span>
<span class="nc" id="L321">            logger.error(&quot;Error al actualizar último login para usuario: {}&quot;, username, e);</span>
<span class="nc" id="L322">        }</span>
<span class="nc" id="L323">    }</span>

    /**
     * Verifica si existe un usuario con el username dado
     */
    public boolean existsByUsername(String username) {
<span class="nc" id="L329">        String sql = &quot;SELECT COUNT(*) FROM usuarios WHERE username = ?&quot;;</span>

<span class="nc" id="L331">        try (Connection conn = databaseConfig.getConnection();</span>
<span class="nc" id="L332">                PreparedStatement stmt = conn.prepareStatement(sql)) {</span>

<span class="nc" id="L334">            stmt.setString(1, username);</span>

<span class="nc" id="L336">            try (ResultSet rs = stmt.executeQuery()) {</span>
<span class="nc bnc" id="L337" title="All 2 branches missed.">                if (rs.next()) {</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">                    return rs.getInt(1) &gt; 0;</span>
                }
<span class="nc bnc" id="L340" title="All 2 branches missed.">            }</span>

<span class="nc bnc" id="L342" title="All 4 branches missed.">        } catch (SQLException e) {</span>
<span class="nc" id="L343">            logger.error(&quot;Error al verificar existencia de usuario: {}&quot;, username, e);</span>
<span class="nc" id="L344">        }</span>

<span class="nc" id="L346">        return false;</span>
    }

    /**
     * Valida credenciales de usuario
     */
    public boolean validateCredentials(String username, String passwordHash) {
<span class="nc" id="L353">        String sql = &quot;SELECT COUNT(*) FROM usuarios WHERE username = ? AND password_hash = ? AND activo = true&quot;;</span>

<span class="nc" id="L355">        try (Connection conn = databaseConfig.getConnection();</span>
<span class="nc" id="L356">                PreparedStatement stmt = conn.prepareStatement(sql)) {</span>

<span class="nc" id="L358">            stmt.setString(1, username);</span>
<span class="nc" id="L359">            stmt.setString(2, passwordHash);</span>

<span class="nc" id="L361">            try (ResultSet rs = stmt.executeQuery()) {</span>
<span class="nc bnc" id="L362" title="All 2 branches missed.">                if (rs.next()) {</span>
<span class="nc bnc" id="L363" title="All 2 branches missed.">                    return rs.getInt(1) &gt; 0;</span>
                }
<span class="nc bnc" id="L365" title="All 2 branches missed.">            }</span>

<span class="nc bnc" id="L367" title="All 4 branches missed.">        } catch (SQLException e) {</span>
<span class="nc" id="L368">            logger.error(&quot;Error al validar credenciales para usuario: {}&quot;, username, e);</span>
<span class="nc" id="L369">        }</span>

<span class="nc" id="L371">        return false;</span>
    }

    /**
     * Mapea ResultSet a Usuario
     */
    private Usuario mapResultSetToUsuario(ResultSet rs) throws SQLException {
<span class="nc" id="L378">        Usuario usuario = new Usuario();</span>

<span class="nc" id="L380">        usuario.setId(rs.getLong(&quot;id&quot;));</span>
<span class="nc" id="L381">        usuario.setUsername(rs.getString(&quot;username&quot;));</span>
<span class="nc" id="L382">        usuario.setPasswordHash(rs.getString(&quot;password_hash&quot;));</span>
<span class="nc" id="L383">        usuario.setRol(Usuario.Rol.valueOf(rs.getString(&quot;rol&quot;)));</span>
        // Eliminado sucursalId
<span class="nc" id="L385">        usuario.setNombres(rs.getString(&quot;nombres&quot;));</span>
<span class="nc" id="L386">        usuario.setApellidos(rs.getString(&quot;apellidos&quot;));</span>
<span class="nc" id="L387">        usuario.setDni(rs.getString(&quot;dni&quot;));</span>
<span class="nc" id="L388">        usuario.setTelefono(rs.getString(&quot;telefono&quot;));</span>
<span class="nc" id="L389">        usuario.setEmail(rs.getString(&quot;email&quot;));</span>
<span class="nc" id="L390">        usuario.setActivo(rs.getBoolean(&quot;activo&quot;));</span>

        // Manejar fechas que pueden ser null
<span class="nc" id="L393">        Timestamp createdAt = rs.getTimestamp(&quot;created_at&quot;);</span>
<span class="nc bnc" id="L394" title="All 2 branches missed.">        if (createdAt != null) {</span>
<span class="nc" id="L395">            usuario.setCreatedAt(createdAt.toLocalDateTime());</span>
        }

<span class="nc" id="L398">        Timestamp lastLogin = rs.getTimestamp(&quot;last_login&quot;);</span>
<span class="nc bnc" id="L399" title="All 2 branches missed.">        if (lastLogin != null) {</span>
<span class="nc" id="L400">            usuario.setLastLogin(lastLogin.toLocalDateTime());</span>
        }

        // Token de recuperación
<span class="nc" id="L404">        usuario.setRecoveryToken(rs.getString(&quot;recovery_token&quot;));</span>
<span class="nc" id="L405">        Timestamp tokenExpiry = rs.getTimestamp(&quot;recovery_token_expiry&quot;);</span>
<span class="nc bnc" id="L406" title="All 2 branches missed.">        if (tokenExpiry != null) {</span>
<span class="nc" id="L407">            usuario.setRecoveryTokenExpiry(tokenExpiry.toLocalDateTime());</span>
        }
<span class="nc" id="L409">        return usuario;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>
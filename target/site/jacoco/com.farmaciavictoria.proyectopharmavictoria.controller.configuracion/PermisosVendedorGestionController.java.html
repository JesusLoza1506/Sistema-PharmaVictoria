<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PermisosVendedorGestionController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">proyectopharmavictoria</a> &gt; <a href="index.source.html" class="el_package">com.farmaciavictoria.proyectopharmavictoria.controller.configuracion</a> &gt; <span class="el_source">PermisosVendedorGestionController.java</span></div><h1>PermisosVendedorGestionController.java</h1><pre class="source lang-java linenums">package com.farmaciavictoria.proyectopharmavictoria.controller.configuracion;

import javafx.fxml.FXML;
import javafx.scene.control.Label;
import javafx.scene.control.TitledPane;
import javafx.scene.layout.VBox;
import javafx.stage.Stage;
import com.farmaciavictoria.proyectopharmavictoria.service.UsuarioService;
import com.farmaciavictoria.proyectopharmavictoria.model.Usuario.UsuarioPermiso;
import java.time.LocalDateTime;

<span class="nc" id="L12">public class PermisosVendedorGestionController {</span>
        // Checkboxes de Clientes
        @FXML
        private javafx.scene.control.CheckBox chkVerCliente;
        @FXML
        private javafx.scene.control.CheckBox chkNuevoCliente;
        @FXML
        private javafx.scene.control.CheckBox chkExportarCliente;
        @FXML
        private javafx.scene.control.CheckBox chkEditarCliente;
        @FXML
        private javafx.scene.control.CheckBox chkEliminarCliente;
        @FXML
        private javafx.scene.control.CheckBox chkDashboardTopClientes;
        @FXML
        private javafx.scene.control.CheckBox chkGraficaEdad;
        // Checkboxes de Proveedores
        @FXML
        private javafx.scene.control.CheckBox chkVerProveedor;
        @FXML
        private javafx.scene.control.CheckBox chkNuevoProveedor;
        @FXML
        private javafx.scene.control.CheckBox chkExportarProveedor;
        @FXML
        private javafx.scene.control.CheckBox chkContactarProveedor;
        @FXML
        private javafx.scene.control.CheckBox chkEditarProveedor;
        @FXML
        private javafx.scene.control.CheckBox chkEliminarProveedor;
        @FXML
        private javafx.scene.control.CheckBox chkActivarInactivarProveedor;
        @FXML
        private javafx.scene.control.CheckBox chkDashboardTopProveedores;
        @FXML
        private javafx.scene.control.CheckBox chkDashboardDistribucionEstado;
        @FXML
        private VBox root;
        @FXML
        private TitledPane inventarioPane;
        @FXML
        private TitledPane clientesPane;
        @FXML
        private TitledPane proveedoresPane;
        @FXML
        private Label lblTitulo;

        // Checkboxes de Inventario
        @FXML
        private javafx.scene.control.CheckBox chkVerInventario;
        @FXML
        private javafx.scene.control.CheckBox chkAgregarProducto;
        @FXML
        private javafx.scene.control.CheckBox chkEditarProducto;
        @FXML
        private javafx.scene.control.CheckBox chkEliminarProducto;
        @FXML
        private javafx.scene.control.CheckBox chkActivarInactivarProducto;
        @FXML
        private javafx.scene.control.CheckBox chkEdicionMasiva;
        @FXML
        private javafx.scene.control.CheckBox chkExportarInventario;

<span class="nc" id="L74">        private final UsuarioService usuarioService = UsuarioService.getInstance();</span>
        // Ya no se usa vendedorId espec√≠fico
<span class="nc" id="L76">        private boolean permisosModificados = false;</span>

        @FXML
        public void initialize() {
<span class="nc" id="L80">                inicializarPermisosInventario();</span>
<span class="nc" id="L81">                agregarListenersPermisosInventario();</span>
<span class="nc" id="L82">                inicializarPermisosProveedores();</span>
<span class="nc" id="L83">                agregarListenersPermisosProveedores();</span>
<span class="nc" id="L84">                inicializarPermisosClientes();</span>
<span class="nc" id="L85">                agregarListenersPermisosClientes();</span>
<span class="nc" id="L86">                javafx.application.Platform.runLater(() -&gt; {</span>
<span class="nc bnc" id="L87" title="All 6 branches missed.">                        if (root != null &amp;&amp; root.getScene() != null &amp;&amp; root.getScene().getWindow() != null) {</span>
<span class="nc" id="L88">                                Stage stage = (Stage) root.getScene().getWindow();</span>
<span class="nc" id="L89">                                stage.setOnCloseRequest(event -&gt; {</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">                                        if (permisosModificados) {</span>
<span class="nc" id="L91">                                                javafx.scene.control.Alert alert = new javafx.scene.control.Alert(</span>
                                                                javafx.scene.control.Alert.AlertType.INFORMATION);
<span class="nc" id="L93">                                                alert.setTitle(&quot;Permisos actualizados&quot;);</span>
<span class="nc" id="L94">                                                alert.setHeaderText(null);</span>
<span class="nc" id="L95">                                                alert.setContentText(</span>
                                                                &quot;Los permisos han sido actualizados correctamente.&quot;);
<span class="nc" id="L97">                                                alert.showAndWait();</span>
                                        }
<span class="nc" id="L99">                                });</span>
                        }
<span class="nc" id="L101">                });</span>
<span class="nc" id="L102">        }</span>

        public void setStage(Stage stage) {
<span class="nc" id="L105">                stage.setOnCloseRequest(event -&gt; {</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">                        if (permisosModificados) {</span>
<span class="nc" id="L107">                                javafx.scene.control.Alert alert = new javafx.scene.control.Alert(</span>
                                                javafx.scene.control.Alert.AlertType.INFORMATION);
<span class="nc" id="L109">                                alert.setTitle(&quot;Permisos actualizados&quot;);</span>
<span class="nc" id="L110">                                alert.setHeaderText(null);</span>
<span class="nc" id="L111">                                alert.setContentText(&quot;Los permisos han sido actualizados correctamente.&quot;);</span>
<span class="nc" id="L112">                                alert.showAndWait();</span>
                        }
<span class="nc" id="L114">                });</span>
<span class="nc" id="L115">        }</span>

        private void inicializarPermisosClientes() {
<span class="nc" id="L118">                java.util.List&lt;com.farmaciavictoria.proyectopharmavictoria.model.Usuario.Usuario&gt; vendedores = usuarioService</span>
<span class="nc" id="L119">                                .obtenerUsuarios()</span>
<span class="nc" id="L120">                                .stream()</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">                                .filter(u -&gt; u.getRol() == com.farmaciavictoria.proyectopharmavictoria.model.Usuario.Usuario.Rol.VENDEDOR)</span>
<span class="nc" id="L122">                                .collect(java.util.stream.Collectors.toList());</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">                if (!vendedores.isEmpty()) {</span>
<span class="nc" id="L124">                        Long primerVendedorId = vendedores.get(0).getId();</span>
<span class="nc" id="L125">                        java.util.List&lt;UsuarioPermiso&gt; permisos = usuarioService.obtenerPermisos(primerVendedorId);</span>
<span class="nc" id="L126">                        chkVerCliente.setSelected(true);</span>
<span class="nc" id="L127">                        chkVerCliente.setDisable(true); // Siempre activo y no editable</span>
<span class="nc" id="L128">                        chkNuevoCliente.setSelected(buscarPermiso(permisos, &quot;clientes.nuevo&quot;));</span>
<span class="nc" id="L129">                        chkExportarCliente.setSelected(buscarPermiso(permisos, &quot;clientes.exportar&quot;));</span>
<span class="nc" id="L130">                        chkEditarCliente.setSelected(buscarPermiso(permisos, &quot;clientes.editar&quot;));</span>
<span class="nc" id="L131">                        chkEliminarCliente.setSelected(buscarPermiso(permisos, &quot;clientes.eliminar&quot;));</span>
<span class="nc" id="L132">                        chkDashboardTopClientes.setSelected(buscarPermiso(permisos, &quot;clientes.dashboard_top&quot;));</span>
<span class="nc" id="L133">                        chkGraficaEdad.setSelected(buscarPermiso(permisos, &quot;clientes.grafica_edad&quot;));</span>
                }
<span class="nc" id="L135">        }</span>

        private void agregarListenersPermisosClientes() {
                // &quot;Ver cliente&quot; siempre activo, no editable
<span class="nc" id="L139">                chkNuevoCliente.selectedProperty()</span>
<span class="nc" id="L140">                                .addListener((obs, oldVal, newVal) -&gt; guardarPermiso(&quot;clientes.nuevo&quot;, newVal));</span>
<span class="nc" id="L141">                chkExportarCliente.selectedProperty()</span>
<span class="nc" id="L142">                                .addListener((obs, oldVal, newVal) -&gt; guardarPermiso(&quot;clientes.exportar&quot;, newVal));</span>
<span class="nc" id="L143">                chkEditarCliente.selectedProperty()</span>
<span class="nc" id="L144">                                .addListener((obs, oldVal, newVal) -&gt; guardarPermiso(&quot;clientes.editar&quot;, newVal));</span>
<span class="nc" id="L145">                chkEliminarCliente.selectedProperty()</span>
<span class="nc" id="L146">                                .addListener((obs, oldVal, newVal) -&gt; guardarPermiso(&quot;clientes.eliminar&quot;, newVal));</span>
<span class="nc" id="L147">                chkDashboardTopClientes.selectedProperty()</span>
<span class="nc" id="L148">                                .addListener((obs, oldVal, newVal) -&gt; guardarPermiso(&quot;clientes.dashboard_top&quot;, newVal));</span>
<span class="nc" id="L149">                chkGraficaEdad.selectedProperty()</span>
<span class="nc" id="L150">                                .addListener((obs, oldVal, newVal) -&gt; guardarPermiso(&quot;clientes.grafica_edad&quot;, newVal));</span>
<span class="nc" id="L151">        }</span>

        private void inicializarPermisosProveedores() {
<span class="nc" id="L154">                java.util.List&lt;com.farmaciavictoria.proyectopharmavictoria.model.Usuario.Usuario&gt; vendedores = usuarioService</span>
<span class="nc" id="L155">                                .obtenerUsuarios()</span>
<span class="nc" id="L156">                                .stream()</span>
<span class="nc" id="L157">                                .filter(u -&gt; u</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">                                                .getRol() == com.farmaciavictoria.proyectopharmavictoria.model.Usuario.Usuario.Rol.VENDEDOR)</span>
<span class="nc" id="L159">                                .collect(java.util.stream.Collectors.toList());</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">                if (!vendedores.isEmpty()) {</span>
<span class="nc" id="L161">                        Long primerVendedorId = vendedores.get(0).getId();</span>
<span class="nc" id="L162">                        java.util.List&lt;UsuarioPermiso&gt; permisos = usuarioService.obtenerPermisos(primerVendedorId);</span>
<span class="nc" id="L163">                        chkVerProveedor.setSelected(true);</span>
<span class="nc" id="L164">                        chkVerProveedor.setDisable(true); // Siempre activo y no editable</span>
<span class="nc" id="L165">                        chkNuevoProveedor.setSelected(buscarPermiso(permisos, &quot;proveedores.nuevo&quot;));</span>
<span class="nc" id="L166">                        chkExportarProveedor.setSelected(buscarPermiso(permisos, &quot;proveedores.exportar&quot;));</span>
<span class="nc" id="L167">                        chkContactarProveedor.setSelected(buscarPermiso(permisos, &quot;proveedores.contactar&quot;));</span>
<span class="nc" id="L168">                        chkEditarProveedor.setSelected(buscarPermiso(permisos, &quot;proveedores.editar&quot;));</span>
<span class="nc" id="L169">                        chkEliminarProveedor.setSelected(buscarPermiso(permisos, &quot;proveedores.eliminar&quot;));</span>
<span class="nc" id="L170">                        chkActivarInactivarProveedor</span>
<span class="nc" id="L171">                                        .setSelected(buscarPermiso(permisos, &quot;proveedores.activar_inactivar&quot;));</span>
<span class="nc" id="L172">                        chkDashboardTopProveedores.setSelected(buscarPermiso(permisos, &quot;proveedores.dashboard_top&quot;));</span>
<span class="nc" id="L173">                        chkDashboardDistribucionEstado</span>
<span class="nc" id="L174">                                        .setSelected(buscarPermiso(permisos, &quot;proveedores.dashboard_estado&quot;));</span>
                }
<span class="nc" id="L176">        }</span>

        private void agregarListenersPermisosProveedores() {
                // No agregar listener, siempre activo y no editable
<span class="nc" id="L180">                chkNuevoProveedor.selectedProperty()</span>
<span class="nc" id="L181">                                .addListener((obs, oldVal, newVal) -&gt; guardarPermiso(&quot;proveedores.nuevo&quot;, newVal));</span>
<span class="nc" id="L182">                chkExportarProveedor.selectedProperty()</span>
<span class="nc" id="L183">                                .addListener((obs, oldVal, newVal) -&gt; guardarPermiso(&quot;proveedores.exportar&quot;, newVal));</span>
<span class="nc" id="L184">                chkContactarProveedor.selectedProperty()</span>
<span class="nc" id="L185">                                .addListener((obs, oldVal, newVal) -&gt; guardarPermiso(&quot;proveedores.contactar&quot;, newVal));</span>
<span class="nc" id="L186">                chkEditarProveedor.selectedProperty()</span>
<span class="nc" id="L187">                                .addListener((obs, oldVal, newVal) -&gt; guardarPermiso(&quot;proveedores.editar&quot;, newVal));</span>
<span class="nc" id="L188">                chkEliminarProveedor.selectedProperty()</span>
<span class="nc" id="L189">                                .addListener((obs, oldVal, newVal) -&gt; guardarPermiso(&quot;proveedores.eliminar&quot;, newVal));</span>
<span class="nc" id="L190">                chkActivarInactivarProveedor.selectedProperty()</span>
<span class="nc" id="L191">                                .addListener((obs, oldVal, newVal) -&gt; guardarPermiso(&quot;proveedores.activar_inactivar&quot;,</span>
<span class="nc" id="L192">                                                newVal));</span>
<span class="nc" id="L193">                chkDashboardTopProveedores.selectedProperty()</span>
<span class="nc" id="L194">                                .addListener((obs, oldVal, newVal) -&gt; guardarPermiso(&quot;proveedores.dashboard_top&quot;,</span>
<span class="nc" id="L195">                                                newVal));</span>
<span class="nc" id="L196">                chkDashboardDistribucionEstado.selectedProperty()</span>
<span class="nc" id="L197">                                .addListener((obs, oldVal, newVal) -&gt; guardarPermiso(&quot;proveedores.dashboard_estado&quot;,</span>
<span class="nc" id="L198">                                                newVal));</span>
<span class="nc" id="L199">        }</span>

        private void inicializarPermisosInventario() {
                // Cargar permisos globales para vendedores
                // Tomar el primer usuario con rol VENDEDOR para mostrar el estado
<span class="nc" id="L204">                java.util.List&lt;com.farmaciavictoria.proyectopharmavictoria.model.Usuario.Usuario&gt; vendedores = usuarioService</span>
<span class="nc" id="L205">                                .obtenerUsuarios()</span>
<span class="nc" id="L206">                                .stream()</span>
<span class="nc" id="L207">                                .filter(u -&gt; u</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">                                                .getRol() == com.farmaciavictoria.proyectopharmavictoria.model.Usuario.Usuario.Rol.VENDEDOR)</span>
<span class="nc" id="L209">                                .collect(java.util.stream.Collectors.toList());</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">                if (!vendedores.isEmpty()) {</span>
<span class="nc" id="L211">                        Long primerVendedorId = vendedores.get(0).getId();</span>
<span class="nc" id="L212">                        java.util.List&lt;UsuarioPermiso&gt; permisos = usuarioService.obtenerPermisos(primerVendedorId);</span>
<span class="nc" id="L213">                        chkVerInventario.setSelected(true); // Siempre activo y no editable</span>
<span class="nc" id="L214">                        chkAgregarProducto.setSelected(buscarPermiso(permisos, &quot;inventario.agregar&quot;));</span>
<span class="nc" id="L215">                        chkEditarProducto.setSelected(buscarPermiso(permisos, &quot;inventario.editar&quot;));</span>
<span class="nc" id="L216">                        chkEliminarProducto.setSelected(buscarPermiso(permisos, &quot;inventario.eliminar&quot;));</span>
<span class="nc" id="L217">                        chkActivarInactivarProducto</span>
<span class="nc" id="L218">                                        .setSelected(buscarPermiso(permisos, &quot;inventario.activar_inactivar&quot;));</span>
<span class="nc" id="L219">                        chkEdicionMasiva.setSelected(buscarPermiso(permisos, &quot;inventario.edicion_masiva&quot;));</span>
<span class="nc" id="L220">                        chkExportarInventario.setSelected(buscarPermiso(permisos, &quot;inventario.exportar&quot;));</span>
                }
<span class="nc" id="L222">        }</span>

        private boolean buscarPermiso(java.util.List&lt;UsuarioPermiso&gt; permisos, String clave) {
<span class="nc bnc" id="L225" title="All 4 branches missed.">                return permisos.stream().anyMatch(p -&gt; clave.equals(p.getPermiso()) &amp;&amp; p.isValor());</span>
        }

        private void agregarListenersPermisosInventario() {
                // &quot;Ver inventario&quot; siempre activo, no editable
<span class="nc" id="L230">                chkAgregarProducto.selectedProperty()</span>
<span class="nc" id="L231">                                .addListener((obs, oldVal, newVal) -&gt; guardarPermiso(&quot;inventario.agregar&quot;, newVal));</span>
<span class="nc" id="L232">                chkEditarProducto.selectedProperty()</span>
<span class="nc" id="L233">                                .addListener((obs, oldVal, newVal) -&gt; guardarPermiso(&quot;inventario.editar&quot;, newVal));</span>
<span class="nc" id="L234">                chkEliminarProducto.selectedProperty()</span>
<span class="nc" id="L235">                                .addListener((obs, oldVal, newVal) -&gt; guardarPermiso(&quot;inventario.eliminar&quot;, newVal));</span>
<span class="nc" id="L236">                chkActivarInactivarProducto.selectedProperty()</span>
<span class="nc" id="L237">                                .addListener((obs, oldVal, newVal) -&gt; guardarPermiso(&quot;inventario.activar_inactivar&quot;,</span>
<span class="nc" id="L238">                                                newVal));</span>
<span class="nc" id="L239">                chkEdicionMasiva.selectedProperty()</span>
<span class="nc" id="L240">                                .addListener((obs, oldVal, newVal) -&gt; guardarPermiso(&quot;inventario.edicion_masiva&quot;,</span>
<span class="nc" id="L241">                                                newVal));</span>
<span class="nc" id="L242">                chkExportarInventario.selectedProperty()</span>
<span class="nc" id="L243">                                .addListener((obs, oldVal, newVal) -&gt; guardarPermiso(&quot;inventario.exportar&quot;, newVal));</span>
<span class="nc" id="L244">        }</span>

        private void guardarPermiso(String clave, boolean valor) {
                // Guardar el permiso para todos los usuarios con rol VENDEDOR
<span class="nc" id="L248">                java.util.List&lt;com.farmaciavictoria.proyectopharmavictoria.model.Usuario.Usuario&gt; vendedores = usuarioService</span>
<span class="nc" id="L249">                                .obtenerUsuarios()</span>
<span class="nc" id="L250">                                .stream()</span>
<span class="nc" id="L251">                                .filter(u -&gt; u</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">                                                .getRol() == com.farmaciavictoria.proyectopharmavictoria.model.Usuario.Usuario.Rol.VENDEDOR)</span>
<span class="nc" id="L253">                                .collect(java.util.stream.Collectors.toList());</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">                for (com.farmaciavictoria.proyectopharmavictoria.model.Usuario.Usuario vendedor : vendedores) {</span>
<span class="nc" id="L255">                        UsuarioPermiso permiso = new UsuarioPermiso();</span>
<span class="nc" id="L256">                        permiso.setUsuarioId(vendedor.getId());</span>
<span class="nc" id="L257">                        permiso.setPermiso(clave);</span>
<span class="nc" id="L258">                        permiso.setValor(valor);</span>
<span class="nc" id="L259">                        permiso.setFechaAsignacion(LocalDateTime.now());</span>
<span class="nc" id="L260">                        usuarioService.getPermisoRepository().save(permiso);</span>
<span class="nc" id="L261">                }</span>
<span class="nc" id="L262">                permisosModificados = true;</span>
<span class="nc" id="L263">        }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>
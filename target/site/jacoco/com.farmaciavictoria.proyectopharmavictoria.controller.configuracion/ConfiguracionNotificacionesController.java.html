<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ConfiguracionNotificacionesController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">proyectopharmavictoria</a> &gt; <a href="index.source.html" class="el_package">com.farmaciavictoria.proyectopharmavictoria.controller.configuracion</a> &gt; <span class="el_source">ConfiguracionNotificacionesController.java</span></div><h1>ConfiguracionNotificacionesController.java</h1><pre class="source lang-java linenums">package com.farmaciavictoria.proyectopharmavictoria.controller.configuracion;

import javafx.fxml.FXML;
import javafx.scene.control.*;

<span class="nc" id="L6">public class ConfiguracionNotificacionesController {</span>
    // Checkbox para activar/desactivar alertas
    @FXML
    private CheckBox chkActivarAlertas;
    // Campo para destinatario del correo
    @FXML
    private TextField txtDestinatario;
    // Campo para servidor SMTP
    @FXML
    private TextField txtSmtpServer;
    // Campo para puerto SMTP
    @FXML
    private TextField txtSmtpPort;
    // Usuario SMTP (remitente)
    @FXML
    private TextField txtSmtpUser;
    // Contraseña del remitente
    @FXML
    private PasswordField txtSmtpPassword;
    // Checkbox para usar SSL
    @FXML
    private CheckBox chkSSL;
    // Checkbox para usar TLS
    @FXML
    private CheckBox chkTLS;
    // Botón para probar envío de correo
    @FXML
    private Button btnProbar;
    // Botón para guardar configuración
    @FXML
    private Button btnGuardar;
    // Etiqueta para mostrar estado o mensajes
    @FXML
    private Label lblEstado;

    // Configuración de correo electrónico
    private EmailConfig config;

    // Inicializa el controlador y carga la configuración actual
    @FXML
    public void initialize() {
        try {
<span class="nc" id="L48">            config = EmailConfigService.cargarConfig();</span>
<span class="nc" id="L49">            cargarEnFormulario();</span>
<span class="nc" id="L50">        } catch (Exception e) {</span>
<span class="nc" id="L51">            lblEstado.setText(&quot;No se pudo cargar configuración: &quot; + e.getMessage());</span>
<span class="nc" id="L52">        }</span>
<span class="nc" id="L53">        btnGuardar.setOnAction(e -&gt; guardarConfig());</span>
<span class="nc" id="L54">        btnProbar.setOnAction(e -&gt; probarEnvio());</span>
<span class="nc" id="L55">    }</span>

    // Carga los datos de configuración en el formulario
    private void cargarEnFormulario() {
<span class="nc" id="L59">        chkActivarAlertas.setSelected(config.isAlertasActivas());</span>
<span class="nc" id="L60">        txtDestinatario.setText(config.getDestinatario());</span>
<span class="nc" id="L61">        txtSmtpServer.setText(config.getSmtpServer());</span>
<span class="nc bnc" id="L62" title="All 2 branches missed.">        txtSmtpPort.setText(config.getSmtpPort() &gt; 0 ? String.valueOf(config.getSmtpPort()) : &quot;&quot;);</span>
<span class="nc" id="L63">        txtSmtpUser.setText(config.getSmtpUser());</span>
<span class="nc" id="L64">        txtSmtpUser.setEditable(false); // Remitente no editable</span>
<span class="nc" id="L65">        txtSmtpPassword.setText(config.getSmtpPassword());</span>
<span class="nc" id="L66">        txtSmtpPassword.setEditable(false); // Contraseña remitente no editable</span>
<span class="nc" id="L67">        chkSSL.setSelected(config.isUseSSL());</span>
<span class="nc" id="L68">        chkTLS.setSelected(config.isUseTLS());</span>
<span class="nc" id="L69">    }</span>

    // Guarda la configuración modificada por el usuario
    private void guardarConfig() {
        try {
<span class="nc" id="L74">            config.setAlertasActivas(chkActivarAlertas.isSelected());</span>
<span class="nc" id="L75">            config.setDestinatario(txtDestinatario.getText());</span>
<span class="nc" id="L76">            config.setSmtpServer(txtSmtpServer.getText());</span>
<span class="nc" id="L77">            config.setSmtpPort(Integer.parseInt(txtSmtpPort.getText()));</span>
<span class="nc" id="L78">            config.setUseSSL(chkSSL.isSelected());</span>
<span class="nc" id="L79">            config.setUseTLS(chkTLS.isSelected());</span>
<span class="nc" id="L80">            EmailConfigService.guardarConfig(config);</span>
            // Actualizar el observador de correo para que use el nuevo destinatario sin
            // reiniciar la app
            com.farmaciavictoria.proyectopharmavictoria.events.SystemEventManager eventManager = com.farmaciavictoria.proyectopharmavictoria.events.SystemEventManager
<span class="nc" id="L84">                    .getInstance();</span>
<span class="nc" id="L85">            eventManager.unsubscribe(&quot;StockVencimientoEmailObserver&quot;);</span>
<span class="nc" id="L86">            com.farmaciavictoria.proyectopharmavictoria.service.EmailService emailService = new com.farmaciavictoria.proyectopharmavictoria.service.EmailService(</span>
<span class="nc" id="L87">                    config.getSmtpUser(), config.getSmtpPassword());</span>
<span class="nc" id="L88">            com.farmaciavictoria.proyectopharmavictoria.util.StockVencimientoEmailObserver nuevoObserver = new com.farmaciavictoria.proyectopharmavictoria.util.StockVencimientoEmailObserver(</span>
<span class="nc" id="L89">                    emailService, config.getDestinatario());</span>
<span class="nc" id="L90">            eventManager.subscribe(nuevoObserver);</span>
<span class="nc" id="L91">            lblEstado.setText(&quot;Configuración guardada correctamente y destinatario actualizado.&quot;);</span>
<span class="nc" id="L92">        } catch (Exception e) {</span>
<span class="nc" id="L93">            lblEstado.setText(&quot;Error al guardar: &quot; + e.getMessage());</span>
<span class="nc" id="L94">        }</span>
<span class="nc" id="L95">    }</span>

    // Prueba el envío de correo con la configuración actual
    private void probarEnvio() {
        try {
<span class="nc" id="L100">            guardarConfig();</span>
<span class="nc" id="L101">            EmailService.enviarCorreo(config, &quot;Prueba de alerta PharmaVictoria&quot;, &quot;Este es un correo de prueba.&quot;);</span>
<span class="nc" id="L102">            lblEstado.setText(&quot;¡Correo de prueba enviado!&quot;);</span>
<span class="nc" id="L103">        } catch (Exception e) {</span>
<span class="nc" id="L104">            lblEstado.setText(&quot;Error al enviar: &quot; + e.getMessage());</span>
<span class="nc" id="L105">        }</span>
<span class="nc" id="L106">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>
<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TicketVentaController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">proyectopharmavictoria</a> &gt; <a href="index.source.html" class="el_package">com.farmaciavictoria.proyectopharmavictoria.controller.Ventas</a> &gt; <span class="el_source">TicketVentaController.java</span></div><h1>TicketVentaController.java</h1><pre class="source lang-java linenums">
package com.farmaciavictoria.proyectopharmavictoria.controller.Ventas;

import com.farmaciavictoria.proyectopharmavictoria.model.Cliente.Cliente;

import com.farmaciavictoria.proyectopharmavictoria.model.Inventario.Producto;
import com.farmaciavictoria.proyectopharmavictoria.model.Ventas.DetalleVenta;
import com.farmaciavictoria.proyectopharmavictoria.model.Ventas.Venta;
import com.farmaciavictoria.proyectopharmavictoria.model.Ventas.Comprobante;
import com.farmaciavictoria.proyectopharmavictoria.repository.Ventas.VentaRepositoryJdbcImpl;
import com.farmaciavictoria.proyectopharmavictoria.repository.Ventas.ComprobanteRepositoryJdbcImpl;
import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.util.List;

<span class="nc" id="L16">public class TicketVentaController {</span>
<span class="nc" id="L17">    private final VentaRepositoryJdbcImpl ventaRepository = new VentaRepositoryJdbcImpl();</span>
<span class="nc" id="L18">    private final ComprobanteRepositoryJdbcImpl comprobanteRepository = new ComprobanteRepositoryJdbcImpl();</span>

    public Venta registrarVentaTicket(List&lt;DetalleVenta&gt; carrito, String metodoPago, String usuario,
            String nombreFarmacia, Cliente cliente) {

        // Repositorios necesarios
<span class="nc" id="L24">        com.farmaciavictoria.proyectopharmavictoria.repository.Inventario.ProductoRepository productoRepository = new com.farmaciavictoria.proyectopharmavictoria.repository.Inventario.ProductoRepository();</span>
<span class="nc" id="L25">        com.farmaciavictoria.proyectopharmavictoria.repository.Inventario.ProductoHistorialCambioRepository historialRepository = new com.farmaciavictoria.proyectopharmavictoria.repository.Inventario.ProductoHistorialCambioRepository();</span>
<span class="nc" id="L26">        com.farmaciavictoria.proyectopharmavictoria.repository.Ventas.DetalleVentaRepositoryJdbcImpl detalleRepository = new com.farmaciavictoria.proyectopharmavictoria.repository.Ventas.DetalleVentaRepositoryJdbcImpl();</span>

        // Calcular totales
<span class="nc" id="L29">        BigDecimal subtotal = BigDecimal.ZERO;</span>
<span class="nc bnc" id="L30" title="All 2 branches missed.">        for (DetalleVenta d : carrito) {</span>
<span class="nc bnc" id="L31" title="All 2 branches missed.">            if (d.getSubtotal() != null)</span>
<span class="nc" id="L32">                subtotal = subtotal.add(d.getSubtotal());</span>
<span class="nc" id="L33">        }</span>
<span class="nc" id="L34">        BigDecimal igv = subtotal.multiply(new BigDecimal(&quot;0.18&quot;));</span>
<span class="nc" id="L35">        BigDecimal total = subtotal.add(igv);</span>

        // Generar serie y nÃºmero
<span class="nc" id="L38">        String serieTicket = &quot;TKT1&quot;;</span>
<span class="nc" id="L39">        int ultimoNumero = comprobanteRepository.obtenerUltimoNumeroPorSerieYTipo(serieTicket, &quot;TICKET&quot;);</span>
<span class="nc" id="L40">        String numeroTicket = String.format(&quot;%06d&quot;, ultimoNumero + 1);</span>

        // Crear comprobante tipo TICKET
<span class="nc" id="L43">        Comprobante comprobante = new Comprobante();</span>
<span class="nc" id="L44">        comprobante.setSerie(serieTicket);</span>
<span class="nc" id="L45">        comprobante.setNumero(numeroTicket);</span>
<span class="nc" id="L46">        comprobante.setTipo(&quot;TICKET&quot;);</span>
<span class="nc" id="L47">        comprobante.setFechaEmision(LocalDateTime.now());</span>
<span class="nc" id="L48">        comprobante.setEstadoSunat(&quot;GENERADO&quot;);</span>
<span class="nc" id="L49">        comprobante.setHashSunat(null);</span>

        // Crear venta
<span class="nc" id="L52">        Venta venta = new Venta();</span>
<span class="nc" id="L53">        venta.setSubtotal(subtotal);</span>
<span class="nc" id="L54">        venta.setIgvMonto(igv);</span>
<span class="nc" id="L55">        venta.setTotal(total);</span>
<span class="nc" id="L56">        venta.setTipoPago(metodoPago);</span>
<span class="nc" id="L57">        venta.setTipoComprobante(&quot;TICKET&quot;);</span>
<span class="nc" id="L58">        venta.setNumeroBoleta(numeroTicket);</span>
<span class="nc" id="L59">        venta.setSerie(serieTicket);</span>
<span class="nc" id="L60">        venta.setFechaVenta(LocalDateTime.now());</span>
<span class="nc" id="L61">        venta.setCreatedAt(LocalDateTime.now());</span>
<span class="nc" id="L62">        venta.setEstado(&quot;REALIZADA&quot;);</span>
<span class="nc" id="L63">        venta.setDetalles(carrito);</span>
<span class="nc" id="L64">        venta.setComprobante(comprobante);</span>
<span class="nc" id="L65">        venta.setObservaciones(&quot;Venta registrada como ticket simple&quot;);</span>
        // Asignar usuario actual
        com.farmaciavictoria.proyectopharmavictoria.model.Usuario.Usuario usuarioActual = com.farmaciavictoria.proyectopharmavictoria.SessionManager
<span class="nc" id="L68">                .getUsuarioActual();</span>
<span class="nc" id="L69">        venta.setUsuario(usuarioActual);</span>
        // Asignar cliente recibido
<span class="nc bnc" id="L71" title="All 2 branches missed.">        if (cliente != null) {</span>
<span class="nc" id="L72">            venta.setCliente(cliente);</span>
        }
        // Asignar updatedAt igual a createdAt
<span class="nc" id="L75">        venta.setUpdatedAt(venta.getCreatedAt());</span>

        // Guardar venta y comprobante
<span class="nc" id="L78">        Venta ventaGuardada = ventaRepository.save(venta);</span>
<span class="nc" id="L79">        comprobante.setVenta(ventaGuardada);</span>
<span class="nc" id="L80">        comprobanteRepository.save(comprobante);</span>

        // Registrar detalle de venta y descontar stock
<span class="nc bnc" id="L83" title="All 2 branches missed.">        for (DetalleVenta d : carrito) {</span>
            // Asignar venta al detalle
<span class="nc" id="L85">            d.setVenta(ventaGuardada);</span>
<span class="nc" id="L86">            detalleRepository.save(d);</span>

            // Descontar stock
<span class="nc" id="L89">            Producto producto = d.getProducto();</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">            if (producto != null) {</span>
<span class="nc" id="L91">                int stockAnterior = producto.getStockActual();</span>
<span class="nc" id="L92">                int nuevoStock = stockAnterior - d.getCantidad();</span>
<span class="nc" id="L93">                productoRepository.updateStock(producto.getId(), nuevoStock);</span>

                // Registrar historial de cambio de stock (llamada estÃ¡tica)
<span class="nc" id="L96">                com.farmaciavictoria.proyectopharmavictoria.repository.Inventario.ProductoHistorialCambioRepository</span>
<span class="nc" id="L97">                        .registrarCambio(</span>
<span class="nc" id="L98">                                producto.getId(),</span>
                                &quot;stock_actual&quot;,
<span class="nc" id="L100">                                String.valueOf(stockAnterior),</span>
<span class="nc" id="L101">                                String.valueOf(nuevoStock),</span>
                                usuario);
            }
<span class="nc" id="L104">        }</span>

        // Retornar la venta registrada
<span class="nc" id="L107">        return ventaGuardada;</span>
    }

    public void mostrarVistaPreviaTicket(String textoTicket) {
        try {
<span class="nc" id="L112">            javafx.fxml.FXMLLoader loader = new javafx.fxml.FXMLLoader(</span>
<span class="nc" id="L113">                    getClass().getResource(&quot;/fxml/vista_previa_ticket.fxml&quot;));</span>
<span class="nc" id="L114">            javafx.scene.Parent root = loader.load();</span>
<span class="nc" id="L115">            VistaPreviaTicketController controller = loader.getController();</span>
<span class="nc" id="L116">            controller.setTicketTexto(textoTicket);</span>

<span class="nc" id="L118">            javafx.stage.Stage stage = new javafx.stage.Stage();</span>
<span class="nc" id="L119">            stage.setTitle(&quot;Vista previa del ticket&quot;);</span>
<span class="nc" id="L120">            stage.initModality(javafx.stage.Modality.APPLICATION_MODAL);</span>
<span class="nc" id="L121">            stage.setScene(new javafx.scene.Scene(root));</span>
<span class="nc" id="L122">            stage.showAndWait();</span>
<span class="nc" id="L123">        } catch (Exception e) {</span>
<span class="nc" id="L124">            e.printStackTrace();</span>
<span class="nc" id="L125">        }</span>
<span class="nc" id="L126">    }</span>

    // MÃ©todo para generar el texto del ticket adaptado
    public String generarTextoTicket(Venta venta, String nombreFarmacia) {
<span class="nc" id="L130">        StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L131">        sb.append(&quot;â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n&quot;);</span>
<span class="nc" id="L132">        sb.append(String.format(&quot;â”‚%-76sâ”‚\n&quot;, &quot;PharmaVictoria&quot;));</span>
<span class="nc" id="L133">        sb.append(String.format(&quot;â”‚RUC: %-52sâ”‚\n&quot;, &quot;10468894501&quot;));</span>
<span class="nc" id="L134">        sb.append(String.format(&quot;â”‚DirecciÃ³n: %-48sâ”‚\n&quot;, &quot;IMPERIAL, CAÃ‘ETE&quot;));</span>
<span class="nc" id="L135">        sb.append(&quot;â”‚--------------------------------------------------------------â”‚\n&quot;);</span>
<span class="nc" id="L136">        sb.append(String.format(&quot;â”‚%30sâ”‚\n&quot;, &quot;TICKET DE VENTA&quot;));</span>
<span class="nc" id="L137">        sb.append(String.format(&quot;â”‚%30sâ”‚\n&quot;, &quot;SERIE: &quot; + venta.getSerie() + &quot; - NÂ° &quot; + venta.getNumeroBoleta()));</span>
<span class="nc" id="L138">        sb.append(&quot;â”‚--------------------------------------------------------------â”‚\n&quot;);</span>
<span class="nc" id="L139">        sb.append(String.format(&quot;â”‚ FECHA: %s â”‚\n&quot;, venta.getFechaVenta().toLocalDate()));</span>
<span class="nc" id="L140">        sb.append(String.format(&quot;â”‚ HORA: %s â”‚\n&quot;, venta.getFechaVenta().toLocalTime().toString()));</span>
<span class="nc" id="L141">        String cajero = &quot;&quot;;</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">        if (venta.getUsuario() != null) {</span>
<span class="nc" id="L143">            cajero = venta.getUsuario().getNombreCompleto();</span>
        }
<span class="nc" id="L145">        sb.append(String.format(&quot;â”‚ CAJERO: %s â”‚\n&quot;, cajero));</span>

        // Datos de cliente
<span class="nc" id="L148">        String clienteNombre = &quot;CONSUMIDOR FINAL&quot;;</span>
<span class="nc" id="L149">        String clienteDoc = &quot;00000000&quot;;</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">        if (venta.getCliente() != null) {</span>
<span class="nc" id="L151">            clienteNombre = venta.getCliente().getNombreCompleto();</span>
<span class="nc" id="L152">            clienteDoc = venta.getCliente().getDocumento();</span>
        }
<span class="nc" id="L154">        sb.append(String.format(&quot;â”‚ CLIENTE: %s â”‚\n&quot;, clienteNombre));</span>
<span class="nc bnc" id="L155" title="All 4 branches missed.">        if (venta.getCliente() != null &amp;&amp; &quot;NATURAL&quot;.equalsIgnoreCase(venta.getCliente().getTipoCliente())) {</span>
<span class="nc" id="L156">            sb.append(String.format(&quot;â”‚ DNI: %s â”‚\n&quot;, clienteDoc));</span>
        }
<span class="nc" id="L158">        sb.append(&quot;â”‚--------------------------------------------------------------â”‚\n&quot;);</span>
<span class="nc" id="L159">        sb.append(&quot;â”‚ CANT.  |  DESCRIPCIÃ“N                  | P.U.   | IMPORTE    â”‚\n&quot;);</span>
<span class="nc" id="L160">        sb.append(&quot;â”‚--------------------------------------------------------------â”‚\n&quot;);</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">        for (DetalleVenta d : venta.getDetalles()) {</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">            String prod = d.getProducto() != null ? d.getProducto().getNombre() : &quot;&quot;;</span>
<span class="nc" id="L163">            String linea = String.format(&quot;â”‚ %-6d | %-28s | %-6.2f | %-9.2f â”‚\n&quot;, d.getCantidad(), prod,</span>
<span class="nc" id="L164">                    d.getPrecioUnitario(), d.getSubtotal());</span>
<span class="nc" id="L165">            sb.append(linea);</span>
<span class="nc" id="L166">        }</span>
<span class="nc" id="L167">        sb.append(&quot;â”‚--------------------------------------------------------------â”‚\n&quot;);</span>
<span class="nc" id="L168">        sb.append(String.format(&quot;â”‚%40s%8.2f â”‚\n&quot;, &quot;SUBTOTAL:&quot;, venta.getSubtotal().doubleValue()));</span>
<span class="nc" id="L169">        sb.append(String.format(&quot;â”‚%40s%8.2f â”‚\n&quot;, &quot;IGV (18%):&quot;, venta.getIgvMonto().doubleValue()));</span>
<span class="nc" id="L170">        sb.append(&quot;â”‚--------------------------------------------------------------â”‚\n&quot;);</span>
<span class="nc" id="L171">        sb.append(String.format(&quot;â”‚%40s%8.2f â”‚\n&quot;, &quot;TOTAL:&quot;, venta.getTotal().doubleValue()));</span>
<span class="nc" id="L172">        sb.append(&quot;â”‚--------------------------------------------------------------â”‚\n&quot;);</span>
<span class="nc" id="L173">        sb.append(String.format(&quot;â”‚ MÃ‰TODO DE PAGO: %s â”‚\n&quot;,</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">                venta.getTipoPago() != null ? venta.getTipoPago() : &quot;EFECTIVO&quot;));</span>
<span class="nc" id="L175">        sb.append(&quot;â”‚--------------------------------------------------------------â”‚\n&quot;);</span>
<span class="nc" id="L176">        sb.append(&quot;â”‚             Â¡GRACIAS POR SU COMPRA! ğŸ’š                        â”‚\n&quot;);</span>
<span class="nc" id="L177">        sb.append(&quot;â”‚   Consuma responsablemente. Medicamentos bajo receta mÃ©dica.  â”‚\n&quot;);</span>
<span class="nc" id="L178">        sb.append(&quot;â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n&quot;);</span>
<span class="nc" id="L179">        return sb.toString();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>
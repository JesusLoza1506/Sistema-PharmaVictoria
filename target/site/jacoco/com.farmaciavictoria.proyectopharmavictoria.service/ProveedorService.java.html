<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ProveedorService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">proyectopharmavictoria</a> &gt; <a href="index.source.html" class="el_package">com.farmaciavictoria.proyectopharmavictoria.service</a> &gt; <span class="el_source">ProveedorService.java</span></div><h1>ProveedorService.java</h1><pre class="source lang-java linenums">package com.farmaciavictoria.proyectopharmavictoria.service;

import com.farmaciavictoria.proyectopharmavictoria.repository.ProveedorRepository;
import com.farmaciavictoria.proyectopharmavictoria.events.SystemEventManager;
import com.farmaciavictoria.proyectopharmavictoria.model.Proveedor.Proveedor;
import com.farmaciavictoria.proyectopharmavictoria.events.SystemEvent;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.time.LocalDateTime;
import java.util.List;
import java.util.regex.Pattern;

/**
 * ✅ SERVICE LAYER PATTERN - Servicio de negocio para proveedores
 * Centraliza toda la lógica de negocio relacionada con proveedores
 * Aplicando principios de separación de responsabilidades
 */
public class ProveedorService {

<span class="fc" id="L21">    private static final Logger logger = LoggerFactory.getLogger(ProveedorService.class);</span>

    // Patrones de validación centralizados
<span class="fc" id="L24">    private static final Pattern PATTERN_EMAIL = Pattern.compile(</span>
            &quot;^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$&quot;);
<span class="fc" id="L26">    private static final Pattern PATTERN_RUC = Pattern.compile(&quot;^\\d{11}$&quot;);</span>
<span class="fc" id="L27">    private static final Pattern PATTERN_TELEFONO = Pattern.compile(&quot;^\\d{7,15}$&quot;);</span>

    private final ProveedorRepository proveedorRepository;
    private final SystemEventManager eventManager;

    // Temporal: Constructor con parámetro hasta implementar DI
<span class="fc" id="L33">    public ProveedorService(ProveedorRepository proveedorRepository) {</span>
<span class="fc" id="L34">        this.proveedorRepository = proveedorRepository;</span>
<span class="fc" id="L35">        this.eventManager = SystemEventManager.getInstance();</span>
<span class="fc" id="L36">    }</span>

    /**
     * ✅ SERVICE LAYER: Obtener todos los proveedores activos
     * Encapsula la lógica de negocio para listado de proveedores
     */
    public List&lt;Proveedor&gt; obtenerTodos() {
        try {
<span class="nc" id="L44">            logger.debug(&quot;Obteniendo todos los proveedores activos&quot;);</span>
<span class="nc" id="L45">            List&lt;Proveedor&gt; proveedores = proveedorRepository.findAll();</span>
<span class="nc" id="L46">            logger.info(&quot;Proveedores obtenidos exitosamente: {}&quot;, proveedores.size());</span>
<span class="nc" id="L47">            return proveedores;</span>
<span class="nc" id="L48">        } catch (Exception e) {</span>
<span class="nc" id="L49">            logger.error(&quot;Error al obtener proveedores: {}&quot;, e.getMessage(), e);</span>
<span class="nc" id="L50">            throw new RuntimeException(&quot;Error al obtener la lista de proveedores&quot;, e);</span>
        }
    }

    /**
     * ✅ SERVICE LAYER: Buscar proveedores por texto
     * Aplica lógica de búsqueda de negocio
     */
    public List&lt;Proveedor&gt; buscarPorTexto(String texto) {
        try {
<span class="nc bnc" id="L60" title="All 4 branches missed.">            if (texto == null || texto.trim().isEmpty()) {</span>
<span class="nc" id="L61">                return obtenerTodos();</span>
            }

<span class="nc" id="L64">            logger.debug(&quot;Buscando proveedores por texto: {}&quot;, texto);</span>
<span class="nc" id="L65">            List&lt;Proveedor&gt; resultados = proveedorRepository.buscarProveedores(texto.trim());</span>
<span class="nc" id="L66">            logger.info(&quot;Búsqueda completada. Resultados encontrados: {}&quot;, resultados.size());</span>
<span class="nc" id="L67">            return resultados;</span>
<span class="nc" id="L68">        } catch (Exception e) {</span>
<span class="nc" id="L69">            logger.error(&quot;Error en búsqueda de proveedores: {}&quot;, e.getMessage(), e);</span>
<span class="nc" id="L70">            throw new RuntimeException(&quot;Error al buscar proveedores&quot;, e);</span>
        }
    }

    /**
     * ✅ SERVICE LAYER: Obtener proveedor por ID
     */
    public Proveedor obtenerPorId(Integer id) {
        try {
<span class="nc bnc" id="L79" title="All 4 branches missed.">            if (id == null || id &lt;= 0) {</span>
<span class="nc" id="L80">                throw new IllegalArgumentException(&quot;ID de proveedor inválido&quot;);</span>
            }

<span class="nc" id="L83">            logger.debug(&quot;Obteniendo proveedor por ID: {}&quot;, id);</span>
<span class="nc" id="L84">            Proveedor proveedor = proveedorRepository.findById(id);</span>

<span class="nc bnc" id="L86" title="All 2 branches missed.">            if (proveedor == null) {</span>
<span class="nc" id="L87">                logger.warn(&quot;Proveedor no encontrado con ID: {}&quot;, id);</span>
<span class="nc" id="L88">                throw new RuntimeException(&quot;Proveedor no encontrado&quot;);</span>
            }

<span class="nc" id="L91">            return proveedor;</span>
<span class="nc" id="L92">        } catch (Exception e) {</span>
<span class="nc" id="L93">            logger.error(&quot;Error al obtener proveedor por ID {}: {}&quot;, id, e.getMessage(), e);</span>
<span class="nc" id="L94">            throw new RuntimeException(&quot;Error al obtener el proveedor&quot;, e);</span>
        }
    }

    /**
     * ✅ SERVICE LAYER: Guardar proveedor (crear o actualizar)
     * Aplica todas las validaciones de negocio antes de persistir
     */
    public Proveedor guardar(Proveedor proveedor) {
        try {
<span class="nc" id="L104">            logger.debug(&quot;Iniciando proceso de guardado de proveedor&quot;);</span>

            // Aplicar validaciones de negocio
<span class="nc" id="L107">            validarProveedor(proveedor);</span>

            // Verificar duplicados por RUC
<span class="nc" id="L110">            verificarRucUnico(proveedor);</span>

            // Preparar datos para persistencia
<span class="nc" id="L113">            prepararProveedorParaGuardar(proveedor);</span>

            // Guardar en base de datos
<span class="nc" id="L116">            boolean guardado = proveedorRepository.save(proveedor);</span>

<span class="nc bnc" id="L118" title="All 2 branches missed.">            if (!guardado) {</span>
<span class="nc" id="L119">                throw new RuntimeException(&quot;No se pudo guardar el proveedor en la base de datos&quot;);</span>
            }

<span class="nc" id="L122">            logger.info(&quot;Proveedor guardado exitosamente: {} (RUC: {})&quot;,</span>
<span class="nc" id="L123">                    proveedor.getRazonSocial(), proveedor.getRuc());</span>

            // ✅ OBSERVER PATTERN: Notificar evento de creación
<span class="nc" id="L126">            eventManager.publishEvent(SystemEvent.EventType.PROVEEDOR_CREADO,</span>
<span class="nc" id="L127">                    &quot;Nuevo proveedor creado: &quot; + proveedor.getRazonSocial(),</span>
                    this);

<span class="nc" id="L130">            return proveedor;</span>

<span class="nc" id="L132">        } catch (Exception e) {</span>
<span class="nc" id="L133">            logger.error(&quot;Error al guardar proveedor: {}&quot;, e.getMessage(), e);</span>
<span class="nc" id="L134">            throw new RuntimeException(&quot;Error al guardar el proveedor: &quot; + e.getMessage(), e);</span>
        }
    }

    /**
     * ✅ SERVICE LAYER: Actualizar proveedor existente
     */
    public Proveedor actualizar(Proveedor proveedor, String usuario) {
        try {
<span class="nc bnc" id="L143" title="All 2 branches missed.">            if (proveedor.getId() == null) {</span>
<span class="nc" id="L144">                throw new IllegalArgumentException(&quot;ID de proveedor requerido para actualización&quot;);</span>
            }
<span class="nc" id="L146">            logger.debug(&quot;Actualizando proveedor ID: {}&quot;, proveedor.getId());</span>
<span class="nc" id="L147">            Proveedor existente = obtenerPorId(proveedor.getId());</span>
<span class="nc" id="L148">            validarProveedor(proveedor);</span>
<span class="nc" id="L149">            verificarRucUnicoParaActualizacion(proveedor);</span>
<span class="nc" id="L150">            proveedor.setCreatedAt(existente.getCreatedAt());</span>
            // Registrar cambios en historial si hay modificaciones
<span class="nc" id="L152">            compararYRegistrarCambios(existente, proveedor, usuario);</span>
<span class="nc" id="L153">            boolean actualizado = proveedorRepository.update(proveedor);</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">            if (!actualizado) {</span>
<span class="nc" id="L155">                throw new RuntimeException(&quot;No se pudo actualizar el proveedor&quot;);</span>
            }
<span class="nc" id="L157">            logger.info(&quot;Proveedor actualizado exitosamente: {}&quot;, proveedor.getRazonSocial());</span>
<span class="nc" id="L158">            eventManager.publishEvent(SystemEvent.EventType.PROVEEDOR_ACTUALIZADO,</span>
<span class="nc" id="L159">                    &quot;Proveedor actualizado: &quot; + proveedor.getRazonSocial(),</span>
                    this);
<span class="nc" id="L161">            return proveedor;</span>
<span class="nc" id="L162">        } catch (Exception e) {</span>
<span class="nc" id="L163">            logger.error(&quot;Error al actualizar proveedor: {}&quot;, e.getMessage(), e);</span>
<span class="nc" id="L164">            throw new RuntimeException(&quot;Error al actualizar el proveedor: &quot; + e.getMessage(), e);</span>
        }
    }

    /**
     * Compara los campos relevantes y registra los cambios en el historial
     */
    private void compararYRegistrarCambios(Proveedor anterior, Proveedor nuevo, String usuario) {
        String usuarioLogueado = com.farmaciavictoria.proyectopharmavictoria.service.AuthenticationService
<span class="nc bnc" id="L173" title="All 2 branches missed.">                .getUsuarioActual() != null</span>
<span class="nc" id="L174">                        ? com.farmaciavictoria.proyectopharmavictoria.service.AuthenticationService.getUsuarioActual()</span>
<span class="nc" id="L175">                                .getUsername()</span>
<span class="nc" id="L176">                        : usuario;</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">        if (!safeEquals(anterior.getRazonSocial(), nuevo.getRazonSocial())) {</span>
<span class="nc" id="L178">            proveedorRepository.registrarCambioProveedor(nuevo.getId(), &quot;razon_social&quot;, anterior.getRazonSocial(),</span>
<span class="nc" id="L179">                    nuevo.getRazonSocial(), usuarioLogueado);</span>
        }
<span class="nc bnc" id="L181" title="All 2 branches missed.">        if (!safeEquals(anterior.getRuc(), nuevo.getRuc())) {</span>
<span class="nc" id="L182">            proveedorRepository.registrarCambioProveedor(nuevo.getId(), &quot;ruc&quot;, anterior.getRuc(), nuevo.getRuc(),</span>
                    usuarioLogueado);
        }
<span class="nc bnc" id="L185" title="All 2 branches missed.">        if (!safeEquals(anterior.getContacto(), nuevo.getContacto())) {</span>
<span class="nc" id="L186">            proveedorRepository.registrarCambioProveedor(nuevo.getId(), &quot;contacto&quot;, anterior.getContacto(),</span>
<span class="nc" id="L187">                    nuevo.getContacto(), usuarioLogueado);</span>
        }
<span class="nc bnc" id="L189" title="All 2 branches missed.">        if (!safeEquals(anterior.getTelefono(), nuevo.getTelefono())) {</span>
<span class="nc" id="L190">            proveedorRepository.registrarCambioProveedor(nuevo.getId(), &quot;telefono&quot;, anterior.getTelefono(),</span>
<span class="nc" id="L191">                    nuevo.getTelefono(), usuarioLogueado);</span>
        }
<span class="nc bnc" id="L193" title="All 2 branches missed.">        if (!safeEquals(anterior.getEmail(), nuevo.getEmail())) {</span>
<span class="nc" id="L194">            proveedorRepository.registrarCambioProveedor(nuevo.getId(), &quot;email&quot;, anterior.getEmail(), nuevo.getEmail(),</span>
                    usuarioLogueado);
        }
<span class="nc bnc" id="L197" title="All 2 branches missed.">        if (!safeEquals(anterior.getDireccion(), nuevo.getDireccion())) {</span>
<span class="nc" id="L198">            proveedorRepository.registrarCambioProveedor(nuevo.getId(), &quot;direccion&quot;, anterior.getDireccion(),</span>
<span class="nc" id="L199">                    nuevo.getDireccion(), usuarioLogueado);</span>
        }
<span class="nc bnc" id="L201" title="All 2 branches missed.">        if (!safeEquals(anterior.getCondicionesPago(), nuevo.getCondicionesPago())) {</span>
<span class="nc" id="L202">            proveedorRepository.registrarCambioProveedor(nuevo.getId(), &quot;condiciones_pago&quot;,</span>
<span class="nc" id="L203">                    anterior.getCondicionesPago(), nuevo.getCondicionesPago(), usuarioLogueado);</span>
        }
<span class="nc bnc" id="L205" title="All 2 branches missed.">        if (!safeEquals(anterior.getObservaciones(), nuevo.getObservaciones())) {</span>
<span class="nc" id="L206">            proveedorRepository.registrarCambioProveedor(nuevo.getId(), &quot;observaciones&quot;, anterior.getObservaciones(),</span>
<span class="nc" id="L207">                    nuevo.getObservaciones(), usuarioLogueado);</span>
        }
<span class="nc bnc" id="L209" title="All 2 branches missed.">        if (!safeEquals(anterior.getTipoProducto(), nuevo.getTipoProducto())) {</span>
<span class="nc" id="L210">            proveedorRepository.registrarCambioProveedor(nuevo.getId(), &quot;tipo_producto&quot;, anterior.getTipoProducto(),</span>
<span class="nc" id="L211">                    nuevo.getTipoProducto(), usuarioLogueado);</span>
        }
<span class="nc bnc" id="L213" title="All 2 branches missed.">        if (anterior.getActivo() != nuevo.getActivo()) {</span>
<span class="nc" id="L214">            proveedorRepository.registrarCambioProveedor(nuevo.getId(), &quot;activo&quot;, String.valueOf(anterior.getActivo()),</span>
<span class="nc" id="L215">                    String.valueOf(nuevo.getActivo()), usuarioLogueado);</span>
        }
<span class="nc" id="L217">    }</span>

    private boolean safeEquals(Object a, Object b) {
<span class="nc bnc" id="L220" title="All 4 branches missed.">        if (a == null &amp;&amp; b == null)</span>
<span class="nc" id="L221">            return true;</span>
<span class="nc bnc" id="L222" title="All 4 branches missed.">        if (a == null || b == null)</span>
<span class="nc" id="L223">            return false;</span>
<span class="nc" id="L224">        return a.equals(b);</span>
    }

    /**
     * Permite consultar el historial de cambios de un proveedor
     */
    public List&lt;ProveedorRepository.HistorialCambioDTO&gt; obtenerHistorialCambios(Integer proveedorId) {
<span class="nc" id="L231">        return proveedorRepository.obtenerHistorialCambios(proveedorId);</span>
    }

    /**
     * ✅ SERVICE LAYER: Eliminar proveedor
     * Aplica reglas de negocio para eliminación
     */
    public boolean eliminar(Integer id) {
        try {
<span class="nc bnc" id="L240" title="All 4 branches missed.">            if (id == null || id &lt;= 0) {</span>
<span class="nc" id="L241">                throw new IllegalArgumentException(&quot;ID de proveedor inválido&quot;);</span>
            }

<span class="nc" id="L244">            logger.debug(&quot;Eliminando proveedor ID: {}&quot;, id);</span>

            // Verificar que existe
<span class="nc" id="L247">            Proveedor proveedor = obtenerPorId(id);</span>

            // - No se puede eliminar si tiene productos asociados
            // - No se puede eliminar si tiene compras registradas
            // Por ahora permitimos la eliminación

<span class="nc" id="L253">            boolean eliminado = proveedorRepository.delete(id);</span>

<span class="nc bnc" id="L255" title="All 2 branches missed.">            if (!eliminado) {</span>
<span class="nc" id="L256">                throw new RuntimeException(&quot;No se pudo eliminar el proveedor&quot;);</span>
            }

<span class="nc" id="L259">            logger.info(&quot;Proveedor eliminado exitosamente: {}&quot;, proveedor.getRazonSocial());</span>

            // ✅ OBSERVER PATTERN: Notificar evento de eliminación
<span class="nc" id="L262">            eventManager.publishEvent(SystemEvent.EventType.PROVEEDOR_ELIMINADO,</span>
<span class="nc" id="L263">                    &quot;Proveedor eliminado: &quot; + proveedor.getRazonSocial(),</span>
                    this);

<span class="nc" id="L266">            return true;</span>

<span class="nc" id="L268">        } catch (Exception e) {</span>
<span class="nc" id="L269">            logger.error(&quot;Error al eliminar proveedor ID {}: {}&quot;, id, e.getMessage(), e);</span>
<span class="nc" id="L270">            throw new RuntimeException(&quot;Error al eliminar el proveedor: &quot; + e.getMessage(), e);</span>
        }
    }

    /**
     * ✅ SERVICE LAYER: Validaciones de negocio centralizadas
     * Todas las reglas de validación en un solo lugar
     */
    public void validarProveedor(Proveedor proveedor) {
<span class="nc bnc" id="L279" title="All 2 branches missed.">        if (proveedor == null) {</span>
<span class="nc" id="L280">            throw new IllegalArgumentException(&quot;Proveedor no puede ser nulo&quot;);</span>
        }

        // Validar razón social
<span class="nc" id="L284">        validarRazonSocial(proveedor.getRazonSocial());</span>

        // Validar RUC
<span class="nc" id="L287">        validarRuc(proveedor.getRuc());</span>

        // Validar email (opcional)
<span class="nc bnc" id="L290" title="All 4 branches missed.">        if (proveedor.getEmail() != null &amp;&amp; !proveedor.getEmail().trim().isEmpty()) {</span>
<span class="nc" id="L291">            validarEmail(proveedor.getEmail());</span>
        }

        // Validar teléfono (opcional)
<span class="nc bnc" id="L295" title="All 4 branches missed.">        if (proveedor.getTelefono() != null &amp;&amp; !proveedor.getTelefono().trim().isEmpty()) {</span>
<span class="nc" id="L296">            validarTelefono(proveedor.getTelefono());</span>
        }

<span class="nc" id="L299">        logger.debug(&quot;Validaciones de proveedor completadas exitosamente&quot;);</span>
<span class="nc" id="L300">    }</span>

    /**
     * ✅ SERVICE LAYER: Validar razón social
     */
    public void validarRazonSocial(String razonSocial) {
<span class="nc bnc" id="L306" title="All 4 branches missed.">        if (razonSocial == null || razonSocial.trim().isEmpty()) {</span>
<span class="nc" id="L307">            throw new IllegalArgumentException(&quot;La razón social es obligatoria&quot;);</span>
        }

<span class="nc bnc" id="L310" title="All 2 branches missed.">        if (razonSocial.trim().length() &lt; 3) {</span>
<span class="nc" id="L311">            throw new IllegalArgumentException(&quot;La razón social debe tener al menos 3 caracteres&quot;);</span>
        }

<span class="nc bnc" id="L314" title="All 2 branches missed.">        if (razonSocial.trim().length() &gt; 150) {</span>
<span class="nc" id="L315">            throw new IllegalArgumentException(&quot;La razón social no puede exceder 150 caracteres&quot;);</span>
        }
<span class="nc" id="L317">    }</span>

    /**
     * ✅ SERVICE LAYER: Validar RUC (OPCIONAL)
     */
    public void validarRuc(String ruc) {
        // RUC es OPCIONAL - solo validar formato si se proporciona
<span class="nc bnc" id="L324" title="All 4 branches missed.">        if (ruc != null &amp;&amp; !ruc.trim().isEmpty()) {</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">            if (!PATTERN_RUC.matcher(ruc.trim()).matches()) {</span>
<span class="nc" id="L326">                throw new IllegalArgumentException(&quot;El RUC debe tener exactamente 11 dígitos numéricos&quot;);</span>
            }
        }
<span class="nc" id="L329">    }</span>

    /**
     * ✅ SERVICE LAYER: Validar email
     */
    public void validarEmail(String email) {
<span class="nc bnc" id="L335" title="All 4 branches missed.">        if (email != null &amp;&amp; !email.trim().isEmpty()) {</span>
<span class="nc bnc" id="L336" title="All 2 branches missed.">            if (!PATTERN_EMAIL.matcher(email.trim()).matches()) {</span>
<span class="nc" id="L337">                throw new IllegalArgumentException(&quot;El formato del email es inválido&quot;);</span>
            }
        }
<span class="nc" id="L340">    }</span>

    /**
     * ✅ SERVICE LAYER: Validar teléfono
     */
    public void validarTelefono(String telefono) {
<span class="nc bnc" id="L346" title="All 4 branches missed.">        if (telefono != null &amp;&amp; !telefono.trim().isEmpty()) {</span>
<span class="nc bnc" id="L347" title="All 2 branches missed.">            if (!PATTERN_TELEFONO.matcher(telefono.trim()).matches()) {</span>
<span class="nc" id="L348">                throw new IllegalArgumentException(&quot;El teléfono debe tener entre 7 y 15 dígitos numéricos&quot;);</span>
            }
        }
<span class="nc" id="L351">    }</span>

    /**
     * ✅ SERVICE LAYER: Verificar que el RUC sea único (solo si se proporciona)
     */
    private void verificarRucUnico(Proveedor proveedor) {
        // Solo verificar unicidad si se proporciona RUC
<span class="nc bnc" id="L358" title="All 4 branches missed.">        if (proveedor.getRuc() != null &amp;&amp; !proveedor.getRuc().trim().isEmpty()) {</span>
<span class="nc" id="L359">            Proveedor existente = proveedorRepository.findByRuc(proveedor.getRuc());</span>
<span class="nc bnc" id="L360" title="All 2 branches missed.">            if (existente != null) {</span>
<span class="nc" id="L361">                logger.warn(&quot;Intento de crear proveedor con RUC duplicado: {}&quot;, proveedor.getRuc());</span>
<span class="nc" id="L362">                throw new IllegalArgumentException(&quot;Ya existe un proveedor con el RUC: &quot; + proveedor.getRuc());</span>
            }
        }
<span class="nc" id="L365">    }</span>

    /**
     * ✅ SERVICE LAYER: Verificar RUC único para actualización (solo si se
     * proporciona)
     */
    private void verificarRucUnicoParaActualizacion(Proveedor proveedor) {
        // Solo verificar unicidad si se proporciona RUC
<span class="nc bnc" id="L373" title="All 4 branches missed.">        if (proveedor.getRuc() != null &amp;&amp; !proveedor.getRuc().trim().isEmpty()) {</span>
<span class="nc" id="L374">            Proveedor existente = proveedorRepository.findByRuc(proveedor.getRuc());</span>
<span class="nc bnc" id="L375" title="All 4 branches missed.">            if (existente != null &amp;&amp; !existente.getId().equals(proveedor.getId())) {</span>
<span class="nc" id="L376">                logger.warn(&quot;Intento de actualizar con RUC duplicado: {}&quot;, proveedor.getRuc());</span>
<span class="nc" id="L377">                throw new IllegalArgumentException(&quot;Ya existe otro proveedor con el RUC: &quot; + proveedor.getRuc());</span>
            }
        }
<span class="nc" id="L380">    }</span>

    /**
     * ✅ SERVICE LAYER: Preparar proveedor para guardar
     */
    private void prepararProveedorParaGuardar(Proveedor proveedor) {
        // Limpiar y normalizar datos
<span class="nc" id="L387">        proveedor.setRazonSocial(proveedor.getRazonSocial().trim());</span>

        // RUC es opcional - solo normalizar si se proporciona
<span class="nc bnc" id="L390" title="All 4 branches missed.">        if (proveedor.getRuc() != null &amp;&amp; !proveedor.getRuc().trim().isEmpty()) {</span>
<span class="nc" id="L391">            proveedor.setRuc(proveedor.getRuc().trim());</span>
        } else {
<span class="nc" id="L393">            proveedor.setRuc(null); // Asegurar que esté en null si está vacío</span>
        }

<span class="nc bnc" id="L396" title="All 2 branches missed.">        if (proveedor.getEmail() != null) {</span>
<span class="nc" id="L397">            proveedor.setEmail(proveedor.getEmail().trim().toLowerCase());</span>
        }

        // Establecer fecha de creación si es nuevo
<span class="nc bnc" id="L401" title="All 2 branches missed.">        if (proveedor.getCreatedAt() == null) {</span>
<span class="nc" id="L402">            proveedor.setCreatedAt(LocalDateTime.now());</span>
        }

        // Por defecto está activo (si no se especifica)
        // proveedor.setActivo(true); // Ya viene del formulario
<span class="nc" id="L407">    }</span>

    /**
     * ✅ ELIMINACIÓN DEFINITIVA: Hard delete del proveedor (IRREVERSIBLE)
     * ⚠️ USAR CON PRECAUCIÓN: Esta operación es IRREVERSIBLE
     */
    public boolean eliminarDefinitivamente(Integer id) {
        try {
<span class="nc bnc" id="L415" title="All 4 branches missed.">            if (id == null || id &lt;= 0) {</span>
<span class="nc" id="L416">                throw new IllegalArgumentException(&quot;ID de proveedor inválido&quot;);</span>
            }

<span class="nc" id="L419">            logger.warn(&quot;ELIMINACIÓN DEFINITIVA solicitada para proveedor ID: {}&quot;, id);</span>

            // Verificar que existe antes de eliminar
<span class="nc" id="L422">            Proveedor proveedor = obtenerPorId(id);</span>
<span class="nc" id="L423">            String nombreProveedor = proveedor.getRazonSocial();</span>
<span class="nc" id="L424">            String rucProveedor = proveedor.getRuc();</span>

            // ELIMINACIÓN DEFINITIVA (hard delete)
<span class="nc" id="L427">            boolean eliminado = proveedorRepository.deleteDefinitivamente(id);</span>

<span class="nc bnc" id="L429" title="All 2 branches missed.">            if (!eliminado) {</span>
<span class="nc" id="L430">                throw new RuntimeException(&quot;No se pudo eliminar definitivamente el proveedor&quot;);</span>
            }

<span class="nc" id="L433">            logger.warn(&quot;Proveedor ELIMINADO DEFINITIVAMENTE: {} (RUC: {})&quot;, nombreProveedor, rucProveedor);</span>

            // ✅ OBSERVER PATTERN: Notificar evento de eliminación definitiva
<span class="nc" id="L436">            eventManager.publishEvent(SystemEvent.EventType.PROVEEDOR_ELIMINADO,</span>
                    &quot;Proveedor ELIMINADO DEFINITIVAMENTE: &quot; + nombreProveedor,
                    this);

<span class="nc" id="L440">            return true;</span>

<span class="nc" id="L442">        } catch (Exception e) {</span>
<span class="nc" id="L443">            logger.error(&quot;Error al eliminar definitivamente proveedor ID {}: {}&quot;, id, e.getMessage(), e);</span>
<span class="nc" id="L444">            throw new RuntimeException(&quot;Error al eliminar definitivamente el proveedor: &quot; + e.getMessage(), e);</span>
        }
    }

    /**
     * ✅ SERVICE LAYER: Obtener todos los proveedores incluyendo inactivos
     */
    public List&lt;Proveedor&gt; obtenerTodosIncluyendoInactivos() {
        try {
<span class="nc" id="L453">            logger.debug(&quot;Obteniendo todos los proveedores incluyendo inactivos&quot;);</span>
<span class="nc" id="L454">            List&lt;Proveedor&gt; proveedores = proveedorRepository.findAllIncludingInactive();</span>
<span class="nc" id="L455">            logger.info(&quot;Proveedores obtenidos (incluye inactivos): {}&quot;, proveedores.size());</span>
<span class="nc" id="L456">            return proveedores;</span>
<span class="nc" id="L457">        } catch (Exception e) {</span>
<span class="nc" id="L458">            logger.error(&quot;Error al obtener proveedores incluyendo inactivos: {}&quot;, e.getMessage(), e);</span>
<span class="nc" id="L459">            throw new RuntimeException(&quot;Error al obtener la lista completa de proveedores&quot;, e);</span>
        }
    }

    /**
     * Verifica si existe un proveedor con la misma razón social (excluyendo el id
     * si se indica)
     */
    public boolean existePorRazonSocial(String razonSocial, Integer idExcluir) {
<span class="nc" id="L468">        return proveedorRepository.existePorRazonSocial(razonSocial, idExcluir);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>
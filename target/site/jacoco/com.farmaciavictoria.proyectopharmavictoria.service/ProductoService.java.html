<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ProductoService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">proyectopharmavictoria</a> &gt; <a href="index.source.html" class="el_package">com.farmaciavictoria.proyectopharmavictoria.service</a> &gt; <span class="el_source">ProductoService.java</span></div><h1>ProductoService.java</h1><pre class="source lang-java linenums">package com.farmaciavictoria.proyectopharmavictoria.service;

import com.farmaciavictoria.proyectopharmavictoria.model.Inventario.CategoriaProducto;
import com.farmaciavictoria.proyectopharmavictoria.model.Inventario.Producto;
import com.farmaciavictoria.proyectopharmavictoria.repository.Inventario.ProductoRepository;
import com.farmaciavictoria.proyectopharmavictoria.events.SystemEventManager;
import com.farmaciavictoria.proyectopharmavictoria.events.SystemEvent;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.math.BigDecimal;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.List;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.Date;
import com.farmaciavictoria.proyectopharmavictoria.config.DatabaseConfig;
import java.util.Optional;

/**
 * ✅ SERVICE LAYER PATTERN - Servicio de negocio para productos
 * Centraliza toda la lógica de negocio relacionada con productos
 * Incluye validaciones, cálculos y reglas de inventario
 */
public class ProductoService {
    /**
     * Actualiza un campo individual del producto en la base de datos
     */
    public void actualizarCampo(Integer id, String campo, Object valor) {
<span class="nc" id="L31">        String sql = &quot;UPDATE producto SET &quot; + campo + &quot; = ? WHERE id = ?&quot;;</span>
<span class="nc" id="L32">        try (Connection conn = DatabaseConfig.getInstance().getConnection();</span>
<span class="nc" id="L33">                PreparedStatement stmt = conn.prepareStatement(sql)) {</span>
<span class="nc bnc" id="L34" title="All 2 branches missed.">            if (valor instanceof BigDecimal) {</span>
<span class="nc" id="L35">                stmt.setBigDecimal(1, (BigDecimal) valor);</span>
<span class="nc bnc" id="L36" title="All 2 branches missed.">            } else if (valor instanceof Integer) {</span>
<span class="nc" id="L37">                stmt.setInt(1, (Integer) valor);</span>
<span class="nc bnc" id="L38" title="All 2 branches missed.">            } else if (valor instanceof LocalDate) {</span>
<span class="nc" id="L39">                stmt.setDate(1, Date.valueOf((LocalDate) valor));</span>
<span class="nc bnc" id="L40" title="All 2 branches missed.">            } else if (valor instanceof String) {</span>
<span class="nc" id="L41">                stmt.setString(1, (String) valor);</span>
            } else {
<span class="nc" id="L43">                stmt.setObject(1, valor);</span>
            }
<span class="nc" id="L45">            stmt.setInt(2, id);</span>
<span class="nc" id="L46">            stmt.executeUpdate();</span>
<span class="nc" id="L47">        } catch (Exception e) {</span>
            // Puedes loguear el error si lo deseas
<span class="nc" id="L49">        }</span>
<span class="nc" id="L50">    }</span>

    // Singleton para exportación
    private static ProductoService instance;

    /**
     * Valida que el código del producto corresponda al prefijo de la categoría
     * seleccionada
     */
    private void validarCodigoConCategoria(Producto producto) {
<span class="nc bnc" id="L60" title="All 6 branches missed.">        if (producto == null || producto.getCategoria() == null || producto.getCodigo() == null) {</span>
<span class="nc" id="L61">            throw new IllegalArgumentException(&quot;Producto, categoría o código no pueden ser nulos&quot;);</span>
        }
<span class="nc" id="L63">        String categoria = producto.getCategoria().name();</span>
<span class="nc" id="L64">        String codigo = producto.getCodigo();</span>
<span class="nc" id="L65">        String prefijoEsperado = codigoGeneratorService.getPrefijoPorCategoria(categoria);</span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">        if (!codigo.startsWith(prefijoEsperado)) {</span>
<span class="nc" id="L67">            throw new IllegalArgumentException(</span>
                    &quot;El código del producto (&quot; + codigo + &quot;) no corresponde a la categoría seleccionada (&quot; + categoria
                            + &quot;). Debe comenzar con: &quot; + prefijoEsperado);
        }
<span class="nc" id="L71">    }</span>

    public static ProductoService getInstance() {
<span class="nc bnc" id="L74" title="All 2 branches missed.">        if (instance == null) {</span>
            // Aquí deberías inyectar los repositorios reales
<span class="nc" id="L76">            instance = new ProductoService(</span>
                    new com.farmaciavictoria.proyectopharmavictoria.repository.Inventario.ProductoRepository(),
                    new com.farmaciavictoria.proyectopharmavictoria.service.CodigoGeneratorService());
        }
<span class="nc" id="L80">        return instance;</span>
    }

    public List&lt;String&gt; obtenerCategorias() {
        // Devuelve la lista de nombres de categorías
<span class="nc" id="L85">        return java.util.Arrays</span>
<span class="nc" id="L86">                .stream(com.farmaciavictoria.proyectopharmavictoria.model.Inventario.CategoriaProducto.values())</span>
<span class="nc" id="L87">                .map(com.farmaciavictoria.proyectopharmavictoria.model.Inventario.CategoriaProducto::getNombre)</span>
<span class="nc" id="L88">                .toList();</span>
    }

<span class="fc" id="L91">    private static final Logger logger = LoggerFactory.getLogger(ProductoService.class);</span>

    private final ProductoRepository productoRepository;
    private final CodigoGeneratorService codigoGeneratorService;
    private final SystemEventManager eventManager;

    // Constantes de negocio
    private static final int STOCK_MINIMO_DEFAULT = 5;
    private static final int STOCK_MAXIMO_DEFAULT = 100;
<span class="fc" id="L100">    private static int DIAS_VENCIMIENTO_ALERTA = cargarDiasVencimientoAlerta();</span>

    private static int cargarDiasVencimientoAlerta() {
        try {
<span class="fc" id="L104">            java.util.Properties prop = new java.util.Properties();</span>
<span class="fc" id="L105">            java.io.InputStream input = ProductoService.class.getClassLoader()</span>
<span class="fc" id="L106">                    .getResourceAsStream(&quot;alerta-config.properties&quot;);</span>
<span class="pc bpc" id="L107" title="1 of 2 branches missed.">            if (input != null) {</span>
<span class="fc" id="L108">                prop.load(input);</span>
<span class="fc" id="L109">                String valor = prop.getProperty(&quot;alerta.vencimiento.dias&quot;);</span>
<span class="pc bpc" id="L110" title="2 of 4 branches missed.">                if (valor != null &amp;&amp; !valor.isEmpty()) {</span>
<span class="fc" id="L111">                    return Integer.parseInt(valor);</span>
                }
            }
<span class="nc" id="L114">        } catch (Exception e) {</span>
            // Si falla, usar el valor por defecto
<span class="nc" id="L116">        }</span>
<span class="nc" id="L117">        return 30;</span>
    }

    // Permite cambiar el valor en tiempo real desde la UI
    public static void setDiasVencimientoAlerta(int dias) {
<span class="nc" id="L122">        DIAS_VENCIMIENTO_ALERTA = dias;</span>
        // Guardar en archivo de configuración
        try {
<span class="nc" id="L125">            java.util.Properties prop = new java.util.Properties();</span>
<span class="nc" id="L126">            prop.setProperty(&quot;alerta.vencimiento.dias&quot;, String.valueOf(dias));</span>
<span class="nc" id="L127">            java.io.OutputStream output = new java.io.FileOutputStream(&quot;src/main/resources/alerta-config.properties&quot;);</span>
<span class="nc" id="L128">            prop.store(output, null);</span>
<span class="nc" id="L129">            output.close();</span>
<span class="nc" id="L130">        } catch (Exception e) {</span>
            // Silenciar error de guardado
<span class="nc" id="L132">        }</span>
        // Limpiar todas las marcas de notificación de vencimiento
<span class="nc" id="L134">        com.farmaciavictoria.proyectopharmavictoria.util.AlertaCorreoPersistente.limpiar();</span>
<span class="nc" id="L135">    }</span>

    public static int getDiasVencimientoAlerta() {
<span class="nc" id="L138">        return DIAS_VENCIMIENTO_ALERTA;</span>
    }

<span class="fc" id="L141">    public ProductoService(ProductoRepository productoRepository, CodigoGeneratorService codigoGeneratorService) {</span>
<span class="fc" id="L142">        this.productoRepository = productoRepository;</span>
<span class="fc" id="L143">        this.codigoGeneratorService = codigoGeneratorService;</span>
<span class="fc" id="L144">        this.eventManager = SystemEventManager.getInstance();</span>
<span class="fc" id="L145">    }</span>

    /**
     * ✅ SERVICE LAYER: Obtener todos los productos
     */
    public List&lt;Producto&gt; obtenerTodos() {
        try {
<span class="nc" id="L152">            logger.debug(&quot;Obteniendo todos los productos&quot;);</span>
<span class="nc" id="L153">            List&lt;Producto&gt; productos = productoRepository.findAllIncludingInactive();</span>

            // Verificar alertas de stock y vencimiento
<span class="nc" id="L156">            verificarAlertas(productos);</span>

<span class="nc" id="L158">            logger.info(&quot;Productos obtenidos exitosamente: {}&quot;, productos.size());</span>
<span class="nc" id="L159">            return productos;</span>
<span class="nc" id="L160">        } catch (Exception e) {</span>
<span class="nc" id="L161">            logger.error(&quot;Error al obtener productos: {}&quot;, e.getMessage(), e);</span>
<span class="nc" id="L162">            throw new RuntimeException(&quot;Error al obtener la lista de productos&quot;, e);</span>
        }
    }

    /**
     * ✅ SERVICE LAYER: Obtener solo productos activos
     */
    public List&lt;Producto&gt; obtenerActivos() {
        try {
<span class="nc" id="L171">            logger.debug(&quot;Obteniendo productos activos&quot;);</span>
<span class="nc" id="L172">            List&lt;Producto&gt; productos = productoRepository.findAll(); // Usar findAll que existe</span>
<span class="nc" id="L173">            logger.info(&quot;Productos activos obtenidos: {}&quot;, productos.size());</span>
<span class="nc" id="L174">            return productos;</span>
<span class="nc" id="L175">        } catch (Exception e) {</span>
<span class="nc" id="L176">            logger.error(&quot;Error al obtener productos activos: {}&quot;, e.getMessage(), e);</span>
<span class="nc" id="L177">            throw new RuntimeException(&quot;Error al obtener productos activos&quot;, e);</span>
        }
    }

    /**
     * ✅ SERVICE LAYER: Buscar productos por texto
     */
    public List&lt;Producto&gt; buscarPorTexto(String texto) {
        try {
<span class="nc bnc" id="L186" title="All 4 branches missed.">            if (texto == null || texto.trim().isEmpty()) {</span>
<span class="nc" id="L187">                return obtenerActivos();</span>
            }

<span class="nc" id="L190">            logger.debug(&quot;Buscando productos por texto: {}&quot;, texto);</span>
<span class="nc" id="L191">            List&lt;Producto&gt; resultados = productoRepository.findByNombre(texto.trim()); // Usar método existente</span>
<span class="nc" id="L192">            logger.info(&quot;Búsqueda completada. Resultados: {}&quot;, resultados.size());</span>
<span class="nc" id="L193">            return resultados;</span>
<span class="nc" id="L194">        } catch (Exception e) {</span>
<span class="nc" id="L195">            logger.error(&quot;Error en búsqueda de productos: {}&quot;, e.getMessage(), e);</span>
<span class="nc" id="L196">            throw new RuntimeException(&quot;Error al buscar productos&quot;, e);</span>
        }
    }

    /**
     * ✅ SERVICE LAYER: Obtener producto por ID
     */
    public Producto obtenerPorId(Integer id) {
        try {
<span class="nc bnc" id="L205" title="All 4 branches missed.">            if (id == null || id &lt;= 0) {</span>
<span class="nc" id="L206">                throw new IllegalArgumentException(&quot;ID de producto inválido&quot;);</span>
            }

<span class="nc" id="L209">            logger.debug(&quot;Obteniendo producto por ID: {}&quot;, id);</span>
<span class="nc" id="L210">            Optional&lt;Producto&gt; productoOpt = productoRepository.findById(Long.valueOf(id));</span>

<span class="nc bnc" id="L212" title="All 2 branches missed.">            if (!productoOpt.isPresent()) {</span>
<span class="nc" id="L213">                logger.warn(&quot;Producto no encontrado con ID: {}&quot;, id);</span>
<span class="nc" id="L214">                throw new RuntimeException(&quot;Producto no encontrado&quot;);</span>
            }

<span class="nc" id="L217">            return productoOpt.get();</span>
<span class="nc" id="L218">        } catch (Exception e) {</span>
<span class="nc" id="L219">            logger.error(&quot;Error al obtener producto por ID {}: {}&quot;, id, e.getMessage(), e);</span>
<span class="nc" id="L220">            throw new RuntimeException(&quot;Error al obtener el producto&quot;, e);</span>
        }
    }

    /**
     * ✅ SERVICE LAYER: Obtener producto por código
     */
    public Producto obtenerPorCodigo(String codigo) {
        try {
<span class="nc bnc" id="L229" title="All 4 branches missed.">            if (codigo == null || codigo.trim().isEmpty()) {</span>
<span class="nc" id="L230">                throw new IllegalArgumentException(&quot;Código de producto requerido&quot;);</span>
            }

<span class="nc" id="L233">            logger.debug(&quot;Obteniendo producto por código: {}&quot;, codigo);</span>
<span class="nc" id="L234">            Optional&lt;Producto&gt; productoOpt = productoRepository.findByCodigo(codigo.trim());</span>

<span class="nc bnc" id="L236" title="All 2 branches missed.">            if (!productoOpt.isPresent()) {</span>
<span class="nc" id="L237">                logger.warn(&quot;Producto no encontrado con código: {}&quot;, codigo);</span>
<span class="nc" id="L238">                throw new RuntimeException(&quot;Producto no encontrado&quot;);</span>
            }

<span class="nc" id="L241">            return productoOpt.get();</span>
<span class="nc" id="L242">        } catch (Exception e) {</span>
<span class="nc" id="L243">            logger.error(&quot;Error al obtener producto por código {}: {}&quot;, codigo, e.getMessage(), e);</span>
<span class="nc" id="L244">            throw new RuntimeException(&quot;Error al obtener el producto&quot;, e);</span>
        }
    }

    /**
     * ✅ SERVICE LAYER: Guardar producto (crear o actualizar)
     */
    public Producto guardar(Producto producto) {
        try {
<span class="nc" id="L253">            logger.debug(&quot;Iniciando proceso de guardado de producto&quot;);</span>
            // Validaciones de negocio
<span class="nc" id="L255">            validarProducto(producto);</span>
<span class="nc" id="L256">            validarCodigoConCategoria(producto);</span>
            // Validar nombre único
<span class="nc bnc" id="L258" title="All 2 branches missed.">            if (productoRepository.existsByNombre(producto.getNombre())) {</span>
<span class="nc" id="L259">                throw new IllegalArgumentException(&quot;Ya existe un producto con el nombre: &quot; + producto.getNombre());</span>
            }
            // Generar código si es nuevo
<span class="nc bnc" id="L262" title="All 4 branches missed.">            if (producto.getCodigo() == null || producto.getCodigo().trim().isEmpty()) {</span>
<span class="nc" id="L263">                String codigo = codigoGeneratorService.generarSiguienteCodigo(producto.getCategoria().name());</span>
<span class="nc" id="L264">                producto.setCodigo(codigo);</span>
            }
            // Verificar código único
<span class="nc" id="L267">            verificarCodigoUnico(producto);</span>
            // Calcular margen de ganancia
<span class="nc" id="L269">            calcularMargenGanancia(producto);</span>
            // Preparar para guardar
<span class="nc" id="L271">            prepararProductoParaGuardar(producto);</span>
            // Guardar en base de datos
<span class="nc" id="L273">            boolean guardado = productoRepository.save(producto);</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">            if (!guardado) {</span>
<span class="nc" id="L275">                throw new RuntimeException(&quot;No se pudo guardar el producto en la base de datos&quot;);</span>
            }
<span class="nc" id="L277">            logger.info(&quot;Producto guardado exitosamente: {} (Código: {})&quot;,</span>
<span class="nc" id="L278">                    producto.getNombre(), producto.getCodigo());</span>
            // ✅ OBSERVER PATTERN: Notificar evento
<span class="nc" id="L280">            eventManager.publishEvent(SystemEvent.EventType.PRODUCTO_CREADO,</span>
<span class="nc" id="L281">                    &quot;Nuevo producto creado: &quot; + producto.getNombre(),</span>
                    this);
<span class="nc" id="L283">            return producto;</span>
<span class="nc" id="L284">        } catch (Exception e) {</span>
<span class="nc" id="L285">            logger.error(&quot;Error al guardar producto: {}&quot;, e.getMessage(), e);</span>
<span class="nc" id="L286">            throw new RuntimeException(&quot;Error al guardar el producto: &quot; + e.getMessage(), e);</span>
        }
    }

    /**
     * ✅ SERVICE LAYER: Actualizar producto existente
     */
    public Producto actualizar(Producto producto) {
        try {
<span class="nc bnc" id="L295" title="All 2 branches missed.">            if (producto.getId() == null) {</span>
<span class="nc" id="L296">                throw new IllegalArgumentException(&quot;ID de producto requerido para actualización&quot;);</span>
            }
<span class="nc" id="L298">            logger.debug(&quot;Actualizando producto ID: {}&quot;, producto.getId());</span>
            // Verificar que existe
<span class="nc" id="L300">            Producto existente = obtenerPorId(producto.getId());</span>
            // Validaciones
<span class="nc" id="L302">            validarProducto(producto);</span>
<span class="nc" id="L303">            validarCodigoConCategoria(producto);</span>
            // Validar nombre único (excluyendo el actual)
<span class="nc bnc" id="L305" title="All 2 branches missed.">            if (!producto.getNombre().equalsIgnoreCase(existente.getNombre())</span>
<span class="nc bnc" id="L306" title="All 2 branches missed.">                    &amp;&amp; productoRepository.existsByNombre(producto.getNombre())) {</span>
<span class="nc" id="L307">                throw new IllegalArgumentException(&quot;Ya existe un producto con el nombre: &quot; + producto.getNombre());</span>
            }
            // Verificar código único (excluyendo el actual)
<span class="nc" id="L310">            verificarCodigoUnicoParaActualizacion(producto);</span>
            // Calcular margen
<span class="nc" id="L312">            calcularMargenGanancia(producto);</span>
            // Mantener fecha de creación
<span class="nc" id="L314">            producto.setCreatedAt(existente.getCreatedAt());</span>
<span class="nc" id="L315">            producto.setUpdatedAt(LocalDateTime.now());</span>

            // Si la fecha de vencimiento cambió, eliminar la marca de notificado
<span class="nc bnc" id="L318" title="All 4 branches missed.">            if (producto.getFechaVencimiento() != null &amp;&amp; existente.getFechaVencimiento() != null</span>
<span class="nc bnc" id="L319" title="All 2 branches missed.">                    &amp;&amp; !producto.getFechaVencimiento().isEqual(existente.getFechaVencimiento())) {</span>
<span class="nc" id="L320">                com.farmaciavictoria.proyectopharmavictoria.util.AlertaCorreoPersistente</span>
<span class="nc" id="L321">                        .eliminarNotificadoVencimiento(producto.getNombre());</span>
            }

            // Actualizar en base de datos
<span class="nc" id="L325">            boolean actualizado = productoRepository.update(producto);</span>
<span class="nc bnc" id="L326" title="All 2 branches missed.">            if (!actualizado) {</span>
<span class="nc" id="L327">                throw new RuntimeException(&quot;No se pudo actualizar el producto&quot;);</span>
            }
<span class="nc" id="L329">            logger.info(&quot;Producto actualizado exitosamente: {}&quot;, producto.getNombre());</span>
            // ✅ OBSERVER PATTERN: Notificar evento
<span class="nc" id="L331">            eventManager.publishEvent(SystemEvent.EventType.PRODUCTO_ACTUALIZADO,</span>
<span class="nc" id="L332">                    &quot;Producto actualizado: &quot; + producto.getNombre(),</span>
                    this);
<span class="nc" id="L334">            return producto;</span>
<span class="nc" id="L335">        } catch (Exception e) {</span>
<span class="nc" id="L336">            logger.error(&quot;Error al actualizar producto: {}&quot;, e.getMessage(), e);</span>
<span class="nc" id="L337">            throw new RuntimeException(&quot;Error al actualizar el producto: &quot; + e.getMessage(), e);</span>
        }
    }

    /**
     * ✅ SERVICE LAYER: Eliminar producto
     */
    public boolean eliminar(Integer id) {
        try {
<span class="nc bnc" id="L346" title="All 4 branches missed.">            if (id == null || id &lt;= 0) {</span>
<span class="nc" id="L347">                throw new IllegalArgumentException(&quot;ID de producto inválido&quot;);</span>
            }

<span class="nc" id="L350">            logger.debug(&quot;Eliminando producto ID: {}&quot;, id);</span>

            // Verificar que existe
<span class="nc" id="L353">            Producto producto = obtenerPorId(id);</span>

            // - No se puede eliminar si tiene ventas registradas
            // - Evaluar si desactivar en lugar de eliminar

<span class="nc" id="L358">            boolean eliminado = productoRepository.delete(id);</span>

<span class="nc bnc" id="L360" title="All 2 branches missed.">            if (!eliminado) {</span>
<span class="nc" id="L361">                throw new RuntimeException(&quot;No se pudo eliminar el producto&quot;);</span>
            }

<span class="nc" id="L364">            logger.info(&quot;Producto eliminado exitosamente: {}&quot;, producto.getNombre());</span>

            // ✅ OBSERVER PATTERN: Notificar evento
<span class="nc" id="L367">            eventManager.publishEvent(SystemEvent.EventType.PRODUCTO_ELIMINADO,</span>
<span class="nc" id="L368">                    &quot;Producto eliminado: &quot; + producto.getNombre(),</span>
                    this);

<span class="nc" id="L371">            return true;</span>

<span class="nc" id="L373">        } catch (Exception e) {</span>
<span class="nc" id="L374">            logger.error(&quot;Error al eliminar producto ID {}: {}&quot;, id, e.getMessage(), e);</span>
<span class="nc" id="L375">            throw new RuntimeException(&quot;Error al eliminar el producto: &quot; + e.getMessage(), e);</span>
        }
    }

    /**
     * ✅ SERVICE LAYER: Validaciones de negocio centralizadas
     */
    public void validarProducto(Producto producto) {
<span class="nc bnc" id="L383" title="All 2 branches missed.">        if (producto == null) {</span>
<span class="nc" id="L384">            throw new IllegalArgumentException(&quot;Producto no puede ser nulo&quot;);</span>
        }

        // Validar nombre
<span class="nc" id="L388">        validarNombre(producto.getNombre());</span>

        // Validar precios
<span class="nc" id="L391">        validarPrecios(producto.getPrecioCompra(), producto.getPrecioVenta());</span>

        // Validar stock
<span class="nc" id="L394">        validarStock(producto.getStockActual(), producto.getStockMinimo(), producto.getStockMaximo());</span>
        // Validar que el stock actual no supere el stock máximo
<span class="nc bnc" id="L396" title="All 4 branches missed.">        if (producto.getStockMaximo() != null &amp;&amp; producto.getStockActual() != null</span>
<span class="nc bnc" id="L397" title="All 2 branches missed.">                &amp;&amp; producto.getStockActual() &gt; producto.getStockMaximo()) {</span>
<span class="nc" id="L398">            throw new IllegalArgumentException(&quot;El stock actual (&quot; + producto.getStockActual()</span>
<span class="nc" id="L399">                    + &quot;) no puede superar el stock máximo permitido (&quot; + producto.getStockMaximo() + &quot;).&quot;);</span>
        }

        // Validar fecha de vencimiento
<span class="nc" id="L403">        validarFechaVencimiento(producto.getFechaVencimiento());</span>

        // Validar categoría
<span class="nc" id="L406">        validarCategoria(producto.getCategoria());</span>

<span class="nc" id="L408">        logger.debug(&quot;Validaciones de producto completadas exitosamente&quot;);</span>
<span class="nc" id="L409">    }</span>

    /**
     * ✅ SERVICE LAYER: Validar nombre del producto
     */
    public void validarNombre(String nombre) {
<span class="nc bnc" id="L415" title="All 4 branches missed.">        if (nombre == null || nombre.trim().isEmpty()) {</span>
<span class="nc" id="L416">            throw new IllegalArgumentException(&quot;El nombre del producto es obligatorio&quot;);</span>
        }

<span class="nc bnc" id="L419" title="All 2 branches missed.">        if (nombre.trim().length() &lt; 3) {</span>
<span class="nc" id="L420">            throw new IllegalArgumentException(&quot;El nombre debe tener al menos 3 caracteres&quot;);</span>
        }

<span class="nc bnc" id="L423" title="All 2 branches missed.">        if (nombre.trim().length() &gt; 150) {</span>
<span class="nc" id="L424">            throw new IllegalArgumentException(&quot;El nombre no puede exceder 150 caracteres&quot;);</span>
        }
<span class="nc" id="L426">    }</span>

    /**
     * ✅ SERVICE LAYER: Validar precios
     */
    public void validarPrecios(BigDecimal precioCompra, BigDecimal precioVenta) {
<span class="nc bnc" id="L432" title="All 4 branches missed.">        if (precioCompra == null || precioCompra.compareTo(BigDecimal.ZERO) &lt;= 0) {</span>
<span class="nc" id="L433">            throw new IllegalArgumentException(&quot;El precio de compra debe ser mayor a cero&quot;);</span>
        }

<span class="nc bnc" id="L436" title="All 4 branches missed.">        if (precioVenta == null || precioVenta.compareTo(BigDecimal.ZERO) &lt;= 0) {</span>
<span class="nc" id="L437">            throw new IllegalArgumentException(&quot;El precio de venta debe ser mayor a cero&quot;);</span>
        }

<span class="nc bnc" id="L440" title="All 2 branches missed.">        if (precioVenta.compareTo(precioCompra) &lt;= 0) {</span>
<span class="nc" id="L441">            throw new IllegalArgumentException(&quot;El precio de venta debe ser mayor al precio de compra&quot;);</span>
        }
<span class="nc" id="L443">    }</span>

    /**
     * ✅ SERVICE LAYER: Validar stock
     */
    public void validarStock(Integer stockActual, Integer stockMinimo, Integer stockMaximo) {
<span class="nc bnc" id="L449" title="All 4 branches missed.">        if (stockActual == null || stockActual &lt; 0) {</span>
<span class="nc" id="L450">            throw new IllegalArgumentException(&quot;El stock actual no puede ser negativo&quot;);</span>
        }

<span class="nc bnc" id="L453" title="All 4 branches missed.">        if (stockMinimo == null || stockMinimo &lt; 0) {</span>
<span class="nc" id="L454">            throw new IllegalArgumentException(&quot;El stock mínimo no puede ser negativo&quot;);</span>
        }

<span class="nc bnc" id="L457" title="All 4 branches missed.">        if (stockMaximo == null || stockMaximo &lt; 0) {</span>
<span class="nc" id="L458">            throw new IllegalArgumentException(&quot;El stock máximo no puede ser negativo&quot;);</span>
        }

<span class="nc bnc" id="L461" title="All 2 branches missed.">        if (stockMaximo &lt; stockMinimo) {</span>
<span class="nc" id="L462">            throw new IllegalArgumentException(&quot;El stock máximo debe ser mayor o igual al stock mínimo&quot;);</span>
        }
<span class="nc" id="L464">    }</span>

    /**
     * ✅ SERVICE LAYER: Validar fecha de vencimiento
     */
    public void validarFechaVencimiento(LocalDate fechaVencimiento) {
<span class="nc bnc" id="L470" title="All 4 branches missed.">        if (fechaVencimiento != null &amp;&amp; fechaVencimiento.isBefore(LocalDate.now())) {</span>
<span class="nc" id="L471">            throw new IllegalArgumentException(&quot;La fecha de vencimiento no puede ser anterior a hoy&quot;);</span>
        }
<span class="nc" id="L473">    }</span>

    /**
     * ✅ SERVICE LAYER: Validar categoría
     */
    public void validarCategoria(CategoriaProducto categoria) {
<span class="nc bnc" id="L479" title="All 2 branches missed.">        if (categoria == null) {</span>
<span class="nc" id="L480">            throw new IllegalArgumentException(&quot;La categoría del producto es obligatoria&quot;);</span>
        }
<span class="nc" id="L482">    }</span>

    /**
     * ✅ SERVICE LAYER: Verificar código único
     */
    private void verificarCodigoUnico(Producto producto) {
<span class="nc" id="L488">        Optional&lt;Producto&gt; existenteOpt = productoRepository.findByCodigo(producto.getCodigo());</span>
<span class="nc bnc" id="L489" title="All 2 branches missed.">        if (existenteOpt.isPresent()) {</span>
<span class="nc" id="L490">            logger.warn(&quot;Intento de crear producto con código duplicado: {}&quot;, producto.getCodigo());</span>
<span class="nc" id="L491">            throw new IllegalArgumentException(&quot;Ya existe un producto con el código: &quot; + producto.getCodigo());</span>
        }
<span class="nc" id="L493">    }</span>

    /**
     * ✅ SERVICE LAYER: Verificar código único para actualización
     */
    private void verificarCodigoUnicoParaActualizacion(Producto producto) {
<span class="nc" id="L499">        Optional&lt;Producto&gt; existenteOpt = productoRepository.findByCodigo(producto.getCodigo());</span>
<span class="nc bnc" id="L500" title="All 4 branches missed.">        if (existenteOpt.isPresent() &amp;&amp; !existenteOpt.get().getId().equals(producto.getId())) {</span>
<span class="nc" id="L501">            logger.warn(&quot;Intento de actualizar con código duplicado: {}&quot;, producto.getCodigo());</span>
<span class="nc" id="L502">            throw new IllegalArgumentException(&quot;Ya existe otro producto con el código: &quot; + producto.getCodigo());</span>
        }
<span class="nc" id="L504">    }</span>

    /**
     * ✅ SERVICE LAYER: Calcular margen de ganancia
     */
    private void calcularMargenGanancia(Producto producto) {
<span class="nc bnc" id="L510" title="All 4 branches missed.">        if (producto.getPrecioCompra() != null &amp;&amp; producto.getPrecioVenta() != null) {</span>
<span class="nc" id="L511">            BigDecimal margen = producto.getPrecioVenta()</span>
<span class="nc" id="L512">                    .subtract(producto.getPrecioCompra())</span>
<span class="nc" id="L513">                    .divide(producto.getPrecioCompra(), 4, java.math.RoundingMode.HALF_UP)</span>
<span class="nc" id="L514">                    .multiply(new BigDecimal(100));</span>

<span class="nc" id="L516">            producto.setMargenGanancia(margen);</span>
        }
<span class="nc" id="L518">    }</span>

    /**
     * ✅ SERVICE LAYER: Preparar producto para guardar
     */
    private void prepararProductoParaGuardar(Producto producto) {
        // Limpiar y normalizar datos
<span class="nc" id="L525">        producto.setNombre(producto.getNombre().trim());</span>

<span class="nc bnc" id="L527" title="All 2 branches missed.">        if (producto.getDescripcion() != null) {</span>
<span class="nc" id="L528">            producto.setDescripcion(producto.getDescripcion().trim());</span>
        }

        // Establecer valores por defecto
<span class="nc bnc" id="L532" title="All 2 branches missed.">        if (producto.getStockMinimo() == null) {</span>
<span class="nc" id="L533">            producto.setStockMinimo(STOCK_MINIMO_DEFAULT);</span>
        }

<span class="nc bnc" id="L536" title="All 2 branches missed.">        if (producto.getStockMaximo() == null) {</span>
<span class="nc" id="L537">            producto.setStockMaximo(STOCK_MAXIMO_DEFAULT);</span>
        }

<span class="nc bnc" id="L540" title="All 2 branches missed.">        if (producto.getStockActual() == null) {</span>
<span class="nc" id="L541">            producto.setStockActual(0);</span>
        }

        // Establecer fechas
<span class="nc bnc" id="L545" title="All 2 branches missed.">        if (producto.getCreatedAt() == null) {</span>
<span class="nc" id="L546">            producto.setCreatedAt(LocalDateTime.now());</span>
        }
<span class="nc" id="L548">        producto.setUpdatedAt(LocalDateTime.now());</span>

        // Por defecto activo
<span class="nc bnc" id="L551" title="All 2 branches missed.">        if (producto.getActivo() == null) {</span>
<span class="nc" id="L552">            producto.setActivo(true);</span>
        }
<span class="nc" id="L554">    }</span>

    /**
     * ✅ OBSERVER PATTERN: Verificar alertas de stock y vencimiento
     */
    private void verificarAlertas(List&lt;Producto&gt; productos) {
<span class="nc" id="L560">        int diasVencimientoAlerta = DIAS_VENCIMIENTO_ALERTA;</span>
<span class="nc bnc" id="L561" title="All 2 branches missed.">        for (Producto producto : productos) {</span>
            // Alerta de stock bajo
<span class="nc bnc" id="L563" title="All 2 branches missed.">            if (producto.getStockActual() &lt;= producto.getStockMinimo()) {</span>
<span class="nc" id="L564">                eventManager.publishEvent(SystemEvent.EventType.STOCK_BAJO,</span>
<span class="nc" id="L565">                        &quot;Stock bajo en producto: &quot; + producto.getNombre(),</span>
                        this);
            }

            // Alerta de vencimiento próximo
<span class="nc bnc" id="L570" title="All 2 branches missed.">            if (producto.getFechaVencimiento() != null) {</span>
<span class="nc" id="L571">                LocalDate hoy = LocalDate.now();</span>
<span class="nc" id="L572">                LocalDate fechaLimite = hoy.plusDays(diasVencimientoAlerta);</span>
<span class="nc bnc" id="L573" title="All 2 branches missed.">                if (producto.getFechaVencimiento().isAfter(hoy) &amp;&amp;</span>
<span class="nc bnc" id="L574" title="All 2 branches missed.">                        (producto.getFechaVencimiento().isEqual(fechaLimite)</span>
<span class="nc bnc" id="L575" title="All 2 branches missed.">                                || producto.getFechaVencimiento().isBefore(fechaLimite))) {</span>
<span class="nc" id="L576">                    eventManager.publishEvent(SystemEvent.EventType.PRODUCTO_VENCIMIENTO_PROXIMO,</span>
<span class="nc" id="L577">                            &quot;Producto próximo a vencer: &quot; + producto.getNombre(),</span>
                            this);
                }
            }
<span class="nc" id="L581">        }</span>
<span class="nc" id="L582">    }</span>

    /**
     * ✅ SERVICE LAYER: Obtener productos con stock bajo
     */
    public List&lt;Producto&gt; obtenerProductosStockBajo() {
        try {
<span class="nc" id="L589">            logger.debug(&quot;Obteniendo productos con stock bajo&quot;);</span>
<span class="nc" id="L590">            List&lt;Producto&gt; productos = productoRepository.findStockBajo();</span>
<span class="nc" id="L591">            logger.info(&quot;Productos con stock bajo: {}&quot;, productos.size());</span>
<span class="nc" id="L592">            return productos;</span>
<span class="nc" id="L593">        } catch (Exception e) {</span>
<span class="nc" id="L594">            logger.error(&quot;Error al obtener productos con stock bajo: {}&quot;, e.getMessage(), e);</span>
<span class="nc" id="L595">            throw new RuntimeException(&quot;Error al obtener productos con stock bajo&quot;, e);</span>
        }
    }

    /**
     * ✅ SERVICE LAYER: Obtener productos próximos a vencer
     */
    public List&lt;Producto&gt; obtenerProductosProximosVencer() {
        try {
<span class="nc" id="L604">            logger.debug(&quot;Obteniendo productos próximos a vencer&quot;);</span>
<span class="nc" id="L605">            int dias = getDiasVencimientoAlerta();</span>
<span class="nc" id="L606">            List&lt;Producto&gt; productos = productoRepository.findProximosVencer(dias);</span>
<span class="nc" id="L607">            logger.info(&quot;Productos próximos a vencer: {}&quot;, productos.size());</span>
<span class="nc" id="L608">            return productos;</span>
<span class="nc" id="L609">        } catch (Exception e) {</span>
<span class="nc" id="L610">            logger.error(&quot;Error al obtener productos próximos a vencer: {}&quot;, e.getMessage(), e);</span>
<span class="nc" id="L611">            throw new RuntimeException(&quot;Error al obtener productos próximos a vencer&quot;, e);</span>
        }
    }

    /**
     * ✅ SERVICE LAYER: Eliminación DEFINITIVA de producto (hard delete)
     * ⚠️ USAR CON PRECAUCIÓN: Esta operación es IRREVERSIBLE
     */
    public boolean eliminarDefinitivamente(Integer id) {
        try {
<span class="nc bnc" id="L621" title="All 4 branches missed.">            if (id == null || id &lt;= 0) {</span>
<span class="nc" id="L622">                throw new IllegalArgumentException(&quot;ID de producto inválido&quot;);</span>
            }
<span class="nc" id="L624">            logger.warn(&quot;ELIMINACIÓN DEFINITIVA solicitada para producto ID: {}&quot;, id);</span>
            // Verificar que existe antes de eliminar
<span class="nc" id="L626">            Producto producto = obtenerPorId(id);</span>
<span class="nc" id="L627">            String nombreProducto = producto.getNombre();</span>
<span class="nc" id="L628">            String codigoProducto = producto.getCodigo();</span>

            // 1. Eliminar hijos en producto_historial_cambio
            try (java.sql.Connection connection = com.farmaciavictoria.proyectopharmavictoria.config.DatabaseConfig
<span class="nc" id="L632">                    .getInstance().getConnection();</span>
<span class="nc" id="L633">                    java.sql.PreparedStatement stmt = connection</span>
<span class="nc" id="L634">                            .prepareStatement(&quot;DELETE FROM producto_historial_cambio WHERE producto_id = ?&quot;)) {</span>
<span class="nc" id="L635">                stmt.setInt(1, id);</span>
<span class="nc" id="L636">                stmt.executeUpdate();</span>
<span class="nc" id="L637">            } catch (Exception ex) {</span>
<span class="nc" id="L638">                logger.error(&quot;Error al eliminar historial de cambios del producto {}: {}&quot;, id, ex.getMessage(), ex);</span>
<span class="nc" id="L639">                throw new RuntimeException(</span>
<span class="nc" id="L640">                        &quot;No se pudo eliminar el historial de cambios del producto: &quot; + ex.getMessage(), ex);</span>
<span class="nc" id="L641">            }</span>

            // 2. Eliminar el producto
<span class="nc" id="L644">            boolean eliminado = productoRepository.deleteDefinitivamente(id);</span>
<span class="nc bnc" id="L645" title="All 2 branches missed.">            if (!eliminado) {</span>
<span class="nc" id="L646">                throw new RuntimeException(&quot;No se pudo eliminar definitivamente el producto&quot;);</span>
            }

            // ✅ OBSERVER PATTERN: Notificar eliminación definitiva
<span class="nc" id="L650">            SystemEventManager.getInstance().publishEvent(new SystemEvent(</span>
                    SystemEvent.EventType.PRODUCTO_ELIMINADO,
<span class="nc" id="L652">                    String.format(&quot;Producto '%s' eliminado definitivamente&quot;, nombreProducto),</span>
<span class="nc" id="L653">                    LocalDateTime.now()));</span>
<span class="nc" id="L654">            logger.warn(&quot;Producto ELIMINADO DEFINITIVAMENTE: {} ({})&quot;, nombreProducto, codigoProducto);</span>
<span class="nc" id="L655">            return true;</span>
<span class="nc" id="L656">        } catch (Exception e) {</span>
<span class="nc" id="L657">            logger.error(&quot;Error al eliminar definitivamente producto ID {}: {}&quot;, id, e.getMessage(), e);</span>
<span class="nc" id="L658">            throw new RuntimeException(&quot;Error al eliminar definitivamente el producto: &quot; + e.getMessage(), e);</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>
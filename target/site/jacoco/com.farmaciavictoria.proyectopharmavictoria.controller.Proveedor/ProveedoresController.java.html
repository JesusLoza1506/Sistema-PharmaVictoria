<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ProveedoresController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">proyectopharmavictoria</a> &gt; <a href="index.source.html" class="el_package">com.farmaciavictoria.proyectopharmavictoria.controller.Proveedor</a> &gt; <span class="el_source">ProveedoresController.java</span></div><h1>ProveedoresController.java</h1><pre class="source lang-java linenums">package com.farmaciavictoria.proyectopharmavictoria.controller.Proveedor;

import com.farmaciavictoria.proyectopharmavictoria.repository.ProveedorRepository;
import com.farmaciavictoria.proyectopharmavictoria.service.ProveedorService;
import com.farmaciavictoria.proyectopharmavictoria.service.NotificationService;
import com.farmaciavictoria.proyectopharmavictoria.config.ServiceContainer;
import com.farmaciavictoria.proyectopharmavictoria.model.Proveedor.Proveedor;
import javafx.application.Platform;
import javafx.collections.FXCollections;
import javafx.collections.ObservableList;
import javafx.fxml.FXML;
import javafx.fxml.FXMLLoader;
import javafx.fxml.Initializable;
import javafx.scene.Parent;
import javafx.scene.Scene;
import javafx.scene.control.*;
import javafx.scene.control.cell.PropertyValueFactory;
import javafx.scene.layout.HBox;
import javafx.scene.layout.VBox;
import javafx.stage.Modality;
import javafx.stage.Stage;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import java.io.IOException;
import java.net.URL;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.List;
import java.util.ResourceBundle;
import java.util.Optional;

<span class="nc" id="L32">public class ProveedoresController implements Initializable {</span>
    @FXML
    private Button btnNuevoProveedor;
    @FXML
    private Label lblGraficoTopProveedores;
    @FXML
    private Label lblGraficoEstadoProveedores;
    @FXML
    private Button btnContactarProveedores;
    @FXML
    private Button btnExportar;

    // Permisos granulares del vendedor para Proveedores
<span class="nc" id="L45">    private boolean permisoNuevoProveedor = false;</span>
<span class="nc" id="L46">    private boolean permisoExportar = false;</span>
<span class="nc" id="L47">    private boolean permisoContactar = false;</span>
<span class="nc" id="L48">    private boolean permisoEditar = false;</span>
<span class="nc" id="L49">    private boolean permisoVer = false;</span>
<span class="nc" id="L50">    private boolean permisoToggleEstado = false;</span>
<span class="nc" id="L51">    private boolean permisoEliminar = false;</span>
<span class="nc" id="L52">    private boolean permisoDashboardTop = false;</span>
<span class="nc" id="L53">    private boolean permisoDashboardEstado = false;</span>

    @FXML
    private void onContactarProveedores() {
        try {
<span class="nc" id="L58">            FXMLLoader loader = new FXMLLoader(getClass().getResource(&quot;/fxml/Proveedor/contactar_proveedores.fxml&quot;));</span>
<span class="nc" id="L59">            Parent root = loader.load();</span>
<span class="nc" id="L60">            Stage stage = new Stage();</span>
<span class="nc" id="L61">            stage.setTitle(&quot;Contactar Proveedores&quot;);</span>
<span class="nc" id="L62">            stage.initModality(Modality.APPLICATION_MODAL);</span>
<span class="nc" id="L63">            stage.setScene(new Scene(root));</span>
<span class="nc" id="L64">            stage.showAndWait();</span>
<span class="nc" id="L65">        } catch (Exception e) {</span>
<span class="nc" id="L66">            mostrarAlerta(&quot;Error al abrir panel de contacto&quot;, e.getMessage(), Alert.AlertType.ERROR);</span>
<span class="nc" id="L67">        }</span>
<span class="nc" id="L68">    }</span>

    @FXML
    private Button btnAjustes;

    @FXML
    private void onEnviarCorreo() {
<span class="nc" id="L75">        String user = System.getProperty(&quot;mail.smtp.user&quot;, &quot;TU_CORREO@gmail.com&quot;);</span>
<span class="nc" id="L76">        String pass = System.getProperty(&quot;mail.smtp.password&quot;, &quot;TU_CONTRASEÑA&quot;);</span>
<span class="nc" id="L77">        com.farmaciavictoria.proyectopharmavictoria.service.EmailService emailService = new com.farmaciavictoria.proyectopharmavictoria.service.EmailService(</span>
                user, pass);
        try {
<span class="nc" id="L80">            emailService.sendEmail(&quot;destinatario@correo.com&quot;, &quot;Prueba desde PHARMAVICTORIA&quot;,</span>
                    &quot;¡Correo enviado correctamente desde el sistema!&quot;);
<span class="nc" id="L82">            mostrarAlerta(&quot;Correo enviado&quot;, &quot;El correo se envió correctamente.&quot;, Alert.AlertType.INFORMATION);</span>
<span class="nc" id="L83">        } catch (Exception e) {</span>
<span class="nc" id="L84">            mostrarAlerta(&quot;Error al enviar correo&quot;, e.getMessage(), Alert.AlertType.ERROR);</span>
<span class="nc" id="L85">        }</span>
<span class="nc" id="L86">    }</span>

    private void mostrarAlerta(String titulo, String mensaje, Alert.AlertType tipo) {
<span class="nc" id="L89">        Platform.runLater(() -&gt; {</span>
<span class="nc" id="L90">            Alert alert = new Alert(tipo);</span>
<span class="nc" id="L91">            alert.setTitle(titulo);</span>
<span class="nc" id="L92">            alert.setHeaderText(null);</span>
<span class="nc" id="L93">            alert.setContentText(mensaje);</span>
<span class="nc" id="L94">            alert.showAndWait();</span>
<span class="nc" id="L95">        });</span>
<span class="nc" id="L96">    }</span>

    // Dashboard: Gráficas
    @FXML
    private javafx.scene.chart.BarChart&lt;String, Number&gt; barChartTopProveedores;
    @FXML
    private javafx.scene.chart.PieChart pieChartEstadoProveedores;

    // Inicializa y carga las gráficas del dashboard inferior
    private void inicializarDashboardGraficas() {
<span class="nc" id="L106">        cargarGraficaTopProveedores();</span>
<span class="nc" id="L107">        cargarGraficaEstadoProveedores();</span>
<span class="nc" id="L108">    }</span>

    // Carga la gráfica de barras: Top proveedores con más productos asociados
    // Utiliza ProductoService y mapeo por proveedorId/proveedorNombre
    private void cargarGraficaTopProveedores() {
<span class="nc bnc" id="L113" title="All 2 branches missed.">        if (barChartTopProveedores == null)</span>
<span class="nc" id="L114">            return;</span>
<span class="nc" id="L115">        barChartTopProveedores.getData().clear();</span>
<span class="nc" id="L116">        barChartTopProveedores.setLegendVisible(false);</span>
<span class="nc" id="L117">        barChartTopProveedores.setAnimated(false);</span>
<span class="nc" id="L118">        barChartTopProveedores.getStylesheets()</span>
<span class="nc" id="L119">                .add(getClass().getResource(&quot;/css/Proveedor/barChart-custom.css&quot;).toExternalForm());</span>

        // Configurar el eje Y para mostrar solo enteros
<span class="nc bnc" id="L122" title="All 2 branches missed.">        if (barChartTopProveedores.getYAxis() instanceof javafx.scene.chart.NumberAxis yAxis) {</span>
<span class="nc" id="L123">            yAxis.setTickUnit(1);</span>
<span class="nc" id="L124">            yAxis.setMinorTickCount(0);</span>
<span class="nc" id="L125">            yAxis.setAutoRanging(true);</span>
<span class="nc" id="L126">            yAxis.setTickLabelFormatter(new javafx.util.StringConverter&lt;Number&gt;() {</span>
                @Override
                public String toString(Number object) {
<span class="nc" id="L129">                    return String.valueOf(object.intValue());</span>
                }

                @Override
                public Number fromString(String string) {
                    try {
<span class="nc" id="L135">                        return Integer.parseInt(string);</span>
<span class="nc" id="L136">                    } catch (Exception e) {</span>
<span class="nc" id="L137">                        return 0;</span>
                    }
                }
            });
        }

        List&lt;com.farmaciavictoria.proyectopharmavictoria.model.Inventario.Producto&gt; productos = ServiceContainer
<span class="nc" id="L144">                .getInstance().getProductoService().obtenerTodos();</span>
        List&lt;com.farmaciavictoria.proyectopharmavictoria.model.Proveedor.Proveedor&gt; proveedoresActivos = ServiceContainer
<span class="nc" id="L146">                .getInstance().getProveedorService().obtenerTodos();</span>
<span class="nc" id="L147">        java.util.Set&lt;Integer&gt; proveedoresValidos = new java.util.HashSet&lt;&gt;();</span>
<span class="nc" id="L148">        java.util.Map&lt;Integer, String&gt; proveedorNombreMap = new java.util.HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">        for (com.farmaciavictoria.proyectopharmavictoria.model.Proveedor.Proveedor proveedor : proveedoresActivos) {</span>
<span class="nc" id="L150">            proveedoresValidos.add(proveedor.getId());</span>
<span class="nc" id="L151">            proveedorNombreMap.put(proveedor.getId(), proveedor.getRazonSocial());</span>
<span class="nc" id="L152">        }</span>
<span class="nc" id="L153">        java.util.Map&lt;Integer, Integer&gt; proveedorProductoCount = new java.util.HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">        for (com.farmaciavictoria.proyectopharmavictoria.model.Inventario.Producto prod : productos) {</span>
<span class="nc" id="L155">            Integer proveedorId = prod.getProveedorId();</span>
<span class="nc bnc" id="L156" title="All 4 branches missed.">            if (proveedorId != null &amp;&amp; proveedoresValidos.contains(proveedorId)) {</span>
<span class="nc" id="L157">                proveedorProductoCount.put(proveedorId, proveedorProductoCount.getOrDefault(proveedorId, 0) + 1);</span>
            }
<span class="nc" id="L159">        }</span>
        // Obtener top 3 proveedores
<span class="nc" id="L161">        java.util.List&lt;java.util.Map.Entry&lt;Integer, Integer&gt;&gt; top = proveedorProductoCount.entrySet().stream()</span>
<span class="nc" id="L162">                .sorted((a, b) -&gt; Integer.compare(b.getValue(), a.getValue()))</span>
<span class="nc" id="L163">                .limit(3)</span>
<span class="nc" id="L164">                .toList();</span>
<span class="nc" id="L165">        javafx.scene.chart.XYChart.Series&lt;String, Number&gt; series = new javafx.scene.chart.XYChart.Series&lt;&gt;();</span>
<span class="nc" id="L166">        series.setName(&quot;Productos asociados&quot;);</span>
        // Añadir los proveedores reales
<span class="nc bnc" id="L168" title="All 2 branches missed.">        for (java.util.Map.Entry&lt;Integer, Integer&gt; entry : top) {</span>
<span class="nc" id="L169">            String nombre = proveedorNombreMap.get(entry.getKey());</span>
<span class="nc" id="L170">            javafx.scene.chart.XYChart.Data&lt;String, Number&gt; data = new javafx.scene.chart.XYChart.Data&lt;&gt;(</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">                    nombre != null ? nombre : &quot;Proveedor &quot; + entry.getKey(), entry.getValue());</span>
<span class="nc" id="L172">            series.getData().add(data);</span>
<span class="nc" id="L173">        }</span>
        // Si hay menos de 3, rellenar con barras vacías
<span class="nc" id="L175">        int faltantes = 3 - top.size();</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">        for (int i = 0; i &lt; faltantes; i++) {</span>
<span class="nc" id="L177">            javafx.scene.chart.XYChart.Data&lt;String, Number&gt; data = new javafx.scene.chart.XYChart.Data&lt;&gt;(&quot;Sin datos&quot;,</span>
<span class="nc" id="L178">                    0);</span>
<span class="nc" id="L179">            series.getData().add(data);</span>
        }
<span class="nc" id="L181">        barChartTopProveedores.getData().add(series);</span>
        // Etiquetas de valor sobre cada barra
<span class="nc" id="L183">        Platform.runLater(() -&gt; {</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">            for (javafx.scene.chart.XYChart.Data&lt;String, Number&gt; data : series.getData()) {</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">                if (data.getNode() != null) {</span>
<span class="nc" id="L186">                    final Label label = new Label(</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">                            data.getYValue().intValue() &gt; 0 ? String.valueOf(data.getYValue()) : &quot;&quot;);</span>
<span class="nc" id="L188">                    label.getStyleClass().add(&quot;bar-value-label&quot;);</span>
<span class="nc" id="L189">                    label.setStyle(</span>
                            &quot;-fx-font-size: 16px; -fx-font-weight: bold; -fx-text-fill: #222; -fx-background-color: transparent;&quot;);
<span class="nc" id="L191">                    data.getNode().parentProperty().addListener((obs, oldParent, newParent) -&gt; {</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">                        if (newParent != null) {</span>
<span class="nc" id="L193">                            ((javafx.scene.layout.StackPane) data.getNode()).getChildren().add(label);</span>
                        }
<span class="nc" id="L195">                    });</span>
                }
<span class="nc" id="L197">            }</span>
<span class="nc" id="L198">        });</span>
<span class="nc" id="L199">    }</span>

    // Carga la gráfica de pastel: Distribución de proveedores por estado
    private void cargarGraficaEstadoProveedores() {
<span class="nc bnc" id="L203" title="All 2 branches missed.">        if (pieChartEstadoProveedores == null)</span>
<span class="nc" id="L204">            return;</span>
<span class="nc" id="L205">        pieChartEstadoProveedores.getData().clear();</span>
<span class="nc" id="L206">        long activos = proveedoresOriginales.stream().filter(Proveedor::getActivo).count();</span>
<span class="nc" id="L207">        long inactivos = proveedoresOriginales.size() - activos;</span>
<span class="nc" id="L208">        javafx.scene.chart.PieChart.Data activosData = new javafx.scene.chart.PieChart.Data(&quot;Activos&quot;, activos);</span>
<span class="nc" id="L209">        javafx.scene.chart.PieChart.Data inactivosData = new javafx.scene.chart.PieChart.Data(&quot;Inactivos&quot;, inactivos);</span>
<span class="nc" id="L210">        pieChartEstadoProveedores.getData().addAll(activosData, inactivosData);</span>
<span class="nc" id="L211">    }</span>

    @FXML
    public void onExportarProveedores(javafx.event.ActionEvent event) {
<span class="nc" id="L215">        exportar();</span>
<span class="nc" id="L216">    }</span>

    @FXML
    private void exportar() {
<span class="nc" id="L220">        abrirVistaPreviaExportacion();</span>
<span class="nc" id="L221">    }</span>

    private void abrirVistaPreviaExportacion() {
        try {
<span class="nc" id="L225">            javafx.fxml.FXMLLoader loader = new javafx.fxml.FXMLLoader(</span>
<span class="nc" id="L226">                    getClass().getResource(&quot;/fxml/Proveedor/exportar-proveedores-preview.fxml&quot;));</span>
<span class="nc" id="L227">            javafx.scene.Parent root = loader.load();</span>
<span class="nc" id="L228">            ExportarProveedoresController controller = loader.getController();</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">            List&lt;Proveedor&gt; proveedores = proveedoresOriginales != null ? proveedoresOriginales : proveedoresList;</span>
<span class="nc" id="L230">            controller.setProveedoresFiltrados(proveedores);</span>
<span class="nc" id="L231">            javafx.stage.Stage stage = new javafx.stage.Stage();</span>
<span class="nc" id="L232">            stage.setTitle(&quot;Vista previa de exportación de proveedores&quot;);</span>
<span class="nc" id="L233">            stage.setScene(new javafx.scene.Scene(root));</span>
<span class="nc" id="L234">            stage.initModality(javafx.stage.Modality.APPLICATION_MODAL);</span>
<span class="nc" id="L235">            stage.showAndWait();</span>
<span class="nc" id="L236">        } catch (Exception e) {</span>
<span class="nc" id="L237">            e.printStackTrace();</span>
<span class="nc" id="L238">            mostrarError(&quot;Error&quot;, &quot;No se pudo abrir la vista previa de exportación&quot;, e.getMessage());</span>
<span class="nc" id="L239">        }</span>
<span class="nc" id="L240">    }</span>

<span class="nc" id="L242">    private static final Logger logger = LoggerFactory.getLogger(ProveedoresController.class);</span>

    // Evento para avanzar una página en la tabla de proveedores
    @FXML
    public void onPaginaSiguiente(javafx.event.ActionEvent event) {
<span class="nc bnc" id="L247" title="All 2 branches missed.">        if (paginaActual &lt; totalPaginas) {</span>
<span class="nc" id="L248">            paginaActual++;</span>
<span class="nc" id="L249">            actualizarPaginacion();</span>
        }
<span class="nc" id="L251">    }</span>

    // Variables de paginación
<span class="nc" id="L254">    private int paginaActual = 1;</span>
<span class="nc" id="L255">    private int totalPaginas = 1;</span>
<span class="nc" id="L256">    private int tamanoPagina = -1; // -1 = Todos por defecto</span>

    // Actualiza la paginación de la tabla de proveedores
    private void actualizarPaginacion() {
        // Ahora solo llama a filtrarProveedores para que la paginación siempre respete
        // el filtro
<span class="nc" id="L262">        filtrarProveedores();</span>
<span class="nc" id="L263">    }</span>

    // Evento para retroceder una página en la tabla de proveedores
    @FXML
    public void onPaginaAnterior(javafx.event.ActionEvent event) {
<span class="nc bnc" id="L268" title="All 2 branches missed.">        if (paginaActual &gt; 1) {</span>
<span class="nc" id="L269">            paginaActual--;</span>
<span class="nc" id="L270">            actualizarPaginacion();</span>
        }
<span class="nc" id="L272">    }</span>

    // Maneja el evento de activar/desactivar el filtro de solo activos
    @FXML
    public void onToggleSoloActivos(javafx.event.ActionEvent event) {
<span class="nc" id="L277">        boolean soloActivos = chkSoloActivos.isSelected();</span>
        // Filtrar la lista según el estado del checkbox
<span class="nc" id="L279">        List&lt;Proveedor&gt; filtrados = proveedoresOriginales.stream()</span>
<span class="nc bnc" id="L280" title="All 4 branches missed.">                .filter(p -&gt; !soloActivos || p.getActivo())</span>
<span class="nc" id="L281">                .collect(java.util.stream.Collectors.toList());</span>
<span class="nc" id="L282">        proveedoresList.setAll(filtrados);</span>
<span class="nc" id="L283">        actualizarEstadisticas();</span>
<span class="nc" id="L284">    }</span>

    // Servicios
    private ProveedorService proveedorService;
    private NotificationService notificationService;

    // Estrategia de búsqueda avanzada ELIMINADA: ahora solo se usan los nuevos
    // filtros con ProveedorFilterStrategy

    // Listas de proveedores
    private ObservableList&lt;Proveedor&gt; proveedoresList;
    private ObservableList&lt;Proveedor&gt; proveedoresOriginales;

    @FXML
    private ComboBox&lt;String&gt; cmbTipoFiltro;

    // Filtro avanzado usando Strategy Pattern
    private void aplicarFiltroAvanzado() {
<span class="nc" id="L302">        String criterio = txtBuscar.getText();</span>
<span class="nc bnc" id="L303" title="All 2 branches missed.">        String tipo = cmbTipoFiltro != null ? cmbTipoFiltro.getValue() : &quot;Razón Social&quot;;</span>
<span class="nc bnc" id="L304" title="All 2 branches missed.">        List&lt;Proveedor&gt; base = proveedoresOriginales != null ? proveedoresOriginales : proveedoresList;</span>
<span class="nc" id="L305">        com.farmaciavictoria.proyectopharmavictoria.strategy.Proveedor.ProveedorFilterStrategy strategy = null;</span>
        // Selección estricta del campo a filtrar
<span class="nc bnc" id="L307" title="All 5 branches missed.">        switch (tipo) {</span>
            case &quot;Razón Social&quot;:
<span class="nc" id="L309">                strategy = new com.farmaciavictoria.proyectopharmavictoria.strategy.Proveedor.FiltroPorRazonSocial();</span>
<span class="nc" id="L310">                break;</span>
            case &quot;RUC&quot;:
<span class="nc" id="L312">                strategy = new com.farmaciavictoria.proyectopharmavictoria.strategy.Proveedor.FiltroPorRuc();</span>
<span class="nc" id="L313">                break;</span>
            case &quot;Contacto&quot;:
<span class="nc" id="L315">                strategy = new com.farmaciavictoria.proyectopharmavictoria.strategy.Proveedor.FiltroPorContacto();</span>
<span class="nc" id="L316">                break;</span>
            case &quot;Tipo de Producto&quot;:
<span class="nc" id="L318">                strategy = new com.farmaciavictoria.proyectopharmavictoria.strategy.Proveedor.FiltroPorTipoProducto();</span>
<span class="nc" id="L319">                break;</span>
            default:
<span class="nc" id="L321">                strategy = null;</span>
        }
        List&lt;Proveedor&gt; filtrados;
<span class="nc bnc" id="L324" title="All 6 branches missed.">        if (strategy != null &amp;&amp; criterio != null &amp;&amp; !criterio.isBlank()) {</span>
<span class="nc" id="L325">            filtrados = strategy.filtrar(base, criterio);</span>
        } else {
<span class="nc" id="L327">            filtrados = base;</span>
        }
        // Mostrar solo los filtrados, ignorando paginación
<span class="nc" id="L330">        proveedoresList.clear();</span>
<span class="nc" id="L331">        proveedoresList.addAll(filtrados);</span>
<span class="nc" id="L332">        actualizarEstadisticas();</span>
<span class="nc" id="L333">    }</span>

    @FXML
    private Label lblContadorProveedores;
    @FXML
    private Label lblContadorTotal;
    @FXML
    private Button btnPaginaAnterior;
    @FXML
    private Label lblPaginaActual;
    @FXML
    private Button btnPaginaSiguiente;
    @FXML
    private ComboBox&lt;Integer&gt; cmbTamanoPagina;
    @FXML
    private Label lblTotalActivos;
    @FXML
    private Label lblTotalInactivos;
    @FXML
    private Label lblTotalVIP;
    @FXML
    private Label lblTotalObservacion;
    @FXML
    private TextField txtBuscar;
    @FXML
    private Button btnBuscar;
    @FXML
    private Button btnLimpiar;
    @FXML
    private Button btnHistorial;
    @FXML
    private ComboBox&lt;String&gt; cmbOrdenar;
    @FXML
    private CheckBox chkSoloActivos;
    @FXML
    private TableView&lt;Proveedor&gt; tableProveedores;
    @FXML
    private TableColumn&lt;Proveedor, Integer&gt; colId;
    @FXML
    private TableColumn&lt;Proveedor, String&gt; colRazonSocial;
    @FXML
    private TableColumn&lt;Proveedor, String&gt; colRuc;
    @FXML
    private TableColumn&lt;Proveedor, String&gt; colContacto;
    @FXML
    private TableColumn&lt;Proveedor, String&gt; colTelefono;
    @FXML
    private TableColumn&lt;Proveedor, String&gt; colEmail;
    @FXML
    private TableColumn&lt;Proveedor, String&gt; colTipoProducto;
    @FXML
    private TableColumn&lt;Proveedor, String&gt; colEstado;
    @FXML
    private TableColumn&lt;Proveedor, Void&gt; colAcciones;
    @FXML
    private Label lblEstadistica;
    @FXML
    private Label lblUltimaActualizacion;

    @Override
    public void initialize(URL location, ResourceBundle resources) {
        // Control de visibilidad por rol
        com.farmaciavictoria.proyectopharmavictoria.model.Usuario.Usuario usuario = com.farmaciavictoria.proyectopharmavictoria.config.ServiceContainer
<span class="nc" id="L396">                .getInstance().getAuthenticationService().getUsuarioActual();</span>
<span class="nc bnc" id="L397" title="All 4 branches missed.">        boolean esAdmin = usuario != null &amp;&amp; usuario.isAdmin();</span>
<span class="nc bnc" id="L398" title="All 4 branches missed.">        boolean esVendedor = usuario != null &amp;&amp; usuario.isVendedor();</span>

        // Cargar permisos granulares del vendedor para Proveedores
<span class="nc bnc" id="L401" title="All 2 branches missed.">        if (esVendedor) {</span>
<span class="nc" id="L402">            var usuarioService = com.farmaciavictoria.proyectopharmavictoria.config.ServiceContainer.getInstance()</span>
<span class="nc" id="L403">                    .getUsuarioService();</span>
<span class="nc" id="L404">            permisoNuevoProveedor = usuarioService.tienePermiso(usuario.getId(), &quot;proveedores&quot;, &quot;nuevo&quot;);</span>
<span class="nc" id="L405">            permisoExportar = usuarioService.tienePermiso(usuario.getId(), &quot;proveedores&quot;, &quot;exportar&quot;);</span>
<span class="nc" id="L406">            permisoContactar = usuarioService.tienePermiso(usuario.getId(), &quot;proveedores&quot;, &quot;contactar&quot;);</span>
<span class="nc" id="L407">            permisoEditar = usuarioService.tienePermiso(usuario.getId(), &quot;proveedores&quot;, &quot;editar&quot;);</span>
            // El permiso &quot;ver&quot; SIEMPRE debe estar habilitado para vendedores
<span class="nc" id="L409">            permisoVer = true;</span>
<span class="nc" id="L410">            permisoToggleEstado = usuarioService.tienePermiso(usuario.getId(), &quot;proveedores&quot;, &quot;activar_inactivar&quot;);</span>
<span class="nc" id="L411">            permisoEliminar = usuarioService.tienePermiso(usuario.getId(), &quot;proveedores&quot;, &quot;eliminar&quot;);</span>
<span class="nc" id="L412">            permisoDashboardTop = usuarioService.tienePermiso(usuario.getId(), &quot;proveedores&quot;, &quot;dashboard_top&quot;);</span>
<span class="nc" id="L413">            permisoDashboardEstado = usuarioService.tienePermiso(usuario.getId(), &quot;proveedores&quot;, &quot;dashboard_estado&quot;);</span>
        }

        // Control de visibilidad por permisos
<span class="nc bnc" id="L417" title="All 2 branches missed.">        if (btnNuevoProveedor != null) {</span>
<span class="nc bnc" id="L418" title="All 4 branches missed.">            btnNuevoProveedor.setVisible(esAdmin || permisoNuevoProveedor);</span>
<span class="nc bnc" id="L419" title="All 4 branches missed.">            btnNuevoProveedor.setManaged(esAdmin || permisoNuevoProveedor);</span>
        }
<span class="nc bnc" id="L421" title="All 2 branches missed.">        if (btnExportar != null) {</span>
            // Solo mostrar si el permiso está habilitado para el vendedor
<span class="nc bnc" id="L423" title="All 6 branches missed.">            boolean mostrarExportar = esAdmin || (esVendedor &amp;&amp; permisoExportar);</span>
<span class="nc" id="L424">            btnExportar.setVisible(mostrarExportar);</span>
<span class="nc" id="L425">            btnExportar.setManaged(mostrarExportar);</span>
        }
<span class="nc bnc" id="L427" title="All 2 branches missed.">        if (btnContactarProveedores != null) {</span>
<span class="nc bnc" id="L428" title="All 4 branches missed.">            btnContactarProveedores.setVisible(esAdmin || permisoContactar);</span>
<span class="nc bnc" id="L429" title="All 4 branches missed.">            btnContactarProveedores.setManaged(esAdmin || permisoContactar);</span>
        }
<span class="nc bnc" id="L431" title="All 2 branches missed.">        if (barChartTopProveedores != null) {</span>
<span class="nc bnc" id="L432" title="All 4 branches missed.">            barChartTopProveedores.setVisible(esAdmin || permisoDashboardTop);</span>
<span class="nc bnc" id="L433" title="All 4 branches missed.">            barChartTopProveedores.setManaged(esAdmin || permisoDashboardTop);</span>
        }
<span class="nc bnc" id="L435" title="All 2 branches missed.">        if (lblGraficoTopProveedores != null) {</span>
<span class="nc bnc" id="L436" title="All 4 branches missed.">            lblGraficoTopProveedores.setVisible(esAdmin || permisoDashboardTop);</span>
<span class="nc bnc" id="L437" title="All 4 branches missed.">            lblGraficoTopProveedores.setManaged(esAdmin || permisoDashboardTop);</span>
        }
<span class="nc bnc" id="L439" title="All 2 branches missed.">        if (pieChartEstadoProveedores != null) {</span>
<span class="nc bnc" id="L440" title="All 4 branches missed.">            pieChartEstadoProveedores.setVisible(esAdmin || permisoDashboardEstado);</span>
<span class="nc bnc" id="L441" title="All 4 branches missed.">            pieChartEstadoProveedores.setManaged(esAdmin || permisoDashboardEstado);</span>
        }
<span class="nc bnc" id="L443" title="All 2 branches missed.">        if (lblGraficoEstadoProveedores != null) {</span>
<span class="nc bnc" id="L444" title="All 4 branches missed.">            lblGraficoEstadoProveedores.setVisible(esAdmin || permisoDashboardEstado);</span>
<span class="nc bnc" id="L445" title="All 4 branches missed.">            lblGraficoEstadoProveedores.setManaged(esAdmin || permisoDashboardEstado);</span>
        }
        // Configurar ComboBox de tipo de búsqueda avanzada
<span class="nc bnc" id="L448" title="All 2 branches missed.">        if (cmbTipoFiltro != null) {</span>
<span class="nc" id="L449">            cmbTipoFiltro.setItems(FXCollections.observableArrayList(</span>
                    &quot;Razón Social&quot;, &quot;RUC&quot;, &quot;Contacto&quot;, &quot;Tipo de Producto&quot;));
<span class="nc" id="L451">            cmbTipoFiltro.getSelectionModel().selectFirst();</span>
<span class="nc" id="L452">            cmbTipoFiltro.valueProperty().addListener((obs, oldVal, newVal) -&gt; {</span>
<span class="nc bnc" id="L453" title="All 2 branches missed.">                if (txtBuscar != null)</span>
<span class="nc" id="L454">                    txtBuscar.clear();</span>
<span class="nc" id="L455">                aplicarFiltroAvanzado();</span>
<span class="nc" id="L456">            });</span>
        }
<span class="nc" id="L458">        txtBuscar.textProperty().addListener((obs, oldVal, newVal) -&gt; aplicarFiltroAvanzado());</span>
<span class="nc" id="L459">        System.out.println(&quot;Inicializando ProveedoresController...&quot;);</span>

        // Obtener services desde ServiceContainer
<span class="nc" id="L462">        ServiceContainer container = ServiceContainer.getInstance();</span>
<span class="nc" id="L463">        this.proveedorService = container.getProveedorService();</span>
<span class="nc" id="L464">        this.notificationService = container.getNotificationService();</span>

        // Inicializar listas
<span class="nc" id="L467">        proveedoresList = FXCollections.observableArrayList();</span>
<span class="nc" id="L468">        proveedoresOriginales = FXCollections.observableArrayList();</span>
        // Configurar ComboBox de tamaño de página (paginación)
<span class="nc bnc" id="L470" title="All 2 branches missed.">        if (cmbTamanoPagina != null) {</span>
<span class="nc" id="L471">            cmbTamanoPagina.getItems().clear();</span>
<span class="nc" id="L472">            cmbTamanoPagina.getItems().addAll(-1, 5, 10, 20, 50); // -1 = Todos</span>
<span class="nc" id="L473">            cmbTamanoPagina.setValue(-1);</span>
<span class="nc" id="L474">            cmbTamanoPagina.setConverter(new javafx.util.StringConverter&lt;Integer&gt;() {</span>
                @Override
                public String toString(Integer value) {
<span class="nc bnc" id="L477" title="All 4 branches missed.">                    if (value == null || value == -1)</span>
<span class="nc" id="L478">                        return &quot;Todos&quot;;</span>
<span class="nc" id="L479">                    return value.toString();</span>
                }

                @Override
                public Integer fromString(String string) {
<span class="nc bnc" id="L484" title="All 2 branches missed.">                    if (&quot;Todos&quot;.equals(string))</span>
<span class="nc" id="L485">                        return -1;</span>
                    try {
<span class="nc" id="L487">                        return Integer.parseInt(string);</span>
<span class="nc" id="L488">                    } catch (Exception e) {</span>
<span class="nc" id="L489">                        return -1;</span>
                    }
                }
            });
<span class="nc" id="L493">            cmbTamanoPagina.setCellFactory(listView -&gt; new javafx.scene.control.ListCell&lt;Integer&gt;() {</span>
                @Override
                protected void updateItem(Integer item, boolean empty) {
<span class="nc" id="L496">                    super.updateItem(item, empty);</span>
<span class="nc bnc" id="L497" title="All 4 branches missed.">                    if (empty || item == null) {</span>
<span class="nc" id="L498">                        setText(null);</span>
                    } else {
<span class="nc bnc" id="L500" title="All 2 branches missed.">                        setText(item == -1 ? &quot;Todos&quot; : item.toString());</span>
                    }
<span class="nc" id="L502">                }</span>
            });
<span class="nc" id="L504">            cmbTamanoPagina.setButtonCell(new javafx.scene.control.ListCell&lt;Integer&gt;() {</span>
                @Override
                protected void updateItem(Integer item, boolean empty) {
<span class="nc" id="L507">                    super.updateItem(item, empty);</span>
<span class="nc bnc" id="L508" title="All 4 branches missed.">                    if (empty || item == null) {</span>
<span class="nc" id="L509">                        setText(null);</span>
                    } else {
<span class="nc bnc" id="L511" title="All 2 branches missed.">                        setText(item == -1 ? &quot;Todos&quot; : item.toString());</span>
                    }
<span class="nc" id="L513">                }</span>
            });
<span class="nc" id="L515">            cmbTamanoPagina.valueProperty().addListener((obs, oldVal, newVal) -&gt; {</span>
<span class="nc" id="L516">                tamanoPagina = newVal;</span>
<span class="nc" id="L517">                paginaActual = 1;</span>
<span class="nc" id="L518">                actualizarPaginacion();</span>
<span class="nc" id="L519">                actualizarEstadisticas();</span>
<span class="nc" id="L520">            });</span>
            // Mostrar todos por defecto al iniciar
<span class="nc" id="L522">            paginaActual = 1;</span>
<span class="nc" id="L523">            actualizarPaginacion();</span>
<span class="nc" id="L524">            actualizarEstadisticas();</span>
        }

        // Configurar tabla
<span class="nc" id="L528">        configurarTabla();</span>

        // Aplicar CSS personalizado al BarChart
<span class="nc bnc" id="L531" title="All 2 branches missed.">        if (barChartTopProveedores != null) {</span>
<span class="nc" id="L532">            barChartTopProveedores.getStylesheets()</span>
<span class="nc" id="L533">                    .add(getClass().getResource(&quot;/css/Proveedor/barChart-custom.css&quot;).toExternalForm());</span>
        }

        // Cargar datos iniciales
<span class="nc" id="L537">        cargarProveedores();</span>

<span class="nc" id="L539">        System.out.println(&quot;ProveedoresController inicializado correctamente&quot;);</span>
<span class="nc" id="L540">    }</span>

    // Configurar la tabla de proveedores

    private void configurarTabla() {
        // Configurar columnas
<span class="nc" id="L546">        colRazonSocial.setCellValueFactory(new PropertyValueFactory&lt;&gt;(&quot;razonSocial&quot;));</span>
<span class="nc" id="L547">        colRuc.setCellValueFactory(new PropertyValueFactory&lt;&gt;(&quot;ruc&quot;));</span>
<span class="nc" id="L548">        colContacto.setCellValueFactory(new PropertyValueFactory&lt;&gt;(&quot;contacto&quot;));</span>
<span class="nc" id="L549">        colTelefono.setCellValueFactory(new PropertyValueFactory&lt;&gt;(&quot;telefono&quot;));</span>
        // Asegurar que la columna de acciones sea visible y no se compacte demasiado
        try {
<span class="nc bnc" id="L552" title="All 2 branches missed.">            if (colAcciones != null) {</span>
<span class="nc" id="L553">                colAcciones.setPrefWidth(200);</span>
<span class="nc" id="L554">                colAcciones.setMinWidth(140);</span>
<span class="nc" id="L555">                colAcciones.setMaxWidth(300);</span>
            }
<span class="nc" id="L557">        } catch (Exception ex) {</span>
            // No bloquear la inicialización si algo falla al ajustar tamaños
<span class="nc" id="L559">            logger.warn(&quot;No se pudo ajustar anchos de columnas de acciones: {}&quot;, ex.getMessage());</span>
<span class="nc" id="L560">        }</span>
        // colCondicionesPago.setVisible(false); // Ahora visible
<span class="nc" id="L562">        colEstado.setCellValueFactory(cellData -&gt; {</span>
<span class="nc" id="L563">            boolean activo = cellData.getValue().getActivo();</span>
<span class="nc bnc" id="L564" title="All 2 branches missed.">            return new javafx.beans.property.SimpleStringProperty(activo ? &quot;Activo&quot; : &quot;Inactivo&quot;);</span>
        });
<span class="nc" id="L566">        configurarColumnaAcciones();</span>
<span class="nc" id="L567">        tableProveedores.setRowFactory(tv -&gt; {</span>
<span class="nc" id="L568">            TableRow&lt;Proveedor&gt; row = new TableRow&lt;Proveedor&gt;() {</span>
                @Override
                protected void updateItem(Proveedor proveedor, boolean empty) {
<span class="nc" id="L571">                    super.updateItem(proveedor, empty);</span>
<span class="nc" id="L572">                    getStyleClass().removeAll(&quot;row-activo&quot;, &quot;row-inactivo&quot;, &quot;row-vip&quot;, &quot;row-observacion&quot;);</span>
<span class="nc bnc" id="L573" title="All 4 branches missed.">                    if (empty || proveedor == null) {</span>
<span class="nc" id="L574">                        setStyle(&quot;&quot;);</span>
                    } else {
<span class="nc bnc" id="L576" title="All 2 branches missed.">                        if (!proveedor.getActivo()) {</span>
<span class="nc" id="L577">                            getStyleClass().add(&quot;row-inactivo&quot;);</span>
                        } else {
<span class="nc" id="L579">                            getStyleClass().add(&quot;row-activo&quot;);</span>
                        }
                    }
<span class="nc" id="L582">                }</span>
            };
            // Solo click derecho para historial de cambios
<span class="nc" id="L585">            row.setOnMouseClicked(event -&gt; {</span>
<span class="nc bnc" id="L586" title="All 4 branches missed.">                if (event.isSecondaryButtonDown() &amp;&amp; !row.isEmpty()) {</span>
<span class="nc" id="L587">                    mostrarHistorialProveedor(row.getItem());</span>
                }
<span class="nc" id="L589">            });</span>
<span class="nc" id="L590">            return row;</span>
        });
<span class="nc" id="L592">        tableProveedores.setItems(proveedoresList);</span>
<span class="nc" id="L593">    }</span>

    // Mostrar historial de cambios de un proveedor
    private void mostrarHistorialProveedor(Proveedor proveedor) {
<span class="nc" id="L597">        List&lt;ProveedorRepository.HistorialCambioDTO&gt; historial = proveedorService</span>
<span class="nc" id="L598">                .obtenerHistorialCambios(proveedor.getId());</span>
<span class="nc bnc" id="L599" title="All 2 branches missed.">        if (historial.isEmpty()) {</span>
<span class="nc" id="L600">            Alert alert = new Alert(Alert.AlertType.INFORMATION);</span>
<span class="nc" id="L601">            alert.setTitle(&quot;Historial de Cambios&quot;);</span>
<span class="nc" id="L602">            alert.setHeaderText(&quot;Proveedor: &quot; + proveedor.getRazonSocial());</span>
<span class="nc" id="L603">            alert.setContentText(&quot;No hay historial de cambios para este proveedor.&quot;);</span>
<span class="nc" id="L604">            alert.showAndWait();</span>
<span class="nc" id="L605">            return;</span>
        }

<span class="nc" id="L608">        javafx.scene.control.TableView&lt;ProveedorRepository.HistorialCambioDTO&gt; table = new javafx.scene.control.TableView&lt;&gt;();</span>
<span class="nc" id="L609">        javafx.scene.control.TableColumn&lt;ProveedorRepository.HistorialCambioDTO, String&gt; colFecha = new javafx.scene.control.TableColumn&lt;&gt;(</span>
                &quot;Fecha&quot;);
<span class="nc" id="L611">        javafx.scene.control.TableColumn&lt;ProveedorRepository.HistorialCambioDTO, String&gt; colUsuario = new javafx.scene.control.TableColumn&lt;&gt;(</span>
                &quot;Usuario&quot;);
<span class="nc" id="L613">        javafx.scene.control.TableColumn&lt;ProveedorRepository.HistorialCambioDTO, String&gt; colCampo = new javafx.scene.control.TableColumn&lt;&gt;(</span>
                &quot;Campo&quot;);
<span class="nc" id="L615">        javafx.scene.control.TableColumn&lt;ProveedorRepository.HistorialCambioDTO, String&gt; colAnterior = new javafx.scene.control.TableColumn&lt;&gt;(</span>
                &quot;Anterior&quot;);
<span class="nc" id="L617">        javafx.scene.control.TableColumn&lt;ProveedorRepository.HistorialCambioDTO, String&gt; colNuevo = new javafx.scene.control.TableColumn&lt;&gt;(</span>
                &quot;Nuevo&quot;);

<span class="nc" id="L620">        colFecha.setCellValueFactory(cell -&gt; new javafx.beans.property.SimpleStringProperty(</span>
<span class="nc bnc" id="L621" title="All 2 branches missed.">                cell.getValue().fecha != null</span>
<span class="nc" id="L622">                        ? new java.text.SimpleDateFormat(&quot;dd/MM/yyyy HH:mm&quot;).format(cell.getValue().fecha)</span>
<span class="nc" id="L623">                        : &quot;&quot;));</span>
<span class="nc" id="L624">        colUsuario.setCellValueFactory(cell -&gt; new javafx.beans.property.SimpleStringProperty(cell.getValue().usuario));</span>
<span class="nc" id="L625">        colCampo.setCellValueFactory(cell -&gt; new javafx.beans.property.SimpleStringProperty(cell.getValue().campo));</span>
<span class="nc" id="L626">        colAnterior</span>
<span class="nc" id="L627">                .setCellValueFactory(cell -&gt; new javafx.beans.property.SimpleStringProperty(cell.getValue().anterior));</span>
<span class="nc" id="L628">        colNuevo.setCellValueFactory(cell -&gt; new javafx.beans.property.SimpleStringProperty(cell.getValue().nuevo));</span>

<span class="nc" id="L630">        table.getColumns().addAll(colFecha, colUsuario, colCampo, colAnterior, colNuevo);</span>
<span class="nc" id="L631">        table.setItems(javafx.collections.FXCollections.observableArrayList(historial));</span>
<span class="nc" id="L632">        table.setPrefHeight(300);</span>
<span class="nc" id="L633">        table.setPrefWidth(700);</span>

<span class="nc" id="L635">        javafx.scene.layout.VBox vbox = new javafx.scene.layout.VBox(table);</span>
<span class="nc" id="L636">        vbox.setPrefHeight(320);</span>
<span class="nc" id="L637">        vbox.setPrefWidth(720);</span>

<span class="nc" id="L639">        javafx.scene.control.Dialog&lt;Void&gt; dialog = new javafx.scene.control.Dialog&lt;&gt;();</span>
<span class="nc" id="L640">        dialog.setTitle(&quot;Historial de Cambios&quot;);</span>
<span class="nc" id="L641">        dialog.setHeaderText(&quot;Proveedor: &quot; + proveedor.getRazonSocial());</span>
<span class="nc" id="L642">        dialog.getDialogPane().setContent(vbox);</span>
<span class="nc" id="L643">        dialog.getDialogPane().getButtonTypes().add(javafx.scene.control.ButtonType.CLOSE);</span>
<span class="nc" id="L644">        dialog.showAndWait();</span>
<span class="nc" id="L645">    }</span>

    // Configurar la columna de acciones
    private void configurarColumnaAcciones() {
        // Reusar el patrón del módulo Inventario: Editar - Ver - Toggle - Eliminar
<span class="nc" id="L650">        colAcciones.setCellFactory(param -&gt; new TableCell&lt;&gt;() {</span>
<span class="nc" id="L651">            private final Button btnEditar = new Button();</span>
<span class="nc" id="L652">            private final Button btnVer = new Button();</span>
<span class="nc" id="L653">            private final Button btnToggleEstado = new Button();</span>
<span class="nc" id="L654">            private final Button btnEliminar = new Button();</span>

            {
                // Íconos: los mismos recursos que usa Inventario
<span class="nc" id="L658">                javafx.scene.image.ImageView iconEditar = new javafx.scene.image.ImageView(</span>
<span class="nc" id="L659">                        getClass().getResource(&quot;/icons/editar.png&quot;).toExternalForm());</span>
<span class="nc" id="L660">                javafx.scene.image.ImageView iconVer = new javafx.scene.image.ImageView(</span>
<span class="nc" id="L661">                        getClass().getResource(&quot;/icons/ver.png&quot;).toExternalForm());</span>
<span class="nc" id="L662">                javafx.scene.image.ImageView iconEliminar = new javafx.scene.image.ImageView(</span>
<span class="nc" id="L663">                        getClass().getResource(&quot;/icons/eliminar.png&quot;).toExternalForm());</span>

<span class="nc" id="L665">                iconEditar.setFitWidth(24);</span>
<span class="nc" id="L666">                iconEditar.setFitHeight(24);</span>
<span class="nc" id="L667">                iconVer.setFitWidth(24);</span>
<span class="nc" id="L668">                iconVer.setFitHeight(24);</span>
<span class="nc" id="L669">                iconEliminar.setFitWidth(24);</span>
<span class="nc" id="L670">                iconEliminar.setFitHeight(24);</span>

<span class="nc" id="L672">                btnEditar.setGraphic(iconEditar);</span>
<span class="nc" id="L673">                btnVer.setGraphic(iconVer);</span>
<span class="nc" id="L674">                btnEliminar.setGraphic(iconEliminar);</span>

                // Clases CSS coherentes con Inventario
<span class="nc" id="L677">                btnEditar.getStyleClass().setAll(&quot;btn-action&quot;, &quot;btn-add&quot;);</span>
<span class="nc" id="L678">                btnVer.getStyleClass().setAll(&quot;btn-action&quot;, &quot;btn-eye&quot;);</span>
<span class="nc" id="L679">                btnToggleEstado.getStyleClass().setAll(&quot;btn-action&quot;, &quot;btn-toggle&quot;);</span>
<span class="nc" id="L680">                btnEliminar.getStyleClass().setAll(&quot;btn-action&quot;, &quot;btn-trash&quot;);</span>

<span class="nc" id="L682">                btnEditar.setPrefSize(35, 35);</span>
<span class="nc" id="L683">                btnVer.setPrefSize(35, 35);</span>
<span class="nc" id="L684">                btnToggleEstado.setPrefSize(35, 35);</span>
<span class="nc" id="L685">                btnEliminar.setPrefSize(35, 35);</span>

                // Tooltips
<span class="nc" id="L688">                btnEditar.setTooltip(new Tooltip(&quot;Editar proveedor&quot;));</span>
<span class="nc" id="L689">                btnVer.setTooltip(new Tooltip(&quot;Ver detalles&quot;));</span>
<span class="nc" id="L690">                btnEliminar.setTooltip(new Tooltip(&quot;Eliminar&quot;));</span>

<span class="nc" id="L692">                btnEditar.setOnAction(e -&gt; {</span>
<span class="nc" id="L693">                    Proveedor proveedor = getTableView().getItems().get(getIndex());</span>
<span class="nc" id="L694">                    editarProveedor(proveedor);</span>
<span class="nc" id="L695">                });</span>
<span class="nc" id="L696">                btnVer.setOnAction(e -&gt; {</span>
<span class="nc" id="L697">                    Proveedor proveedor = getTableView().getItems().get(getIndex());</span>
<span class="nc" id="L698">                    verDetalles(proveedor);</span>
<span class="nc" id="L699">                });</span>
<span class="nc" id="L700">                btnToggleEstado.setOnAction(e -&gt; {</span>
<span class="nc" id="L701">                    Proveedor proveedor = getTableView().getItems().get(getIndex());</span>
<span class="nc" id="L702">                    toggleEstadoProveedor(proveedor);</span>
<span class="nc" id="L703">                });</span>
<span class="nc" id="L704">                btnEliminar.setOnAction(e -&gt; {</span>
<span class="nc" id="L705">                    Proveedor proveedor = getTableView().getItems().get(getIndex());</span>
<span class="nc" id="L706">                    eliminarProveedorDefinitivo(proveedor);</span>
<span class="nc" id="L707">                });</span>
<span class="nc" id="L708">            }</span>

            @Override
            protected void updateItem(Void item, boolean empty) {
<span class="nc" id="L712">                super.updateItem(item, empty);</span>
<span class="nc bnc" id="L713" title="All 2 branches missed.">                if (empty) {</span>
<span class="nc" id="L714">                    setGraphic(null);</span>
                } else {
                    com.farmaciavictoria.proyectopharmavictoria.model.Usuario.Usuario usuario = com.farmaciavictoria.proyectopharmavictoria.config.ServiceContainer
<span class="nc" id="L717">                            .getInstance().getAuthenticationService().getUsuarioActual();</span>
<span class="nc bnc" id="L718" title="All 4 branches missed.">                    boolean esAdmin = usuario != null &amp;&amp; usuario.isAdmin();</span>
<span class="nc bnc" id="L719" title="All 4 branches missed.">                    boolean esVendedor = usuario != null &amp;&amp; usuario.isVendedor();</span>

<span class="nc bnc" id="L721" title="All 6 branches missed.">                    boolean mostrarEditar = esAdmin || (esVendedor &amp;&amp; permisoEditar);</span>
<span class="nc bnc" id="L722" title="All 6 branches missed.">                    boolean mostrarToggle = esAdmin || (esVendedor &amp;&amp; permisoToggleEstado);</span>
<span class="nc bnc" id="L723" title="All 6 branches missed.">                    boolean mostrarEliminar = esAdmin || (esVendedor &amp;&amp; permisoEliminar);</span>
                    // El botón Ver SIEMPRE debe mostrarse para vendedores
<span class="nc bnc" id="L725" title="All 4 branches missed.">                    boolean mostrarVer = esAdmin || esVendedor;</span>

<span class="nc" id="L727">                    btnEditar.setVisible(mostrarEditar);</span>
<span class="nc" id="L728">                    btnEditar.setManaged(mostrarEditar);</span>
<span class="nc" id="L729">                    btnToggleEstado.setVisible(mostrarToggle);</span>
<span class="nc" id="L730">                    btnToggleEstado.setManaged(mostrarToggle);</span>
<span class="nc" id="L731">                    btnEliminar.setVisible(mostrarEliminar);</span>
<span class="nc" id="L732">                    btnEliminar.setManaged(mostrarEliminar);</span>
<span class="nc" id="L733">                    btnVer.setVisible(mostrarVer);</span>
<span class="nc" id="L734">                    btnVer.setManaged(mostrarVer);</span>

                    // Estado visual del botón toggle
<span class="nc bnc" id="L737" title="All 2 branches missed.">                    if (mostrarToggle) {</span>
<span class="nc" id="L738">                        Proveedor proveedor = getTableView().getItems().get(getIndex());</span>
<span class="nc bnc" id="L739" title="All 4 branches missed.">                        if (proveedor != null &amp;&amp; proveedor.getActivo()) {</span>
<span class="nc" id="L740">                            btnToggleEstado.setText(&quot;⏸&quot;);</span>
<span class="nc" id="L741">                            btnToggleEstado.setTooltip(new Tooltip(&quot;Inactivar proveedor&quot;));</span>
<span class="nc" id="L742">                            btnToggleEstado.getStyleClass().setAll(&quot;btn-action&quot;, &quot;btn-toggle&quot;, &quot;btn-toggle-active&quot;);</span>
                        } else {
<span class="nc" id="L744">                            btnToggleEstado.setText(&quot;▶&quot;);</span>
<span class="nc" id="L745">                            btnToggleEstado.setTooltip(new Tooltip(&quot;Activar proveedor&quot;));</span>
<span class="nc" id="L746">                            btnToggleEstado.getStyleClass().setAll(&quot;btn-action&quot;, &quot;btn-toggle&quot;, &quot;btn-toggle-inactive&quot;);</span>
                        }
                    }

<span class="nc" id="L750">                    HBox hbox = new HBox(7);</span>
<span class="nc" id="L751">                    hbox.setAlignment(javafx.geometry.Pos.CENTER);</span>
<span class="nc bnc" id="L752" title="All 2 branches missed.">                    if (mostrarEditar)</span>
<span class="nc" id="L753">                        hbox.getChildren().add(btnEditar);</span>
<span class="nc bnc" id="L754" title="All 2 branches missed.">                    if (mostrarVer)</span>
<span class="nc" id="L755">                        hbox.getChildren().add(btnVer);</span>
<span class="nc bnc" id="L756" title="All 2 branches missed.">                    if (mostrarToggle)</span>
<span class="nc" id="L757">                        hbox.getChildren().add(btnToggleEstado);</span>
<span class="nc bnc" id="L758" title="All 2 branches missed.">                    if (mostrarEliminar)</span>
<span class="nc" id="L759">                        hbox.getChildren().add(btnEliminar);</span>
<span class="nc" id="L760">                    setGraphic(hbox);</span>
                }
<span class="nc" id="L762">            }</span>
        });

<span class="nc" id="L765">    }</span>

    // Búsqueda en tiempo real
    @FXML
    private void buscarProveedores(javafx.event.ActionEvent event) {
<span class="nc" id="L770">        txtBuscar.textProperty().addListener((observable, oldValue, newValue) -&gt; {</span>
<span class="nc bnc" id="L771" title="All 2 branches missed.">            if (newValue != null) {</span>
<span class="nc" id="L772">                filtrarProveedores();</span>
            }
<span class="nc" id="L774">        });</span>
<span class="nc" id="L775">    }</span>

    @FXML
    private void onBuscar(javafx.scene.input.KeyEvent event) {
<span class="nc" id="L779">        filtrarProveedores();</span>
<span class="nc" id="L780">    }</span>

    // SERVICE LAYER: Cargar proveedores usando ProveedorService
    // Migrado de acceso directo a Repository hacia Service Layer
    private void cargarProveedores() {
        try {
<span class="nc" id="L786">            System.out.println(&quot;Cargando proveedores...&quot;);</span>

            // SERVICE LAYER: Cargando todos los proveedores (activos e inactivos) para
            // filtros
<span class="nc" id="L790">            List&lt;Proveedor&gt; proveedores = proveedorService.obtenerTodosIncluyendoInactivos();</span>

<span class="nc" id="L792">            Platform.runLater(() -&gt; {</span>
<span class="nc" id="L793">                proveedoresOriginales.clear();</span>
<span class="nc" id="L794">                proveedoresOriginales.addAll(proveedores);</span>

<span class="nc" id="L796">                aplicarFiltros();</span>
<span class="nc" id="L797">                actualizarEstadisticas();</span>
<span class="nc" id="L798">                actualizarUltimaActualizacion();</span>

                // Actualizar dashboard de gráficas
<span class="nc" id="L801">                inicializarDashboardGraficas();</span>

                // Refuerza visibilidad del botón Exportar cada vez que se cargan proveedores
                com.farmaciavictoria.proyectopharmavictoria.model.Usuario.Usuario usuario = com.farmaciavictoria.proyectopharmavictoria.config.ServiceContainer
<span class="nc" id="L805">                        .getInstance().getAuthenticationService().getUsuarioActual();</span>
<span class="nc bnc" id="L806" title="All 4 branches missed.">                boolean esAdmin = usuario != null &amp;&amp; usuario.isAdmin();</span>
<span class="nc bnc" id="L807" title="All 4 branches missed.">                boolean esVendedor = usuario != null &amp;&amp; usuario.isVendedor();</span>
<span class="nc bnc" id="L808" title="All 6 branches missed.">                boolean mostrarExportar = esAdmin || (esVendedor &amp;&amp; permisoExportar);</span>
<span class="nc bnc" id="L809" title="All 2 branches missed.">                if (btnExportar != null) {</span>
<span class="nc" id="L810">                    btnExportar.setVisible(mostrarExportar);</span>
<span class="nc" id="L811">                    btnExportar.setManaged(mostrarExportar);</span>
                }

<span class="nc" id="L814">                System.out.println(&quot;Proveedores cargados: &quot; + proveedores.size());</span>
<span class="nc" id="L815">            });</span>

<span class="nc" id="L817">        } catch (Exception e) {</span>
<span class="nc" id="L818">            System.err.println(&quot;Error cargando proveedores: &quot; + e.getMessage());</span>
<span class="nc" id="L819">            Platform.runLater(() -&gt; {</span>
<span class="nc" id="L820">                mostrarError(&quot;Error&quot;, &quot;No se pudieron cargar los proveedores&quot;, e.getMessage());</span>
<span class="nc" id="L821">            });</span>
<span class="nc" id="L822">        }</span>
<span class="nc" id="L823">    }</span>

    // Método público para refrescar la tabla (llamado desde formularios)
    public void refrescarTabla() {
<span class="nc" id="L827">        cargarProveedores();</span>
<span class="nc" id="L828">    }</span>

    // Filtrar proveedores según criterios (búsqueda simple)
    private void filtrarProveedores() {
<span class="nc" id="L832">        String textoBusqueda = txtBuscar.getText().toLowerCase().trim();</span>
<span class="nc" id="L833">        boolean soloActivos = chkSoloActivos.isSelected();</span>
<span class="nc bnc" id="L834" title="All 2 branches missed.">        String tipo = cmbTipoFiltro != null ? cmbTipoFiltro.getValue() : &quot;Razón Social&quot;;</span>

<span class="nc" id="L836">        List&lt;Proveedor&gt; proveedoresFiltrados = proveedoresOriginales.stream()</span>
<span class="nc" id="L837">                .filter(p -&gt; {</span>
<span class="nc bnc" id="L838" title="All 4 branches missed.">                    if (soloActivos &amp;&amp; !p.getActivo()) {</span>
<span class="nc" id="L839">                        return false;</span>
                    }
<span class="nc bnc" id="L841" title="All 2 branches missed.">                    if (!textoBusqueda.isEmpty()) {</span>
<span class="nc bnc" id="L842" title="All 5 branches missed.">                        switch (tipo) {</span>
                            case &quot;Razón Social&quot;:
<span class="nc bnc" id="L844" title="All 2 branches missed.">                                return p.getRazonSocial() != null</span>
<span class="nc bnc" id="L845" title="All 2 branches missed.">                                        &amp;&amp; p.getRazonSocial().toLowerCase().contains(textoBusqueda);</span>
                            case &quot;RUC&quot;:
<span class="nc bnc" id="L847" title="All 4 branches missed.">                                return p.getRuc() != null &amp;&amp; p.getRuc().toLowerCase().contains(textoBusqueda);</span>
                            case &quot;Contacto&quot;:
<span class="nc bnc" id="L849" title="All 4 branches missed.">                                return p.getContacto() != null &amp;&amp; p.getContacto().toLowerCase().contains(textoBusqueda);</span>
                            case &quot;Tipo de Producto&quot;:
<span class="nc bnc" id="L851" title="All 2 branches missed.">                                return p.getTipoProducto() != null</span>
<span class="nc bnc" id="L852" title="All 2 branches missed.">                                        &amp;&amp; p.getTipoProducto().toLowerCase().contains(textoBusqueda);</span>
                            default:
<span class="nc" id="L854">                                return true;</span>
                        }
                    }
<span class="nc" id="L857">                    return true;</span>
                })
<span class="nc" id="L859">                .toList();</span>

<span class="nc" id="L861">        int total = proveedoresFiltrados.size();</span>
<span class="nc bnc" id="L862" title="All 2 branches missed.">        if (tamanoPagina == -1) {</span>
<span class="nc" id="L863">            proveedoresList.clear();</span>
<span class="nc" id="L864">            proveedoresList.addAll(proveedoresFiltrados);</span>
<span class="nc bnc" id="L865" title="All 2 branches missed.">            if (lblPaginaActual != null)</span>
<span class="nc" id="L866">                lblPaginaActual.setText(&quot;Mostrando todos&quot;);</span>
<span class="nc bnc" id="L867" title="All 2 branches missed.">            if (btnPaginaAnterior != null)</span>
<span class="nc" id="L868">                btnPaginaAnterior.setDisable(true);</span>
<span class="nc bnc" id="L869" title="All 2 branches missed.">            if (btnPaginaSiguiente != null)</span>
<span class="nc" id="L870">                btnPaginaSiguiente.setDisable(true);</span>
        } else {
<span class="nc" id="L872">            totalPaginas = (int) Math.max(1, Math.ceil((double) total / tamanoPagina));</span>
<span class="nc bnc" id="L873" title="All 2 branches missed.">            if (paginaActual &gt; totalPaginas)</span>
<span class="nc" id="L874">                paginaActual = totalPaginas;</span>
<span class="nc bnc" id="L875" title="All 2 branches missed.">            if (paginaActual &lt; 1)</span>
<span class="nc" id="L876">                paginaActual = 1;</span>
<span class="nc" id="L877">            int fromIndex = (paginaActual - 1) * tamanoPagina;</span>
<span class="nc" id="L878">            int toIndex = Math.min(fromIndex + tamanoPagina, total);</span>
<span class="nc" id="L879">            List&lt;Proveedor&gt; pagina = proveedoresFiltrados.subList(fromIndex, toIndex);</span>
<span class="nc" id="L880">            proveedoresList.clear();</span>
<span class="nc" id="L881">            proveedoresList.addAll(pagina);</span>
<span class="nc bnc" id="L882" title="All 2 branches missed.">            if (lblPaginaActual != null)</span>
<span class="nc" id="L883">                lblPaginaActual.setText(&quot;Página &quot; + paginaActual + &quot; de &quot; + totalPaginas);</span>
<span class="nc bnc" id="L884" title="All 2 branches missed.">            if (btnPaginaAnterior != null)</span>
<span class="nc bnc" id="L885" title="All 2 branches missed.">                btnPaginaAnterior.setDisable(paginaActual &lt;= 1);</span>
<span class="nc bnc" id="L886" title="All 2 branches missed.">            if (btnPaginaSiguiente != null)</span>
<span class="nc bnc" id="L887" title="All 2 branches missed.">                btnPaginaSiguiente.setDisable(paginaActual &gt;= totalPaginas);</span>
        }

<span class="nc" id="L890">        actualizarEstadisticas();</span>
<span class="nc" id="L891">    }</span>

    // Actualizar estadísticas
    private void actualizarEstadisticas() {
        // Mostrar el total general de proveedores de la BD
<span class="nc bnc" id="L896" title="All 2 branches missed.">        int totalGeneral = proveedoresOriginales != null ? proveedoresOriginales.size() : 0;</span>
<span class="nc" id="L897">        int activos = (int) tableProveedores.getItems().stream().filter(Proveedor::getActivo).count();</span>
<span class="nc bnc" id="L898" title="All 2 branches missed.">        if (lblContadorTotal != null) {</span>
<span class="nc" id="L899">            lblContadorTotal.setText(&quot;Total: &quot; + totalGeneral + &quot; proveedores&quot;);</span>
        }
<span class="nc bnc" id="L901" title="All 2 branches missed.">        if (lblEstadistica != null) {</span>
<span class="nc" id="L902">            lblEstadistica.setText(String.format(&quot;Total: %d proveedores (%d activos)&quot;, totalGeneral, activos));</span>
        }
<span class="nc" id="L904">    }</span>

    // Actualizar timestamp de última actualización
    private void actualizarUltimaActualizacion() {
<span class="nc bnc" id="L908" title="All 2 branches missed.">        if (lblUltimaActualizacion != null) {</span>
<span class="nc" id="L909">            DateTimeFormatter formatter = DateTimeFormatter.ofPattern(&quot;dd/MM/yyyy HH:mm:ss&quot;);</span>
<span class="nc" id="L910">            lblUltimaActualizacion.setText(&quot;Última actualización: &quot; + LocalDateTime.now().format(formatter));</span>
        }
<span class="nc" id="L912">    }</span>

    @FXML
    private void limpiarBusqueda() {
<span class="nc" id="L916">        txtBuscar.clear();</span>
<span class="nc" id="L917">        filtrarProveedores();</span>
<span class="nc" id="L918">    }</span>

    @FXML
    private void aplicarFiltros() {
<span class="nc" id="L922">        filtrarProveedores();</span>
<span class="nc" id="L923">    }</span>

    @FXML
    private void nuevoProveedor() {
<span class="nc" id="L927">        abrirFormularioProveedor(null);</span>
<span class="nc" id="L928">    }</span>

    // Editar proveedor seleccionado
    private void editarProveedor(Proveedor proveedor) {
<span class="nc bnc" id="L932" title="All 2 branches missed.">        if (proveedor != null) {</span>
<span class="nc" id="L933">            abrirFormularioProveedor(proveedor);</span>
        }
<span class="nc" id="L935">    }</span>

    // Eliminar proveedor
    private void eliminarProveedor(Proveedor proveedor) {
<span class="nc" id="L939">        Alert confirmacion = new Alert(Alert.AlertType.CONFIRMATION);</span>
<span class="nc" id="L940">        confirmacion.setTitle(&quot;Confirmar Eliminación&quot;);</span>
<span class="nc" id="L941">        confirmacion.setHeaderText(&quot;¿Eliminar proveedor?&quot;);</span>
<span class="nc" id="L942">        confirmacion.setContentText(&quot;¿Está seguro de que desea eliminar el proveedor \&quot;&quot; +</span>
<span class="nc" id="L943">                proveedor.getRazonSocial() + &quot;\&quot;?&quot;);</span>

<span class="nc" id="L945">        confirmacion.showAndWait().ifPresent(response -&gt; {</span>
<span class="nc bnc" id="L946" title="All 2 branches missed.">            if (response == ButtonType.OK) {</span>
                try {
<span class="nc" id="L948">                    boolean eliminado = proveedorService.eliminar(proveedor.getId());</span>
<span class="nc bnc" id="L949" title="All 2 branches missed.">                    if (eliminado) {</span>
<span class="nc" id="L950">                        mostrarInformacion(&quot;Éxito&quot;, &quot;Proveedor eliminado correctamente&quot;);</span>
<span class="nc" id="L951">                        cargarProveedores();</span>
                    } else {
<span class="nc" id="L953">                        mostrarError(&quot;Error&quot;, &quot;No se pudo eliminar el proveedor&quot;, &quot;&quot;);</span>
                    }
<span class="nc" id="L955">                } catch (Exception e) {</span>
<span class="nc" id="L956">                    mostrarError(&quot;Error&quot;, &quot;Error al eliminar proveedor&quot;, e.getMessage());</span>
<span class="nc" id="L957">                }</span>
            }
<span class="nc" id="L959">        });</span>
<span class="nc" id="L960">    }</span>

    // Toggle rápido de estado activo/inactivo (sin confirmación)
    private void toggleEstadoProveedor(Proveedor proveedor) {
        try {
            // Cambiar estado
<span class="nc bnc" id="L966" title="All 2 branches missed.">            boolean nuevoEstado = !proveedor.getActivo();</span>
<span class="nc" id="L967">            proveedor.setActivo(nuevoEstado);</span>

            // Actualizar en BD usando service layer
<span class="nc" id="L970">            String usuarioActual = System.getProperty(&quot;user.name&quot;, &quot;sistema&quot;);</span>
<span class="nc" id="L971">            proveedorService.actualizar(proveedor, usuarioActual);</span>

            // Actualizar solo la fila modificada en la tabla (sin recargar toda la lista)
<span class="nc" id="L974">            tableProveedores.refresh();</span>

            // Notificación discreta
<span class="nc bnc" id="L977" title="All 2 branches missed.">            String mensaje = nuevoEstado</span>
<span class="nc" id="L978">                    ? String.format(&quot;Proveedor '%s' ACTIVADO correctamente&quot;, proveedor.getRazonSocial())</span>
<span class="nc" id="L979">                    : String.format(&quot;Proveedor '%s' INACTIVADO correctamente&quot;, proveedor.getRazonSocial());</span>

<span class="nc" id="L981">            notificationService.mostrarExito(mensaje);</span>
<span class="nc" id="L982">            logger.info(&quot;Estado del proveedor {} cambiado a: {}&quot;, proveedor.getRuc(),</span>
<span class="nc bnc" id="L983" title="All 2 branches missed.">                    nuevoEstado ? &quot;ACTIVO&quot; : &quot;INACTIVO&quot;);</span>
<span class="nc" id="L984">        } catch (Exception e) {</span>
<span class="nc" id="L985">            logger.error(&quot;Error al cambiar estado del proveedor: {}&quot;, e.getMessage(), e);</span>
<span class="nc" id="L986">            notificationService.mostrarError(&quot;No se pudo cambiar el estado del proveedor: &quot; + e.getMessage());</span>
<span class="nc" id="L987">        }</span>
<span class="nc" id="L988">    }</span>

    // Eliminación DEFINITIVA con doble confirmación
    private void eliminarProveedorDefinitivo(Proveedor proveedor) {
        // Primera confirmación: moderna y coherente con productos
<span class="nc" id="L993">        Alert confirmacion1 = new Alert(Alert.AlertType.WARNING);</span>
<span class="nc" id="L994">        confirmacion1.setTitle(&quot;🟢 Eliminación definitiva&quot;);</span>
<span class="nc" id="L995">        confirmacion1.setHeaderText(null);</span>
<span class="nc" id="L996">        confirmacion1.setContentText(null);</span>
<span class="nc" id="L997">        String mensaje1 = String.format(</span>
                &quot;🟢 ¡Atención!\n\n&quot; +
                        &quot;Esta acción NO se puede deshacer.\n\n&quot; +
                        &quot;Proveedor: %s\nRUC: %s\nEmail: %s\n\n&quot; +
                        &quot;Esta acción es IRREVERSIBLE&quot;,
<span class="nc" id="L1002">                proveedor.getRazonSocial(),</span>
<span class="nc" id="L1003">                proveedor.getRuc(),</span>
<span class="nc bnc" id="L1004" title="All 2 branches missed.">                proveedor.getEmail() != null ? proveedor.getEmail() : &quot;No especificado&quot;);</span>
<span class="nc" id="L1005">        Label label1 = new Label(mensaje1);</span>
<span class="nc" id="L1006">        label1.getStyleClass().add(&quot;label&quot;);</span>
<span class="nc" id="L1007">        VBox content1 = new VBox(label1);</span>
<span class="nc" id="L1008">        content1.setSpacing(10);</span>
<span class="nc" id="L1009">        content1.setPadding(new javafx.geometry.Insets(10));</span>
<span class="nc" id="L1010">        confirmacion1.getDialogPane().setContent(content1);</span>
<span class="nc" id="L1011">        confirmacion1.getDialogPane().getStylesheets().add(getClass().getResource(&quot;/css/styles.css&quot;).toExternalForm());</span>
<span class="nc" id="L1012">        confirmacion1.getDialogPane().getStylesheets()</span>
<span class="nc" id="L1013">                .add(getClass().getResource(&quot;/css/Proveedor/proveedores.css&quot;).toExternalForm());</span>
<span class="nc" id="L1014">        confirmacion1.getDialogPane().getStyleClass().add(&quot;proveedores-alert&quot;);</span>

<span class="nc" id="L1016">        ButtonType btnContinuar = new ButtonType(&quot;Continuar&quot;, ButtonBar.ButtonData.OK_DONE);</span>
<span class="nc" id="L1017">        ButtonType btnCancelar1 = new ButtonType(&quot;Cancelar&quot;, ButtonBar.ButtonData.CANCEL_CLOSE);</span>
<span class="nc" id="L1018">        confirmacion1.getButtonTypes().setAll(btnContinuar, btnCancelar1);</span>

<span class="nc" id="L1020">        Optional&lt;ButtonType&gt; resultado1 = confirmacion1.showAndWait();</span>
<span class="nc bnc" id="L1021" title="All 4 branches missed.">        if (resultado1.isPresent() &amp;&amp; resultado1.get() == btnContinuar) {</span>
            // Segunda confirmación: moderna y con campo de texto
<span class="nc" id="L1023">            Alert confirmacion2 = new Alert(Alert.AlertType.CONFIRMATION);</span>
<span class="nc" id="L1024">            confirmacion2.setTitle(&quot;🚨 Confirmación final&quot;);</span>
<span class="nc" id="L1025">            confirmacion2.setHeaderText(null);</span>
<span class="nc" id="L1026">            confirmacion2.setContentText(null);</span>
<span class="nc" id="L1027">            String mensaje2 = String.format(</span>
                    &quot;🟢 ¡ÚLTIMA OPORTUNIDAD!\n\n&quot; +
                            &quot;¿Realmente desea ELIMINAR PARA SIEMPRE el proveedor '%s'?\n\n&quot; +
                            &quot;🟡 Después de esto NO podrá recuperarlo\n&quot; +
                            &quot;🟡 Se perderán TODOS los datos\n&quot; +
                            &quot;🟡 No hay función de 'deshacer'\n\n&quot; +
                            &quot;Escriba 'ELIMINAR' para confirmar&quot;,
<span class="nc" id="L1034">                    proveedor.getRazonSocial());</span>
<span class="nc" id="L1035">            Label label2 = new Label(mensaje2);</span>
<span class="nc" id="L1036">            label2.getStyleClass().add(&quot;label&quot;);</span>
<span class="nc" id="L1037">            TextField input = new TextField();</span>
<span class="nc" id="L1038">            input.setPromptText(&quot;Escriba: ELIMINAR&quot;);</span>
<span class="nc" id="L1039">            input.getStyleClass().add(&quot;text-field&quot;);</span>
<span class="nc" id="L1040">            VBox content2 = new VBox(label2, input);</span>
<span class="nc" id="L1041">            content2.setSpacing(12);</span>
<span class="nc" id="L1042">            content2.setPadding(new javafx.geometry.Insets(10));</span>
<span class="nc" id="L1043">            confirmacion2.getDialogPane().setContent(content2);</span>
<span class="nc" id="L1044">            confirmacion2.getDialogPane().getStylesheets()</span>
<span class="nc" id="L1045">                    .add(getClass().getResource(&quot;/css/styles.css&quot;).toExternalForm());</span>
<span class="nc" id="L1046">            confirmacion2.getDialogPane().getStylesheets()</span>
<span class="nc" id="L1047">                    .add(getClass().getResource(&quot;/css/Proveedor/proveedores.css&quot;).toExternalForm());</span>
<span class="nc" id="L1048">            confirmacion2.getDialogPane().getStyleClass().add(&quot;proveedores-alert&quot;);</span>

<span class="nc" id="L1050">            ButtonType btnEliminarDefinitivo = new ButtonType(&quot;ELIMINAR DEFINITIVAMENTE&quot;, ButtonBar.ButtonData.OK_DONE);</span>
<span class="nc" id="L1051">            ButtonType btnCancelar2 = new ButtonType(&quot;Cancelar&quot;, ButtonBar.ButtonData.CANCEL_CLOSE);</span>
<span class="nc" id="L1052">            confirmacion2.getButtonTypes().setAll(btnEliminarDefinitivo, btnCancelar2);</span>

<span class="nc" id="L1054">            final Button btnOk = (Button) confirmacion2.getDialogPane().lookupButton(btnEliminarDefinitivo);</span>
<span class="nc" id="L1055">            btnOk.setDisable(true);</span>
<span class="nc" id="L1056">            input.textProperty().addListener((obs, oldVal, newVal) -&gt; {</span>
<span class="nc bnc" id="L1057" title="All 2 branches missed.">                btnOk.setDisable(!&quot;ELIMINAR&quot;.equalsIgnoreCase(newVal.trim()));</span>
<span class="nc" id="L1058">            });</span>

<span class="nc" id="L1060">            Optional&lt;ButtonType&gt; resultado2 = confirmacion2.showAndWait();</span>
<span class="nc bnc" id="L1061" title="All 4 branches missed.">            if (resultado2.isPresent() &amp;&amp; resultado2.get() == btnEliminarDefinitivo</span>
<span class="nc bnc" id="L1062" title="All 2 branches missed.">                    &amp;&amp; &quot;ELIMINAR&quot;.equalsIgnoreCase(input.getText().trim())) {</span>
                try {
                    // ELIMINACIÓN DEFINITIVA (hard delete)
<span class="nc" id="L1065">                    proveedorService.eliminarDefinitivamente(proveedor.getId());</span>
<span class="nc" id="L1066">                    notificationService.mostrarExito(</span>
<span class="nc" id="L1067">                            String.format(&quot;Proveedor '%s' ELIMINADO DEFINITIVAMENTE&quot;, proveedor.getRazonSocial()));</span>
<span class="nc" id="L1068">                    logger.warn(&quot;Proveedor ELIMINADO DEFINITIVAMENTE: {} ({})&quot;, proveedor.getRazonSocial(),</span>
<span class="nc" id="L1069">                            proveedor.getRuc());</span>
<span class="nc" id="L1070">                } catch (Exception e) {</span>
<span class="nc" id="L1071">                    logger.error(&quot;Error al eliminar definitivamente el proveedor: {}&quot;, e.getMessage(), e);</span>
<span class="nc" id="L1072">                    notificationService.mostrarError(&quot;No se pudo eliminar el proveedor: &quot; + e.getMessage());</span>
<span class="nc" id="L1073">                }</span>
            }
        }
<span class="nc" id="L1076">    }</span>

    private void abrirFormularioProveedor(Proveedor proveedor) {
        try {
<span class="nc" id="L1080">            FXMLLoader loader = new FXMLLoader(getClass().getResource(&quot;/fxml/Proveedor/proveedor-form.fxml&quot;));</span>
<span class="nc" id="L1081">            Parent root = loader.load();</span>

<span class="nc" id="L1083">            ProveedorFormController controller = loader.getController();</span>
<span class="nc bnc" id="L1084" title="All 2 branches missed.">            if (controller != null) {</span>
<span class="nc bnc" id="L1085" title="All 2 branches missed.">                if (proveedor != null) {</span>
<span class="nc" id="L1086">                    controller.setProveedor(proveedor);</span>
                }
<span class="nc" id="L1088">                controller.setOnProveedorGuardado(proveedorGuardado -&gt; {</span>
                    // Guardar/actualizar proveedor con usuario actual
<span class="nc" id="L1090">                    String usuarioActual = System.getProperty(&quot;user.name&quot;, &quot;sistema&quot;);</span>
<span class="nc bnc" id="L1091" title="All 2 branches missed.">                    if (proveedorGuardado.getId() == null) {</span>
<span class="nc" id="L1092">                        proveedorService.guardar(proveedorGuardado); // alta: no requiere historial</span>
                    } else {
<span class="nc" id="L1094">                        proveedorService.actualizar(proveedorGuardado, usuarioActual); // edición: registra historial</span>
                    }
<span class="nc" id="L1096">                    cargarProveedores();</span>
<span class="nc" id="L1097">                    Platform.runLater(() -&gt; tableProveedores.refresh());</span>
<span class="nc" id="L1098">                });</span>
            }

<span class="nc" id="L1101">            Stage stage = new Stage();</span>
<span class="nc bnc" id="L1102" title="All 2 branches missed.">            stage.setTitle(proveedor == null ? &quot;Nuevo Proveedor&quot; : &quot;Editar Proveedor&quot;);</span>
<span class="nc" id="L1103">            Scene scene = new Scene(root);</span>

            try {
<span class="nc" id="L1106">                String css = getClass().getResource(&quot;/css/Proveedor/proveedor-form.css&quot;).toExternalForm();</span>
<span class="nc" id="L1107">                scene.getStylesheets().add(css);</span>
<span class="nc" id="L1108">            } catch (Exception ex) {</span>
<span class="nc" id="L1109">                logger.warn(&quot;No se pudo cargar CSS del formulario de proveedor: {}&quot;, ex.getMessage());</span>
<span class="nc" id="L1110">            }</span>

<span class="nc" id="L1112">            stage.setScene(scene);</span>
<span class="nc" id="L1113">            stage.initModality(Modality.APPLICATION_MODAL);</span>
<span class="nc" id="L1114">            stage.setResizable(true);</span>
<span class="nc" id="L1115">            stage.centerOnScreen();</span>
<span class="nc" id="L1116">            stage.show();</span>

<span class="nc" id="L1118">        } catch (IOException ex) {</span>
<span class="nc" id="L1119">            logger.error(&quot;Error al abrir formulario de proveedor: {}&quot;, ex.getMessage(), ex);</span>
<span class="nc" id="L1120">            mostrarError(&quot;Error&quot;, &quot;No se pudo abrir el formulario de proveedor&quot;, ex.getMessage());</span>
<span class="nc" id="L1121">        }</span>
<span class="nc" id="L1122">    }</span>

    private void mostrarError(String titulo, String header, String contenido) {
<span class="nc" id="L1125">        Alert alert = new Alert(Alert.AlertType.ERROR);</span>
<span class="nc" id="L1126">        alert.setTitle(titulo);</span>
<span class="nc" id="L1127">        alert.setHeaderText(header);</span>
<span class="nc" id="L1128">        alert.setContentText(contenido);</span>
<span class="nc" id="L1129">        alert.showAndWait();</span>
        // Si el contenido es un stacktrace, imprímelo
<span class="nc bnc" id="L1131" title="All 4 branches missed.">        if (contenido != null &amp;&amp; contenido.contains(&quot;Exception&quot;)) {</span>
<span class="nc" id="L1132">            System.err.println(&quot;[ERROR] &quot; + header + &quot;: &quot; + contenido);</span>
        }
<span class="nc" id="L1134">    }</span>

    // Mostrar diálogo de información
    private void mostrarInformacion(String titulo, String mensaje) {
<span class="nc" id="L1138">        Alert alert = new Alert(Alert.AlertType.INFORMATION);</span>
<span class="nc" id="L1139">        alert.setTitle(titulo);</span>
<span class="nc" id="L1140">        alert.setHeaderText(null);</span>
<span class="nc" id="L1141">        alert.setContentText(mensaje);</span>
<span class="nc" id="L1142">        alert.showAndWait();</span>
<span class="nc" id="L1143">    }</span>

    // Ver detalles del proveedor
    public void verDetalles(Proveedor proveedor) {
        try {
<span class="nc" id="L1148">            FXMLLoader loader = new FXMLLoader(getClass().getResource(&quot;/fxml/Proveedor/proveedor-detalles.fxml&quot;));</span>
<span class="nc" id="L1149">            Parent root = loader.load();</span>

<span class="nc" id="L1151">            Stage stage = new Stage();</span>
<span class="nc" id="L1152">            stage.setTitle(&quot;Detalles del Proveedor - &quot; + proveedor.getRazonSocial());</span>
<span class="nc" id="L1153">            stage.setScene(new Scene(root, 800, 700));</span>
<span class="nc" id="L1154">            stage.initModality(Modality.APPLICATION_MODAL);</span>
<span class="nc" id="L1155">            stage.setResizable(false);</span>
<span class="nc" id="L1156">            stage.centerOnScreen();</span>

<span class="nc" id="L1158">            ProveedorDetallesController controller = loader.getController();</span>
<span class="nc" id="L1159">            controller.setProveedor(proveedor);</span>
<span class="nc" id="L1160">            controller.setStage(stage);</span>

<span class="nc" id="L1162">            stage.show();</span>

<span class="nc" id="L1164">        } catch (IOException e) {</span>
<span class="nc" id="L1165">            System.err.println(&quot;Error al abrir detalles del proveedor: &quot; + e.getMessage());</span>
<span class="nc" id="L1166">            e.printStackTrace();</span>
<span class="nc" id="L1167">            mostrarError(&quot;Error&quot;, &quot;No se pudo abrir los detalles del proveedor&quot;, e.getMessage());</span>
<span class="nc" id="L1168">        }</span>
<span class="nc" id="L1169">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>
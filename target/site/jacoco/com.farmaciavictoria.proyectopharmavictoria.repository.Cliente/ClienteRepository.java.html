<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ClienteRepository.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">proyectopharmavictoria</a> &gt; <a href="index.source.html" class="el_package">com.farmaciavictoria.proyectopharmavictoria.repository.Cliente</a> &gt; <span class="el_source">ClienteRepository.java</span></div><h1>ClienteRepository.java</h1><pre class="source lang-java linenums">package com.farmaciavictoria.proyectopharmavictoria.repository.Cliente;

import com.farmaciavictoria.proyectopharmavictoria.config.DatabaseConfig;
import com.farmaciavictoria.proyectopharmavictoria.model.Cliente.Cliente;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.sql.*;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;
import java.util.Optional;

/**
 * REPOSITORY PATTERN - Repository para gestión de clientes
 * Implementa patrón Repository para operaciones CRUD de clientes
 * Incluye búsquedas especializadas y queries optimizadas
 * 
 * @author PHARMAVICTORIA Development Team
 * @version 1.0
 */
public class ClienteRepository {

<span class="fc" id="L26">    private static final Logger logger = LoggerFactory.getLogger(ClienteRepository.class);</span>
    private final DatabaseConfig databaseConfig;

<span class="fc" id="L29">    public ClienteRepository() {</span>
<span class="fc" id="L30">        this.databaseConfig = DatabaseConfig.getInstance();</span>
<span class="fc" id="L31">    }</span>

    public List&lt;Cliente&gt; findAll(int offset, int limit) {
<span class="nc" id="L34">        String sql = &quot;SELECT * FROM clientes ORDER BY id ASC LIMIT ? OFFSET ?&quot;;</span>
<span class="nc" id="L35">        List&lt;Cliente&gt; clientes = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L36">        try (Connection conn = databaseConfig.getConnection();</span>
<span class="nc" id="L37">                PreparedStatement stmt = conn.prepareStatement(sql)) {</span>
<span class="nc" id="L38">            stmt.setInt(1, limit);</span>
<span class="nc" id="L39">            stmt.setInt(2, offset);</span>
<span class="nc" id="L40">            try (ResultSet rs = stmt.executeQuery()) {</span>
<span class="nc bnc" id="L41" title="All 2 branches missed.">                while (rs.next()) {</span>
<span class="nc" id="L42">                    clientes.add(mapResultSetToCliente(rs));</span>
                }
            }
<span class="nc" id="L45">            logger.debug(&quot;Clientes obtenidos: {}&quot;, clientes.size());</span>
<span class="nc" id="L46">        } catch (SQLException e) {</span>
<span class="nc" id="L47">            logger.error(&quot;Error al obtener clientes: {}&quot;, e.getMessage(), e);</span>
<span class="nc" id="L48">            throw new RuntimeException(&quot;Error al obtener clientes&quot;, e);</span>
<span class="nc" id="L49">        }</span>
<span class="nc" id="L50">        return clientes;</span>
    }

    public Optional&lt;Cliente&gt; findById(Integer id) {
<span class="nc" id="L54">        String sql = &quot;SELECT * FROM clientes WHERE id = ?&quot;;</span>

<span class="nc" id="L56">        try (Connection conn = databaseConfig.getConnection();</span>
<span class="nc" id="L57">                PreparedStatement stmt = conn.prepareStatement(sql)) {</span>

<span class="nc" id="L59">            stmt.setInt(1, id);</span>

<span class="nc" id="L61">            try (ResultSet rs = stmt.executeQuery()) {</span>
<span class="nc bnc" id="L62" title="All 2 branches missed.">                if (rs.next()) {</span>
<span class="nc" id="L63">                    Cliente cliente = mapResultSetToCliente(rs);</span>
<span class="nc" id="L64">                    logger.debug(&quot;Cliente encontrado por ID {}: {}&quot;, id, cliente.getNombreCompleto());</span>
<span class="nc" id="L65">                    return Optional.of(cliente);</span>
                }
<span class="nc bnc" id="L67" title="All 2 branches missed.">            }</span>

<span class="nc bnc" id="L69" title="All 4 branches missed.">        } catch (SQLException e) {</span>
<span class="nc" id="L70">            logger.error(&quot;Error al buscar cliente por ID {}: {}&quot;, id, e.getMessage(), e);</span>
<span class="nc" id="L71">        }</span>

<span class="nc" id="L73">        return Optional.empty();</span>
    }

    public Optional&lt;Cliente&gt; findByCodigo(String codigo) {
<span class="nc" id="L77">        String sql = &quot;SELECT * FROM clientes WHERE codigo = ? AND activo = true&quot;;</span>

<span class="nc" id="L79">        try (Connection conn = databaseConfig.getConnection();</span>
<span class="nc" id="L80">                PreparedStatement stmt = conn.prepareStatement(sql)) {</span>

<span class="nc" id="L82">            stmt.setString(1, codigo);</span>

<span class="nc" id="L84">            try (ResultSet rs = stmt.executeQuery()) {</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">                if (rs.next()) {</span>
<span class="nc" id="L86">                    Cliente cliente = mapResultSetToCliente(rs);</span>
<span class="nc" id="L87">                    logger.debug(&quot;Cliente encontrado por código {}: {}&quot;, codigo, cliente.getNombreCompleto());</span>
<span class="nc" id="L88">                    return Optional.of(cliente);</span>
                }
<span class="nc bnc" id="L90" title="All 2 branches missed.">            }</span>

<span class="nc bnc" id="L92" title="All 4 branches missed.">        } catch (SQLException e) {</span>
<span class="nc" id="L93">            logger.error(&quot;Error al buscar cliente por código {}: {}&quot;, codigo, e.getMessage(), e);</span>
<span class="nc" id="L94">        }</span>

<span class="nc" id="L96">        return Optional.empty();</span>
    }

    public List&lt;Cliente&gt; findByNombreOApellido(String texto) {
<span class="nc" id="L100">        String sql = &quot;SELECT * FROM clientes WHERE LOWER(nombres) LIKE ? OR LOWER(apellidos) LIKE ? ORDER BY nombres, apellidos&quot;;</span>
<span class="nc" id="L101">        List&lt;Cliente&gt; clientes = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L102">        String pattern = &quot;%&quot; + texto.toLowerCase() + &quot;%&quot;;</span>
<span class="nc" id="L103">        try (Connection conn = databaseConfig.getConnection();</span>
<span class="nc" id="L104">                PreparedStatement stmt = conn.prepareStatement(sql)) {</span>
<span class="nc" id="L105">            stmt.setString(1, pattern);</span>
<span class="nc" id="L106">            stmt.setString(2, pattern);</span>
<span class="nc" id="L107">            try (ResultSet rs = stmt.executeQuery()) {</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">                while (rs.next()) {</span>
<span class="nc" id="L109">                    clientes.add(mapResultSetToCliente(rs));</span>
                }
            }
<span class="nc" id="L112">            logger.debug(&quot;Clientes encontrados por nombre/apellido '{}': {}&quot;, texto, clientes.size());</span>
<span class="nc" id="L113">        } catch (SQLException e) {</span>
<span class="nc" id="L114">            logger.error(&quot;Error al buscar clientes por nombre/apellido '{}': {}&quot;, texto, e.getMessage(), e);</span>
<span class="nc" id="L115">        }</span>
<span class="nc" id="L116">        return clientes;</span>
    }

    public List&lt;Cliente&gt; findByCategoria(String categoria) {
<span class="nc" id="L120">        String sql = &quot;&quot;&quot;</span>
                SELECT * FROM clientes
                WHERE categoria_cliente = ? AND activo = true
                ORDER BY puntos_acumulados DESC
                &quot;&quot;&quot;;

<span class="nc" id="L126">        List&lt;Cliente&gt; clientes = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L128">        try (Connection conn = databaseConfig.getConnection();</span>
<span class="nc" id="L129">                PreparedStatement stmt = conn.prepareStatement(sql)) {</span>

<span class="nc" id="L131">            stmt.setString(1, categoria);</span>

<span class="nc" id="L133">            try (ResultSet rs = stmt.executeQuery()) {</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">                while (rs.next()) {</span>
<span class="nc" id="L135">                    clientes.add(mapResultSetToCliente(rs));</span>
                }
            }

<span class="nc" id="L139">            logger.debug(&quot;Clientes encontrados por categoría '{}': {}&quot;, categoria, clientes.size());</span>

<span class="nc" id="L141">        } catch (SQLException e) {</span>
<span class="nc" id="L142">            logger.error(&quot;Error al buscar clientes por categoría '{}': {}&quot;, categoria, e.getMessage(), e);</span>
<span class="nc" id="L143">        }</span>

<span class="nc" id="L145">        return clientes;</span>
    }

    public List&lt;Cliente&gt; findClientesVip() {
<span class="nc" id="L149">        String sql = &quot;&quot;&quot;</span>
                SELECT * FROM clientes
                WHERE (categoria_cliente = 'VIP' OR descuento_preferencial &gt;= 10.0)
                AND activo = true
                ORDER BY puntos_acumulados DESC
                &quot;&quot;&quot;;

<span class="nc" id="L156">        List&lt;Cliente&gt; clientes = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L158">        try (Connection conn = databaseConfig.getConnection();</span>
<span class="nc" id="L159">                PreparedStatement stmt = conn.prepareStatement(sql);</span>
<span class="nc" id="L160">                ResultSet rs = stmt.executeQuery()) {</span>

<span class="nc bnc" id="L162" title="All 2 branches missed.">            while (rs.next()) {</span>
<span class="nc" id="L163">                clientes.add(mapResultSetToCliente(rs));</span>
            }

<span class="nc" id="L166">            logger.debug(&quot;Clientes VIP encontrados: {}&quot;, clientes.size());</span>

<span class="nc" id="L168">        } catch (SQLException e) {</span>
<span class="nc" id="L169">            logger.error(&quot;Error al obtener clientes VIP: {}&quot;, e.getMessage(), e);</span>
<span class="nc" id="L170">        }</span>

<span class="nc" id="L172">        return clientes;</span>
    }

    public boolean save(Cliente cliente) {
<span class="nc bnc" id="L176" title="All 2 branches missed.">        if (cliente.getId() == null) {</span>
<span class="nc" id="L177">            return insert(cliente);</span>
        } else {
<span class="nc" id="L179">            return update(cliente);</span>
        }
    }

    private boolean insert(Cliente cliente) {
<span class="nc" id="L184">        String sql = &quot;INSERT INTO clientes (documento, tipo_cliente, razon_social, nombres, apellidos, telefono, email, direccion, fecha_nacimiento, puntos_totales, puntos_usados, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)&quot;;</span>
<span class="nc" id="L185">        try (Connection conn = databaseConfig.getConnection();</span>
<span class="nc" id="L186">                PreparedStatement stmt = conn.prepareStatement(sql, Statement.RETURN_GENERATED_KEYS)) {</span>
<span class="nc" id="L187">            String tipo = cliente.getTipoCliente();</span>
            // Si es Empresa, usar ruc como documento; si es Natural, usar dni
<span class="nc bnc" id="L189" title="All 2 branches missed.">            String documento = &quot;Empresa&quot;.equalsIgnoreCase(tipo) ? cliente.getRuc() : cliente.getDni();</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">            String razonSocial = &quot;Empresa&quot;.equalsIgnoreCase(tipo) ? cliente.getRazonSocial() : null;</span>
<span class="nc" id="L191">            logger.info(</span>
                    &quot;[INSERT] Datos recibidos: documento={}, tipo_cliente={}, razon_social={}, nombres={}, apellidos={}, telefono={}, email={}, direccion={}, fecha_nacimiento={}, puntos_totales={}, puntos_usados{}&quot;,
<span class="nc" id="L193">                    documento, tipo, razonSocial, cliente.getNombres(), cliente.getApellidos(), cliente.getTelefono(),</span>
<span class="nc" id="L194">                    cliente.getEmail(), cliente.getDireccion(), cliente.getFechaNacimiento(),</span>
<span class="nc" id="L195">                    cliente.getPuntosTotales(), cliente.getPuntosUsados());</span>
<span class="nc" id="L196">            stmt.setString(1, documento); // documento</span>
<span class="nc" id="L197">            stmt.setString(2, tipo); // tipo_cliente</span>
<span class="nc bnc" id="L198" title="All 4 branches missed.">            if (razonSocial != null &amp;&amp; !razonSocial.trim().isEmpty()) {</span>
<span class="nc" id="L199">                stmt.setString(3, razonSocial); // razon_social</span>
            } else {
<span class="nc" id="L201">                stmt.setNull(3, java.sql.Types.VARCHAR); // razon_social null para Natural</span>
            }
<span class="nc" id="L203">            stmt.setString(4, cliente.getNombres());</span>
<span class="nc" id="L204">            stmt.setString(5, cliente.getApellidos());</span>
<span class="nc" id="L205">            stmt.setString(6, cliente.getTelefono());</span>
<span class="nc" id="L206">            stmt.setString(7, cliente.getEmail());</span>
<span class="nc" id="L207">            stmt.setString(8, cliente.getDireccion());</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">            if (cliente.getFechaNacimiento() != null) {</span>
<span class="nc" id="L209">                stmt.setDate(9, java.sql.Date.valueOf(cliente.getFechaNacimiento()));</span>
            } else {
<span class="nc" id="L211">                stmt.setNull(9, Types.DATE);</span>
            }
<span class="nc bnc" id="L213" title="All 2 branches missed.">            stmt.setInt(10, cliente.getPuntosTotales() != null ? cliente.getPuntosTotales() : 0);</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">            stmt.setInt(11, cliente.getPuntosUsados() != null ? cliente.getPuntosUsados() : 0);</span>
<span class="nc" id="L215">            stmt.setTimestamp(12, new java.sql.Timestamp(System.currentTimeMillis()));</span>
<span class="nc" id="L216">            stmt.setTimestamp(13, new java.sql.Timestamp(System.currentTimeMillis()));</span>
<span class="nc" id="L217">            int rowsAffected = stmt.executeUpdate();</span>
<span class="nc" id="L218">            logger.info(&quot;[INSERT] Filas afectadas: {}&quot;, rowsAffected);</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">            if (rowsAffected &gt; 0) {</span>
<span class="nc" id="L220">                try (ResultSet generatedKeys = stmt.getGeneratedKeys()) {</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">                    if (generatedKeys.next()) {</span>
<span class="nc" id="L222">                        cliente.setId(generatedKeys.getInt(1));</span>
                    }
                }
<span class="nc" id="L225">                logger.info(&quot;Cliente creado exitosamente: {}&quot;, cliente.getNombreCompleto());</span>
<span class="nc" id="L226">                return true;</span>
            }
<span class="nc bnc" id="L228" title="All 4 branches missed.">        } catch (SQLException e) {</span>
<span class="nc" id="L229">            logger.error(&quot;[INSERT][ERROR] Error al crear cliente: {}&quot;, e.getMessage(), e);</span>
<span class="nc" id="L230">            logger.error(&quot;[INSERT][ERROR] Stacktrace:&quot;, e);</span>
<span class="nc" id="L231">        } catch (Exception ex) {</span>
<span class="nc" id="L232">            logger.error(&quot;[INSERT][ERROR] Excepción inesperada: {}&quot;, ex.getMessage(), ex);</span>
<span class="nc" id="L233">        }</span>
<span class="nc" id="L234">        return false;</span>
    }

    private boolean update(Cliente cliente) {
<span class="nc" id="L238">        String sql = &quot;UPDATE clientes SET documento = ?, tipo_cliente = ?, razon_social = ?, nombres = ?, apellidos = ?, telefono = ?, email = ?, direccion = ?, fecha_nacimiento = ?, puntos_totales = ?, puntos_usados = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?&quot;;</span>
<span class="nc" id="L239">        try (Connection conn = databaseConfig.getConnection();</span>
<span class="nc" id="L240">                PreparedStatement stmt = conn.prepareStatement(sql)) {</span>
<span class="nc" id="L241">            int idx = 1;</span>
<span class="nc" id="L242">            logger.info(</span>
                    &quot;[UPDATE] Datos recibidos: documento={}, tipo_cliente={}, razon_social={}, nombres={}, apellidos={}, telefono={}, email={}, direccion={}, fecha_nacimiento={}, puntos_totales={}, puntos_usados={}, id={}&quot;,
<span class="nc" id="L244">                    cliente.getDocumento(), cliente.getTipoCliente(),</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">                    &quot;Empresa&quot;.equalsIgnoreCase(cliente.getTipoCliente()) ? cliente.getRazonSocial() : null,</span>
<span class="nc" id="L246">                    cliente.getNombres(), cliente.getApellidos(), cliente.getTelefono(), cliente.getEmail(),</span>
<span class="nc" id="L247">                    cliente.getDireccion(), cliente.getFechaNacimiento(), cliente.getPuntosTotales(),</span>
<span class="nc" id="L248">                    cliente.getPuntosUsados(), cliente.getId());</span>
<span class="nc" id="L249">            stmt.setString(idx++, cliente.getDocumento());</span>
<span class="nc" id="L250">            stmt.setString(idx++, cliente.getTipoCliente());</span>
<span class="nc" id="L251">            String tipo = cliente.getTipoCliente();</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">            String razonSocial = &quot;Empresa&quot;.equalsIgnoreCase(tipo) ? cliente.getRazonSocial() : null;</span>
<span class="nc bnc" id="L253" title="All 4 branches missed.">            if (razonSocial != null &amp;&amp; !razonSocial.trim().isEmpty()) {</span>
<span class="nc" id="L254">                stmt.setString(idx++, razonSocial);</span>
            } else {
<span class="nc" id="L256">                stmt.setNull(idx++, java.sql.Types.VARCHAR);</span>
            }
<span class="nc" id="L258">            stmt.setString(idx++, cliente.getNombres());</span>
<span class="nc" id="L259">            stmt.setString(idx++, cliente.getApellidos());</span>
<span class="nc" id="L260">            stmt.setString(idx++, cliente.getTelefono());</span>
<span class="nc" id="L261">            stmt.setString(idx++, cliente.getEmail());</span>
<span class="nc" id="L262">            stmt.setString(idx++, cliente.getDireccion());</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">            if (cliente.getFechaNacimiento() != null) {</span>
<span class="nc" id="L264">                stmt.setDate(idx++, java.sql.Date.valueOf(cliente.getFechaNacimiento()));</span>
            } else {
<span class="nc" id="L266">                stmt.setNull(idx++, java.sql.Types.DATE);</span>
            }
<span class="nc bnc" id="L268" title="All 2 branches missed.">            stmt.setInt(idx++, cliente.getPuntosTotales() != null ? cliente.getPuntosTotales() : 0);</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">            stmt.setInt(idx++, cliente.getPuntosUsados() != null ? cliente.getPuntosUsados() : 0);</span>
<span class="nc" id="L270">            stmt.setInt(idx++, cliente.getId());</span>
<span class="nc" id="L271">            int rowsAffected = stmt.executeUpdate();</span>
<span class="nc" id="L272">            logger.info(&quot;[UPDATE] Filas afectadas: {}&quot;, rowsAffected);</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">            if (rowsAffected &gt; 0) {</span>
<span class="nc" id="L274">                logger.info(&quot;Cliente actualizado exitosamente: {}&quot;, cliente.getNombreCompleto());</span>
<span class="nc" id="L275">                return true;</span>
            }
<span class="nc bnc" id="L277" title="All 4 branches missed.">        } catch (SQLException e) {</span>
<span class="nc" id="L278">            logger.error(&quot;[UPDATE][ERROR] Error al actualizar cliente: {}&quot;, e.getMessage(), e);</span>
<span class="nc" id="L279">            logger.error(&quot;[UPDATE][ERROR] Stacktrace:&quot;, e);</span>
<span class="nc" id="L280">        } catch (Exception ex) {</span>
<span class="nc" id="L281">            logger.error(&quot;[UPDATE][ERROR] Excepción inesperada: {}&quot;, ex.getMessage(), ex);</span>
<span class="nc" id="L282">        }</span>
<span class="nc" id="L283">        return false;</span>
    }

    public boolean delete(Integer id) {
<span class="nc" id="L287">        String sql = &quot;DELETE FROM clientes WHERE id = ?&quot;;</span>
<span class="nc" id="L288">        try (Connection conn = databaseConfig.getConnection();</span>
<span class="nc" id="L289">                PreparedStatement stmt = conn.prepareStatement(sql)) {</span>
<span class="nc" id="L290">            stmt.setInt(1, id);</span>
<span class="nc" id="L291">            int rowsAffected = stmt.executeUpdate();</span>
<span class="nc bnc" id="L292" title="All 2 branches missed.">            if (rowsAffected &gt; 0) {</span>
<span class="nc" id="L293">                logger.info(&quot;Cliente eliminado físicamente: ID {}&quot;, id);</span>
<span class="nc" id="L294">                return true;</span>
            }
<span class="nc bnc" id="L296" title="All 4 branches missed.">        } catch (SQLException e) {</span>
<span class="nc" id="L297">            logger.error(&quot;Error al eliminar cliente ID {}: {}&quot;, id, e.getMessage(), e);</span>
<span class="nc" id="L298">        }</span>
<span class="nc" id="L299">        return false;</span>
    }

    public boolean reactivate(Integer id) {
<span class="nc" id="L303">        String sql = &quot;UPDATE clientes SET activo = true WHERE id = ?&quot;;</span>

<span class="nc" id="L305">        try (Connection conn = databaseConfig.getConnection();</span>
<span class="nc" id="L306">                PreparedStatement stmt = conn.prepareStatement(sql)) {</span>

<span class="nc" id="L308">            stmt.setInt(1, id);</span>

<span class="nc" id="L310">            int rowsAffected = stmt.executeUpdate();</span>

<span class="nc bnc" id="L312" title="All 2 branches missed.">            if (rowsAffected &gt; 0) {</span>
<span class="nc" id="L313">                logger.info(&quot;Cliente reactivado: ID {}&quot;, id);</span>
<span class="nc" id="L314">                return true;</span>
            }

<span class="nc bnc" id="L317" title="All 4 branches missed.">        } catch (SQLException e) {</span>
<span class="nc" id="L318">            logger.error(&quot;Error al reactivar cliente ID {}: {}&quot;, id, e.getMessage(), e);</span>
<span class="nc" id="L319">        }</span>

<span class="nc" id="L321">        return false;</span>
    }

    public int countClientesActivos() {
<span class="nc" id="L325">        String sql = &quot;SELECT COUNT(*) FROM clientes WHERE activo = true&quot;;</span>

<span class="nc" id="L327">        try (Connection conn = databaseConfig.getConnection();</span>
<span class="nc" id="L328">                PreparedStatement stmt = conn.prepareStatement(sql);</span>
<span class="nc" id="L329">                ResultSet rs = stmt.executeQuery()) {</span>

<span class="nc bnc" id="L331" title="All 2 branches missed.">            if (rs.next()) {</span>
<span class="nc" id="L332">                return rs.getInt(1);</span>
            }

<span class="nc bnc" id="L335" title="All 6 branches missed.">        } catch (SQLException e) {</span>
<span class="nc" id="L336">            logger.error(&quot;Error al contar clientes activos: {}&quot;, e.getMessage(), e);</span>
<span class="nc" id="L337">        }</span>

<span class="nc" id="L339">        return 0;</span>
    }

    public int countClientesNuevosDelMes() {
<span class="nc" id="L343">        String sql = &quot;&quot;&quot;</span>
                SELECT COUNT(*) FROM clientes
                WHERE YEAR(fecha_registro) = YEAR(CURDATE())
                AND MONTH(fecha_registro) = MONTH(CURDATE())
                AND activo = true
                &quot;&quot;&quot;;

<span class="nc" id="L350">        try (Connection conn = databaseConfig.getConnection();</span>
<span class="nc" id="L351">                PreparedStatement stmt = conn.prepareStatement(sql);</span>
<span class="nc" id="L352">                ResultSet rs = stmt.executeQuery()) {</span>

<span class="nc bnc" id="L354" title="All 2 branches missed.">            if (rs.next()) {</span>
<span class="nc" id="L355">                return rs.getInt(1);</span>
            }

<span class="nc bnc" id="L358" title="All 6 branches missed.">        } catch (SQLException e) {</span>
<span class="nc" id="L359">            logger.error(&quot;Error al contar clientes nuevos del mes: {}&quot;, e.getMessage(), e);</span>
<span class="nc" id="L360">        }</span>

<span class="nc" id="L362">        return 0;</span>
    }

    public List&lt;Object[]&gt; getClientesPorCategoria() {
<span class="nc" id="L366">        String sql = &quot;&quot;&quot;</span>
                SELECT categoria_cliente, COUNT(*) as cantidad
                FROM clientes
                WHERE activo = true
                GROUP BY categoria_cliente
                ORDER BY cantidad DESC
                &quot;&quot;&quot;;

<span class="nc" id="L374">        List&lt;Object[]&gt; resultado = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L376">        try (Connection conn = databaseConfig.getConnection();</span>
<span class="nc" id="L377">                PreparedStatement stmt = conn.prepareStatement(sql);</span>
<span class="nc" id="L378">                ResultSet rs = stmt.executeQuery()) {</span>

<span class="nc bnc" id="L380" title="All 2 branches missed.">            while (rs.next()) {</span>
<span class="nc" id="L381">                resultado.add(new Object[] {</span>
<span class="nc" id="L382">                        rs.getString(&quot;categoria_cliente&quot;),</span>
<span class="nc" id="L383">                        rs.getInt(&quot;cantidad&quot;)</span>
                });
            }

<span class="nc" id="L387">        } catch (SQLException e) {</span>
<span class="nc" id="L388">            logger.error(&quot;Error al obtener clientes por categoría: {}&quot;, e.getMessage(), e);</span>
<span class="nc" id="L389">        }</span>

<span class="nc" id="L391">        return resultado;</span>
    }

    private Cliente mapResultSetToCliente(ResultSet rs) throws SQLException {
        try {
<span class="nc" id="L396">            String tipoRaw = rs.getString(&quot;tipo_cliente&quot;);</span>
<span class="nc" id="L397">            String documentoRaw = rs.getString(&quot;documento&quot;);</span>
<span class="nc" id="L398">            String razonSocialRaw = rs.getString(&quot;razon_social&quot;);</span>
<span class="nc" id="L399">            logger.info(&quot;[DEBUG RAW] tipo_cliente={} | documento={} | razon_social={}&quot;, tipoRaw, documentoRaw,</span>
                    razonSocialRaw);
<span class="nc bnc" id="L401" title="All 4 branches missed.">            if (tipoRaw == null || tipoRaw.trim().isEmpty()) {</span>
<span class="nc" id="L402">                logger.warn(&quot;[ERROR] tipo_cliente vacío o nulo en ResultSet&quot;);</span>
            }
<span class="nc bnc" id="L404" title="All 4 branches missed.">            if (documentoRaw == null || documentoRaw.trim().isEmpty()) {</span>
<span class="nc" id="L405">                logger.warn(&quot;[ERROR] documento vacío o nulo en ResultSet&quot;);</span>
            }
            // Solo advertir si el tipo es Empresa y razon_social está vacío
<span class="nc bnc" id="L408" title="All 4 branches missed.">            if (&quot;Empresa&quot;.equalsIgnoreCase(tipoRaw)</span>
<span class="nc bnc" id="L409" title="All 2 branches missed.">                    &amp;&amp; (razonSocialRaw == null || razonSocialRaw.trim().isEmpty())) {</span>
<span class="nc" id="L410">                logger.warn(&quot;[ADVERTENCIA] razon_social vacío o nulo en ResultSet para cliente Empresa&quot;);</span>
            }
<span class="nc" id="L412">        } catch (Exception ex) {</span>
<span class="nc" id="L413">            logger.error(&quot;[EXCEPCION] Error al leer campos RAW del ResultSet: {}&quot;, ex.getMessage(), ex);</span>
<span class="nc" id="L414">        }</span>
<span class="nc" id="L415">        Cliente cliente = new Cliente();</span>
<span class="nc" id="L416">        cliente.setId(rs.getInt(&quot;id&quot;));</span>
<span class="nc" id="L417">        String documento = rs.getString(&quot;documento&quot;);</span>
<span class="nc" id="L418">        String tipoCliente = rs.getString(&quot;tipo_cliente&quot;);</span>
<span class="nc" id="L419">        cliente.setTipoCliente(tipoCliente);</span>
        // Mapeo correcto de documento según tipo
<span class="nc bnc" id="L421" title="All 2 branches missed.">        if (&quot;Empresa&quot;.equalsIgnoreCase(tipoCliente)) {</span>
<span class="nc" id="L422">            cliente.setRuc(documento);</span>
<span class="nc" id="L423">            cliente.setDocumento(documento);</span>
<span class="nc" id="L424">            cliente.setRazonSocial(rs.getString(&quot;razon_social&quot;));</span>
<span class="nc" id="L425">            cliente.setDni(&quot;&quot;);</span>
        } else {
<span class="nc" id="L427">            cliente.setDni(documento);</span>
<span class="nc" id="L428">            cliente.setDocumento(documento);</span>
<span class="nc" id="L429">            cliente.setRazonSocial(&quot;&quot;);</span>
<span class="nc" id="L430">            cliente.setRuc(&quot;&quot;);</span>
        }
<span class="nc" id="L432">        cliente.setNombres(rs.getString(&quot;nombres&quot;));</span>
<span class="nc" id="L433">        cliente.setApellidos(rs.getString(&quot;apellidos&quot;));</span>
<span class="nc" id="L434">        cliente.setTelefono(rs.getString(&quot;telefono&quot;));</span>
<span class="nc" id="L435">        cliente.setEmail(rs.getString(&quot;email&quot;));</span>
<span class="nc" id="L436">        cliente.setDireccion(rs.getString(&quot;direccion&quot;));</span>
<span class="nc" id="L437">        Date fechaNacimiento = rs.getDate(&quot;fecha_nacimiento&quot;);</span>
<span class="nc bnc" id="L438" title="All 2 branches missed.">        if (fechaNacimiento != null) {</span>
<span class="nc" id="L439">            cliente.setFechaNacimiento(fechaNacimiento.toLocalDate());</span>
        }
<span class="nc" id="L441">        cliente.setPuntosTotales(rs.getInt(&quot;puntos_totales&quot;));</span>
<span class="nc" id="L442">        cliente.setPuntosUsados(rs.getInt(&quot;puntos_usados&quot;));</span>
<span class="nc" id="L443">        Timestamp created = rs.getTimestamp(&quot;created_at&quot;);</span>
<span class="nc bnc" id="L444" title="All 2 branches missed.">        if (created != null)</span>
<span class="nc" id="L445">            cliente.setCreatedAt(created.toLocalDateTime());</span>
<span class="nc" id="L446">        Timestamp updated = rs.getTimestamp(&quot;updated_at&quot;);</span>
<span class="nc bnc" id="L447" title="All 2 branches missed.">        if (updated != null)</span>
<span class="nc" id="L448">            cliente.setUpdatedAt(updated.toLocalDateTime());</span>
<span class="nc" id="L449">        logger.info(&quot;[MAPEO CLIENTE] tipo_cliente={} | documento={} | razon_social={}&quot;, cliente.getTipoCliente(),</span>
<span class="nc" id="L450">                cliente.getDocumento(), cliente.getRazonSocial());</span>
<span class="nc" id="L451">        return cliente;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>
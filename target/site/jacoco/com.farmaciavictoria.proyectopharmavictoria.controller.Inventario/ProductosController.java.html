<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ProductosController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">proyectopharmavictoria</a> &gt; <a href="index.source.html" class="el_package">com.farmaciavictoria.proyectopharmavictoria.controller.Inventario</a> &gt; <span class="el_source">ProductosController.java</span></div><h1>ProductosController.java</h1><pre class="source lang-java linenums">package com.farmaciavictoria.proyectopharmavictoria.controller.Inventario;

import com.farmaciavictoria.proyectopharmavictoria.model.Inventario.CategoriaProducto;
import com.farmaciavictoria.proyectopharmavictoria.model.Inventario.Producto;
import com.farmaciavictoria.proyectopharmavictoria.service.ProductoService;
import com.farmaciavictoria.proyectopharmavictoria.service.NotificationService;
import com.farmaciavictoria.proyectopharmavictoria.config.ServiceContainer;
import com.farmaciavictoria.proyectopharmavictoria.events.SystemEventObserver;
import com.farmaciavictoria.proyectopharmavictoria.events.SystemEvent;
import com.farmaciavictoria.proyectopharmavictoria.events.SystemEventManager;
import javafx.application.Platform;
import javafx.beans.property.SimpleStringProperty;
import javafx.beans.property.SimpleObjectProperty;
import javafx.collections.FXCollections;
import javafx.collections.ObservableList;
import javafx.collections.transformation.FilteredList;
import javafx.concurrent.Task;
import javafx.fxml.FXML;
import javafx.fxml.FXMLLoader;
import javafx.fxml.Initializable;
import javafx.scene.Parent;
import javafx.scene.Scene;
import javafx.scene.control.*;
import javafx.scene.control.cell.PropertyValueFactory;
import javafx.scene.layout.HBox;
import javafx.scene.layout.VBox;
import javafx.geometry.Insets;
import javafx.stage.Modality;
import javafx.stage.Stage;
import javafx.util.Callback;
import javafx.util.StringConverter;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import java.io.IOException;
import java.math.BigDecimal;
import java.net.URL;
import java.text.DecimalFormat;
import java.time.LocalDate;
import javafx.scene.control.cell.TextFieldTableCell;
import javafx.util.converter.BigDecimalStringConverter;
import javafx.util.converter.IntegerStringConverter;
import java.time.format.DateTimeFormatter;
import java.util.List;
import java.util.Optional;
import java.util.ResourceBundle;

public class ProductosController implements Initializable, SystemEventObserver {
    // Botones granulares para permisos
    @FXML
    private Button btnAgregarProducto;
    @FXML
    private Button btnEditarProducto;
    @FXML
    private Button btnEliminarProducto;
    @FXML
    private Button btnActivarInactivarProducto;
    @FXML
    private Button btnExportar;

    @FXML
    private Button btnPaginaAnterior;
    @FXML
    private Button btnPaginaSiguiente;
    @FXML
    private Label lblPaginaActual;
    @FXML
    private ComboBox&lt;Integer&gt; cmbTamanoPagina;

<span class="nc" id="L69">    private int paginaActual = 1;</span>
<span class="nc" id="L70">    private int totalPaginas = 1;</span>
<span class="nc" id="L71">    private int tamanoPagina = -1; // -1 = Todos por defecto</span>

<span class="nc" id="L73">    private static final Logger logger = LoggerFactory.getLogger(ProductosController.class);</span>
    @FXML
    private TableView&lt;Producto&gt; tableProductos;
    @FXML
    private TableColumn&lt;Producto, String&gt; colCodigo;
    @FXML
    private TableColumn&lt;Producto, String&gt; colNombre;
    @FXML
    private TableColumn&lt;Producto, BigDecimal&gt; colPrecioVenta;
    @FXML
    private TableColumn&lt;Producto, Integer&gt; colStockActual;
    @FXML
    private TableColumn&lt;Producto, String&gt; colFechaVencimiento;
    @FXML
    private TableColumn&lt;Producto, Boolean&gt; colEstado;
    @FXML
    private TableColumn&lt;Producto, Void&gt; colAcciones;
    @FXML
    private TextField txtBuscar;
    @FXML
    private ComboBox&lt;CategoriaProducto&gt; cmbCategoria;
    @FXML
    private Button btnEdicionMasiva;
    @FXML
    private ComboBox&lt;String&gt; cmbEstado;
    @FXML
    private CheckBox chkMostrarInactivos;
    @FXML
    private ComboBox&lt;String&gt; cmbBusquedaStrategy;
    @FXML
    private Button btnNuevoProducto;
    @FXML
    private Label lblTotalProductos;
    @FXML
    private Label lblTotalActivos;
    @FXML
    private Label lblStockBajo;
    @FXML
    private Label lblProximosVencer;
    @FXML
    private Label lblValorInventario;

    private final ProductoService productoService;
    private final NotificationService notificationService;
    private final SystemEventManager eventManager;

    private ObservableList&lt;Producto&gt; productos;
    private FilteredList&lt;Producto&gt; productosFiltrados;

<span class="nc" id="L122">    private final DecimalFormat formatoMoneda = new DecimalFormat(&quot;S/ #,##0.00&quot;);</span>
<span class="nc" id="L123">    private final DateTimeFormatter formatoFecha = DateTimeFormatter.ofPattern(&quot;dd/MM/yyyy&quot;);</span>

<span class="nc" id="L125">    public ProductosController() {</span>
        try {
<span class="nc" id="L127">            ServiceContainer container = ServiceContainer.getInstance();</span>
<span class="nc" id="L128">            this.productoService = container.getProductoService();</span>
<span class="nc" id="L129">            this.notificationService = container.getNotificationService();</span>
<span class="nc" id="L130">            this.eventManager = SystemEventManager.getInstance();</span>

<span class="nc" id="L132">            logger.info(&quot;ProductosController inicializado con enterprise patterns&quot;);</span>
<span class="nc" id="L133">        } catch (Exception e) {</span>
<span class="nc" id="L134">            logger.error(&quot;Error al inicializar ProductosController: {}&quot;, e.getMessage(), e);</span>
<span class="nc" id="L135">            throw new RuntimeException(&quot;Fallo crítico en inicialización del controlador&quot;, e);</span>
<span class="nc" id="L136">        }</span>
<span class="nc" id="L137">    }</span>

    @Override
    public void initialize(URL location, ResourceBundle resources) {
        com.farmaciavictoria.proyectopharmavictoria.model.Usuario.Usuario usuario = com.farmaciavictoria.proyectopharmavictoria.config.ServiceContainer
<span class="nc" id="L142">                .getInstance()</span>
<span class="nc" id="L143">                .getAuthenticationService().getUsuarioActual();</span>
        // Ocultar/mostrar botones principales según permisos granulares del vendedor
<span class="nc bnc" id="L145" title="All 4 branches missed.">        boolean esAdmin = usuario != null &amp;&amp; usuario.isAdmin();</span>
<span class="nc bnc" id="L146" title="All 4 branches missed.">        boolean esVendedor = usuario != null &amp;&amp; usuario.isVendedor();</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">        if (btnExportar != null) {</span>
<span class="nc" id="L148">            btnExportar.setOnAction(e -&gt; mostrarModalExportar());</span>
        }
<span class="nc" id="L150">        setupTableColumns();</span>
<span class="nc" id="L151">        initializeComponents();</span>
<span class="nc" id="L152">        loadData();</span>
<span class="nc" id="L153">        setupRowStyles();</span>
<span class="nc" id="L154">        setupFilters();</span>
<span class="nc" id="L155">        setupActionColumn();</span>
<span class="nc" id="L156">        setupEventHandlers();</span>

        // Ocultar/mostrar botones principales según permisos granulares del vendedor
        // Variables ya declaradas previamente en el método, no repetir

<span class="nc bnc" id="L161" title="All 2 branches missed.">        if (esAdmin) {</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">            if (btnNuevoProducto != null) {</span>
<span class="nc" id="L163">                btnNuevoProducto.setVisible(true);</span>
<span class="nc" id="L164">                btnNuevoProducto.setManaged(true);</span>
            }
<span class="nc bnc" id="L166" title="All 2 branches missed.">            if (btnEdicionMasiva != null) {</span>
<span class="nc" id="L167">                btnEdicionMasiva.setVisible(true);</span>
<span class="nc" id="L168">                btnEdicionMasiva.setManaged(true);</span>
            }
<span class="nc bnc" id="L170" title="All 2 branches missed.">            if (btnExportar != null) {</span>
<span class="nc" id="L171">                btnExportar.setVisible(true);</span>
<span class="nc" id="L172">                btnExportar.setManaged(true);</span>
            }
<span class="nc bnc" id="L174" title="All 2 branches missed.">        } else if (esVendedor) {</span>
            com.farmaciavictoria.proyectopharmavictoria.service.UsuarioService usuarioService = com.farmaciavictoria.proyectopharmavictoria.service.UsuarioService
<span class="nc" id="L176">                    .getInstance();</span>
<span class="nc" id="L177">            java.util.List&lt;com.farmaciavictoria.proyectopharmavictoria.model.Usuario.Usuario&gt; vendedores = usuarioService</span>
<span class="nc" id="L178">                    .obtenerUsuarios().stream()</span>
<span class="nc" id="L179">                    .filter(u -&gt; u</span>
<span class="nc bnc" id="L180" title="All 2 branches missed.">                            .getRol() == com.farmaciavictoria.proyectopharmavictoria.model.Usuario.Usuario.Rol.VENDEDOR)</span>
<span class="nc" id="L181">                    .collect(java.util.stream.Collectors.toList());</span>
            final java.util.List&lt;com.farmaciavictoria.proyectopharmavictoria.model.Usuario.UsuarioPermiso&gt; permisos;
<span class="nc bnc" id="L183" title="All 2 branches missed.">            if (!vendedores.isEmpty()) {</span>
<span class="nc" id="L184">                permisos = usuarioService.obtenerPermisos(vendedores.get(0).getId());</span>
            } else {
<span class="nc" id="L186">                permisos = java.util.Collections.emptyList();</span>
            }
<span class="nc" id="L188">            java.util.function.Function&lt;String, Boolean&gt; tienePermiso = clave -&gt; permisos.stream()</span>
<span class="nc bnc" id="L189" title="All 4 branches missed.">                    .anyMatch(p -&gt; clave.equals(p.getPermiso()) &amp;&amp; p.isValor());</span>

<span class="nc bnc" id="L191" title="All 2 branches missed.">            if (btnNuevoProducto != null) {</span>
<span class="nc" id="L192">                boolean visible = tienePermiso.apply(&quot;inventario.agregar&quot;);</span>
<span class="nc" id="L193">                btnNuevoProducto.setVisible(visible);</span>
<span class="nc" id="L194">                btnNuevoProducto.setManaged(visible);</span>
            }
<span class="nc bnc" id="L196" title="All 2 branches missed.">            if (btnEdicionMasiva != null) {</span>
<span class="nc" id="L197">                boolean visible = tienePermiso.apply(&quot;inventario.edicion_masiva&quot;);</span>
<span class="nc" id="L198">                btnEdicionMasiva.setVisible(visible);</span>
<span class="nc" id="L199">                btnEdicionMasiva.setManaged(visible);</span>
            }
<span class="nc bnc" id="L201" title="All 2 branches missed.">            if (btnExportar != null) {</span>
<span class="nc" id="L202">                boolean visible = tienePermiso.apply(&quot;inventario.exportar&quot;);</span>
<span class="nc" id="L203">                btnExportar.setVisible(visible);</span>
<span class="nc" id="L204">                btnExportar.setManaged(visible);</span>
            }
<span class="nc" id="L206">        } else {</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">            if (btnNuevoProducto != null) {</span>
<span class="nc" id="L208">                btnNuevoProducto.setVisible(false);</span>
<span class="nc" id="L209">                btnNuevoProducto.setManaged(false);</span>
            }
<span class="nc bnc" id="L211" title="All 2 branches missed.">            if (btnEdicionMasiva != null) {</span>
<span class="nc" id="L212">                btnEdicionMasiva.setVisible(false);</span>
<span class="nc" id="L213">                btnEdicionMasiva.setManaged(false);</span>
            }
<span class="nc bnc" id="L215" title="All 2 branches missed.">            if (btnExportar != null) {</span>
<span class="nc" id="L216">                btnExportar.setVisible(false);</span>
<span class="nc" id="L217">                btnExportar.setManaged(false);</span>
            }
        }

        // Suscribirse al Observer para recibir eventos del sistema
<span class="nc" id="L222">        eventManager.subscribe(this);</span>

<span class="nc" id="L224">        mostrarNotificacionesInventario();</span>

<span class="nc bnc" id="L226" title="All 2 branches missed.">        if (esAdmin) {</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">            if (btnNuevoProducto != null) {</span>
<span class="nc" id="L228">                btnNuevoProducto.setVisible(true);</span>
<span class="nc" id="L229">                btnNuevoProducto.setManaged(true);</span>
            }
<span class="nc bnc" id="L231" title="All 2 branches missed.">            if (btnEdicionMasiva != null) {</span>
<span class="nc" id="L232">                btnEdicionMasiva.setVisible(true);</span>
<span class="nc" id="L233">                btnEdicionMasiva.setManaged(true);</span>
            }
<span class="nc bnc" id="L235" title="All 2 branches missed.">            if (lblValorInventario != null) {</span>
<span class="nc" id="L236">                lblValorInventario.setVisible(true);</span>
<span class="nc" id="L237">                lblValorInventario.setManaged(true);</span>
            }
<span class="nc bnc" id="L239" title="All 2 branches missed.">            if (btnAgregarProducto != null) {</span>
<span class="nc" id="L240">                btnAgregarProducto.setVisible(true);</span>
<span class="nc" id="L241">                btnAgregarProducto.setManaged(true);</span>
            }
<span class="nc bnc" id="L243" title="All 2 branches missed.">            if (btnEditarProducto != null) {</span>
<span class="nc" id="L244">                btnEditarProducto.setVisible(true);</span>
<span class="nc" id="L245">                btnEditarProducto.setManaged(true);</span>
            }
<span class="nc bnc" id="L247" title="All 2 branches missed.">            if (btnEliminarProducto != null) {</span>
<span class="nc" id="L248">                btnEliminarProducto.setVisible(true);</span>
<span class="nc" id="L249">                btnEliminarProducto.setManaged(true);</span>
            }
<span class="nc bnc" id="L251" title="All 2 branches missed.">            if (btnActivarInactivarProducto != null) {</span>
<span class="nc" id="L252">                btnActivarInactivarProducto.setVisible(true);</span>
<span class="nc" id="L253">                btnActivarInactivarProducto.setManaged(true);</span>
            }
<span class="nc bnc" id="L255" title="All 2 branches missed.">            if (btnExportar != null) {</span>
<span class="nc" id="L256">                btnExportar.setVisible(true);</span>
<span class="nc" id="L257">                btnExportar.setManaged(true);</span>
            }
<span class="nc bnc" id="L259" title="All 2 branches missed.">        } else if (esVendedor) {</span>
            // Obtener permisos granulares del primer vendedor (global)
            com.farmaciavictoria.proyectopharmavictoria.service.UsuarioService usuarioService = com.farmaciavictoria.proyectopharmavictoria.service.UsuarioService
<span class="nc" id="L262">                    .getInstance();</span>
<span class="nc" id="L263">            java.util.List&lt;com.farmaciavictoria.proyectopharmavictoria.model.Usuario.Usuario&gt; vendedores = usuarioService</span>
<span class="nc" id="L264">                    .obtenerUsuarios()</span>
<span class="nc" id="L265">                    .stream()</span>
<span class="nc" id="L266">                    .filter(u -&gt; u</span>
<span class="nc bnc" id="L267" title="All 2 branches missed.">                            .getRol() == com.farmaciavictoria.proyectopharmavictoria.model.Usuario.Usuario.Rol.VENDEDOR)</span>
<span class="nc" id="L268">                    .collect(java.util.stream.Collectors.toList());</span>
            final java.util.List&lt;com.farmaciavictoria.proyectopharmavictoria.model.Usuario.UsuarioPermiso&gt; permisos;
<span class="nc bnc" id="L270" title="All 2 branches missed.">            if (!vendedores.isEmpty()) {</span>
<span class="nc" id="L271">                permisos = usuarioService.obtenerPermisos(vendedores.get(0).getId());</span>
            } else {
<span class="nc" id="L273">                permisos = java.util.Collections.emptyList();</span>
            }
<span class="nc" id="L275">            java.util.function.Function&lt;String, Boolean&gt; tienePermiso = clave -&gt; permisos.stream()</span>
<span class="nc bnc" id="L276" title="All 4 branches missed.">                    .anyMatch(p -&gt; clave.equals(p.getPermiso()) &amp;&amp; p.isValor());</span>

<span class="nc bnc" id="L278" title="All 2 branches missed.">            if (btnNuevoProducto != null) {</span>
<span class="nc" id="L279">                boolean visible = tienePermiso.apply(&quot;inventario.agregar&quot;);</span>
<span class="nc" id="L280">                btnNuevoProducto.setVisible(visible);</span>
<span class="nc" id="L281">                btnNuevoProducto.setManaged(visible);</span>
            }
<span class="nc bnc" id="L283" title="All 2 branches missed.">            if (btnEdicionMasiva != null) {</span>
<span class="nc" id="L284">                boolean visible = tienePermiso.apply(&quot;inventario.edicion_masiva&quot;);</span>
<span class="nc" id="L285">                btnEdicionMasiva.setVisible(visible);</span>
<span class="nc" id="L286">                btnEdicionMasiva.setManaged(visible);</span>
            }
<span class="nc bnc" id="L288" title="All 2 branches missed.">            if (btnAgregarProducto != null) {</span>
<span class="nc" id="L289">                boolean visible = tienePermiso.apply(&quot;inventario.agregar&quot;);</span>
<span class="nc" id="L290">                btnAgregarProducto.setVisible(visible);</span>
<span class="nc" id="L291">                btnAgregarProducto.setManaged(visible);</span>
            }
<span class="nc bnc" id="L293" title="All 2 branches missed.">            if (btnEditarProducto != null) {</span>
<span class="nc" id="L294">                boolean visible = tienePermiso.apply(&quot;inventario.editar&quot;);</span>
<span class="nc" id="L295">                btnEditarProducto.setVisible(visible);</span>
<span class="nc" id="L296">                btnEditarProducto.setManaged(visible);</span>
            }
<span class="nc bnc" id="L298" title="All 2 branches missed.">            if (btnEliminarProducto != null) {</span>
<span class="nc" id="L299">                boolean visible = tienePermiso.apply(&quot;inventario.eliminar&quot;);</span>
<span class="nc" id="L300">                btnEliminarProducto.setVisible(visible);</span>
<span class="nc" id="L301">                btnEliminarProducto.setManaged(visible);</span>
            }
<span class="nc bnc" id="L303" title="All 2 branches missed.">            if (btnActivarInactivarProducto != null) {</span>
<span class="nc" id="L304">                boolean visible = tienePermiso.apply(&quot;inventario.activar_inactivar&quot;);</span>
<span class="nc" id="L305">                btnActivarInactivarProducto.setVisible(visible);</span>
<span class="nc" id="L306">                btnActivarInactivarProducto.setManaged(visible);</span>
            }
<span class="nc bnc" id="L308" title="All 2 branches missed.">            if (btnExportar != null) {</span>
<span class="nc" id="L309">                boolean visible = tienePermiso.apply(&quot;inventario.exportar&quot;);</span>
<span class="nc" id="L310">                btnExportar.setVisible(visible);</span>
<span class="nc" id="L311">                btnExportar.setManaged(visible);</span>
            }
            // Estadística: valor inventario solo para admin
<span class="nc bnc" id="L314" title="All 2 branches missed.">            if (lblValorInventario != null) {</span>
<span class="nc" id="L315">                lblValorInventario.setVisible(false);</span>
<span class="nc" id="L316">                lblValorInventario.setManaged(false);</span>
            }
        }
<span class="nc" id="L319">    }</span>

    @FXML
    public void onExportar(javafx.event.ActionEvent event) {
<span class="nc" id="L323">        mostrarModalExportar();</span>
<span class="nc" id="L324">    }</span>

    private void mostrarModalExportar() {
        try {
<span class="nc" id="L328">            FXMLLoader loader = new FXMLLoader(getClass().getResource(&quot;/fxml/Inventario/exportar-inventario.fxml&quot;));</span>
<span class="nc" id="L329">            Parent root = loader.load();</span>
<span class="nc" id="L330">            ExportarInventarioController exportController = loader.getController();</span>
<span class="nc" id="L331">            exportController.setProductosFiltrados(new java.util.ArrayList&lt;&gt;(productosFiltrados));</span>
<span class="nc" id="L332">            Stage stage = new Stage();</span>
<span class="nc" id="L333">            stage.setTitle(&quot;Exportar Inventario / Reporte&quot;);</span>
<span class="nc" id="L334">            stage.setScene(new Scene(root));</span>
<span class="nc" id="L335">            stage.initModality(Modality.APPLICATION_MODAL);</span>
<span class="nc" id="L336">            stage.setResizable(true);</span>
<span class="nc" id="L337">            stage.setMinWidth(900);</span>
<span class="nc" id="L338">            stage.setMinHeight(600);</span>
<span class="nc" id="L339">            stage.showAndWait();</span>
<span class="nc" id="L340">        } catch (IOException ex) {</span>
<span class="nc" id="L341">            ex.printStackTrace();</span>
<span class="nc" id="L342">            notificationService.mostrarError(&quot;No se pudo abrir la ventana de exportación: &quot; + ex.getMessage());</span>
<span class="nc" id="L343">        }</span>
<span class="nc" id="L344">    }</span>

    @Override
    public void onEvent(SystemEvent event) {
<span class="nc" id="L348">        Platform.runLater(() -&gt; {</span>
            try {
<span class="nc bnc" id="L350" title="All 4 branches missed.">                switch (event.getTipo()) {</span>
                    case PRODUCTO_CREADO:
                    case PRODUCTO_ACTUALIZADO:
                    case PRODUCTO_ELIMINADO:
<span class="nc" id="L354">                        logger.debug(&quot;Recibido evento de producto: {}&quot;, event.getTipo());</span>
<span class="nc" id="L355">                        loadData();</span>
<span class="nc" id="L356">                        break;</span>
                    case STOCK_BAJO:
<span class="nc" id="L358">                        logger.debug(&quot;Evento de stock bajo recibido: {}&quot;, event.getMensaje());</span>
<span class="nc" id="L359">                        break;</span>
                    case PRODUCTO_VENCIMIENTO_PROXIMO:
<span class="nc" id="L361">                        logger.debug(&quot;Evento de vencimiento próximo recibido: {}&quot;, event.getMensaje());</span>
<span class="nc" id="L362">                        break;</span>
                    default:
<span class="nc" id="L364">                        logger.debug(&quot;Evento no manejado: {}&quot;, event.getTipo());</span>
                }
<span class="nc" id="L366">            } catch (Exception e) {</span>
<span class="nc" id="L367">                logger.error(&quot;Error al procesar evento {}: {}&quot;, event.getTipo(), e.getMessage(), e);</span>
<span class="nc" id="L368">            }</span>
<span class="nc" id="L369">        });</span>
<span class="nc" id="L370">    }</span>

    @Override
    public String getObserverId() {
<span class="nc" id="L374">        return &quot;ProductosController-&quot; + this.hashCode();</span>
    }

    private void initializeComponents() {
<span class="nc" id="L378">        productos = FXCollections.observableArrayList();</span>
<span class="nc" id="L379">        productosFiltrados = new FilteredList&lt;&gt;(productos, p -&gt; true);</span>
<span class="nc" id="L380">        tableProductos.setItems(productosFiltrados);</span>

        // Inicializar opciones de paginación
<span class="nc bnc" id="L383" title="All 2 branches missed.">        if (cmbTamanoPagina != null) {</span>
<span class="nc" id="L384">            cmbTamanoPagina.getItems().clear();</span>
<span class="nc" id="L385">            cmbTamanoPagina.getItems().addAll(-1, 5, 10, 20, 50); // -1 = Todos</span>
<span class="nc" id="L386">            cmbTamanoPagina.setValue(-1);</span>
<span class="nc" id="L387">            cmbTamanoPagina.setConverter(new javafx.util.StringConverter&lt;Integer&gt;() {</span>
                @Override
                public String toString(Integer value) {
<span class="nc bnc" id="L390" title="All 4 branches missed.">                    if (value == null || value == -1)</span>
<span class="nc" id="L391">                        return &quot;Todos&quot;;</span>
<span class="nc" id="L392">                    return value.toString();</span>
                }

                @Override
                public Integer fromString(String string) {
<span class="nc bnc" id="L397" title="All 2 branches missed.">                    if (&quot;Todos&quot;.equals(string))</span>
<span class="nc" id="L398">                        return -1;</span>
                    try {
<span class="nc" id="L400">                        return Integer.parseInt(string);</span>
<span class="nc" id="L401">                    } catch (Exception e) {</span>
<span class="nc" id="L402">                        return -1;</span>
                    }
                }
            });
<span class="nc" id="L406">            cmbTamanoPagina.setCellFactory(listView -&gt; new javafx.scene.control.ListCell&lt;Integer&gt;() {</span>
                @Override
                protected void updateItem(Integer item, boolean empty) {
<span class="nc" id="L409">                    super.updateItem(item, empty);</span>
<span class="nc bnc" id="L410" title="All 4 branches missed.">                    if (empty || item == null) {</span>
<span class="nc" id="L411">                        setText(null);</span>
                    } else {
<span class="nc bnc" id="L413" title="All 2 branches missed.">                        setText(item == -1 ? &quot;Todos&quot; : item.toString());</span>
                    }
<span class="nc" id="L415">                }</span>
            });
<span class="nc" id="L417">            cmbTamanoPagina.setButtonCell(new javafx.scene.control.ListCell&lt;Integer&gt;() {</span>
                @Override
                protected void updateItem(Integer item, boolean empty) {
<span class="nc" id="L420">                    super.updateItem(item, empty);</span>
<span class="nc bnc" id="L421" title="All 4 branches missed.">                    if (empty || item == null) {</span>
<span class="nc" id="L422">                        setText(null);</span>
                    } else {
<span class="nc bnc" id="L424" title="All 2 branches missed.">                        setText(item == -1 ? &quot;Todos&quot; : item.toString());</span>
                    }
<span class="nc" id="L426">                }</span>
            });
<span class="nc" id="L428">            cmbTamanoPagina.valueProperty().addListener((obs, oldVal, newVal) -&gt; {</span>
<span class="nc" id="L429">                tamanoPagina = newVal;</span>
<span class="nc" id="L430">                paginaActual = 1;</span>
<span class="nc" id="L431">                actualizarPaginacion();</span>
<span class="nc" id="L432">                actualizarEstadisticas();</span>
<span class="nc" id="L433">            });</span>
            // Mostrar todos por defecto al iniciar
<span class="nc" id="L435">            paginaActual = 1;</span>
<span class="nc" id="L436">            actualizarPaginacion();</span>
<span class="nc" id="L437">            actualizarEstadisticas();</span>
        }

        // Inicializar opciones de estrategia de búsqueda
<span class="nc bnc" id="L441" title="All 2 branches missed.">        if (cmbBusquedaStrategy != null) {</span>
<span class="nc" id="L442">            cmbBusquedaStrategy.getItems().clear();</span>
<span class="nc" id="L443">            cmbBusquedaStrategy.getItems().addAll(&quot;Nombre&quot;, &quot;Laboratorio&quot;, &quot;Lote&quot;, &quot;Proveedor&quot;, &quot;Vencimiento&quot;);</span>
<span class="nc" id="L444">            cmbBusquedaStrategy.setValue(&quot;Nombre&quot;);</span>
<span class="nc" id="L445">            cmbBusquedaStrategy.valueProperty().addListener((obs, oldVal, newVal) -&gt; {</span>
<span class="nc" id="L446">                aplicarFiltros();</span>
<span class="nc" id="L447">            });</span>
        }
<span class="nc" id="L449">        logger.debug(&quot;Componentes de UI inicializados&quot;);</span>
<span class="nc" id="L450">    }</span>

    private void setupTableColumns() {
<span class="nc" id="L453">        colPrecioVenta.setCellFactory(TextFieldTableCell.forTableColumn(new BigDecimalStringConverter()));</span>
<span class="nc" id="L454">        colPrecioVenta.setOnEditCommit(event -&gt; {</span>
<span class="nc" id="L455">            Producto producto = event.getRowValue();</span>
<span class="nc" id="L456">            productoService.actualizarCampo(producto.getId(), &quot;precio_venta&quot;, event.getNewValue());</span>
            // Consultar el valor actualizado desde la base de datos
<span class="nc" id="L458">            Producto actualizado = productoService.obtenerPorId(producto.getId());</span>
<span class="nc bnc" id="L459" title="All 2 branches missed.">            if (actualizado != null) {</span>
<span class="nc" id="L460">                producto.setPrecioVenta(actualizado.getPrecioVenta());</span>
            } else {
<span class="nc" id="L462">                producto.setPrecioVenta(event.getNewValue());</span>
            }
<span class="nc" id="L464">            tableProductos.refresh();</span>
<span class="nc" id="L465">        });</span>

<span class="nc" id="L467">        colStockActual.setCellFactory(TextFieldTableCell.forTableColumn(new IntegerStringConverter()));</span>
<span class="nc" id="L468">        colStockActual.setOnEditCommit(event -&gt; {</span>
<span class="nc" id="L469">            Producto producto = event.getRowValue();</span>
<span class="nc" id="L470">            producto.setStockActual(event.getNewValue());</span>
<span class="nc" id="L471">            productoService.actualizarCampo(producto.getId(), &quot;stock_actual&quot;, event.getNewValue());</span>
<span class="nc" id="L472">            tableProductos.refresh();</span>
<span class="nc" id="L473">        });</span>

<span class="nc" id="L475">        colFechaVencimiento.setCellFactory(TextFieldTableCell.forTableColumn());</span>
<span class="nc" id="L476">        colFechaVencimiento.setOnEditCommit(event -&gt; {</span>
<span class="nc" id="L477">            Producto producto = event.getRowValue();</span>
            try {
<span class="nc" id="L479">                LocalDate nuevaFecha = LocalDate.parse(event.getNewValue(), formatoFecha);</span>
<span class="nc" id="L480">                productoService.actualizarCampo(producto.getId(), &quot;fecha_vencimiento&quot;, nuevaFecha);</span>
                // Consultar el valor actualizado desde la base de datos
<span class="nc" id="L482">                Producto actualizado = productoService.obtenerPorId(producto.getId());</span>
<span class="nc bnc" id="L483" title="All 2 branches missed.">                if (actualizado != null) {</span>
<span class="nc" id="L484">                    producto.setFechaVencimiento(actualizado.getFechaVencimiento());</span>
                } else {
<span class="nc" id="L486">                    producto.setFechaVencimiento(nuevaFecha);</span>
                }
<span class="nc" id="L488">            } catch (Exception e) {</span>
                // Si la fecha no es válida, no actualiza
<span class="nc" id="L490">            }</span>
<span class="nc" id="L491">            tableProductos.refresh();</span>
<span class="nc" id="L492">        });</span>

        // Ejemplo para nombre, puedes replicar para los demás campos editables
<span class="nc" id="L495">        colNombre.setCellFactory(TextFieldTableCell.forTableColumn());</span>
<span class="nc" id="L496">        colNombre.setOnEditCommit(event -&gt; {</span>
<span class="nc" id="L497">            Producto producto = event.getRowValue();</span>
<span class="nc" id="L498">            producto.setNombre(event.getNewValue());</span>
<span class="nc" id="L499">            productoService.actualizarCampo(producto.getId(), &quot;nombre&quot;, event.getNewValue());</span>
<span class="nc" id="L500">            tableProductos.refresh();</span>
<span class="nc" id="L501">        });</span>

        // Repetir para otros campos editables si lo necesitas (categoría, proveedor,
        // etc.)

<span class="nc" id="L506">        tableProductos.setEditable(true);</span>
        // Configurar columnas básicas
<span class="nc" id="L508">        colCodigo.setCellValueFactory(new PropertyValueFactory&lt;&gt;(&quot;codigo&quot;));</span>
<span class="nc" id="L509">        colNombre.setCellValueFactory(new PropertyValueFactory&lt;&gt;(&quot;nombre&quot;));</span>

        // Precio con formato y consulta en BD
<span class="nc" id="L512">        colPrecioVenta.setCellValueFactory(cellData -&gt; {</span>
<span class="nc" id="L513">            Producto p = cellData.getValue();</span>
<span class="nc" id="L514">            BigDecimal precio = null;</span>
            try {
<span class="nc" id="L516">                Producto actualizado = productoService.obtenerPorId(p.getId());</span>
<span class="nc bnc" id="L517" title="All 2 branches missed.">                precio = actualizado != null ? actualizado.getPrecioVenta() : p.getPrecioVenta();</span>
<span class="nc" id="L518">            } catch (Exception e) {</span>
<span class="nc" id="L519">                precio = p.getPrecioVenta();</span>
<span class="nc" id="L520">            }</span>
<span class="nc" id="L521">            return new SimpleObjectProperty&lt;&gt;(precio);</span>
        });
<span class="nc" id="L523">        colPrecioVenta.setCellFactory(column -&gt; new TableCell&lt;Producto, BigDecimal&gt;() {</span>
            @Override
            protected void updateItem(BigDecimal item, boolean empty) {
<span class="nc" id="L526">                super.updateItem(item, empty);</span>
<span class="nc bnc" id="L527" title="All 4 branches missed.">                if (empty || item == null) {</span>
<span class="nc" id="L528">                    setText(null);</span>
                } else {
<span class="nc" id="L530">                    setText(formatoMoneda.format(item));</span>
                }
<span class="nc" id="L532">            }</span>
        });

<span class="nc" id="L535">        colStockActual.setCellValueFactory(cellData -&gt; {</span>
<span class="nc" id="L536">            Producto p = cellData.getValue();</span>
<span class="nc" id="L537">            Integer stock = null;</span>
            try {
<span class="nc" id="L539">                Producto actualizado = productoService.obtenerPorId(p.getId());</span>
<span class="nc bnc" id="L540" title="All 2 branches missed.">                stock = actualizado != null ? actualizado.getStockActual() : p.getStockActual();</span>
<span class="nc" id="L541">            } catch (Exception e) {</span>
<span class="nc" id="L542">                stock = p.getStockActual();</span>
<span class="nc" id="L543">            }</span>
<span class="nc" id="L544">            return new SimpleObjectProperty&lt;&gt;(stock);</span>
        });

        // Fecha de vencimiento consultando en BD
<span class="nc" id="L548">        colFechaVencimiento.setCellValueFactory(cellData -&gt; {</span>
<span class="nc" id="L549">            Producto p = cellData.getValue();</span>
<span class="nc" id="L550">            LocalDate fecha = null;</span>
            try {
<span class="nc" id="L552">                Producto actualizado = productoService.obtenerPorId(p.getId());</span>
<span class="nc bnc" id="L553" title="All 2 branches missed.">                fecha = actualizado != null ? actualizado.getFechaVencimiento() : p.getFechaVencimiento();</span>
<span class="nc" id="L554">            } catch (Exception e) {</span>
<span class="nc" id="L555">                fecha = p.getFechaVencimiento();</span>
<span class="nc" id="L556">            }</span>
<span class="nc bnc" id="L557" title="All 2 branches missed.">            if (fecha != null) {</span>
<span class="nc" id="L558">                return new SimpleStringProperty(fecha.format(formatoFecha));</span>
            }
<span class="nc" id="L560">            return new SimpleStringProperty(&quot;Sin fecha&quot;);</span>
        });

        // Estado con colores y fondo especial si es inactivo
<span class="nc" id="L564">        colEstado.setCellValueFactory(new PropertyValueFactory&lt;&gt;(&quot;activo&quot;));</span>
<span class="nc" id="L565">        colEstado.setCellFactory(column -&gt; new TableCell&lt;Producto, Boolean&gt;() {</span>
            @Override
            protected void updateItem(Boolean item, boolean empty) {
<span class="nc" id="L568">                super.updateItem(item, empty);</span>
<span class="nc bnc" id="L569" title="All 4 branches missed.">                if (empty || item == null) {</span>
<span class="nc" id="L570">                    setText(null);</span>
<span class="nc" id="L571">                    setStyle(&quot;&quot;);</span>
                } else {
<span class="nc bnc" id="L573" title="All 2 branches missed.">                    if (item) {</span>
<span class="nc" id="L574">                        setText(&quot;Activo&quot;);</span>
<span class="nc" id="L575">                        setStyle(&quot;-fx-text-fill: #28a745; -fx-font-weight: bold; -fx-background-color: transparent;&quot;);</span>
                    } else {
<span class="nc" id="L577">                        setText(&quot;Inactivo&quot;);</span>
<span class="nc" id="L578">                        setStyle(&quot;-fx-text-fill: #dc3545; -fx-font-weight: bold; -fx-background-color: #F3F4F6;&quot;);</span>
                    }
                }
<span class="nc" id="L581">            }</span>
        });
<span class="nc" id="L583">    }</span>

    private void setupRowStyles() {
<span class="nc" id="L586">        tableProductos.setRowFactory(tv -&gt; {</span>
<span class="nc" id="L587">            TableRow&lt;Producto&gt; row = new TableRow&lt;&gt;();</span>
<span class="nc" id="L588">            row.itemProperty().addListener((obs, oldProducto, newProducto) -&gt; {</span>
<span class="nc bnc" id="L589" title="All 2 branches missed.">                if (newProducto == null) {</span>
<span class="nc" id="L590">                    row.getStyleClass().removeAll(&quot;row-stock-bajo&quot;, &quot;row-proximo-vencer&quot;,</span>
                            &quot;row-sin-stock&quot;, &quot;row-vencido&quot;, &quot;row-inactivo&quot;);
                } else {
                    // Limpiar estilos anteriores
<span class="nc" id="L594">                    row.getStyleClass().removeAll(&quot;row-stock-bajo&quot;, &quot;row-proximo-vencer&quot;,</span>
                            &quot;row-sin-stock&quot;, &quot;row-vencido&quot;, &quot;row-inactivo&quot;);

                    // Aplicar estilos según el estado del producto
<span class="nc bnc" id="L598" title="All 2 branches missed.">                    if (!newProducto.getActivo()) {</span>
<span class="nc" id="L599">                        row.getStyleClass().add(&quot;row-inactivo&quot;);</span>
<span class="nc bnc" id="L600" title="All 2 branches missed.">                    } else if (newProducto.getFechaVencimiento() != null &amp;&amp;</span>
<span class="nc bnc" id="L601" title="All 2 branches missed.">                            newProducto.getFechaVencimiento().isBefore(LocalDate.now())) {</span>
<span class="nc" id="L602">                        row.getStyleClass().add(&quot;row-vencido&quot;);</span>
<span class="nc bnc" id="L603" title="All 2 branches missed.">                    } else if (newProducto.getStockActual() == 0) {</span>
<span class="nc" id="L604">                        row.getStyleClass().add(&quot;row-sin-stock&quot;);</span>
<span class="nc bnc" id="L605" title="All 2 branches missed.">                    } else if (newProducto.getStockActual() &lt;= newProducto.getStockMinimo()) {</span>
<span class="nc" id="L606">                        row.getStyleClass().add(&quot;row-stock-bajo&quot;);</span>
<span class="nc bnc" id="L607" title="All 2 branches missed.">                    } else if (newProducto.getFechaVencimiento() != null) {</span>
                        int dias = com.farmaciavictoria.proyectopharmavictoria.service.ProductoService
<span class="nc" id="L609">                                .getDiasVencimientoAlerta();</span>
<span class="nc" id="L610">                        java.time.LocalDate hoy = java.time.LocalDate.now();</span>
<span class="nc" id="L611">                        java.time.LocalDate limite = hoy.plusDays(dias);</span>
<span class="nc bnc" id="L612" title="All 2 branches missed.">                        if (!newProducto.getFechaVencimiento().isBefore(hoy) &amp;&amp;</span>
<span class="nc bnc" id="L613" title="All 2 branches missed.">                                !newProducto.getFechaVencimiento().isAfter(limite)) {</span>
<span class="nc" id="L614">                            row.getStyleClass().add(&quot;row-proximo-vencer&quot;);</span>
                        }
                    }
                }
<span class="nc" id="L618">            });</span>
<span class="nc" id="L619">            return row;</span>
        });
<span class="nc" id="L621">    }</span>

    private void setupFilters() {
        // Configurar ComboBox de categorías
<span class="nc" id="L625">        cmbCategoria.getItems().add(null); // Opción &quot;Todas&quot;</span>
<span class="nc" id="L626">        cmbCategoria.getItems().addAll(CategoriaProducto.values());</span>
<span class="nc" id="L627">        cmbCategoria.setConverter(new StringConverter&lt;CategoriaProducto&gt;() {</span>
            @Override
            public String toString(CategoriaProducto categoria) {
<span class="nc bnc" id="L630" title="All 2 branches missed.">                return categoria == null ? &quot;Todas las categorías&quot; : categoria.toString();</span>
            }

            @Override
            public CategoriaProducto fromString(String string) {
<span class="nc" id="L635">                return null;</span>
            }
        });

        // Configurar ComboBox de estados con opciones especiales
<span class="nc" id="L640">        cmbEstado.getItems().addAll(</span>
                &quot;Todos&quot;,
                &quot;Activo&quot;,
                &quot;Inactivo&quot;,
                &quot;Stock Bajo&quot;,
                &quot;Próximos a Vencer&quot;,
                &quot;Sin Stock&quot;,
                &quot;Productos Vencidos&quot;);
<span class="nc" id="L648">        cmbEstado.setValue(&quot;Todos&quot;);</span>
<span class="nc" id="L649">    }</span>

    private void setupActionColumn() {
<span class="nc" id="L652">        colAcciones.setCellFactory(new Callback&lt;TableColumn&lt;Producto, Void&gt;, TableCell&lt;Producto, Void&gt;&gt;() {</span>
            @Override
            public TableCell&lt;Producto, Void&gt; call(TableColumn&lt;Producto, Void&gt; param) {
<span class="nc" id="L655">                return new TableCell&lt;Producto, Void&gt;() {</span>
<span class="nc" id="L656">                    private final Button btnEditar = new Button();</span>
<span class="nc" id="L657">                    private final Button btnVer = new Button();</span>
<span class="nc" id="L658">                    private final Button btnToggleEstado = new Button();</span>
<span class="nc" id="L659">                    private final Button btnEliminar = new Button();</span>

                    {
                        // Íconos personalizados para agregar, ver y eliminar
                        // Usar imágenes descargadas como íconos
                        // Íconos correctos para acciones: editar, ver detalles y eliminar
<span class="nc" id="L665">                        javafx.scene.image.ImageView iconEditar = new javafx.scene.image.ImageView(</span>
<span class="nc" id="L666">                                getClass().getResource(&quot;/icons/editar.png&quot;).toExternalForm());</span>
<span class="nc" id="L667">                        javafx.scene.image.ImageView iconVer = new javafx.scene.image.ImageView(</span>
<span class="nc" id="L668">                                getClass().getResource(&quot;/icons/ver.png&quot;).toExternalForm());</span>
<span class="nc" id="L669">                        javafx.scene.image.ImageView iconEliminar = new javafx.scene.image.ImageView(</span>
<span class="nc" id="L670">                                getClass().getResource(&quot;/icons/eliminar.png&quot;).toExternalForm());</span>

<span class="nc" id="L672">                        iconEditar.setFitWidth(24);</span>
<span class="nc" id="L673">                        iconEditar.setFitHeight(24);</span>
<span class="nc" id="L674">                        iconVer.setFitWidth(24);</span>
<span class="nc" id="L675">                        iconVer.setFitHeight(24);</span>
<span class="nc" id="L676">                        iconEliminar.setFitWidth(24);</span>
<span class="nc" id="L677">                        iconEliminar.setFitHeight(24);</span>

<span class="nc" id="L679">                        btnEditar.setGraphic(iconEditar);</span>
<span class="nc" id="L680">                        btnVer.setGraphic(iconVer);</span>
<span class="nc" id="L681">                        btnEliminar.setGraphic(iconEliminar);</span>
<span class="nc" id="L682">                        btnEditar.getStyleClass().setAll(&quot;btn-action&quot;, &quot;btn-add&quot;);</span>
<span class="nc" id="L683">                        btnVer.getStyleClass().setAll(&quot;btn-action&quot;, &quot;btn-eye&quot;);</span>
<span class="nc" id="L684">                        btnToggleEstado.getStyleClass().setAll(&quot;btn-action&quot;, &quot;btn-toggle&quot;);</span>
<span class="nc bnc" id="L685" title="All 6 branches missed.">                        if (btnPaginaAnterior != null &amp;&amp; btnPaginaSiguiente != null &amp;&amp; lblPaginaActual != null) {</span>
<span class="nc" id="L686">                            btnPaginaAnterior.setOnAction(e -&gt; onPaginaAnterior());</span>
<span class="nc" id="L687">                            btnPaginaSiguiente.setOnAction(e -&gt; onPaginaSiguiente());</span>
                        }
<span class="nc" id="L689">                        btnEliminar.getStyleClass().setAll(&quot;btn-action&quot;, &quot;btn-trash&quot;);</span>
<span class="nc" id="L690">                        btnEditar.setPrefWidth(35);</span>
<span class="nc" id="L691">                        btnEditar.setPrefHeight(35);</span>
<span class="nc" id="L692">                        btnVer.setPrefWidth(35);</span>
<span class="nc" id="L693">                        btnVer.setPrefHeight(35);</span>
<span class="nc" id="L694">                        btnToggleEstado.setPrefWidth(35);</span>
<span class="nc" id="L695">                        btnToggleEstado.setPrefHeight(35);</span>
<span class="nc" id="L696">                        btnEliminar.setPrefWidth(35);</span>
<span class="nc" id="L697">                        btnEliminar.setPrefHeight(35);</span>

<span class="nc" id="L699">                        btnEditar.setOnAction(e -&gt; {</span>
<span class="nc" id="L700">                            Producto producto = getTableView().getItems().get(getIndex());</span>
<span class="nc" id="L701">                            editarProducto(producto);</span>
<span class="nc" id="L702">                        });</span>
<span class="nc" id="L703">                        btnVer.setOnAction(e -&gt; {</span>
<span class="nc" id="L704">                            Producto producto = getTableView().getItems().get(getIndex());</span>
<span class="nc" id="L705">                            verDetallesProducto(producto);</span>
<span class="nc" id="L706">                        });</span>
<span class="nc" id="L707">                        btnToggleEstado.setOnAction(e -&gt; {</span>
<span class="nc" id="L708">                            Producto producto = getTableView().getItems().get(getIndex());</span>
<span class="nc" id="L709">                            toggleEstadoProducto(producto);</span>
<span class="nc" id="L710">                        });</span>
<span class="nc" id="L711">                        btnEliminar.setOnAction(e -&gt; {</span>
<span class="nc" id="L712">                            Producto producto = getTableView().getItems().get(getIndex());</span>
<span class="nc" id="L713">                            eliminarProductoDefinitivo(producto);</span>
<span class="nc" id="L714">                        });</span>
<span class="nc" id="L715">                    }</span>

                    @Override
                    protected void updateItem(Void item, boolean empty) {
<span class="nc" id="L719">                        super.updateItem(item, empty);</span>
<span class="nc bnc" id="L720" title="All 2 branches missed.">                        if (empty) {</span>
<span class="nc" id="L721">                            setGraphic(null);</span>
                        } else {
<span class="nc" id="L723">                            Producto producto = getTableView().getItems().get(getIndex());</span>
                            com.farmaciavictoria.proyectopharmavictoria.model.Usuario.Usuario usuario = com.farmaciavictoria.proyectopharmavictoria.config.ServiceContainer
<span class="nc" id="L725">                                    .getInstance()</span>
<span class="nc" id="L726">                                    .getAuthenticationService().getUsuarioActual();</span>
<span class="nc bnc" id="L727" title="All 4 branches missed.">                            boolean esAdmin = usuario != null &amp;&amp; usuario.isAdmin();</span>
                            // Acciones por producto según rol
<span class="nc bnc" id="L729" title="All 2 branches missed.">                            if (esAdmin) {</span>
<span class="nc" id="L730">                                btnEditar.setVisible(true);</span>
<span class="nc" id="L731">                                btnEditar.setManaged(true);</span>
<span class="nc" id="L732">                                btnToggleEstado.setVisible(true);</span>
<span class="nc" id="L733">                                btnToggleEstado.setManaged(true);</span>
<span class="nc" id="L734">                                btnEliminar.setVisible(true);</span>
<span class="nc" id="L735">                                btnEliminar.setManaged(true);</span>
<span class="nc" id="L736">                                btnVer.setVisible(true);</span>
<span class="nc" id="L737">                                btnVer.setManaged(true);</span>
<span class="nc bnc" id="L738" title="All 4 branches missed.">                            } else if (usuario != null &amp;&amp; usuario.isVendedor()) {</span>
                                // Obtener permisos granulares del primer vendedor (global)
                                com.farmaciavictoria.proyectopharmavictoria.service.UsuarioService usuarioService = com.farmaciavictoria.proyectopharmavictoria.service.UsuarioService
<span class="nc" id="L741">                                        .getInstance();</span>
<span class="nc" id="L742">                                java.util.List&lt;com.farmaciavictoria.proyectopharmavictoria.model.Usuario.Usuario&gt; vendedores = usuarioService</span>
<span class="nc" id="L743">                                        .obtenerUsuarios().stream()</span>
<span class="nc" id="L744">                                        .filter(u -&gt; u</span>
<span class="nc bnc" id="L745" title="All 2 branches missed.">                                                .getRol() == com.farmaciavictoria.proyectopharmavictoria.model.Usuario.Usuario.Rol.VENDEDOR)</span>
<span class="nc" id="L746">                                        .collect(java.util.stream.Collectors.toList());</span>
                                final java.util.List&lt;com.farmaciavictoria.proyectopharmavictoria.model.Usuario.UsuarioPermiso&gt; permisos;
<span class="nc bnc" id="L748" title="All 2 branches missed.">                                if (!vendedores.isEmpty()) {</span>
<span class="nc" id="L749">                                    permisos = usuarioService.obtenerPermisos(vendedores.get(0).getId());</span>
                                } else {
<span class="nc" id="L751">                                    permisos = java.util.Collections.emptyList();</span>
                                }
<span class="nc" id="L753">                                java.util.function.Function&lt;String, Boolean&gt; tienePermiso = clave -&gt; permisos.stream()</span>
<span class="nc bnc" id="L754" title="All 4 branches missed.">                                        .anyMatch(p -&gt; clave.equals(p.getPermiso()) &amp;&amp; p.isValor());</span>

<span class="nc" id="L756">                                btnEditar.setVisible(tienePermiso.apply(&quot;inventario.editar&quot;));</span>
<span class="nc" id="L757">                                btnEditar.setManaged(tienePermiso.apply(&quot;inventario.editar&quot;));</span>
<span class="nc" id="L758">                                btnToggleEstado.setVisible(tienePermiso.apply(&quot;inventario.activar_inactivar&quot;));</span>
<span class="nc" id="L759">                                btnToggleEstado.setManaged(tienePermiso.apply(&quot;inventario.activar_inactivar&quot;));</span>
<span class="nc" id="L760">                                btnEliminar.setVisible(tienePermiso.apply(&quot;inventario.eliminar&quot;));</span>
<span class="nc" id="L761">                                btnEliminar.setManaged(tienePermiso.apply(&quot;inventario.eliminar&quot;));</span>
<span class="nc" id="L762">                                btnVer.setVisible(true); // Ver detalles siempre visible</span>
<span class="nc" id="L763">                                btnVer.setManaged(true);</span>
<span class="nc" id="L764">                            } else {</span>
<span class="nc" id="L765">                                btnEditar.setVisible(false);</span>
<span class="nc" id="L766">                                btnEditar.setManaged(false);</span>
<span class="nc" id="L767">                                btnToggleEstado.setVisible(false);</span>
<span class="nc" id="L768">                                btnToggleEstado.setManaged(false);</span>
<span class="nc" id="L769">                                btnEliminar.setVisible(false);</span>
<span class="nc" id="L770">                                btnEliminar.setManaged(false);</span>
<span class="nc" id="L771">                                btnVer.setVisible(true);</span>
<span class="nc" id="L772">                                btnVer.setManaged(true);</span>
                            }
<span class="nc bnc" id="L774" title="All 2 branches missed.">                            if (producto.getActivo()) {</span>
<span class="nc" id="L775">                                btnToggleEstado.setText(&quot;⏸&quot;);</span>
<span class="nc" id="L776">                                btnToggleEstado.setTooltip(new Tooltip(&quot;Inactivar producto&quot;));</span>
<span class="nc" id="L777">                                btnToggleEstado.getStyleClass().setAll(&quot;btn-action&quot;, &quot;btn-toggle&quot;, &quot;btn-toggle-active&quot;);</span>
                            } else {
<span class="nc" id="L779">                                btnToggleEstado.setText(&quot;▶&quot;);</span>
<span class="nc" id="L780">                                btnToggleEstado.setTooltip(new Tooltip(&quot;Activar producto&quot;));</span>
<span class="nc" id="L781">                                btnToggleEstado.getStyleClass().setAll(&quot;btn-action&quot;, &quot;btn-toggle&quot;,</span>
                                        &quot;btn-toggle-inactive&quot;);
                            }
<span class="nc" id="L784">                            HBox buttons = new HBox(5, btnEditar, btnVer, btnToggleEstado, btnEliminar);</span>
<span class="nc" id="L785">                            buttons.setAlignment(javafx.geometry.Pos.CENTER);</span>
<span class="nc" id="L786">                            setGraphic(buttons);</span>
                        }
<span class="nc" id="L788">                    }</span>
                };
            }
        });
<span class="nc" id="L792">    }</span>

    // Mostrar historial de movimientos de inventario para un producto
    private void mostrarHistorialInventario(Producto producto) {
        try {
<span class="nc" id="L797">            FXMLLoader loader = new FXMLLoader(getClass().getResource(&quot;/fxml/Inventario/historial-inventario.fxml&quot;));</span>
<span class="nc" id="L798">            Parent root = loader.load();</span>
<span class="nc" id="L799">            HistorialInventarioController controller = loader.getController();</span>
<span class="nc" id="L800">            controller.setProducto(producto);</span>
<span class="nc" id="L801">            Stage stage = new Stage();</span>
<span class="nc" id="L802">            stage.setTitle(&quot;Historial de Inventario - &quot; + producto.getNombre());</span>
<span class="nc" id="L803">            stage.setScene(new Scene(root));</span>
<span class="nc" id="L804">            stage.initModality(Modality.APPLICATION_MODAL);</span>
<span class="nc" id="L805">            stage.setResizable(true);</span>
<span class="nc" id="L806">            stage.setMinWidth(600);</span>
<span class="nc" id="L807">            stage.setMinHeight(400);</span>
<span class="nc" id="L808">            stage.showAndWait();</span>
<span class="nc" id="L809">        } catch (Exception e) {</span>
<span class="nc" id="L810">            notificationService.mostrarError(&quot;No se pudo mostrar el historial: &quot; + e.getMessage());</span>
<span class="nc" id="L811">        }</span>
<span class="nc" id="L812">    }</span>

    private void setupEventHandlers() {
<span class="nc" id="L815">        btnNuevoProducto.setOnAction(e -&gt; onNuevoProducto());</span>
        // btnActualizar.setOnAction(e -&gt; onActualizar()); // Eliminado porque el botón
        // ya no existe en el FXML
<span class="nc" id="L818">        txtBuscar.textProperty().addListener((obs, oldVal, newVal) -&gt; aplicarFiltros());</span>
<span class="nc" id="L819">        cmbCategoria.valueProperty().addListener((obs, oldVal, newVal) -&gt; aplicarFiltros());</span>
<span class="nc" id="L820">        cmbEstado.valueProperty().addListener((obs, oldVal, newVal) -&gt; aplicarFiltros());</span>
<span class="nc bnc" id="L821" title="All 2 branches missed.">        if (chkMostrarInactivos != null) {</span>
<span class="nc" id="L822">            chkMostrarInactivos.selectedProperty().addListener((obs, oldVal, newVal) -&gt; {</span>
<span class="nc" id="L823">                aplicarFiltroMostrarInactivos();</span>
<span class="nc" id="L824">            });</span>
        }
<span class="nc" id="L826">    }</span>

    // Cargar datos usando service layer
    private void loadData() {
<span class="nc" id="L830">        Task&lt;List&lt;Producto&gt;&gt; task = new Task&lt;List&lt;Producto&gt;&gt;() {</span>
            @Override
            protected List&lt;Producto&gt; call() throws Exception {
<span class="nc" id="L833">                logger.debug(&quot;Cargando productos desde service layer&quot;);</span>
<span class="nc" id="L834">                return productoService.obtenerTodos();</span>
            }

            @Override
            protected void succeeded() {
<span class="nc" id="L839">                productos.setAll(getValue());</span>
<span class="nc" id="L840">                paginaActual = 1;</span>
<span class="nc" id="L841">                aplicarFiltros(); // Mostrar productos según filtros activos al inicio</span>
<span class="nc" id="L842">                logger.debug(&quot;Productos cargados exitosamente: {}&quot;, getValue().size());</span>
<span class="nc" id="L843">            }</span>

            @Override
            protected void failed() {
<span class="nc" id="L847">                logger.error(&quot;Error al cargar productos: {}&quot;, getException().getMessage(), getException());</span>
<span class="nc" id="L848">                Platform.runLater(() -&gt; {</span>
<span class="nc" id="L849">                    notificationService</span>
<span class="nc" id="L850">                            .mostrarError(&quot;No se pudieron cargar los productos: &quot; + getException().getMessage());</span>
<span class="nc" id="L851">                });</span>
<span class="nc" id="L852">            }</span>
        };
<span class="nc" id="L854">        new Thread(task).start();</span>
<span class="nc" id="L855">    }</span>

    private void aplicarFiltros() {
<span class="nc" id="L858">        String textoBusqueda = txtBuscar.getText();</span>
<span class="nc" id="L859">        CategoriaProducto categoriaSeleccionada = cmbCategoria.getValue();</span>
<span class="nc" id="L860">        String estadoSeleccionado = cmbEstado.getValue();</span>
<span class="nc bnc" id="L861" title="All 4 branches missed.">        boolean mostrarInactivos = chkMostrarInactivos != null &amp;&amp; chkMostrarInactivos.isSelected();</span>

<span class="nc bnc" id="L863" title="All 4 branches missed.">        String estrategia = (cmbBusquedaStrategy != null &amp;&amp; cmbBusquedaStrategy.getValue() != null)</span>
<span class="nc" id="L864">                ? cmbBusquedaStrategy.getValue()</span>
<span class="nc" id="L865">                : &quot;Nombre&quot;;</span>
        com.farmaciavictoria.proyectopharmavictoria.strategy.Inventario.ProductSearchStrategy strategy;
<span class="nc bnc" id="L867" title="All 5 branches missed.">        switch (estrategia) {</span>
            case &quot;Laboratorio&quot;:
<span class="nc" id="L869">                strategy = new com.farmaciavictoria.proyectopharmavictoria.strategy.Inventario.SearchByLaboratorioStrategy();</span>
<span class="nc" id="L870">                break;</span>
            case &quot;Lote&quot;:
<span class="nc" id="L872">                strategy = new com.farmaciavictoria.proyectopharmavictoria.strategy.Inventario.SearchByLoteStrategy();</span>
<span class="nc" id="L873">                break;</span>
            case &quot;Proveedor&quot;:
<span class="nc" id="L875">                strategy = new com.farmaciavictoria.proyectopharmavictoria.strategy.Inventario.SearchByProveedorStrategy();</span>
<span class="nc" id="L876">                break;</span>
            case &quot;Vencimiento&quot;:
<span class="nc" id="L878">                strategy = new com.farmaciavictoria.proyectopharmavictoria.strategy.Inventario.SearchByVencimientoStrategy();</span>
<span class="nc" id="L879">                break;</span>
            case &quot;Nombre&quot;:
            default:
<span class="nc" id="L882">                strategy = new com.farmaciavictoria.proyectopharmavictoria.strategy.Inventario.SearchByNameStrategy();</span>
                break;
        }

        int diasVencimiento = com.farmaciavictoria.proyectopharmavictoria.service.ProductoService
<span class="nc" id="L887">                .getDiasVencimientoAlerta();</span>
<span class="nc" id="L888">        List&lt;Producto&gt; filtrados = strategy.buscar(productos, textoBusqueda)</span>
<span class="nc" id="L889">                .stream()</span>
<span class="nc bnc" id="L890" title="All 4 branches missed.">                .filter(producto -&gt; mostrarInactivos || producto.getActivo())</span>
<span class="nc bnc" id="L891" title="All 2 branches missed.">                .filter(producto -&gt; categoriaSeleccionada == null</span>
<span class="nc bnc" id="L892" title="All 2 branches missed.">                        || producto.getCategoria().equals(categoriaSeleccionada))</span>
<span class="nc" id="L893">                .filter(producto -&gt; {</span>
<span class="nc bnc" id="L894" title="All 2 branches missed.">                    if (&quot;Todos&quot;.equals(estadoSeleccionado))</span>
<span class="nc" id="L895">                        return true;</span>
<span class="nc bnc" id="L896" title="All 2 branches missed.">                    if (&quot;Activo&quot;.equals(estadoSeleccionado))</span>
<span class="nc" id="L897">                        return producto.getActivo();</span>
<span class="nc bnc" id="L898" title="All 2 branches missed.">                    if (&quot;Inactivo&quot;.equals(estadoSeleccionado))</span>
<span class="nc bnc" id="L899" title="All 2 branches missed.">                        return !producto.getActivo();</span>
<span class="nc bnc" id="L900" title="All 2 branches missed.">                    if (&quot;Stock Bajo&quot;.equals(estadoSeleccionado))</span>
<span class="nc bnc" id="L901" title="All 2 branches missed.">                        return producto.getStockActual() &lt;= producto.getStockMinimo();</span>
<span class="nc bnc" id="L902" title="All 2 branches missed.">                    if (&quot;Próximos a Vencer&quot;.equals(estadoSeleccionado))</span>
<span class="nc bnc" id="L903" title="All 2 branches missed.">                        return producto.getFechaVencimiento() != null</span>
<span class="nc bnc" id="L904" title="All 2 branches missed.">                                &amp;&amp; producto.getFechaVencimiento().isAfter(LocalDate.now())</span>
<span class="nc bnc" id="L905" title="All 2 branches missed.">                                &amp;&amp; (producto.getFechaVencimiento().isEqual(LocalDate.now().plusDays(diasVencimiento))</span>
<span class="nc" id="L906">                                        || producto.getFechaVencimiento()</span>
<span class="nc bnc" id="L907" title="All 2 branches missed.">                                                .isBefore(LocalDate.now().plusDays(diasVencimiento)));</span>
<span class="nc bnc" id="L908" title="All 2 branches missed.">                    if (&quot;Sin Stock&quot;.equals(estadoSeleccionado))</span>
<span class="nc bnc" id="L909" title="All 2 branches missed.">                        return producto.getStockActual() == 0;</span>
<span class="nc bnc" id="L910" title="All 2 branches missed.">                    if (&quot;Productos Vencidos&quot;.equals(estadoSeleccionado))</span>
<span class="nc bnc" id="L911" title="All 2 branches missed.">                        return producto.getFechaVencimiento() != null</span>
<span class="nc bnc" id="L912" title="All 2 branches missed.">                                &amp;&amp; producto.getFechaVencimiento().isBefore(LocalDate.now());</span>
<span class="nc" id="L913">                    return true;</span>
                })
<span class="nc" id="L915">                .collect(java.util.stream.Collectors.toList());</span>

<span class="nc" id="L917">        productosFiltrados = new javafx.collections.transformation.FilteredList&lt;&gt;(</span>
<span class="nc" id="L918">                javafx.collections.FXCollections.observableArrayList(filtrados));</span>
<span class="nc" id="L919">        paginaActual = 1;</span>
<span class="nc" id="L920">        actualizarPaginacion();</span>
<span class="nc" id="L921">        actualizarEstadisticas();</span>
<span class="nc" id="L922">    }</span>

    // Nuevo método para aplicar el filtro de mostrar inactivos
    private void aplicarFiltroMostrarInactivos() {
<span class="nc" id="L926">        aplicarFiltros(); // La paginación ya se actualiza dentro de aplicarFiltros()</span>
<span class="nc" id="L927">    }</span>

    private void actualizarPaginacion() {
        // Filtrar productos válidos si aplica (aquí solo se usa productosFiltrados)
<span class="nc" id="L931">        java.util.List&lt;Producto&gt; productosValidos = productosFiltrados;</span>
<span class="nc" id="L932">        int total = productosValidos.size();</span>
<span class="nc" id="L933">        ObservableList&lt;Producto&gt; pagina = FXCollections.observableArrayList();</span>
<span class="nc bnc" id="L934" title="All 2 branches missed.">        if (tamanoPagina == -1) {</span>
<span class="nc" id="L935">            pagina.addAll(productosValidos);</span>
<span class="nc" id="L936">            tableProductos.setItems(pagina);</span>
<span class="nc bnc" id="L937" title="All 2 branches missed.">            if (lblPaginaActual != null) {</span>
<span class="nc" id="L938">                lblPaginaActual.setText(&quot;Mostrando todos&quot;);</span>
            }
<span class="nc bnc" id="L940" title="All 2 branches missed.">            if (btnPaginaAnterior != null)</span>
<span class="nc" id="L941">                btnPaginaAnterior.setDisable(true);</span>
<span class="nc bnc" id="L942" title="All 2 branches missed.">            if (btnPaginaSiguiente != null)</span>
<span class="nc" id="L943">                btnPaginaSiguiente.setDisable(true);</span>
        } else {
<span class="nc" id="L945">            totalPaginas = (int) Math.ceil((double) total / tamanoPagina);</span>
<span class="nc bnc" id="L946" title="All 2 branches missed.">            if (totalPaginas &lt; 1)</span>
<span class="nc" id="L947">                totalPaginas = 1;</span>
<span class="nc bnc" id="L948" title="All 2 branches missed.">            if (paginaActual &lt; 1)</span>
<span class="nc" id="L949">                paginaActual = 1;</span>
<span class="nc bnc" id="L950" title="All 2 branches missed.">            if (paginaActual &gt; totalPaginas)</span>
<span class="nc" id="L951">                paginaActual = totalPaginas;</span>
<span class="nc" id="L952">            int desde = (paginaActual - 1) * tamanoPagina;</span>
<span class="nc" id="L953">            int hasta = Math.min(desde + tamanoPagina, total);</span>
<span class="nc bnc" id="L954" title="All 2 branches missed.">            for (int i = desde; i &lt; hasta; i++) {</span>
<span class="nc" id="L955">                pagina.add(productosValidos.get(i));</span>
            }
<span class="nc" id="L957">            tableProductos.setItems(pagina);</span>
<span class="nc bnc" id="L958" title="All 2 branches missed.">            if (lblPaginaActual != null) {</span>
<span class="nc" id="L959">                lblPaginaActual.setText(&quot;Página &quot; + paginaActual + &quot; de &quot; + totalPaginas);</span>
            }
<span class="nc bnc" id="L961" title="All 2 branches missed.">            if (btnPaginaAnterior != null)</span>
<span class="nc bnc" id="L962" title="All 2 branches missed.">                btnPaginaAnterior.setDisable(paginaActual &lt;= 1);</span>
<span class="nc bnc" id="L963" title="All 2 branches missed.">            if (btnPaginaSiguiente != null)</span>
<span class="nc bnc" id="L964" title="All 2 branches missed.">                btnPaginaSiguiente.setDisable(paginaActual &gt;= totalPaginas);</span>
        }
        // Mostrar el total de productos filtrados (no solo la página)
<span class="nc bnc" id="L967" title="All 2 branches missed.">        if (lblTotalProductos != null) {</span>
<span class="nc" id="L968">            lblTotalProductos.setText(&quot;Total: &quot; + productosValidos.size() + &quot; productos&quot;);</span>
        }
<span class="nc" id="L970">    }</span>

    @FXML
    private void onPaginaAnterior() {
<span class="nc bnc" id="L974" title="All 2 branches missed.">        if (paginaActual &gt; 1) {</span>
<span class="nc" id="L975">            paginaActual--;</span>
<span class="nc" id="L976">            actualizarPaginacion();</span>
        }
<span class="nc" id="L978">    }</span>

    @FXML
    private void onPaginaSiguiente() {
<span class="nc bnc" id="L982" title="All 2 branches missed.">        if (paginaActual &lt; totalPaginas) {</span>
<span class="nc" id="L983">            paginaActual++;</span>
<span class="nc" id="L984">            actualizarPaginacion();</span>
        }
<span class="nc" id="L986">    }</span>

    private void actualizarEstadisticas() {
<span class="nc" id="L989">        Platform.runLater(() -&gt; {</span>
            // Usar productosFiltrados (total filtrado), no solo la página actual
<span class="nc" id="L991">            List&lt;Producto&gt; lista = productosFiltrados;</span>
            int diasVencimiento = com.farmaciavictoria.proyectopharmavictoria.service.ProductoService
<span class="nc" id="L993">                    .getDiasVencimientoAlerta();</span>
<span class="nc" id="L994">            int productosActivos = (int) lista.stream().filter(Producto::getActivo).count();</span>
<span class="nc bnc" id="L995" title="All 2 branches missed.">            int stockBajo = (int) lista.stream().filter(p -&gt; p.getStockActual() &lt;= p.getStockMinimo()).count();</span>
<span class="nc bnc" id="L996" title="All 2 branches missed.">            int proximosVencer = (int) lista.stream().filter(p -&gt; p.getFechaVencimiento() != null</span>
<span class="nc bnc" id="L997" title="All 2 branches missed.">                    &amp;&amp; p.getFechaVencimiento().isAfter(LocalDate.now())</span>
<span class="nc bnc" id="L998" title="All 2 branches missed.">                    &amp;&amp; (p.getFechaVencimiento().isEqual(LocalDate.now().plusDays(diasVencimiento))</span>
<span class="nc bnc" id="L999" title="All 2 branches missed.">                            || p.getFechaVencimiento().isBefore(LocalDate.now().plusDays(diasVencimiento))))</span>
<span class="nc" id="L1000">                    .count();</span>
<span class="nc" id="L1001">            BigDecimal valorInventario = lista.stream()</span>
<span class="nc" id="L1002">                    .filter(Producto::getActivo)</span>
<span class="nc" id="L1003">                    .map(p -&gt; p.getPrecioVenta().multiply(BigDecimal.valueOf(p.getStockActual())))</span>
<span class="nc" id="L1004">                    .reduce(BigDecimal.ZERO, BigDecimal::add);</span>

<span class="nc" id="L1006">            lblTotalActivos.setText(String.valueOf(productosActivos));</span>
<span class="nc" id="L1007">            lblStockBajo.setText(String.valueOf(stockBajo));</span>
<span class="nc" id="L1008">            lblProximosVencer.setText(String.valueOf(proximosVencer));</span>
<span class="nc" id="L1009">            lblValorInventario.setText(formatoMoneda.format(valorInventario));</span>
<span class="nc" id="L1010">        });</span>
<span class="nc" id="L1011">    }</span>

    @FXML
    private void onNuevoProducto() {
<span class="nc" id="L1015">        abrirFormularioProducto(null);</span>
<span class="nc" id="L1016">    }</span>

    @FXML
    private void onActualizar() {
        // Recargar productos
<span class="nc" id="L1021">        loadData();</span>
        // Refrescar paneles de estadísticas
<span class="nc" id="L1023">        actualizarEstadisticas();</span>
        // Refrescar historial de inventario si está visible
<span class="nc bnc" id="L1025" title="All 2 branches missed.">        if (isHistorialInventarioVisible()) {</span>
<span class="nc" id="L1026">            refrescarHistorialInventario();</span>
        }
        // Mostrar notificación visual de éxito
<span class="nc" id="L1029">        notificationService.mostrarInfo(&quot;¡Inventario actualizado correctamente!&quot;);</span>
<span class="nc" id="L1030">    }</span>

    // Verifica si el panel de historial de inventario está visible
    private boolean isHistorialInventarioVisible() {
        // Implementa la lógica según tu UI, por defecto retorna true si existe el panel
        // Si tienes un TabPane, verifica si el tab está seleccionado
<span class="nc" id="L1036">        return true;</span>
    }

    // Refresca el historial de inventario
    private void refrescarHistorialInventario() {
<span class="nc" id="L1041">    }</span>

    @FXML
    private void onEditarProducto() {
<span class="nc" id="L1045">        Producto productoSeleccionado = tableProductos.getSelectionModel().getSelectedItem();</span>
<span class="nc bnc" id="L1046" title="All 2 branches missed.">        if (productoSeleccionado != null) {</span>
<span class="nc" id="L1047">            editarProducto(productoSeleccionado);</span>
        } else {
<span class="nc" id="L1049">            notificationService.mostrarAdvertencia(&quot;Por favor seleccione un producto para editar&quot;);</span>
        }
<span class="nc" id="L1051">    }</span>

    @FXML
    private void onEliminarProducto() {
<span class="nc" id="L1055">        Producto productoSeleccionado = tableProductos.getSelectionModel().getSelectedItem();</span>
<span class="nc bnc" id="L1056" title="All 2 branches missed.">        if (productoSeleccionado != null) {</span>
<span class="nc" id="L1057">            eliminarProductoDefinitivo(productoSeleccionado);</span>
        } else {
<span class="nc" id="L1059">            notificationService.mostrarAdvertencia(&quot;Por favor seleccione un producto para eliminar&quot;);</span>
        }
<span class="nc" id="L1061">    }</span>

    @FXML
    private void onBuscar() {
<span class="nc" id="L1065">        aplicarFiltros();</span>
<span class="nc" id="L1066">    }</span>

    @FXML
    private void onFiltrarCategoria() {
<span class="nc" id="L1070">        aplicarFiltros();</span>
<span class="nc" id="L1071">    }</span>

    @FXML
    private void onFiltrarEstado() {
<span class="nc" id="L1075">        aplicarFiltros();</span>
<span class="nc" id="L1076">    }</span>

    @FXML
    private void onToggleMostrarInactivos() {
<span class="nc" id="L1080">        aplicarFiltros();</span>
<span class="nc" id="L1081">    }</span>

    @FXML
    private void onVerDetalles() {
<span class="nc" id="L1085">        Producto productoSeleccionado = tableProductos.getSelectionModel().getSelectedItem();</span>
<span class="nc bnc" id="L1086" title="All 2 branches missed.">        if (productoSeleccionado != null) {</span>
<span class="nc" id="L1087">            verDetallesProducto(productoSeleccionado);</span>
        } else {
<span class="nc" id="L1089">            notificationService.mostrarAdvertencia(&quot;Por favor seleccione un producto para ver detalles&quot;);</span>
        }
<span class="nc" id="L1091">    }</span>

    @FXML
    private void onAjustarStock() {
<span class="nc" id="L1095">        Producto productoSeleccionado = tableProductos.getSelectionModel().getSelectedItem();</span>
<span class="nc bnc" id="L1096" title="All 2 branches missed.">        if (productoSeleccionado != null) {</span>
<span class="nc" id="L1097">            ajustarStock(productoSeleccionado);</span>
        } else {
<span class="nc" id="L1099">            notificationService.mostrarAdvertencia(&quot;Por favor seleccione un producto para ajustar stock&quot;);</span>
        }
<span class="nc" id="L1101">    }</span>

    @FXML
    private void onCambiarUbicacion() {
<span class="nc" id="L1105">        Producto productoSeleccionado = tableProductos.getSelectionModel().getSelectedItem();</span>
<span class="nc bnc" id="L1106" title="All 2 branches missed.">        if (productoSeleccionado != null) {</span>
<span class="nc" id="L1107">            cambiarUbicacion(productoSeleccionado);</span>
        } else {
<span class="nc" id="L1109">            notificationService.mostrarAdvertencia(&quot;Por favor seleccione un producto para cambiar ubicación&quot;);</span>
        }
<span class="nc" id="L1111">    }</span>

    @FXML
    private void onToggleEstadoProducto() {
<span class="nc" id="L1115">        Producto productoSeleccionado = tableProductos.getSelectionModel().getSelectedItem();</span>
<span class="nc bnc" id="L1116" title="All 2 branches missed.">        if (productoSeleccionado != null) {</span>
<span class="nc" id="L1117">            toggleEstadoProducto(productoSeleccionado);</span>
        } else {
<span class="nc" id="L1119">            notificationService.mostrarAdvertencia(&quot;Por favor seleccione un producto para cambiar estado&quot;);</span>
        }
<span class="nc" id="L1121">    }</span>

    private void editarProducto(Producto producto) {
<span class="nc bnc" id="L1124" title="All 2 branches missed.">        Producto productoActualizado = producto != null ? productoService.obtenerPorId(producto.getId()) : null;</span>
<span class="nc bnc" id="L1125" title="All 2 branches missed.">        abrirFormularioProducto(productoActualizado != null ? productoActualizado : producto);</span>
<span class="nc" id="L1126">    }</span>

    private void verDetallesProducto(Producto producto) {
        try {
            // Refrescar el producto desde la base de datos antes de mostrar detalles
<span class="nc" id="L1131">            Producto productoActualizado = productoService.obtenerPorId(producto.getId());</span>
<span class="nc" id="L1132">            FXMLLoader loader = new FXMLLoader(getClass().getResource(&quot;/fxml/Inventario/producto-detalles.fxml&quot;));</span>
<span class="nc" id="L1133">            Parent root = loader.load();</span>

<span class="nc" id="L1135">            ProductoDetallesController controller = loader.getController();</span>
<span class="nc bnc" id="L1136" title="All 2 branches missed.">            controller.setProducto(productoActualizado != null ? productoActualizado : producto);</span>

<span class="nc" id="L1138">            Stage stage = new Stage();</span>
<span class="nc" id="L1139">            stage.setTitle(&quot;Detalles del Producto - &quot;</span>
<span class="nc bnc" id="L1140" title="All 2 branches missed.">                    + (productoActualizado != null ? productoActualizado.getNombre() : producto.getNombre()));</span>
<span class="nc" id="L1141">            Scene scene = new Scene(root);</span>

            try {
<span class="nc" id="L1144">                String css = getClass().getResource(&quot;/css/Inventario/producto-detalles.css&quot;).toExternalForm();</span>
<span class="nc" id="L1145">                scene.getStylesheets().add(css);</span>
<span class="nc" id="L1146">            } catch (Exception e) {</span>
<span class="nc" id="L1147">                System.out.println(&quot;No se pudo cargar el CSS de detalles: &quot; + e.getMessage());</span>
<span class="nc" id="L1148">            }</span>

<span class="nc" id="L1150">            stage.setScene(scene);</span>
<span class="nc" id="L1151">            stage.initModality(Modality.APPLICATION_MODAL);</span>
<span class="nc" id="L1152">            stage.setResizable(true);</span>
<span class="nc" id="L1153">            stage.setMinWidth(500);</span>
<span class="nc" id="L1154">            stage.setMinHeight(400);</span>
<span class="nc" id="L1155">            stage.setWidth(800);</span>
<span class="nc" id="L1156">            stage.setHeight(700);</span>
<span class="nc" id="L1157">            stage.show();</span>

<span class="nc" id="L1159">        } catch (IOException e) {</span>
<span class="nc" id="L1160">            System.err.println(&quot;Error al abrir ventana de detalles: &quot; + e.getMessage());</span>
<span class="nc" id="L1161">            e.printStackTrace();</span>
<span class="nc" id="L1162">            notificationService.mostrarError(&quot;No se pudo abrir la ventana de detalles del producto.&quot;);</span>
<span class="nc" id="L1163">        }</span>
<span class="nc" id="L1164">    }</span>

    // Ajustar stock usando service layer
    private void ajustarStock(Producto producto) {
<span class="nc" id="L1168">        TextInputDialog dialog = new TextInputDialog(String.valueOf(producto.getStockActual()));</span>
<span class="nc" id="L1169">        dialog.setTitle(&quot;Ajustar Stock&quot;);</span>
<span class="nc" id="L1170">        dialog.setHeaderText(&quot;Ajustar stock del producto: &quot; + producto.getNombre());</span>
<span class="nc" id="L1171">        dialog.setContentText(&quot;Nuevo stock:&quot;);</span>

<span class="nc" id="L1173">        Optional&lt;String&gt; result = dialog.showAndWait();</span>
<span class="nc" id="L1174">        result.ifPresent(stock -&gt; {</span>
            try {
<span class="nc" id="L1176">                int stockAnterior = producto.getStockActual();</span>
<span class="nc" id="L1177">                int nuevoStock = Integer.parseInt(stock);</span>
<span class="nc bnc" id="L1178" title="All 4 branches missed.">                if (producto.getId() != null &amp;&amp; stockAnterior != nuevoStock) {</span>
<span class="nc" id="L1179">                    producto.setStockActual(nuevoStock);</span>
<span class="nc" id="L1180">                    productoService.actualizar(producto);</span>
<span class="nc" id="L1181">                    notificationService.mostrarExito(&quot;Stock actualizado correctamente&quot;);</span>
                } else {
<span class="nc" id="L1183">                    notificationService.mostrarError(&quot;No se realizó ningún cambio de stock.&quot;);</span>
                }
<span class="nc" id="L1185">            } catch (NumberFormatException e) {</span>
<span class="nc" id="L1186">                notificationService.mostrarError(&quot;Por favor ingrese un número válido&quot;);</span>
<span class="nc" id="L1187">            } catch (Exception e) {</span>
<span class="nc" id="L1188">                logger.error(&quot;Error al actualizar stock: {}&quot;, e.getMessage(), e);</span>
<span class="nc" id="L1189">                notificationService.mostrarError(&quot;No se pudo actualizar el stock: &quot; + e.getMessage());</span>
<span class="nc" id="L1190">            }</span>
<span class="nc" id="L1191">        });</span>
<span class="nc" id="L1192">    }</span>

    private void cambiarUbicacion(Producto producto) {
<span class="nc" id="L1195">        TextInputDialog dialog = new TextInputDialog(producto.getUbicacion());</span>
<span class="nc" id="L1196">        dialog.setTitle(&quot;Cambiar Ubicación&quot;);</span>
<span class="nc" id="L1197">        dialog.setHeaderText(&quot;Cambiar ubicación del producto: &quot; + producto.getNombre());</span>
<span class="nc" id="L1198">        dialog.setContentText(&quot;Nueva ubicación:&quot;);</span>

<span class="nc" id="L1200">        Optional&lt;String&gt; result = dialog.showAndWait();</span>
<span class="nc" id="L1201">        result.ifPresent(ubicacion -&gt; {</span>
            try {
<span class="nc" id="L1203">                producto.setUbicacion(ubicacion);</span>
<span class="nc" id="L1204">                productoService.actualizar(producto);</span>
<span class="nc" id="L1205">                notificationService.mostrarExito(&quot;Ubicación actualizada correctamente&quot;);</span>
                // No necesario llamar loadData() - Observer Pattern se encarga
<span class="nc" id="L1207">            } catch (Exception e) {</span>
<span class="nc" id="L1208">                logger.error(&quot;Error al actualizar ubicación: {}&quot;, e.getMessage(), e);</span>
<span class="nc" id="L1209">                notificationService.mostrarError(&quot;No se pudo actualizar la ubicación: &quot; + e.getMessage());</span>
<span class="nc" id="L1210">            }</span>
<span class="nc" id="L1211">        });</span>
<span class="nc" id="L1212">    }</span>

    // Desactivar producto
    private void abrirFormularioProducto(Producto producto) {
        try {
<span class="nc" id="L1217">            FXMLLoader loader = new FXMLLoader(getClass().getResource(&quot;/fxml/Inventario/producto-form.fxml&quot;));</span>
<span class="nc" id="L1218">            Parent root = loader.load();</span>

<span class="nc" id="L1220">            ProductoFormController controller = loader.getController();</span>
<span class="nc bnc" id="L1221" title="All 2 branches missed.">            Producto productoRefrescado = producto != null ? productoService.obtenerPorId(producto.getId()) : null;</span>
<span class="nc bnc" id="L1222" title="All 2 branches missed.">            if (productoRefrescado != null) {</span>
<span class="nc" id="L1223">                controller.setProducto(productoRefrescado);</span>
<span class="nc bnc" id="L1224" title="All 2 branches missed.">            } else if (producto != null) {</span>
<span class="nc" id="L1225">                controller.setProducto(producto);</span>
            }

<span class="nc" id="L1228">            controller.setOnProductoGuardado(prodGuardado -&gt; {</span>
<span class="nc bnc" id="L1229" title="All 4 branches missed.">                if (producto != null &amp;&amp; productos.contains(producto)) {</span>
                    // Copia profunda del producto previo para comparación
<span class="nc" id="L1231">                    Producto previo = productos.stream().filter(p -&gt; p.getId().equals(prodGuardado.getId())).findFirst()</span>
<span class="nc" id="L1232">                            .orElse(null);</span>
<span class="nc bnc" id="L1233" title="All 4 branches missed.">                    if (previo != null &amp;&amp; prodGuardado.equals(previo)) {</span>
<span class="nc" id="L1234">                        return;</span>
                    }
<span class="nc" id="L1236">                    String usuario = ServiceContainer.getInstance().getAuthenticationService()</span>
<span class="nc bnc" id="L1237" title="All 2 branches missed.">                            .getUsuarioActual() != null</span>
<span class="nc" id="L1238">                                    ? ServiceContainer.getInstance().getAuthenticationService().getUsuarioActual()</span>
<span class="nc" id="L1239">                                            .getNombreCompleto()</span>
<span class="nc" id="L1240">                                    : &quot;Desconocido&quot;;</span>
                    // Solo registrar cambios si el valor realmente cambió
<span class="nc bnc" id="L1242" title="All 2 branches missed.">                    if (previo != null) {</span>
<span class="nc bnc" id="L1243" title="All 2 branches missed.">                        if (!previo.getNombre().equals(prodGuardado.getNombre())) {</span>
<span class="nc" id="L1244">                            com.farmaciavictoria.proyectopharmavictoria.repository.Inventario.ProductoHistorialCambioRepository</span>
<span class="nc" id="L1245">                                    .registrarCambio(previo.getId(), &quot;nombre&quot;, previo.getNombre(),</span>
<span class="nc" id="L1246">                                            prodGuardado.getNombre(), usuario);</span>
                        }
<span class="nc bnc" id="L1248" title="All 4 branches missed.">                        if (previo.getPrecioVenta() != null &amp;&amp; prodGuardado.getPrecioVenta() != null</span>
<span class="nc bnc" id="L1249" title="All 2 branches missed.">                                &amp;&amp; previo.getPrecioVenta().compareTo(prodGuardado.getPrecioVenta()) != 0) {</span>
<span class="nc" id="L1250">                            com.farmaciavictoria.proyectopharmavictoria.repository.Inventario.ProductoHistorialCambioRepository</span>
<span class="nc" id="L1251">                                    .registrarCambio(previo.getId(), &quot;precio_venta&quot;, previo.getPrecioVenta().toString(),</span>
<span class="nc" id="L1252">                                            prodGuardado.getPrecioVenta().toString(), usuario);</span>
                        }
<span class="nc bnc" id="L1254" title="All 2 branches missed.">                        if (previo.getUbicacion() != null</span>
<span class="nc bnc" id="L1255" title="All 2 branches missed.">                                &amp;&amp; !previo.getUbicacion().equals(prodGuardado.getUbicacion())) {</span>
<span class="nc" id="L1256">                            com.farmaciavictoria.proyectopharmavictoria.repository.Inventario.ProductoHistorialCambioRepository</span>
<span class="nc" id="L1257">                                    .registrarCambio(previo.getId(), &quot;ubicacion&quot;, previo.getUbicacion(),</span>
<span class="nc" id="L1258">                                            prodGuardado.getUbicacion(), usuario);</span>
                        }
<span class="nc bnc" id="L1260" title="All 2 branches missed.">                        if (previo.getStockActual() != null</span>
<span class="nc bnc" id="L1261" title="All 2 branches missed.">                                &amp;&amp; !previo.getStockActual().equals(prodGuardado.getStockActual())) {</span>
<span class="nc" id="L1262">                            com.farmaciavictoria.proyectopharmavictoria.repository.Inventario.ProductoHistorialCambioRepository</span>
<span class="nc" id="L1263">                                    .registrarCambio(previo.getId(), &quot;stock_actual&quot;, previo.getStockActual().toString(),</span>
<span class="nc" id="L1264">                                            prodGuardado.getStockActual().toString(), usuario);</span>
                        }
<span class="nc bnc" id="L1266" title="All 2 branches missed.">                        for (int i = 0; i &lt; productos.size(); i++) {</span>
<span class="nc bnc" id="L1267" title="All 2 branches missed.">                            if (productos.get(i).getId().equals(prodGuardado.getId())) {</span>
<span class="nc" id="L1268">                                productos.set(i, prodGuardado);</span>
<span class="nc" id="L1269">                                break;</span>
                            }
                        }
                    }
                }
<span class="nc" id="L1274">                boolean encontrado = false;</span>
<span class="nc bnc" id="L1275" title="All 2 branches missed.">                for (int i = 0; i &lt; productos.size(); i++) {</span>
<span class="nc bnc" id="L1276" title="All 2 branches missed.">                    if (productos.get(i).getId().equals(prodGuardado.getId())) {</span>
<span class="nc" id="L1277">                        productos.set(i, prodGuardado);</span>
<span class="nc" id="L1278">                        encontrado = true;</span>
<span class="nc" id="L1279">                        break;</span>
                    }
                }
<span class="nc bnc" id="L1282" title="All 2 branches missed.">                if (!encontrado) {</span>
<span class="nc" id="L1283">                    productos.add(prodGuardado);</span>
                }
<span class="nc" id="L1285">                int paginaActualTmp = paginaActual;</span>
<span class="nc" id="L1286">                aplicarFiltros();</span>
<span class="nc" id="L1287">                paginaActual = paginaActualTmp;</span>
<span class="nc" id="L1288">                actualizarPaginacion();</span>
<span class="nc" id="L1289">                actualizarEstadisticas();</span>
<span class="nc bnc" id="L1290" title="All 2 branches missed.">                if (tableProductos != null) {</span>
<span class="nc" id="L1291">                    tableProductos.refresh();</span>
                }
<span class="nc" id="L1293">            });</span>
<span class="nc" id="L1294">            Stage stage = new Stage();</span>
<span class="nc" id="L1295">            stage.setTitle(&quot;Formulario de Producto&quot;);</span>
<span class="nc" id="L1296">            stage.setScene(new Scene(root));</span>
<span class="nc" id="L1297">            stage.initModality(Modality.APPLICATION_MODAL);</span>
<span class="nc" id="L1298">            stage.setResizable(true);</span>
<span class="nc" id="L1299">            stage.setMinWidth(600);</span>
<span class="nc" id="L1300">            stage.setMinHeight(400);</span>
<span class="nc" id="L1301">            stage.showAndWait();</span>
<span class="nc" id="L1302">        } catch (Exception e) {</span>
<span class="nc" id="L1303">            notificationService.mostrarError(&quot;No se pudo abrir el formulario: &quot; + e.getMessage());</span>
<span class="nc" id="L1304">        }</span>
<span class="nc" id="L1305">    }</span>

    // Cambia el estado (activo/inactivo) de un producto
    public void toggleEstadoProducto(Producto producto) {
<span class="nc bnc" id="L1309" title="All 4 branches missed.">        if (producto != null &amp;&amp; producto.getId() != null) {</span>
            try {
<span class="nc bnc" id="L1311" title="All 2 branches missed.">                boolean nuevoEstado = !producto.getActivo();</span>
<span class="nc" id="L1312">                producto.setActivo(nuevoEstado);</span>
<span class="nc" id="L1313">                productoService.actualizar(producto);</span>
<span class="nc" id="L1314">                notificationService.mostrarExito(&quot;Estado del producto actualizado correctamente&quot;);</span>
<span class="nc" id="L1315">                aplicarFiltros();</span>
<span class="nc" id="L1316">                tableProductos.refresh();</span>
<span class="nc" id="L1317">            } catch (Exception e) {</span>
<span class="nc" id="L1318">                logger.error(&quot;Error al cambiar estado del producto: {}&quot;, e.getMessage(), e);</span>
<span class="nc" id="L1319">                notificationService.mostrarError(&quot;No se pudo cambiar el estado del producto: &quot; + e.getMessage());</span>
<span class="nc" id="L1320">            }</span>
        }
<span class="nc" id="L1322">    }</span>

    // Elimina definitivamente un producto
    public void eliminarProductoDefinitivo(Producto producto) {
<span class="nc bnc" id="L1326" title="All 4 branches missed.">        if (producto != null &amp;&amp; producto.getId() != null) {</span>
            // Primera advertencia
<span class="nc" id="L1328">            Alert advertencia = new Alert(Alert.AlertType.WARNING);</span>
<span class="nc" id="L1329">            advertencia.setTitle(&quot;🟡 Eliminación definitiva&quot;);</span>
<span class="nc" id="L1330">            advertencia.setHeaderText(&quot;¡Atención! Esta acción NO se puede deshacer&quot;);</span>
<span class="nc" id="L1331">            advertencia.setContentText(&quot;¿Realmente desea ELIMINAR PARA SIEMPRE el producto '&quot; + producto.getNombre()</span>
                    + &quot;'?\n\nSe eliminarán TODOS los registros relacionados.\nNo hay función de 'deshacer'.\n\nPulse 'Continuar' para confirmar.&quot;);
<span class="nc" id="L1333">            ButtonType btnContinuar = new ButtonType(&quot;Continuar&quot;, javafx.scene.control.ButtonBar.ButtonData.OK_DONE);</span>
<span class="nc" id="L1334">            ButtonType btnCancelar = new ButtonType(&quot;Cancelar&quot;, javafx.scene.control.ButtonBar.ButtonData.CANCEL_CLOSE);</span>
<span class="nc" id="L1335">            advertencia.getButtonTypes().setAll(btnContinuar, btnCancelar);</span>

<span class="nc" id="L1337">            advertencia.showAndWait().ifPresent(resultado1 -&gt; {</span>
<span class="nc bnc" id="L1338" title="All 2 branches missed.">                if (resultado1 == btnContinuar) {</span>
                    // Segunda confirmación con campo de texto
<span class="nc" id="L1340">                    Alert confirmacionFinal = new Alert(Alert.AlertType.CONFIRMATION);</span>
<span class="nc" id="L1341">                    confirmacionFinal.setTitle(&quot;🚨 Confirmación final&quot;);</span>
<span class="nc" id="L1342">                    confirmacionFinal.setHeaderText(null);</span>
<span class="nc" id="L1343">                    confirmacionFinal.setContentText(</span>
                            &quot;🟢 ¡ÚLTIMA OPORTUNIDAD!\n\nEscriba 'ELIMINAR' para confirmar la eliminación definitiva del producto.\n\nProducto: &quot;
<span class="nc" id="L1345">                                    + producto.getNombre());</span>

<span class="nc" id="L1347">                    javafx.scene.control.TextField input = new javafx.scene.control.TextField();</span>
<span class="nc" id="L1348">                    input.setPromptText(&quot;Escriba: ELIMINAR&quot;);</span>
<span class="nc" id="L1349">                    javafx.scene.layout.VBox content = new javafx.scene.layout.VBox(</span>
<span class="nc" id="L1350">                            new javafx.scene.control.Label(confirmacionFinal.getContentText()), input);</span>
<span class="nc" id="L1351">                    content.setSpacing(12);</span>
<span class="nc" id="L1352">                    content.setPadding(new javafx.geometry.Insets(10));</span>
<span class="nc" id="L1353">                    confirmacionFinal.getDialogPane().setContent(content);</span>

<span class="nc" id="L1355">                    ButtonType btnEliminarDefinitivo = new ButtonType(&quot;ELIMINAR DEFINITIVAMENTE&quot;,</span>
                            javafx.scene.control.ButtonBar.ButtonData.OK_DONE);
<span class="nc" id="L1357">                    ButtonType btnCancelar2 = new ButtonType(&quot;Cancelar&quot;,</span>
                            javafx.scene.control.ButtonBar.ButtonData.CANCEL_CLOSE);
<span class="nc" id="L1359">                    confirmacionFinal.getButtonTypes().setAll(btnEliminarDefinitivo, btnCancelar2);</span>

<span class="nc" id="L1361">                    final javafx.scene.control.Button btnOk = (javafx.scene.control.Button) confirmacionFinal</span>
<span class="nc" id="L1362">                            .getDialogPane().lookupButton(btnEliminarDefinitivo);</span>
<span class="nc" id="L1363">                    btnOk.setDisable(true);</span>
<span class="nc" id="L1364">                    input.textProperty().addListener((obs, oldVal, newVal) -&gt; {</span>
<span class="nc bnc" id="L1365" title="All 2 branches missed.">                        btnOk.setDisable(!&quot;ELIMINAR&quot;.equalsIgnoreCase(newVal.trim()));</span>
<span class="nc" id="L1366">                    });</span>

<span class="nc" id="L1368">                    confirmacionFinal.showAndWait().ifPresent(resultado2 -&gt; {</span>
<span class="nc bnc" id="L1369" title="All 2 branches missed.">                        if (resultado2 == btnEliminarDefinitivo</span>
<span class="nc bnc" id="L1370" title="All 2 branches missed.">                                &amp;&amp; &quot;ELIMINAR&quot;.equalsIgnoreCase(input.getText().trim())) {</span>
                            try {
<span class="nc" id="L1372">                                productoService.eliminarDefinitivamente(producto.getId());</span>
<span class="nc" id="L1373">                                productos.remove(producto);</span>
<span class="nc" id="L1374">                                notificationService.mostrarExito(&quot;Producto eliminado definitivamente&quot;);</span>
<span class="nc" id="L1375">                                aplicarFiltros();</span>
<span class="nc" id="L1376">                                tableProductos.refresh();</span>
<span class="nc" id="L1377">                            } catch (Exception e) {</span>
<span class="nc" id="L1378">                                logger.error(&quot;Error al eliminar producto definitivamente: {}&quot;, e.getMessage(), e);</span>
<span class="nc" id="L1379">                                notificationService.mostrarError(&quot;No se pudo eliminar el producto: &quot; + e.getMessage());</span>
<span class="nc" id="L1380">                            }</span>
                        }
<span class="nc" id="L1382">                    });</span>
                }
<span class="nc" id="L1384">            });</span>
        }
<span class="nc" id="L1386">    }</span>

    // Solo mostrar notificaciones al entrar al inventario
    private void mostrarNotificacionesInventario() {
        try {
<span class="nc" id="L1391">            notificationService.mostrarNotificacionesInventario();</span>
<span class="nc" id="L1392">            logger.debug(&quot;Notificaciones de inventario mostradas correctamente&quot;);</span>
<span class="nc" id="L1393">        } catch (Exception e) {</span>
<span class="nc" id="L1394">            logger.error(&quot;Error al mostrar notificaciones de inventario: {}&quot;, e.getMessage(), e);</span>
<span class="nc" id="L1395">        }</span>
<span class="nc" id="L1396">    }</span>

    // Método FXML para abrir la edición masiva (llamado desde productos.fxml)
    @FXML
    public void onEdicionMasiva(javafx.event.ActionEvent event) {
<span class="nc" id="L1401">        mostrarModalEdicionMasiva();</span>
<span class="nc" id="L1402">    }</span>

    private void mostrarModalEdicionMasiva() {
        try {
<span class="nc" id="L1406">            FXMLLoader loader = new FXMLLoader(getClass().getResource(&quot;/fxml/Inventario/edicion-masiva-wizard.fxml&quot;));</span>
<span class="nc" id="L1407">            Parent root = loader.load();</span>
<span class="nc" id="L1408">            com.farmaciavictoria.proyectopharmavictoria.controller.Inventario.EdicionMasivaWizardController controller = loader</span>
<span class="nc" id="L1409">                    .getController();</span>
<span class="nc" id="L1410">            controller.setProductos(new java.util.ArrayList&lt;&gt;(productosFiltrados));</span>
<span class="nc" id="L1411">            controller.setProductoService(productoService);</span>
<span class="nc" id="L1412">            controller.setNotificationService(notificationService);</span>
<span class="nc" id="L1413">            controller.setProveedorService(com.farmaciavictoria.proyectopharmavictoria.config.ServiceContainer</span>
<span class="nc" id="L1414">                    .getInstance().getProveedorService());</span>
<span class="nc" id="L1415">            controller.mostrarVistaSeleccion();</span>
<span class="nc" id="L1416">            Stage stage = new Stage();</span>
<span class="nc" id="L1417">            stage.setTitle(&quot;Edición Masiva de Productos&quot;);</span>
<span class="nc" id="L1418">            stage.setScene(new Scene(root));</span>
<span class="nc" id="L1419">            stage.initModality(Modality.APPLICATION_MODAL);</span>
<span class="nc" id="L1420">            stage.setResizable(true);</span>
<span class="nc" id="L1421">            stage.setMinWidth(1100);</span>
<span class="nc" id="L1422">            stage.setMinHeight(600);</span>
<span class="nc" id="L1423">            stage.setWidth(1100);</span>
<span class="nc" id="L1424">            stage.setHeight(600);</span>
<span class="nc" id="L1425">            stage.showAndWait();</span>
<span class="nc" id="L1426">        } catch (IOException ex) {</span>
<span class="nc" id="L1427">            ex.printStackTrace();</span>
<span class="nc" id="L1428">            notificationService.mostrarError(&quot;No se pudo abrir la ventana de edición masiva: &quot; + ex.getMessage());</span>
<span class="nc" id="L1429">        }</span>
<span class="nc" id="L1430">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>
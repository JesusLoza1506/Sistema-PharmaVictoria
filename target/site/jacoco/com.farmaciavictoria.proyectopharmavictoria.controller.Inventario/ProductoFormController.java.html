<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ProductoFormController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">proyectopharmavictoria</a> &gt; <a href="index.source.html" class="el_package">com.farmaciavictoria.proyectopharmavictoria.controller.Inventario</a> &gt; <span class="el_source">ProductoFormController.java</span></div><h1>ProductoFormController.java</h1><pre class="source lang-java linenums">package com.farmaciavictoria.proyectopharmavictoria.controller.Inventario;

import com.farmaciavictoria.proyectopharmavictoria.model.Inventario.CategoriaProducto;
import com.farmaciavictoria.proyectopharmavictoria.model.Inventario.Producto;
import com.farmaciavictoria.proyectopharmavictoria.model.Proveedor.Proveedor;
import com.farmaciavictoria.proyectopharmavictoria.service.ProductoService;
import com.farmaciavictoria.proyectopharmavictoria.service.ProveedorService;
import com.farmaciavictoria.proyectopharmavictoria.service.CodigoGeneratorService;
import com.farmaciavictoria.proyectopharmavictoria.config.ServiceContainer;
import com.farmaciavictoria.proyectopharmavictoria.controller.DashboardController;
import javafx.collections.FXCollections;
import javafx.event.ActionEvent;
import javafx.fxml.FXML;
import javafx.fxml.Initializable;
import javafx.scene.control.*;
import javafx.stage.Stage;
import javafx.util.StringConverter;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import java.util.Arrays;
import java.util.stream.Collectors;
import java.math.BigDecimal;
import java.math.RoundingMode;
import java.net.URL;
import java.time.LocalDate;
import java.util.List;
import java.util.ResourceBundle;
import java.util.function.Consumer;

public class ProductoFormController implements Initializable {
    // Listener de filtrado de proveedores
    private javafx.beans.value.ChangeListener&lt;String&gt; proveedorFiltroListener;
    @FXML
    private javafx.scene.image.ImageView imgConfiguracion;
<span class="fc" id="L35">    private static final Logger logger = LoggerFactory.getLogger(ProductoFormController.class);</span>
    @FXML
    private Label lblTitulo;
    @FXML
    private TextField txtCodigo;
    @FXML
    private TextField txtNombre;
    @FXML
    private TextField txtPrincipioActivo;
    @FXML
    private TextField txtConcentracion;
    @FXML
    private ComboBox&lt;com.farmaciavictoria.proyectopharmavictoria.model.Inventario.FormaFarmaceutica&gt; cmbFormaFarmaceutica;
    @FXML
    private ComboBox&lt;CategoriaProducto&gt; cmbCategoria;
    @FXML
    private TextArea txtDescripcion;
    @FXML
    private TextField txtPrecioCompra;
    @FXML
    private TextField txtPrecioVenta;
    @FXML
    private TextField txtMargen;
    @FXML
    private ComboBox&lt;Proveedor&gt; cmbProveedor;
    @FXML
    private TextField txtLaboratorio;
    @FXML
    private Spinner&lt;Integer&gt; spnStockActual;
    @FXML
    private Spinner&lt;Integer&gt; spnStockMinimo;
    @FXML
    private Spinner&lt;Integer&gt; spnStockMaximo;
    @FXML
    private TextField txtUbicacion;
    @FXML
    private TextField txtLote;
    @FXML
    private DatePicker dpFechaVencimiento;
    @FXML
    private DatePicker dpFechaFabricacion;
    @FXML
    private CheckBox chkActivo;
    @FXML
    private CheckBox chkRequiereReceta;
    @FXML
    private CheckBox chkControlado;
    @FXML
    private Button btnGuardar;
    @FXML
    private Button btnLimpiar;
    // Bot√≥n Cancelar eliminado
    @FXML
    private Button btnCerrar;
    @FXML
    private Button btnGenerarCodigo;
    @FXML
    private Label lblUltimoCodigo;
    @FXML
    private Label lblValidacionCodigo;
    private final ProductoService productoService;
    private final ProveedorService proveedorService;
    private final CodigoGeneratorService codigoGenerator;
    private Producto productoActual;
<span class="fc" id="L99">    private boolean modoEdicion = false;</span>
    private Consumer&lt;Producto&gt; onProductoGuardado;

<span class="fc" id="L102">    public ProductoFormController() {</span>
        try {
<span class="fc" id="L104">            ServiceContainer container = ServiceContainer.getInstance();</span>
<span class="fc" id="L105">            this.productoService = container.getProductoService();</span>
<span class="fc" id="L106">            this.proveedorService = container.getProveedorService();</span>
<span class="fc" id="L107">            this.codigoGenerator = container.getCodigoGeneratorService();</span>
<span class="fc" id="L108">            logger.info(&quot;ProductoFormController inicializado con enterprise patterns&quot;);</span>
<span class="fc" id="L109">        } catch (Exception e) {</span>
<span class="fc" id="L110">            logger.error(&quot;Error al inicializar ProductoFormController: {}&quot;, e.getMessage(), e);</span>
<span class="fc" id="L111">            throw new RuntimeException(&quot;Fallo cr√≠tico en inicializaci√≥n del formulario&quot;, e);</span>
<span class="fc" id="L112">        }</span>
<span class="fc" id="L113">    }</span>

    @Override
    public void initialize(URL location, ResourceBundle resources) {
<span class="nc bnc" id="L117" title="All 2 branches missed.">        if (imgConfiguracion != null) {</span>
            try {
<span class="nc" id="L119">                javafx.scene.image.Image img = new javafx.scene.image.Image(</span>
<span class="nc" id="L120">                        getClass().getResourceAsStream(&quot;/icons/configuracion.png&quot;));</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">                if (img.isError()) {</span>
<span class="nc" id="L122">                    logger.error(&quot;No se pudo cargar la imagen de configuraci√≥n: /icons/configuracion.png&quot;);</span>
                } else {
<span class="nc" id="L124">                    imgConfiguracion.setImage(img);</span>
<span class="nc" id="L125">                    logger.info(&quot;Imagen de configuraci√≥n cargada correctamente&quot;);</span>
                }
<span class="nc" id="L127">            } catch (Exception ex) {</span>
<span class="nc" id="L128">                logger.error(&quot;Error al cargar imagen de configuraci√≥n&quot;, ex);</span>
<span class="nc" id="L129">            }</span>
        }
        try {
<span class="nc" id="L132">            logger.debug(&quot;Iniciando inicializaci√≥n de ProductoFormController&quot;);</span>
<span class="nc" id="L133">            initializeComponents();</span>
<span class="nc" id="L134">            setupEventHandlers();</span>
<span class="nc" id="L135">            loadComboBoxData();</span>
<span class="nc" id="L136">            logger.info(&quot;ProductoFormController inicializado exitosamente&quot;);</span>
<span class="nc" id="L137">        } catch (Exception e) {</span>
<span class="nc" id="L138">            logger.error(&quot;Error en inicializaci√≥n de ProductoFormController: {}&quot;, e.getMessage(), e);</span>
<span class="nc" id="L139">            showError(&quot;Error de inicializaci√≥n&quot;, &quot;No se pudo inicializar el formulario: &quot; + e.getMessage());</span>
<span class="nc" id="L140">        }</span>
<span class="nc" id="L141">    }</span>

    private void initializeComponents() {
        // Configurar spinners
<span class="nc" id="L145">        spnStockActual.setValueFactory(new SpinnerValueFactory.IntegerSpinnerValueFactory(0, 9999, 0));</span>
<span class="nc" id="L146">        spnStockMinimo.setValueFactory(new SpinnerValueFactory.IntegerSpinnerValueFactory(0, 9999, 1));</span>
<span class="nc" id="L147">        spnStockMaximo.setValueFactory(new SpinnerValueFactory.IntegerSpinnerValueFactory(0, 9999, 100));</span>

        // Configurar combo de categor√≠as
<span class="nc" id="L150">        cmbCategoria.setItems(FXCollections.observableArrayList(CategoriaProducto.values()));</span>
<span class="nc" id="L151">        cmbCategoria.setConverter(new StringConverter&lt;CategoriaProducto&gt;() {</span>
            @Override
            public String toString(CategoriaProducto categoria) {
<span class="nc bnc" id="L154" title="All 2 branches missed.">                return categoria != null ? categoria.toString() : &quot;&quot;;</span>
            }

            @Override
            public CategoriaProducto fromString(String string) {
<span class="nc" id="L159">                return null;</span>
            }
        });

        // Configurar combo de forma farmac√©utica
<span class="nc" id="L164">        cmbFormaFarmaceutica.setItems(FXCollections.observableArrayList(</span>
<span class="nc" id="L165">                com.farmaciavictoria.proyectopharmavictoria.model.Inventario.FormaFarmaceutica.values()));</span>
<span class="nc" id="L166">        cmbFormaFarmaceutica.setConverter(</span>
<span class="nc" id="L167">                new StringConverter&lt;com.farmaciavictoria.proyectopharmavictoria.model.Inventario.FormaFarmaceutica&gt;() {</span>
                    @Override
                    public String toString(
                            com.farmaciavictoria.proyectopharmavictoria.model.Inventario.FormaFarmaceutica forma) {
<span class="nc bnc" id="L171" title="All 2 branches missed.">                        return forma != null ? forma.getDescripcion() : &quot;&quot;;</span>
                    }

                    @Override
                    public com.farmaciavictoria.proyectopharmavictoria.model.Inventario.FormaFarmaceutica fromString(
                            String string) {
<span class="nc" id="L177">                        return null;</span>
                    }
                });

        // Configurar combo de proveedores editable y con b√∫squeda
<span class="nc" id="L182">        cmbProveedor.setEditable(true);</span>
<span class="nc" id="L183">        cmbProveedor.setConverter(new StringConverter&lt;Proveedor&gt;() {</span>
            @Override
            public String toString(Proveedor proveedor) {
<span class="nc bnc" id="L186" title="All 2 branches missed.">                return proveedor != null ? proveedor.getRazonSocial() : &quot;&quot;;</span>
            }

            @Override
            public Proveedor fromString(String string) {
                // Permite que el usuario escriba libremente
                // Si coincide con alg√∫n proveedor, lo retorna; si no, retorna null
<span class="nc bnc" id="L193" title="All 4 branches missed.">                if (string == null || string.trim().isEmpty())</span>
<span class="nc" id="L194">                    return null;</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">                for (Proveedor p : cmbProveedor.getItems()) {</span>
<span class="nc bnc" id="L196" title="All 2 branches missed.">                    if (p.getRazonSocial().equalsIgnoreCase(string.trim())) {</span>
<span class="nc" id="L197">                        return p;</span>
                    }
<span class="nc" id="L199">                }</span>
<span class="nc" id="L200">                return null;</span>
            }
        });

        // Listener para filtrar proveedores en tiempo real (solo se agrega una vez)
<span class="nc" id="L205">        proveedorFiltroListener = (obs, oldText, newText) -&gt; filtrarProveedoresComboBox(newText);</span>
<span class="nc" id="L206">        cmbProveedor.getEditor().textProperty().addListener(proveedorFiltroListener);</span>

        // Mantener la lista desplegada al escribir
<span class="nc" id="L209">        cmbProveedor.getEditor().focusedProperty().addListener((obs, wasFocused, isFocused) -&gt; {</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">            if (isFocused)</span>
<span class="nc" id="L211">                cmbProveedor.show();</span>
<span class="nc" id="L212">        });</span>

        // Permitir selecci√≥n libre (si el usuario escribe y presiona Enter)
<span class="nc" id="L215">        cmbProveedor.getEditor().setOnAction(e -&gt; {</span>
<span class="nc" id="L216">            String texto = cmbProveedor.getEditor().getText();</span>
<span class="nc" id="L217">            Proveedor seleccionado = cmbProveedor.getConverter().fromString(texto);</span>
<span class="nc" id="L218">            cmbProveedor.setValue(seleccionado);</span>
<span class="nc" id="L219">        });</span>
        // ...existing code...
<span class="nc" id="L221">    }</span>

    // Filtra proveedores en el ComboBox seg√∫n el texto ingresado (multi-palabra)
    private void filtrarProveedoresComboBox(String texto) {
        // Evitar ciclo infinito: en modo edici√≥n, solo filtrar si el ComboBox est√°
        // desplegado
<span class="nc bnc" id="L227" title="All 4 branches missed.">        if (modoEdicion &amp;&amp; !cmbProveedor.isShowing()) {</span>
<span class="nc" id="L228">            return;</span>
        }
<span class="nc" id="L230">        String textoActual = cmbProveedor.getEditor().getText();</span>
<span class="nc" id="L231">        Proveedor seleccionado = cmbProveedor.getValue();</span>
        java.util.List&lt;Proveedor&gt; proveedores;
<span class="nc bnc" id="L233" title="All 4 branches missed.">        if (texto == null || texto.trim().isEmpty()) {</span>
<span class="nc" id="L234">            proveedores = proveedorService.obtenerTodos();</span>
        } else {
<span class="nc" id="L236">            String[] palabras = texto.toLowerCase().split(&quot;\\s+&quot;);</span>
<span class="nc" id="L237">            proveedores = proveedorService.obtenerTodos().stream()</span>
<span class="nc" id="L238">                    .filter(p -&gt; {</span>
<span class="nc" id="L239">                        String nombre = p.getRazonSocial().toLowerCase();</span>
<span class="nc" id="L240">                        return java.util.Arrays.stream(palabras).allMatch(nombre::contains);</span>
                    })
<span class="nc" id="L242">                    .collect(java.util.stream.Collectors.toList());</span>
        }
<span class="nc" id="L244">        cmbProveedor.setItems(FXCollections.observableArrayList(proveedores));</span>
<span class="nc" id="L245">        cmbProveedor.getEditor().setText(textoActual);</span>
        // Solo modificar la selecci√≥n si el ComboBox est√° desplegado o no est√° en modo
        // edici√≥n
<span class="nc bnc" id="L248" title="All 4 branches missed.">        if (cmbProveedor.isShowing() || !modoEdicion) {</span>
<span class="nc bnc" id="L249" title="All 4 branches missed.">            if (seleccionado != null &amp;&amp; proveedores.contains(seleccionado)) {</span>
<span class="nc" id="L250">                cmbProveedor.setValue(seleccionado);</span>
            } else {
<span class="nc" id="L252">                cmbProveedor.setValue(null);</span>
            }
        }
<span class="nc" id="L255">    }</span>

    private void setupNumericFields() {
        // Validaci√≥n para campos de precio
<span class="nc" id="L259">        txtPrecioCompra.textProperty().addListener((obs, oldVal, newVal) -&gt; {</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">            if (!newVal.matches(&quot;\\d*\\.?\\d*&quot;)) {</span>
<span class="nc" id="L261">                txtPrecioCompra.setText(oldVal);</span>
            } else {
<span class="nc" id="L263">                calcularMargen();</span>
            }
<span class="nc" id="L265">        });</span>

<span class="nc" id="L267">        txtPrecioVenta.textProperty().addListener((obs, oldVal, newVal) -&gt; {</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">            if (!newVal.matches(&quot;\\d*\\.?\\d*&quot;)) {</span>
<span class="nc" id="L269">                txtPrecioVenta.setText(oldVal);</span>
            } else {
<span class="nc" id="L271">                calcularMargen();</span>
            }
<span class="nc" id="L273">        });</span>

        // Validaci√≥n para c√≥digo (solo letras y n√∫meros)
<span class="nc" id="L276">        txtCodigo.textProperty().addListener((obs, oldVal, newVal) -&gt; {</span>
<span class="nc bnc" id="L277" title="All 2 branches missed.">            if (!newVal.matches(&quot;[A-Za-z0-9]*&quot;)) {</span>
<span class="nc" id="L278">                txtCodigo.setText(oldVal);</span>
            }
<span class="nc" id="L280">        });</span>
<span class="nc" id="L281">    }</span>

    private void setupEventHandlers() {
        // Eventos de los spinners
<span class="nc" id="L285">        spnStockActual.valueProperty().addListener((obs, oldVal, newVal) -&gt; validateStock());</span>
<span class="nc" id="L286">        spnStockMinimo.valueProperty().addListener((obs, oldVal, newVal) -&gt; validateStock());</span>
<span class="nc" id="L287">        spnStockMaximo.valueProperty().addListener((obs, oldVal, newVal) -&gt; validateStock());</span>

        // üöÄ Eventos del generador de c√≥digos
<span class="nc bnc" id="L290" title="All 2 branches missed.">        if (btnGenerarCodigo != null) {</span>
<span class="nc" id="L291">            btnGenerarCodigo.setOnAction(e -&gt; generarCodigoAutomatico());</span>
        }

        // Validaci√≥n de c√≥digo en tiempo real
<span class="nc" id="L295">        txtCodigo.textProperty().addListener((obs, oldText, newText) -&gt; {</span>
<span class="nc" id="L296">            validarCodigo(newText);</span>
<span class="nc" id="L297">        });</span>

        // Actualizar informaci√≥n y c√≥digo cuando cambia la categor√≠a
<span class="nc" id="L300">        cmbCategoria.setOnAction(e -&gt; {</span>
<span class="nc" id="L301">            actualizarInfoCategoria();</span>
            // Si el c√≥digo fue generado autom√°ticamente y no fue modificado manualmente,
            // regenerar
<span class="nc bnc" id="L304" title="All 6 branches missed.">            if (!modoEdicion &amp;&amp; (txtCodigo.getText() == null || txtCodigo.getText().trim().isEmpty()</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">                    || esCodigoDeCategoriaAnterior())) {</span>
<span class="nc" id="L306">                sugerirCodigo();</span>
            }
<span class="nc" id="L308">        });</span>

        // Sugerir c√≥digo cuando cambia el nombre (solo en modo nuevo)
<span class="nc" id="L311">        txtNombre.textProperty().addListener((obs, oldText, newText) -&gt; {</span>
<span class="nc bnc" id="L312" title="All 6 branches missed.">            if (!modoEdicion &amp;&amp; (txtCodigo.getText() == null || txtCodigo.getText().trim().isEmpty())) {</span>
<span class="nc" id="L313">                sugerirCodigo();</span>
            }
<span class="nc" id="L315">        });</span>

        // Opcional: podr√≠as agregar validaci√≥n en txtConcentracion si lo deseas
<span class="nc" id="L318">    }</span>

    // Devuelve true si el c√≥digo actual corresponde a la categor√≠a anterior (o a
    // &quot;OTR&quot;)
    private boolean esCodigoDeCategoriaAnterior() {
<span class="nc" id="L323">        String codigo = txtCodigo.getText();</span>
<span class="nc" id="L324">        CategoriaProducto categoria = cmbCategoria.getValue();</span>
<span class="nc bnc" id="L325" title="All 4 branches missed.">        if (codigo == null || categoria == null)</span>
<span class="nc" id="L326">            return false;</span>
        // Si el c√≥digo empieza con OTR o con el prefijo de la categor√≠a anterior, se
        // debe regenerar
<span class="nc bnc" id="L329" title="All 2 branches missed.">        for (CategoriaProducto cat : CategoriaProducto.values()) {</span>
<span class="nc bnc" id="L330" title="All 2 branches missed.">            if (codigo.startsWith(cat.name().substring(0, 3))) {</span>
<span class="nc bnc" id="L331" title="All 2 branches missed.">                return !codigo.startsWith(categoria.name().substring(0, 3));</span>
            }
        }
<span class="nc" id="L334">        return false;</span>
    }

    private void loadComboBoxData() {
        try {
            // ‚úÖ SERVICE LAYER: Cargar proveedores usando service layer
<span class="nc" id="L340">            List&lt;Proveedor&gt; proveedores = proveedorService.obtenerTodos();</span>
<span class="nc" id="L341">            cmbProveedor.setItems(FXCollections.observableArrayList(proveedores));</span>

<span class="nc" id="L343">            logger.debug(&quot;Proveedores cargados exitosamente: {}&quot;, proveedores.size());</span>
<span class="nc" id="L344">        } catch (Exception e) {</span>
<span class="nc" id="L345">            logger.error(&quot;Error al cargar proveedores: {}&quot;, e.getMessage(), e);</span>
<span class="nc" id="L346">            showWarning(&quot;Advertencia&quot;, &quot;No se pudieron cargar los proveedores: &quot; + e.getMessage());</span>
<span class="nc" id="L347">        }</span>
<span class="nc" id="L348">    }</span>

    private void calcularMargen() {
        try {
<span class="nc" id="L352">            String precioCompraStr = txtPrecioCompra.getText();</span>
<span class="nc" id="L353">            String precioVentaStr = txtPrecioVenta.getText();</span>

<span class="nc bnc" id="L355" title="All 4 branches missed.">            if (!precioCompraStr.isEmpty() &amp;&amp; !precioVentaStr.isEmpty()) {</span>
<span class="nc" id="L356">                BigDecimal precioCompra = new BigDecimal(precioCompraStr);</span>
<span class="nc" id="L357">                BigDecimal precioVenta = new BigDecimal(precioVentaStr);</span>

<span class="nc bnc" id="L359" title="All 2 branches missed.">                if (precioCompra.compareTo(BigDecimal.ZERO) &gt; 0) {</span>
<span class="nc" id="L360">                    BigDecimal margen = precioVenta.subtract(precioCompra)</span>
<span class="nc" id="L361">                            .divide(precioCompra, 4, RoundingMode.HALF_UP)</span>
<span class="nc" id="L362">                            .multiply(new BigDecimal(&quot;100&quot;));</span>

<span class="nc" id="L364">                    txtMargen.setText(String.format(&quot;%.2f%%&quot;, margen.doubleValue()));</span>
<span class="nc" id="L365">                } else {</span>
<span class="nc" id="L366">                    txtMargen.setText(&quot;0.00%&quot;);</span>
                }
<span class="nc" id="L368">            } else {</span>
<span class="nc" id="L369">                txtMargen.setText(&quot;0.00%&quot;);</span>
            }
<span class="nc" id="L371">        } catch (NumberFormatException e) {</span>
<span class="nc" id="L372">            txtMargen.setText(&quot;0.00%&quot;);</span>
<span class="nc" id="L373">        }</span>
<span class="nc" id="L374">    }</span>

    private void validateStock() {
        // Validar que stock m√≠nimo no sea mayor que m√°ximo
        // Solo ajustar el stock m√°ximo si NO estamos editando un producto existente con
        // stock m√°ximo definido
<span class="nc bnc" id="L380" title="All 2 branches missed.">        if (spnStockMinimo.getValue() &gt; spnStockMaximo.getValue()) {</span>
<span class="nc bnc" id="L381" title="All 6 branches missed.">            if (!modoEdicion || (productoActual == null) || productoActual.getStockMaximo() == null</span>
<span class="nc bnc" id="L382" title="All 2 branches missed.">                    || productoActual.getStockMaximo() &lt;= 0) {</span>
<span class="nc" id="L383">                spnStockMaximo.getValueFactory().setValue(spnStockMinimo.getValue());</span>
            }
        }
<span class="nc" id="L386">    }</span>

    public void setProducto(Producto producto) {
<span class="nc" id="L389">        this.productoActual = producto;</span>
<span class="nc bnc" id="L390" title="All 2 branches missed.">        this.modoEdicion = (producto != null);</span>

        // Resetear spinner de stock antes de cargar datos
<span class="nc bnc" id="L393" title="All 4 branches missed.">        if (spnStockActual != null &amp;&amp; spnStockActual.getValueFactory() != null) {</span>
<span class="nc" id="L394">            spnStockActual.getValueFactory().setValue(0);</span>
        }

<span class="nc bnc" id="L397" title="All 2 branches missed.">        if (modoEdicion) {</span>
<span class="nc" id="L398">            lblTitulo.setText(&quot;EDITAR PRODUCTO&quot;);</span>
<span class="nc bnc" id="L399" title="All 2 branches missed.">            if (btnGuardar != null)</span>
<span class="nc" id="L400">                btnGuardar.setText(&quot;Actualizar Producto&quot;);</span>
<span class="nc" id="L401">            cargarDatosProducto();</span>
            // El spinner de stock m√°ximo se inicializa SOLO en cargarDatosProducto
<span class="nc" id="L403">            txtCodigo.setEditable(false); // No permitir cambiar c√≥digo en edici√≥n</span>
<span class="nc bnc" id="L404" title="All 2 branches missed.">            if (btnGenerarCodigo != null) {</span>
<span class="nc" id="L405">                btnGenerarCodigo.setDisable(true); // Deshabilitar generaci√≥n en edici√≥n</span>
            }
        } else {
<span class="nc" id="L408">            lblTitulo.setText(&quot;NUEVO PRODUCTO&quot;);</span>
<span class="nc bnc" id="L409" title="All 2 branches missed.">            if (btnGuardar != null)</span>
<span class="nc" id="L410">                btnGuardar.setText(&quot;Guardar Producto&quot;);</span>
<span class="nc" id="L411">            limpiarCampos();</span>
<span class="nc" id="L412">            txtCodigo.setEditable(true); // Permitir editar c√≥digo en nuevo producto</span>
<span class="nc bnc" id="L413" title="All 2 branches missed.">            if (btnGenerarCodigo != null) {</span>
<span class="nc" id="L414">                btnGenerarCodigo.setDisable(false); // Habilitar generaci√≥n en nuevo producto</span>
            }
        }

        // Actualizar informaci√≥n inicial de categor√≠a
<span class="nc" id="L419">        actualizarInfoCategoria();</span>
<span class="nc" id="L420">    }</span>

    private void cargarDatosProducto() {
<span class="nc bnc" id="L423" title="All 2 branches missed.">        if (productoActual == null)</span>
<span class="nc" id="L424">            return;</span>

        // Informaci√≥n b√°sica
<span class="nc" id="L427">        txtCodigo.setText(productoActual.getCodigo());</span>
<span class="nc" id="L428">        txtNombre.setText(productoActual.getNombre());</span>
<span class="nc" id="L429">        txtPrincipioActivo.setText(productoActual.getPrincipioActivo());</span>
<span class="nc" id="L430">        txtConcentracion.setText(productoActual.getConcentracion());</span>
<span class="nc" id="L431">        cmbFormaFarmaceutica.setValue(productoActual.getFormaFarmaceutica());</span>
<span class="nc" id="L432">        cmbCategoria.setValue(productoActual.getCategoria());</span>
<span class="nc" id="L433">        txtDescripcion.setText(productoActual.getDescripcion());</span>

        // Informaci√≥n comercial
<span class="nc" id="L436">        txtPrecioCompra.setText(productoActual.getPrecioCompra().toString());</span>
<span class="nc" id="L437">        txtPrecioVenta.setText(productoActual.getPrecioVenta().toString());</span>
<span class="nc bnc" id="L438" title="All 2 branches missed.">        txtLaboratorio.setText(productoActual.getLaboratorio() != null ? productoActual.getLaboratorio() : &quot;&quot;);</span>

        // --- Soluci√≥n robusta: cargar lista completa y limpiar filtro antes de
        // seleccionar proveedor ---
        // --- Desactivar temporalmente el listener de filtrado para evitar ciclo de
        // eventos ---
<span class="nc" id="L444">        cmbProveedor.getEditor().textProperty().removeListener(proveedorFiltroListener);</span>
<span class="nc" id="L445">        List&lt;Proveedor&gt; proveedoresFull = proveedorService.obtenerTodos();</span>
<span class="nc" id="L446">        cmbProveedor.setItems(FXCollections.observableArrayList(proveedoresFull));</span>
<span class="nc" id="L447">        cmbProveedor.getEditor().setText(&quot;&quot;);</span>
<span class="nc bnc" id="L448" title="All 2 branches missed.">        if (productoActual.getProveedorId() != null) {</span>
<span class="nc" id="L449">            proveedoresFull.stream()</span>
<span class="nc" id="L450">                    .filter(p -&gt; p.getId().equals(productoActual.getProveedorId()))</span>
<span class="nc" id="L451">                    .findFirst()</span>
<span class="nc" id="L452">                    .ifPresent(cmbProveedor::setValue);</span>
        }
        // Agregar listener solo despu√©s de cargar y seleccionar
<span class="nc" id="L455">        cmbProveedor.getEditor().textProperty().addListener(proveedorFiltroListener);</span>

        // Control de inventario
<span class="nc" id="L458">        spnStockActual.getValueFactory().setValue(productoActual.getStockActual());</span>
<span class="nc" id="L459">        spnStockMinimo.getValueFactory().setValue(productoActual.getStockMinimo());</span>
        // SOLO aqu√≠ se inicializa el spinner de stock m√°ximo
<span class="nc" id="L461">        Integer stockMaximoReal = productoActual.getStockMaximo();</span>
<span class="nc bnc" id="L462" title="All 4 branches missed.">        if (stockMaximoReal != null &amp;&amp; stockMaximoReal &gt; 0) {</span>
<span class="nc" id="L463">            spnStockMaximo.getValueFactory().setValue(stockMaximoReal);</span>
        } else {
<span class="nc" id="L465">            spnStockMaximo.getValueFactory().setValue(100); // Solo si no hay valor real</span>
        }
<span class="nc" id="L467">        txtUbicacion.setText(productoActual.getUbicacion());</span>
<span class="nc" id="L468">        txtLote.setText(productoActual.getLote());</span>

        // Fechas
<span class="nc" id="L471">        dpFechaVencimiento.setValue(productoActual.getFechaVencimiento());</span>
<span class="nc" id="L472">        dpFechaFabricacion.setValue(productoActual.getFechaFabricacion()); // Puede ser null y est√° bien</span>

        // Configuraci√≥n
<span class="nc" id="L475">        chkActivo.setSelected(productoActual.getActivo());</span>
<span class="nc" id="L476">        chkRequiereReceta.setSelected(productoActual.getRequiereReceta());</span>
<span class="nc" id="L477">        chkControlado.setSelected(productoActual.getEsControlado());</span>

<span class="nc" id="L479">        calcularMargen();</span>
        // Mostrar margen en campo txtMargen si existe
<span class="nc bnc" id="L481" title="All 2 branches missed.">        if (productoActual.getMargenGanancia() != null) {</span>
<span class="nc" id="L482">            txtMargen.setText(String.format(&quot;%.2f%%&quot;, productoActual.getMargenGanancia().doubleValue()));</span>
        }
<span class="nc" id="L484">    }</span>

    @FXML
    private void onGuardar(ActionEvent event) {
<span class="nc bnc" id="L488" title="All 2 branches missed.">        if (validarCampos()) {</span>
            try {
<span class="nc bnc" id="L490" title="All 2 branches missed.">                Producto producto = modoEdicion ? new Producto() : new Producto();</span>
                // Establecer datos b√°sicos
<span class="nc bnc" id="L492" title="All 4 branches missed.">                producto.setId(modoEdicion &amp;&amp; productoActual != null ? productoActual.getId() : null);</span>
<span class="nc" id="L493">                producto.setCodigo(txtCodigo.getText().trim().toUpperCase());</span>
<span class="nc" id="L494">                producto.setNombre(txtNombre.getText().trim());</span>
<span class="nc" id="L495">                producto.setPrincipioActivo(txtPrincipioActivo.getText().trim());</span>
<span class="nc" id="L496">                producto.setConcentracion(txtConcentracion.getText().trim());</span>
<span class="nc" id="L497">                producto.setFormaFarmaceutica(cmbFormaFarmaceutica.getValue());</span>
<span class="nc" id="L498">                producto.setCategoria(cmbCategoria.getValue());</span>
<span class="nc" id="L499">                producto.setDescripcion(txtDescripcion.getText().trim());</span>

                // Datos comerciales
<span class="nc" id="L502">                producto.setPrecioCompra(new BigDecimal(txtPrecioCompra.getText()));</span>
<span class="nc" id="L503">                producto.setPrecioVenta(new BigDecimal(txtPrecioVenta.getText()));</span>
<span class="nc" id="L504">                producto.setLaboratorio(txtLaboratorio.getText().trim());</span>
<span class="nc bnc" id="L505" title="All 2 branches missed.">                if (cmbProveedor.getValue() != null) {</span>
<span class="nc" id="L506">                    producto.setProveedorId(cmbProveedor.getValue().getId());</span>
                }

                // Control de inventario
<span class="nc bnc" id="L510" title="All 4 branches missed.">                int stockAnterior = modoEdicion &amp;&amp; productoActual != null ? productoActual.getStockActual() : -1;</span>
<span class="nc" id="L511">                int stockNuevo = spnStockActual.getValue();</span>
<span class="nc" id="L512">                producto.setStockActual(stockNuevo);</span>
<span class="nc" id="L513">                producto.setStockMinimo(spnStockMinimo.getValue());</span>
<span class="nc" id="L514">                producto.setStockMaximo(spnStockMaximo.getValue());</span>
<span class="nc" id="L515">                producto.setUbicacion(txtUbicacion.getText().trim());</span>
<span class="nc" id="L516">                producto.setLote(txtLote.getText().trim());</span>

                // Fechas
<span class="nc" id="L519">                producto.setFechaVencimiento(dpFechaVencimiento.getValue());</span>
<span class="nc" id="L520">                producto.setFechaFabricacion(dpFechaFabricacion.getValue());</span>

                // Configuraci√≥n
<span class="nc" id="L523">                producto.setActivo(chkActivo.isSelected());</span>
<span class="nc" id="L524">                producto.setRequiereReceta(chkRequiereReceta.isSelected());</span>
<span class="nc" id="L525">                producto.setEsControlado(chkControlado.isSelected());</span>

                // Calcular y guardar margen de ganancia
                try {
<span class="nc" id="L529">                    BigDecimal precioCompra = new BigDecimal(txtPrecioCompra.getText());</span>
<span class="nc" id="L530">                    BigDecimal precioVenta = new BigDecimal(txtPrecioVenta.getText());</span>
<span class="nc" id="L531">                    BigDecimal margen = BigDecimal.ZERO;</span>
<span class="nc bnc" id="L532" title="All 2 branches missed.">                    if (precioCompra.compareTo(BigDecimal.ZERO) &gt; 0) {</span>
<span class="nc" id="L533">                        margen = precioVenta.subtract(precioCompra)</span>
<span class="nc" id="L534">                                .divide(precioCompra, 4, java.math.RoundingMode.HALF_UP)</span>
<span class="nc" id="L535">                                .multiply(new BigDecimal(&quot;100&quot;));</span>
                    }
<span class="nc" id="L537">                    producto.setMargenGanancia(margen);</span>
<span class="nc" id="L538">                } catch (Exception e) {</span>
<span class="nc" id="L539">                    producto.setMargenGanancia(BigDecimal.ZERO);</span>
<span class="nc" id="L540">                }</span>

                // Registrar cambios en historial para todos los campos relevantes ANTES de
                // guardar
<span class="nc bnc" id="L544" title="All 6 branches missed.">                boolean esEdicion = modoEdicion &amp;&amp; productoActual != null &amp;&amp; productoActual.getId() != null;</span>
<span class="nc bnc" id="L545" title="All 2 branches missed.">                if (esEdicion) {</span>
<span class="nc" id="L546">                    String usuarioNombreCompleto = &quot;Desconocido&quot;;</span>
                    try {
                        com.farmaciavictoria.proyectopharmavictoria.model.Usuario.Usuario usuarioActual = com.farmaciavictoria.proyectopharmavictoria.service.AuthenticationService
<span class="nc" id="L549">                                .getUsuarioActual();</span>
<span class="nc bnc" id="L550" title="All 2 branches missed.">                        if (usuarioActual != null) {</span>
<span class="nc" id="L551">                            usuarioNombreCompleto = usuarioActual.getNombreCompleto();</span>
                        }
<span class="nc" id="L553">                    } catch (Exception ex) {</span>
<span class="nc" id="L554">                    }</span>

<span class="nc" id="L556">                    java.util.function.BiPredicate&lt;Object, Object&gt; distintos = (a, b) -&gt; {</span>
<span class="nc bnc" id="L557" title="All 4 branches missed.">                        if (a == null &amp;&amp; b == null)</span>
<span class="nc" id="L558">                            return false;</span>
<span class="nc bnc" id="L559" title="All 4 branches missed.">                        if (a == null || b == null)</span>
<span class="nc" id="L560">                            return true;</span>
<span class="nc bnc" id="L561" title="All 2 branches missed.">                        return !a.equals(b);</span>
                    };

<span class="nc bnc" id="L564" title="All 2 branches missed.">                    if (distintos.test(productoActual.getNombre(), producto.getNombre())) {</span>
<span class="nc" id="L565">                        com.farmaciavictoria.proyectopharmavictoria.repository.Inventario.ProductoHistorialCambioRepository</span>
<span class="nc" id="L566">                                .registrarCambio(</span>
<span class="nc" id="L567">                                        productoActual.getId(), &quot;nombre&quot;, String.valueOf(productoActual.getNombre()),</span>
<span class="nc" id="L568">                                        String.valueOf(producto.getNombre()), usuarioNombreCompleto);</span>
                    }
<span class="nc bnc" id="L570" title="All 2 branches missed.">                    if (distintos.test(productoActual.getPrincipioActivo(), producto.getPrincipioActivo())) {</span>
<span class="nc" id="L571">                        com.farmaciavictoria.proyectopharmavictoria.repository.Inventario.ProductoHistorialCambioRepository</span>
<span class="nc" id="L572">                                .registrarCambio(</span>
<span class="nc" id="L573">                                        productoActual.getId(), &quot;principio_activo&quot;,</span>
<span class="nc" id="L574">                                        String.valueOf(productoActual.getPrincipioActivo()),</span>
<span class="nc" id="L575">                                        String.valueOf(producto.getPrincipioActivo()), usuarioNombreCompleto);</span>
                    }
<span class="nc bnc" id="L577" title="All 2 branches missed.">                    if (distintos.test(productoActual.getConcentracion(), producto.getConcentracion())) {</span>
<span class="nc" id="L578">                        com.farmaciavictoria.proyectopharmavictoria.repository.Inventario.ProductoHistorialCambioRepository</span>
<span class="nc" id="L579">                                .registrarCambio(</span>
<span class="nc" id="L580">                                        productoActual.getId(), &quot;concentracion&quot;,</span>
<span class="nc" id="L581">                                        String.valueOf(productoActual.getConcentracion()),</span>
<span class="nc" id="L582">                                        String.valueOf(producto.getConcentracion()), usuarioNombreCompleto);</span>
                    }
<span class="nc bnc" id="L584" title="All 2 branches missed.">                    if (distintos.test(productoActual.getLaboratorio(), producto.getLaboratorio())) {</span>
<span class="nc" id="L585">                        com.farmaciavictoria.proyectopharmavictoria.repository.Inventario.ProductoHistorialCambioRepository</span>
<span class="nc" id="L586">                                .registrarCambio(</span>
<span class="nc" id="L587">                                        productoActual.getId(), &quot;laboratorio&quot;,</span>
<span class="nc" id="L588">                                        String.valueOf(productoActual.getLaboratorio()),</span>
<span class="nc" id="L589">                                        String.valueOf(producto.getLaboratorio()), usuarioNombreCompleto);</span>
                    }
<span class="nc bnc" id="L591" title="All 2 branches missed.">                    if (distintos.test(productoActual.getCategoria(), producto.getCategoria())) {</span>
<span class="nc" id="L592">                        com.farmaciavictoria.proyectopharmavictoria.repository.Inventario.ProductoHistorialCambioRepository</span>
<span class="nc" id="L593">                                .registrarCambio(</span>
<span class="nc" id="L594">                                        productoActual.getId(), &quot;categoria&quot;,</span>
<span class="nc" id="L595">                                        String.valueOf(productoActual.getCategoria()),</span>
<span class="nc" id="L596">                                        String.valueOf(producto.getCategoria()), usuarioNombreCompleto);</span>
                    }
<span class="nc bnc" id="L598" title="All 2 branches missed.">                    if (distintos.test(productoActual.getProveedorId(), producto.getProveedorId())) {</span>
<span class="nc" id="L599">                        com.farmaciavictoria.proyectopharmavictoria.repository.Inventario.ProductoHistorialCambioRepository</span>
<span class="nc" id="L600">                                .registrarCambio(</span>
<span class="nc" id="L601">                                        productoActual.getId(), &quot;proveedor_id&quot;,</span>
<span class="nc" id="L602">                                        String.valueOf(productoActual.getProveedorId()),</span>
<span class="nc" id="L603">                                        String.valueOf(producto.getProveedorId()), usuarioNombreCompleto);</span>
                    }
<span class="nc bnc" id="L605" title="All 2 branches missed.">                    if (distintos.test(productoActual.getDescripcion(), producto.getDescripcion())) {</span>
<span class="nc" id="L606">                        com.farmaciavictoria.proyectopharmavictoria.repository.Inventario.ProductoHistorialCambioRepository</span>
<span class="nc" id="L607">                                .registrarCambio(</span>
<span class="nc" id="L608">                                        productoActual.getId(), &quot;descripcion&quot;,</span>
<span class="nc" id="L609">                                        String.valueOf(productoActual.getDescripcion()),</span>
<span class="nc" id="L610">                                        String.valueOf(producto.getDescripcion()), usuarioNombreCompleto);</span>
                    }
<span class="nc bnc" id="L612" title="All 2 branches missed.">                    if (distintos.test(productoActual.getPrecioCompra(), producto.getPrecioCompra())) {</span>
<span class="nc" id="L613">                        com.farmaciavictoria.proyectopharmavictoria.repository.Inventario.ProductoHistorialCambioRepository</span>
<span class="nc" id="L614">                                .registrarCambio(</span>
<span class="nc" id="L615">                                        productoActual.getId(), &quot;precio_compra&quot;,</span>
<span class="nc" id="L616">                                        String.valueOf(productoActual.getPrecioCompra()),</span>
<span class="nc" id="L617">                                        String.valueOf(producto.getPrecioCompra()), usuarioNombreCompleto);</span>
                    }
<span class="nc bnc" id="L619" title="All 2 branches missed.">                    if (distintos.test(productoActual.getPrecioVenta(), producto.getPrecioVenta())) {</span>
<span class="nc" id="L620">                        com.farmaciavictoria.proyectopharmavictoria.repository.Inventario.ProductoHistorialCambioRepository</span>
<span class="nc" id="L621">                                .registrarCambio(</span>
<span class="nc" id="L622">                                        productoActual.getId(), &quot;precio_venta&quot;,</span>
<span class="nc" id="L623">                                        String.valueOf(productoActual.getPrecioVenta()),</span>
<span class="nc" id="L624">                                        String.valueOf(producto.getPrecioVenta()), usuarioNombreCompleto);</span>
                    }
<span class="nc bnc" id="L626" title="All 2 branches missed.">                    if (distintos.test(productoActual.getFechaFabricacion(), producto.getFechaFabricacion())) {</span>
<span class="nc" id="L627">                        com.farmaciavictoria.proyectopharmavictoria.repository.Inventario.ProductoHistorialCambioRepository</span>
<span class="nc" id="L628">                                .registrarCambio(</span>
<span class="nc" id="L629">                                        productoActual.getId(), &quot;fecha_fabricacion&quot;,</span>
<span class="nc" id="L630">                                        String.valueOf(productoActual.getFechaFabricacion()),</span>
<span class="nc" id="L631">                                        String.valueOf(producto.getFechaFabricacion()), usuarioNombreCompleto);</span>
                    }
<span class="nc bnc" id="L633" title="All 2 branches missed.">                    if (distintos.test(productoActual.getFechaVencimiento(), producto.getFechaVencimiento())) {</span>
<span class="nc" id="L634">                        com.farmaciavictoria.proyectopharmavictoria.repository.Inventario.ProductoHistorialCambioRepository</span>
<span class="nc" id="L635">                                .registrarCambio(</span>
<span class="nc" id="L636">                                        productoActual.getId(), &quot;fecha_vencimiento&quot;,</span>
<span class="nc" id="L637">                                        String.valueOf(productoActual.getFechaVencimiento()),</span>
<span class="nc" id="L638">                                        String.valueOf(producto.getFechaVencimiento()), usuarioNombreCompleto);</span>
                    }
<span class="nc bnc" id="L640" title="All 2 branches missed.">                    if (distintos.test(productoActual.getUbicacion(), producto.getUbicacion())) {</span>
<span class="nc" id="L641">                        com.farmaciavictoria.proyectopharmavictoria.repository.Inventario.ProductoHistorialCambioRepository</span>
<span class="nc" id="L642">                                .registrarCambio(</span>
<span class="nc" id="L643">                                        productoActual.getId(), &quot;ubicacion&quot;,</span>
<span class="nc" id="L644">                                        String.valueOf(productoActual.getUbicacion()),</span>
<span class="nc" id="L645">                                        String.valueOf(producto.getUbicacion()), usuarioNombreCompleto);</span>
                    }
<span class="nc bnc" id="L647" title="All 2 branches missed.">                    if (distintos.test(productoActual.getLote(), producto.getLote())) {</span>
<span class="nc" id="L648">                        com.farmaciavictoria.proyectopharmavictoria.repository.Inventario.ProductoHistorialCambioRepository</span>
<span class="nc" id="L649">                                .registrarCambio(</span>
<span class="nc" id="L650">                                        productoActual.getId(), &quot;lote&quot;, String.valueOf(productoActual.getLote()),</span>
<span class="nc" id="L651">                                        String.valueOf(producto.getLote()), usuarioNombreCompleto);</span>
                    }
<span class="nc bnc" id="L653" title="All 4 branches missed.">                    if (stockAnterior != -1 &amp;&amp; stockAnterior != stockNuevo) {</span>
<span class="nc" id="L654">                        com.farmaciavictoria.proyectopharmavictoria.repository.Inventario.ProductoHistorialCambioRepository</span>
<span class="nc" id="L655">                                .registrarCambio(</span>
<span class="nc" id="L656">                                        productoActual.getId(), &quot;stock_actual&quot;, String.valueOf(stockAnterior),</span>
<span class="nc" id="L657">                                        String.valueOf(stockNuevo), usuarioNombreCompleto);</span>
                    }
<span class="nc bnc" id="L659" title="All 2 branches missed.">                    if (distintos.test(productoActual.getRequiereReceta(), producto.getRequiereReceta())) {</span>
<span class="nc" id="L660">                        com.farmaciavictoria.proyectopharmavictoria.repository.Inventario.ProductoHistorialCambioRepository</span>
<span class="nc" id="L661">                                .registrarCambio(</span>
<span class="nc" id="L662">                                        productoActual.getId(), &quot;requiere_receta&quot;,</span>
<span class="nc" id="L663">                                        String.valueOf(productoActual.getRequiereReceta()),</span>
<span class="nc" id="L664">                                        String.valueOf(producto.getRequiereReceta()), usuarioNombreCompleto);</span>
                    }
<span class="nc bnc" id="L666" title="All 2 branches missed.">                    if (distintos.test(productoActual.getEsControlado(), producto.getEsControlado())) {</span>
<span class="nc" id="L667">                        com.farmaciavictoria.proyectopharmavictoria.repository.Inventario.ProductoHistorialCambioRepository</span>
<span class="nc" id="L668">                                .registrarCambio(</span>
<span class="nc" id="L669">                                        productoActual.getId(), &quot;es_controlado&quot;,</span>
<span class="nc" id="L670">                                        String.valueOf(productoActual.getEsControlado()),</span>
<span class="nc" id="L671">                                        String.valueOf(producto.getEsControlado()), usuarioNombreCompleto);</span>
                    }
<span class="nc bnc" id="L673" title="All 2 branches missed.">                    if (distintos.test(productoActual.getActivo(), producto.getActivo())) {</span>
<span class="nc" id="L674">                        com.farmaciavictoria.proyectopharmavictoria.repository.Inventario.ProductoHistorialCambioRepository</span>
<span class="nc" id="L675">                                .registrarCambio(</span>
<span class="nc" id="L676">                                        productoActual.getId(), &quot;activo&quot;, String.valueOf(productoActual.getActivo()),</span>
<span class="nc" id="L677">                                        String.valueOf(producto.getActivo()), usuarioNombreCompleto);</span>
                    }
                }

                // Guardar producto
                Producto productoGuardado;
<span class="nc bnc" id="L683" title="All 2 branches missed.">                if (esEdicion) {</span>
<span class="nc" id="L684">                    productoGuardado = productoService.actualizar(producto);</span>
                } else {
<span class="nc" id="L686">                    productoGuardado = productoService.guardar(producto);</span>
                }

<span class="nc bnc" id="L689" title="All 2 branches missed.">                if (productoGuardado != null) {</span>
                    // Refrescar desde la base de datos para asegurar datos actualizados
<span class="nc" id="L691">                    Producto productoRefrescado = productoService.obtenerPorId(productoGuardado.getId());</span>
                    // ...existing code...

                    // Notificar √©xito
<span class="nc bnc" id="L695" title="All 2 branches missed.">                    String mensaje = esEdicion ? &quot;Producto actualizado correctamente&quot; : &quot;Producto creado correctamente&quot;;</span>
<span class="nc" id="L696">                    showInfo(&quot;√âxito&quot;, mensaje);</span>

                    // Notificar al controlador padre si existe callback
<span class="nc bnc" id="L699" title="All 2 branches missed.">                    if (onProductoGuardado != null) {</span>
<span class="nc bnc" id="L700" title="All 2 branches missed.">                        onProductoGuardado.accept(productoRefrescado != null ? productoRefrescado : productoGuardado);</span>
                    }

                    // Lanzar evento de actualizaci√≥n para refresco inmediato
<span class="nc" id="L704">                    com.farmaciavictoria.proyectopharmavictoria.events.SystemEventManager.getInstance().publishEvent(</span>
<span class="nc bnc" id="L705" title="All 2 branches missed.">                            esEdicion</span>
<span class="nc" id="L706">                                    ? com.farmaciavictoria.proyectopharmavictoria.events.SystemEvent.EventType.PRODUCTO_ACTUALIZADO</span>
<span class="nc" id="L707">                                    : com.farmaciavictoria.proyectopharmavictoria.events.SystemEvent.EventType.PRODUCTO_CREADO,</span>
                            &quot;Producto guardado/actualizado&quot;,
<span class="nc" id="L709">                            productoGuardado.getId());</span>

                    // Cerrar el formulario autom√°ticamente
<span class="nc" id="L712">                    Stage stage = (Stage) btnGuardar.getScene().getWindow();</span>
<span class="nc bnc" id="L713" title="All 2 branches missed.">                    if (stage != null) {</span>
<span class="nc" id="L714">                        stage.close();</span>
                    }
<span class="nc" id="L716">                } else {</span>
<span class="nc" id="L717">                    showError(&quot;Error&quot;, &quot;No se pudo guardar el producto en la base de datos.&quot;);</span>
                }

<span class="nc" id="L720">            } catch (Exception e) {</span>
<span class="nc" id="L721">                showError(&quot;Error&quot;, &quot;No se pudo guardar el producto: &quot; + e.getMessage());</span>
<span class="nc" id="L722">            }</span>
        }
<span class="nc" id="L724">    }</span>

    @FXML
    private void onLimpiar(ActionEvent event) {
<span class="nc" id="L728">        Alert alert = new Alert(Alert.AlertType.CONFIRMATION);</span>
<span class="nc" id="L729">        alert.setTitle(&quot;Limpiar Campos&quot;);</span>
<span class="nc" id="L730">        alert.setHeaderText(&quot;¬øLimpiar todos los campos?&quot;);</span>
<span class="nc" id="L731">        alert.setContentText(&quot;Esta acci√≥n borrar√° toda la informaci√≥n ingresada.&quot;);</span>

<span class="nc bnc" id="L733" title="All 2 branches missed.">        if (alert.showAndWait().orElse(ButtonType.CANCEL) == ButtonType.OK) {</span>
<span class="nc" id="L734">            limpiarCampos();</span>
        }
<span class="nc" id="L736">    }</span>

    // M√©todo onCancelar eliminado
    // M√©todo onCerrar eliminado si no se usa

    private void limpiarCampos() {
        // Informaci√≥n b√°sica
<span class="nc" id="L743">        txtCodigo.clear();</span>
<span class="nc" id="L744">        txtNombre.clear();</span>
<span class="nc" id="L745">        txtPrincipioActivo.clear();</span>
<span class="nc" id="L746">        txtConcentracion.clear();</span>
<span class="nc" id="L747">        cmbFormaFarmaceutica.setValue(null);</span>
<span class="nc" id="L748">        cmbCategoria.setValue(null);</span>
<span class="nc" id="L749">        txtDescripcion.clear();</span>

        // Informaci√≥n comercial
<span class="nc" id="L752">        txtPrecioCompra.clear();</span>
<span class="nc" id="L753">        txtPrecioVenta.clear();</span>
<span class="nc" id="L754">        txtMargen.setText(&quot;0.00%&quot;);</span>
<span class="nc" id="L755">        cmbProveedor.setValue(null);</span>
<span class="nc" id="L756">        txtLaboratorio.clear();</span>

        // Control de inventario
<span class="nc" id="L759">        spnStockActual.getValueFactory().setValue(0);</span>
<span class="nc" id="L760">        spnStockMinimo.getValueFactory().setValue(1);</span>
<span class="nc" id="L761">        spnStockMaximo.getValueFactory().setValue(100);</span>
<span class="nc" id="L762">        txtUbicacion.clear();</span>
<span class="nc" id="L763">        txtLote.clear();</span>
<span class="nc" id="L764">        dpFechaVencimiento.setValue(null);</span>
<span class="nc" id="L765">        dpFechaFabricacion.setValue(null);</span>

        // Configuraci√≥n
<span class="nc" id="L768">        chkActivo.setSelected(true);</span>
<span class="nc" id="L769">        chkRequiereReceta.setSelected(false);</span>
<span class="nc" id="L770">        chkControlado.setSelected(false);</span>

        // Remover estilos de error
<span class="nc" id="L773">        limpiarEstilosValidacion();</span>
<span class="nc" id="L774">    }</span>

    private boolean validarCampos() {
<span class="nc" id="L777">        boolean valido = true;</span>
<span class="nc" id="L778">        limpiarEstilosValidacion();</span>

        // C√≥digo de producto obligatorio
<span class="nc bnc" id="L781" title="All 2 branches missed.">        if (txtCodigo.getText().trim().isEmpty()) {</span>
<span class="nc" id="L782">            marcarError(txtCodigo);</span>
<span class="nc" id="L783">            valido = false;</span>
        }
        // Nombre de producto obligatorio
<span class="nc bnc" id="L786" title="All 2 branches missed.">        if (txtNombre.getText().trim().isEmpty()) {</span>
<span class="nc" id="L787">            marcarError(txtNombre);</span>
<span class="nc" id="L788">            valido = false;</span>
        }
        // Forma Farmac√©utica NO obligatoria
        // Categor√≠a obligatoria
<span class="nc bnc" id="L792" title="All 2 branches missed.">        if (cmbCategoria.getValue() == null) {</span>
<span class="nc" id="L793">            marcarError(cmbCategoria);</span>
<span class="nc" id="L794">            valido = false;</span>
        }
        // Precio de compra obligatorio
<span class="nc bnc" id="L797" title="All 4 branches missed.">        if (txtPrecioCompra.getText().trim().isEmpty() || !isValidDecimal(txtPrecioCompra.getText())) {</span>
<span class="nc" id="L798">            marcarError(txtPrecioCompra);</span>
<span class="nc" id="L799">            valido = false;</span>
        }
        // Precio de venta obligatorio
<span class="nc bnc" id="L802" title="All 4 branches missed.">        if (txtPrecioVenta.getText().trim().isEmpty() || !isValidDecimal(txtPrecioVenta.getText())) {</span>
<span class="nc" id="L803">            marcarError(txtPrecioVenta);</span>
<span class="nc" id="L804">            valido = false;</span>
        }
        // Proveedor obligatorio
<span class="nc bnc" id="L807" title="All 2 branches missed.">        if (cmbProveedor.getValue() == null) {</span>
<span class="nc" id="L808">            marcarError(cmbProveedor);</span>
<span class="nc" id="L809">            valido = false;</span>
        }
        // Stock actual obligatorio
<span class="nc bnc" id="L812" title="All 4 branches missed.">        if (spnStockActual.getValue() == null || spnStockActual.getValue() &lt;= 0) {</span>
<span class="nc" id="L813">            marcarError(spnStockActual);</span>
<span class="nc" id="L814">            valido = false;</span>
        }
        // Stock m√≠nimo es opcional, no marcar error visual ni validar como obligatorio
        // Fecha de vencimiento obligatoria
<span class="nc bnc" id="L818" title="All 2 branches missed.">        if (dpFechaVencimiento.getValue() == null) {</span>
<span class="nc" id="L819">            marcarError(dpFechaVencimiento);</span>
<span class="nc" id="L820">            valido = false;</span>
        }

        // Validar que precio de venta sea mayor a precio de compra
        try {
<span class="nc" id="L825">            BigDecimal precioCompra = new BigDecimal(txtPrecioCompra.getText());</span>
<span class="nc" id="L826">            BigDecimal precioVenta = new BigDecimal(txtPrecioVenta.getText());</span>

<span class="nc bnc" id="L828" title="All 2 branches missed.">            if (precioVenta.compareTo(precioCompra) &lt;= 0) {</span>
<span class="nc" id="L829">                marcarError(txtPrecioVenta);</span>
<span class="nc" id="L830">                showWarning(&quot;Validaci√≥n&quot;, &quot;El precio de venta debe ser mayor al precio de compra.&quot;);</span>
<span class="nc" id="L831">                valido = false;</span>
            }
<span class="nc" id="L833">        } catch (NumberFormatException e) {</span>
            // Ya se valid√≥ antes
<span class="nc" id="L835">        }</span>

        // Validar fechas l√≥gicas
<span class="nc bnc" id="L838" title="All 4 branches missed.">        if (dpFechaFabricacion.getValue() != null &amp;&amp; dpFechaVencimiento.getValue() != null) {</span>
<span class="nc bnc" id="L839" title="All 2 branches missed.">            if (dpFechaFabricacion.getValue().isAfter(dpFechaVencimiento.getValue())) {</span>
<span class="nc" id="L840">                marcarError(dpFechaVencimiento);</span>
<span class="nc" id="L841">                showWarning(&quot;Validaci√≥n&quot;, &quot;La fecha de vencimiento debe ser posterior a la fecha de fabricaci√≥n.&quot;);</span>
<span class="nc" id="L842">                valido = false;</span>
            }
        }

<span class="nc bnc" id="L846" title="All 2 branches missed.">        if (!valido) {</span>
<span class="nc" id="L847">            showWarning(&quot;Campos requeridos&quot;, &quot;Por favor completa todos los campos obligatorios marcados con *&quot;);</span>
        }

<span class="nc" id="L850">        return valido;</span>
    }

    private boolean isValidDecimal(String text) {
        try {
<span class="nc" id="L855">            BigDecimal value = new BigDecimal(text);</span>
<span class="nc bnc" id="L856" title="All 2 branches missed.">            return value.compareTo(BigDecimal.ZERO) &gt; 0;</span>
<span class="nc" id="L857">        } catch (NumberFormatException e) {</span>
<span class="nc" id="L858">            return false;</span>
        }
    }

    private void marcarError(Control control) {
<span class="nc" id="L863">        control.getStyleClass().add(&quot;field-error&quot;);</span>
<span class="nc" id="L864">    }</span>

    private void limpiarEstilosValidacion() {
<span class="nc" id="L867">        txtCodigo.getStyleClass().removeAll(&quot;field-error&quot;, &quot;field-success&quot;);</span>
<span class="nc" id="L868">        txtNombre.getStyleClass().removeAll(&quot;field-error&quot;, &quot;field-success&quot;);</span>
<span class="nc" id="L869">        cmbCategoria.getStyleClass().removeAll(&quot;field-error&quot;, &quot;field-success&quot;);</span>
<span class="nc" id="L870">        txtPrecioVenta.getStyleClass().removeAll(&quot;field-error&quot;, &quot;field-success&quot;);</span>
<span class="nc" id="L871">        cmbProveedor.getStyleClass().removeAll(&quot;field-error&quot;, &quot;field-success&quot;);</span>
<span class="nc" id="L872">        spnStockActual.getStyleClass().removeAll(&quot;field-error&quot;, &quot;field-success&quot;);</span>
        // spnStockMinimo no se limpia porque es opcional
<span class="nc" id="L874">        dpFechaVencimiento.getStyleClass().removeAll(&quot;field-error&quot;, &quot;field-success&quot;);</span>
        // Los campos opcionales NO se limpian porque nunca deben marcar error
<span class="nc" id="L876">    }</span>

    // M√©todo cerrarVentana eliminado completamente

    // Setter para el callback
    public void setOnProductoGuardado(Consumer&lt;Producto&gt; callback) {
<span class="nc" id="L882">        this.onProductoGuardado = callback;</span>
<span class="nc" id="L883">    }</span>

    // M√©todos de utilidad para mostrar alertas
    private void showInfo(String title, String message) {
<span class="nc" id="L887">        Alert alert = new Alert(Alert.AlertType.INFORMATION);</span>
<span class="nc" id="L888">        alert.setTitle(title);</span>
<span class="nc" id="L889">        alert.setHeaderText(null);</span>
<span class="nc" id="L890">        alert.setContentText(message);</span>
<span class="nc" id="L891">        alert.showAndWait();</span>
<span class="nc" id="L892">    }</span>

    private void showWarning(String title, String message) {
<span class="nc" id="L895">        Alert alert = new Alert(Alert.AlertType.WARNING);</span>
<span class="nc" id="L896">        alert.setTitle(title);</span>
<span class="nc" id="L897">        alert.setHeaderText(null);</span>
<span class="nc" id="L898">        alert.setContentText(message);</span>
<span class="nc" id="L899">        alert.showAndWait();</span>
<span class="nc" id="L900">    }</span>

    private void showError(String title, String message) {
<span class="nc" id="L903">        Alert alert = new Alert(Alert.AlertType.ERROR);</span>
<span class="nc" id="L904">        alert.setTitle(title);</span>
<span class="nc" id="L905">        alert.setHeaderText(null);</span>
<span class="nc" id="L906">        alert.setContentText(message);</span>
<span class="nc" id="L907">        alert.showAndWait();</span>
<span class="nc" id="L908">    }</span>

    private void generarCodigoAutomatico() {
        try {
<span class="nc" id="L912">            CategoriaProducto categoria = cmbCategoria.getValue();</span>
<span class="nc bnc" id="L913" title="All 2 branches missed.">            if (categoria == null) {</span>
<span class="nc" id="L914">                showWarning(&quot;‚ö†Ô∏è Selecciona una categor√≠a&quot;,</span>
                        &quot;Debes seleccionar una categor√≠a antes de generar el c√≥digo.&quot;);
<span class="nc" id="L916">                return;</span>
            }

<span class="nc" id="L919">            String nuevoCodigo = codigoGenerator.generarSiguienteCodigo(categoria.name());</span>
<span class="nc" id="L920">            txtCodigo.setText(nuevoCodigo);</span>

<span class="nc" id="L922">            showInfo(&quot;C√≥digo generado&quot;, &quot;C√≥digo generado autom√°ticamente: &quot; + nuevoCodigo);</span>

<span class="nc" id="L924">        } catch (Exception e) {</span>
<span class="nc" id="L925">            showError(&quot;Error&quot;, &quot;No se pudo generar el c√≥digo autom√°ticamente: &quot; + e.getMessage());</span>
<span class="nc" id="L926">        }</span>
<span class="nc" id="L927">    }</span>

    // Sugiere un c√≥digo basado en el nombre y categor√≠a
    private void sugerirCodigo() {
        try {
<span class="nc" id="L932">            String nombre = txtNombre.getText();</span>
<span class="nc" id="L933">            CategoriaProducto categoria = cmbCategoria.getValue();</span>

<span class="nc bnc" id="L935" title="All 4 branches missed.">            if (nombre != null &amp;&amp; !nombre.trim().isEmpty()) {</span>
<span class="nc bnc" id="L936" title="All 2 branches missed.">                String categoriaStr = categoria != null ? categoria.name() : null;</span>
<span class="nc" id="L937">                String codigoSugerido = codigoGenerator.sugerirCodigoPorNombre(nombre, categoriaStr);</span>

                // Solo sugerir si el campo est√° vac√≠o
<span class="nc bnc" id="L940" title="All 4 branches missed.">                if (txtCodigo.getText() == null || txtCodigo.getText().trim().isEmpty()) {</span>
<span class="nc" id="L941">                    txtCodigo.setText(codigoSugerido);</span>
                }
            }
<span class="nc" id="L944">        } catch (Exception e) {</span>
            // Error silencioso para sugerencias
<span class="nc" id="L946">        }</span>
<span class="nc" id="L947">    }</span>

    // Valida el c√≥digo ingresado
    private void validarCodigo(String codigo) {
<span class="nc bnc" id="L951" title="All 2 branches missed.">        if (lblValidacionCodigo == null)</span>
<span class="nc" id="L952">            return; // Si no existe el label, no validar</span>

<span class="nc bnc" id="L954" title="All 4 branches missed.">        if (codigo == null || codigo.trim().isEmpty()) {</span>
<span class="nc" id="L955">            lblValidacionCodigo.setText(&quot;&quot;);</span>
<span class="nc" id="L956">            lblValidacionCodigo.setStyle(&quot;&quot;);</span>
<span class="nc" id="L957">            return;</span>
        }

        try {
<span class="nc" id="L961">            boolean existe = codigoGenerator.codigoExiste(codigo.trim());</span>

<span class="nc bnc" id="L963" title="All 4 branches missed.">            if (existe &amp;&amp; !modoEdicion) {</span>
<span class="nc" id="L964">                lblValidacionCodigo.setText(&quot;Este c√≥digo ya existe&quot;);</span>
<span class="nc" id="L965">                lblValidacionCodigo.setStyle(&quot;-fx-text-fill: red;&quot;);</span>
<span class="nc" id="L966">                btnGuardar.setDisable(true);</span>
<span class="nc bnc" id="L967" title="All 2 branches missed.">            } else if (!existe) {</span>
<span class="nc" id="L968">                lblValidacionCodigo.setText(&quot;C√≥digo disponible&quot;);</span>
<span class="nc" id="L969">                lblValidacionCodigo.setStyle(&quot;-fx-text-fill: green;&quot;);</span>
<span class="nc" id="L970">                btnGuardar.setDisable(false);</span>
            } else {
                // Editando producto existente
<span class="nc" id="L973">                lblValidacionCodigo.setText(&quot;‚ÑπÔ∏è C√≥digo actual&quot;);</span>
<span class="nc" id="L974">                lblValidacionCodigo.setStyle(&quot;-fx-text-fill: blue;&quot;);</span>
<span class="nc" id="L975">                btnGuardar.setDisable(false);</span>
            }

<span class="nc" id="L978">        } catch (Exception e) {</span>
<span class="nc" id="L979">            lblValidacionCodigo.setText(&quot;‚ö†Ô∏è Error al validar&quot;);</span>
<span class="nc" id="L980">            lblValidacionCodigo.setStyle(&quot;-fx-text-fill: orange;&quot;);</span>
<span class="nc" id="L981">        }</span>
<span class="nc" id="L982">    }</span>

    // üìã Actualiza la informaci√≥n de la categor√≠a seleccionada
    private void actualizarInfoCategoria() {
<span class="nc bnc" id="L986" title="All 2 branches missed.">        if (lblUltimoCodigo == null)</span>
<span class="nc" id="L987">            return; // Si no existe el label, no actualizar</span>

<span class="nc" id="L989">        CategoriaProducto categoria = cmbCategoria.getValue();</span>
<span class="nc bnc" id="L990" title="All 2 branches missed.">        if (categoria != null) {</span>
            try {
<span class="nc" id="L992">                String ultimoCodigo = codigoGenerator.obtenerUltimoCodigo(categoria.name());</span>
<span class="nc bnc" id="L993" title="All 2 branches missed.">                if (ultimoCodigo != null) {</span>
<span class="nc" id="L994">                    lblUltimoCodigo.setText(&quot;√öltimo c√≥digo: &quot; + ultimoCodigo);</span>
                } else {
<span class="nc" id="L996">                    lblUltimoCodigo.setText(&quot;Categor√≠a nueva (sin c√≥digos previos)&quot;);</span>
                }
<span class="nc" id="L998">            } catch (Exception e) {</span>
<span class="nc" id="L999">                lblUltimoCodigo.setText(&quot;Error al obtener informaci√≥n&quot;);</span>
<span class="nc" id="L1000">            }</span>
        } else {
<span class="nc" id="L1002">            lblUltimoCodigo.setText(&quot;&quot;);</span>
        }
<span class="nc" id="L1004">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>
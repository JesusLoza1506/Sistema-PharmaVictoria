<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ComprobanteRepositoryJdbcImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">proyectopharmavictoria</a> &gt; <a href="index.source.html" class="el_package">com.farmaciavictoria.proyectopharmavictoria.repository.Ventas</a> &gt; <span class="el_source">ComprobanteRepositoryJdbcImpl.java</span></div><h1>ComprobanteRepositoryJdbcImpl.java</h1><pre class="source lang-java linenums">package com.farmaciavictoria.proyectopharmavictoria.repository.Ventas;

import com.farmaciavictoria.proyectopharmavictoria.model.Ventas.Comprobante;
import java.sql.*;
import java.util.List;
import java.util.ArrayList;
import com.farmaciavictoria.proyectopharmavictoria.config.DatabaseConfig;

public class ComprobanteRepositoryJdbcImpl implements ComprobanteRepository {
    /**
     * Obtiene el siguiente número de boleta para una serie dada.
     */
    public String obtenerSiguienteNumeroBoleta(String serie) {
<span class="nc" id="L14">        String ultimoNumero = &quot;000001&quot;;</span>
<span class="nc" id="L15">        String sql = &quot;SELECT MAX(CAST(numero AS UNSIGNED)) FROM comprobantes WHERE tipo='BOLETA' AND serie=?&quot;;</span>
<span class="nc" id="L16">        try (Connection conn = DatabaseConfig.getInstance().getConnection();</span>
<span class="nc" id="L17">                PreparedStatement stmt = conn.prepareStatement(sql)) {</span>
<span class="nc" id="L18">            stmt.setString(1, serie);</span>
<span class="nc" id="L19">            try (ResultSet rs = stmt.executeQuery()) {</span>
<span class="nc" id="L20">                int num = 0;</span>
<span class="nc bnc" id="L21" title="All 2 branches missed.">                if (rs.next()) {</span>
<span class="nc" id="L22">                    num = rs.getInt(1);</span>
                }
<span class="nc" id="L24">                num++;</span>
<span class="nc" id="L25">                ultimoNumero = String.format(&quot;%06d&quot;, num);</span>
            }
<span class="nc" id="L27">        } catch (Exception ex) {</span>
<span class="nc" id="L28">            System.err.println(&quot;Error obteniendo número de boleta: &quot; + ex.getMessage());</span>
<span class="nc" id="L29">            ultimoNumero = &quot;000001&quot;;</span>
<span class="nc" id="L30">        }</span>
<span class="nc" id="L31">        return ultimoNumero;</span>
    }

    /**
     * Obtiene el último número de comprobante para una serie dada (FACTURA o
     * BOLETA).
     * Devuelve 0 si no hay comprobantes previos.
     */
    public int obtenerUltimoNumeroPorSerieYTipo(String serie, String tipo) {
<span class="nc" id="L40">        int ultimoNumero = 0;</span>
<span class="nc" id="L41">        String sql = &quot;SELECT MAX(CAST(numero AS UNSIGNED)) FROM comprobantes WHERE serie=? AND tipo=?&quot;;</span>
<span class="nc" id="L42">        try (Connection conn = DatabaseConfig.getInstance().getConnection();</span>
<span class="nc" id="L43">                PreparedStatement stmt = conn.prepareStatement(sql)) {</span>
<span class="nc" id="L44">            stmt.setString(1, serie);</span>
<span class="nc" id="L45">            stmt.setString(2, tipo);</span>
<span class="nc" id="L46">            try (ResultSet rs = stmt.executeQuery()) {</span>
<span class="nc bnc" id="L47" title="All 2 branches missed.">                if (rs.next()) {</span>
<span class="nc" id="L48">                    ultimoNumero = rs.getInt(1);</span>
                }
            }
<span class="nc" id="L51">        } catch (Exception ex) {</span>
<span class="nc" id="L52">            System.err.println(&quot;Error obteniendo último número por serie y tipo: &quot; + ex.getMessage());</span>
<span class="nc" id="L53">            ultimoNumero = 0;</span>
<span class="nc" id="L54">        }</span>
<span class="nc" id="L55">        return ultimoNumero;</span>
    }

<span class="nc" id="L58">    public ComprobanteRepositoryJdbcImpl() {</span>
        // Sin argumentos, usa DatabaseConfig Singleton
<span class="nc" id="L60">    }</span>

    @Override
    public Comprobante findById(int id) {
<span class="nc" id="L64">        String sql = &quot;SELECT * FROM comprobantes WHERE id = ?&quot;;</span>
<span class="nc" id="L65">        try (Connection connection = DatabaseConfig.getInstance().getConnection();</span>
<span class="nc" id="L66">                PreparedStatement stmt = connection.prepareStatement(sql)) {</span>
<span class="nc" id="L67">            stmt.setInt(1, id);</span>
<span class="nc" id="L68">            try (ResultSet rs = stmt.executeQuery()) {</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">                if (rs.next()) {</span>
<span class="nc" id="L70">                    return mapComprobanteFromResultSet(rs);</span>
                }
<span class="nc bnc" id="L72" title="All 2 branches missed.">            }</span>
<span class="nc bnc" id="L73" title="All 4 branches missed.">        } catch (SQLException e) {</span>
<span class="nc" id="L74">            throw new RuntimeException(&quot;Error al buscar comprobante por ID&quot;, e);</span>
<span class="nc" id="L75">        }</span>
<span class="nc" id="L76">        return null;</span>
    }

    @Override
    public void update(Comprobante comprobante) {
<span class="nc" id="L81">        String sql = &quot;UPDATE comprobantes SET venta_id=?, tipo=?, serie=?, numero=?, hash_sunat=?, estado_sunat=?, fecha_emision=? WHERE id=?&quot;;</span>
<span class="nc" id="L82">        try (Connection connection = DatabaseConfig.getInstance().getConnection();</span>
<span class="nc" id="L83">                PreparedStatement stmt = connection.prepareStatement(sql)) {</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">            stmt.setObject(1, comprobante.getVenta() != null ? comprobante.getVenta().getId() : null);</span>
<span class="nc" id="L85">            stmt.setString(2, comprobante.getTipo());</span>
<span class="nc" id="L86">            stmt.setString(3, comprobante.getSerie());</span>
<span class="nc" id="L87">            stmt.setString(4, comprobante.getNumero());</span>
<span class="nc" id="L88">            stmt.setString(5, comprobante.getHashSunat());</span>
<span class="nc" id="L89">            stmt.setString(6, comprobante.getEstadoSunat());</span>
<span class="nc" id="L90">            stmt.setObject(7, comprobante.getFechaEmision());</span>
<span class="nc" id="L91">            stmt.setInt(8, comprobante.getId());</span>
<span class="nc" id="L92">            stmt.executeUpdate();</span>
<span class="nc" id="L93">        } catch (SQLException e) {</span>
<span class="nc" id="L94">            throw new RuntimeException(&quot;Error al actualizar comprobante&quot;, e);</span>
<span class="nc" id="L95">        }</span>
<span class="nc" id="L96">    }</span>

    @Override
    public void delete(int id) {
<span class="nc" id="L100">        String sql = &quot;DELETE FROM comprobantes WHERE id = ?&quot;;</span>
<span class="nc" id="L101">        try (Connection connection = DatabaseConfig.getInstance().getConnection();</span>
<span class="nc" id="L102">                PreparedStatement stmt = connection.prepareStatement(sql)) {</span>
<span class="nc" id="L103">            stmt.setInt(1, id);</span>
<span class="nc" id="L104">            stmt.executeUpdate();</span>
<span class="nc" id="L105">        } catch (SQLException e) {</span>
<span class="nc" id="L106">            throw new RuntimeException(&quot;Error al eliminar comprobante&quot;, e);</span>
<span class="nc" id="L107">        }</span>
<span class="nc" id="L108">    }</span>

    @Override
    public void save(Comprobante comprobante) {
<span class="nc" id="L112">        String sql = &quot;INSERT INTO comprobantes (venta_id, tipo, serie, numero, hash_sunat, estado_sunat, fecha_emision) VALUES (?, ?, ?, ?, ?, ?, ?)&quot;;</span>
<span class="nc" id="L113">        try (Connection connection = DatabaseConfig.getInstance().getConnection();</span>
<span class="nc" id="L114">                PreparedStatement stmt = connection.prepareStatement(sql)) {</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">            stmt.setObject(1, comprobante.getVenta() != null ? comprobante.getVenta().getId() : null);</span>
<span class="nc" id="L116">            stmt.setString(2, comprobante.getTipo());</span>
<span class="nc" id="L117">            stmt.setString(3, comprobante.getSerie());</span>
<span class="nc" id="L118">            stmt.setString(4, comprobante.getNumero());</span>
<span class="nc" id="L119">            stmt.setString(5, comprobante.getHashSunat());</span>
<span class="nc" id="L120">            stmt.setString(6, comprobante.getEstadoSunat());</span>
<span class="nc" id="L121">            stmt.setObject(7, comprobante.getFechaEmision());</span>
<span class="nc" id="L122">            stmt.executeUpdate();</span>
<span class="nc" id="L123">        } catch (SQLException e) {</span>
<span class="nc" id="L124">            throw new RuntimeException(&quot;Error al guardar comprobante&quot;, e);</span>
<span class="nc" id="L125">        }</span>
<span class="nc" id="L126">    }</span>

    @Override
    public List&lt;Comprobante&gt; findByVentaId(int ventaId) {
<span class="nc" id="L130">        List&lt;Comprobante&gt; comprobantes = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L131">        String sql = &quot;SELECT * FROM comprobantes WHERE venta_id = ?&quot;;</span>
<span class="nc" id="L132">        try (Connection connection = DatabaseConfig.getInstance().getConnection();</span>
<span class="nc" id="L133">                PreparedStatement stmt = connection.prepareStatement(sql)) {</span>
<span class="nc" id="L134">            stmt.setInt(1, ventaId);</span>
<span class="nc" id="L135">            try (ResultSet rs = stmt.executeQuery()) {</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">                while (rs.next()) {</span>
<span class="nc" id="L137">                    comprobantes.add(mapComprobanteFromResultSet(rs));</span>
                }
            }
<span class="nc" id="L140">        } catch (SQLException e) {</span>
<span class="nc" id="L141">            throw new RuntimeException(&quot;Error al buscar comprobantes por ventaId&quot;, e);</span>
<span class="nc" id="L142">        }</span>
<span class="nc" id="L143">        return comprobantes;</span>
    }

    // Utilidad para mapear ResultSet a Comprobante
    private Comprobante mapComprobanteFromResultSet(ResultSet rs) throws SQLException {
<span class="nc" id="L148">        Comprobante comprobante = new Comprobante();</span>
<span class="nc" id="L149">        comprobante.setId(rs.getInt(&quot;id&quot;));</span>
        // Solo se setea el ID de venta. Se recomienda cargar el objeto completo en el
        // Service si se requiere.
<span class="nc" id="L152">        comprobante.setTipo(rs.getString(&quot;tipo&quot;));</span>
<span class="nc" id="L153">        comprobante.setSerie(rs.getString(&quot;serie&quot;));</span>
<span class="nc" id="L154">        comprobante.setNumero(rs.getString(&quot;numero&quot;));</span>
<span class="nc" id="L155">        comprobante.setHashSunat(rs.getString(&quot;hash_sunat&quot;));</span>
<span class="nc" id="L156">        comprobante.setEstadoSunat(rs.getString(&quot;estado_sunat&quot;));</span>
<span class="nc" id="L157">        comprobante.setFechaEmision(</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">                rs.getTimestamp(&quot;fecha_emision&quot;) != null ? rs.getTimestamp(&quot;fecha_emision&quot;).toLocalDateTime() : null);</span>
<span class="nc" id="L159">        return comprobante;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>
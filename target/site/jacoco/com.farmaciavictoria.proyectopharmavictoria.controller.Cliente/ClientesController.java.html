<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ClientesController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">proyectopharmavictoria</a> &gt; <a href="index.source.html" class="el_package">com.farmaciavictoria.proyectopharmavictoria.controller.Cliente</a> &gt; <span class="el_source">ClientesController.java</span></div><h1>ClientesController.java</h1><pre class="source lang-java linenums">package com.farmaciavictoria.proyectopharmavictoria.controller.Cliente;

import javafx.scene.control.TableCell;
import javafx.collections.FXCollections;
import javafx.fxml.FXML;
import javafx.scene.control.ComboBox;
import javafx.scene.control.Button;
import javafx.fxml.Initializable;
import java.net.URL;
import java.util.ResourceBundle;
import com.farmaciavictoria.proyectopharmavictoria.model.Cliente.Cliente;
// import javafx.scene.control.CheckBox; // Eliminado
import javafx.scene.control.Label;
import javafx.scene.control.TableColumn;
import javafx.scene.control.TableView;
import javafx.scene.control.TextField;

<span class="nc" id="L18">public class ClientesController implements Initializable {</span>

    public void setBarChartTopClientes(javafx.scene.chart.BarChart&lt;String, Number&gt; barChart) {
<span class="nc" id="L21">        this.barChartTopClientes = barChart;</span>
<span class="nc" id="L22">    }</span>

    public void setLblAlertasClientes(Label label) {
<span class="nc" id="L25">        this.lblAlertasClientes = label;</span>
<span class="nc" id="L26">    }</span>

    @FXML
    private javafx.scene.chart.BarChart&lt;String, Number&gt; barChartTopClientes;
    @FXML
    private javafx.scene.chart.CategoryAxis barChartClientesXAxis;
    @FXML
    private javafx.scene.chart.NumberAxis barChartClientesYAxis;
    @FXML
    private javafx.scene.chart.PieChart pieChartRangoEdad;
    @FXML
    private Label lblDistribucionEdad;

    private void cargarTopClientesConMasCompras() {
        // Obtener todos los clientes reales (sin genéricos)
<span class="nc" id="L41">        java.util.Map&lt;Integer, Integer&gt; comprasPorCliente = new java.util.HashMap&lt;&gt;();</span>
<span class="nc" id="L42">        java.util.Map&lt;Integer, com.farmaciavictoria.proyectopharmavictoria.model.Cliente.Cliente&gt; clientesMap = new java.util.HashMap&lt;&gt;();</span>
        try {
<span class="nc" id="L44">            System.out.println(&quot;[DASHBOARD] Iniciando carga de Top Clientes...&quot;);</span>
<span class="nc bnc" id="L45" title="All 2 branches missed.">            if (clienteService == null) {</span>
<span class="nc" id="L46">                System.err.println(&quot;[DASHBOARD ERROR] clienteService es null&quot;);</span>
<span class="nc" id="L47">                return;</span>
            }
<span class="nc" id="L49">            java.util.List&lt;com.farmaciavictoria.proyectopharmavictoria.model.Cliente.Cliente&gt; clientes = clienteService</span>
<span class="nc" id="L50">                    .obtenerTodos();</span>
<span class="nc" id="L51">            System.out.println(&quot;[DASHBOARD] Total clientes obtenidos: &quot; + clientes.size());</span>
<span class="nc" id="L52">            com.farmaciavictoria.proyectopharmavictoria.repository.Ventas.VentaRepositoryJdbcImpl ventaRepository = new com.farmaciavictoria.proyectopharmavictoria.repository.Ventas.VentaRepositoryJdbcImpl();</span>
<span class="nc" id="L53">            com.farmaciavictoria.proyectopharmavictoria.repository.Ventas.DetalleVentaRepositoryJdbcImpl detalleVentaRepository = new com.farmaciavictoria.proyectopharmavictoria.repository.Ventas.DetalleVentaRepositoryJdbcImpl();</span>
<span class="nc" id="L54">            com.farmaciavictoria.proyectopharmavictoria.repository.Ventas.ComprobanteRepositoryJdbcImpl comprobanteRepository = new com.farmaciavictoria.proyectopharmavictoria.repository.Ventas.ComprobanteRepositoryJdbcImpl();</span>
<span class="nc" id="L55">            com.farmaciavictoria.proyectopharmavictoria.repository.Ventas.VentaHistorialCambioRepositoryJdbcImpl historialCambioRepository = new com.farmaciavictoria.proyectopharmavictoria.repository.Ventas.VentaHistorialCambioRepositoryJdbcImpl();</span>
<span class="nc" id="L56">            com.farmaciavictoria.proyectopharmavictoria.repository.Inventario.ProductoRepository productoRepository = new com.farmaciavictoria.proyectopharmavictoria.repository.Inventario.ProductoRepository();</span>
<span class="nc" id="L57">            com.farmaciavictoria.proyectopharmavictoria.service.Ventas.VentaServiceImpl ventaService = new com.farmaciavictoria.proyectopharmavictoria.service.Ventas.VentaServiceImpl(</span>
                    ventaRepository,
                    detalleVentaRepository,
                    comprobanteRepository,
                    historialCambioRepository,
                    productoRepository);
<span class="nc bnc" id="L63" title="All 2 branches missed.">            for (com.farmaciavictoria.proyectopharmavictoria.model.Cliente.Cliente cliente : clientes) {</span>
                try {
                    // Incluir tanto clientes NATURAL como EMPRESA, excluyendo solo los genéricos
                    // (documento 00000000)
<span class="nc bnc" id="L67" title="All 2 branches missed.">                    if (cliente.getId() != null</span>
<span class="nc bnc" id="L68" title="All 4 branches missed.">                            &amp;&amp; (cliente.getDocumento() == null || !cliente.getDocumento().equals(&quot;00000000&quot;))) {</span>
<span class="nc" id="L69">                        java.util.List&lt;com.farmaciavictoria.proyectopharmavictoria.model.Ventas.Venta&gt; ventasCliente = ventaService</span>
<span class="nc" id="L70">                                .listarVentasPorCliente(cliente.getId());</span>
<span class="nc" id="L71">                        System.out.println(&quot;[DASHBOARD] Cliente: &quot; + cliente.getNombres() + &quot; &quot; + cliente.getApellidos()</span>
<span class="nc" id="L72">                                + &quot; | Tipo: &quot; + cliente.getTipoCliente() + &quot; | Compras: &quot; + ventasCliente.size());</span>
<span class="nc" id="L73">                        comprasPorCliente.put(cliente.getId(), ventasCliente.size());</span>
<span class="nc" id="L74">                        clientesMap.put(cliente.getId(), cliente);</span>
                    }
<span class="nc" id="L76">                } catch (Exception ex) {</span>
<span class="nc" id="L77">                    System.err.println(&quot;[DASHBOARD ERROR] Error al obtener ventas para cliente ID &quot; + cliente.getId()</span>
<span class="nc" id="L78">                            + &quot;: &quot; + ex.getMessage());</span>
<span class="nc" id="L79">                    ex.printStackTrace();</span>
<span class="nc" id="L80">                }</span>
<span class="nc" id="L81">            }</span>
<span class="nc" id="L82">        } catch (Exception e) {</span>
<span class="nc" id="L83">            System.err.println(&quot;[DASHBOARD ERROR] Error general en cargarTopClientesConMasCompras: &quot; + e.getMessage());</span>
<span class="nc" id="L84">            e.printStackTrace();</span>
<span class="nc" id="L85">        }</span>
        // Obtener top 3 clientes
<span class="nc" id="L87">        java.util.List&lt;java.util.Map.Entry&lt;Integer, Integer&gt;&gt; top = comprasPorCliente.entrySet().stream()</span>
<span class="nc" id="L88">                .sorted((a, b) -&gt; Integer.compare(b.getValue(), a.getValue()))</span>
<span class="nc" id="L89">                .limit(3)</span>
<span class="nc" id="L90">                .toList();</span>
<span class="nc" id="L91">        barChartTopClientes.getData().clear();</span>
<span class="nc" id="L92">        barChartTopClientes.setLegendVisible(false);</span>
<span class="nc" id="L93">        barChartTopClientes.setAnimated(false);</span>
        // Forzar el título correcto siempre
<span class="nc" id="L95">        barChartTopClientes.setTitle(&quot;Top 3 clientes con más compras&quot;);</span>
<span class="nc" id="L96">        javafx.scene.chart.XYChart.Series&lt;String, Number&gt; series = new javafx.scene.chart.XYChart.Series&lt;&gt;();</span>
<span class="nc" id="L97">        series.setName(&quot;Compras realizadas&quot;);</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">        for (java.util.Map.Entry&lt;Integer, Integer&gt; entry : top) {</span>
<span class="nc" id="L99">            com.farmaciavictoria.proyectopharmavictoria.model.Cliente.Cliente cliente = clientesMap.get(entry.getKey());</span>
            String nombre;
<span class="nc bnc" id="L101" title="All 2 branches missed.">            if (cliente != null) {</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">                if (&quot;Empresa&quot;.equalsIgnoreCase(cliente.getTipoCliente())) {</span>
<span class="nc bnc" id="L103" title="All 4 branches missed.">                    nombre = cliente.getRazonSocial() != null &amp;&amp; !cliente.getRazonSocial().trim().isEmpty()</span>
<span class="nc" id="L104">                            ? cliente.getRazonSocial()</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">                            : (cliente.getNombres() != null ? cliente.getNombres() : &quot;&quot;) + &quot; &quot;</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">                                    + (cliente.getApellidos() != null ? cliente.getApellidos() : &quot;&quot;);</span>
                } else {
<span class="nc bnc" id="L108" title="All 2 branches missed.">                    nombre = (cliente.getNombres() != null ? cliente.getNombres() : &quot;&quot;) + &quot; &quot;</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">                            + (cliente.getApellidos() != null ? cliente.getApellidos() : &quot;&quot;);</span>
                }
            } else {
<span class="nc" id="L112">                nombre = &quot;Cliente &quot; + entry.getKey();</span>
            }
<span class="nc" id="L114">            javafx.scene.chart.XYChart.Data&lt;String, Number&gt; data = new javafx.scene.chart.XYChart.Data&lt;&gt;(nombre.trim(),</span>
<span class="nc" id="L115">                    entry.getValue());</span>
<span class="nc" id="L116">            series.getData().add(data);</span>
<span class="nc" id="L117">        }</span>
<span class="nc" id="L118">        int faltantes = 3 - top.size();</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">        for (int i = 0; i &lt; faltantes; i++) {</span>
<span class="nc" id="L120">            javafx.scene.chart.XYChart.Data&lt;String, Number&gt; data = new javafx.scene.chart.XYChart.Data&lt;&gt;(&quot;Sin datos&quot;,</span>
<span class="nc" id="L121">                    0);</span>
<span class="nc" id="L122">            series.getData().add(data);</span>
        }
<span class="nc" id="L124">        barChartTopClientes.getData().add(series);</span>
        // Configurar el eje Y para mostrar solo enteros y rango adecuado
<span class="nc bnc" id="L126" title="All 2 branches missed.">        if (barChartTopClientes.getYAxis() instanceof javafx.scene.chart.NumberAxis yAxis) {</span>
<span class="nc" id="L127">            int maxCompras = series.getData().stream()</span>
<span class="nc" id="L128">                    .mapToInt(d -&gt; d.getYValue().intValue())</span>
<span class="nc" id="L129">                    .max().orElse(2);</span>
<span class="nc" id="L130">            yAxis.setAutoRanging(false);</span>
<span class="nc" id="L131">            yAxis.setLowerBound(0);</span>
<span class="nc" id="L132">            yAxis.setUpperBound(Math.max(2, maxCompras));</span>
<span class="nc" id="L133">            yAxis.setTickUnit(1);</span>
<span class="nc" id="L134">            yAxis.setMinorTickCount(0);</span>
<span class="nc" id="L135">            yAxis.setTickLabelFormatter(new javafx.util.StringConverter&lt;Number&gt;() {</span>
                @Override
                public String toString(Number object) {
<span class="nc" id="L138">                    return String.valueOf(object.intValue());</span>
                }

                @Override
                public Number fromString(String string) {
                    try {
<span class="nc" id="L144">                        return Integer.parseInt(string);</span>
<span class="nc" id="L145">                    } catch (Exception e) {</span>
<span class="nc" id="L146">                        return 0;</span>
                    }
                }
            });
        }
<span class="nc" id="L151">        javafx.application.Platform.runLater(() -&gt; {</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">            for (javafx.scene.chart.XYChart.Data&lt;String, Number&gt; data : series.getData()) {</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">                if (data.getNode() != null) {</span>
<span class="nc" id="L154">                    final javafx.scene.control.Label label = new javafx.scene.control.Label(</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">                            data.getYValue().intValue() &gt; 0 ? String.valueOf(data.getYValue()) : &quot;&quot;);</span>
<span class="nc" id="L156">                    label.getStyleClass().add(&quot;bar-value-label&quot;);</span>
<span class="nc" id="L157">                    label.setStyle(</span>
                            &quot;-fx-font-size: 16px; -fx-font-weight: bold; -fx-text-fill: #222; -fx-background-color: transparent;&quot;);
<span class="nc" id="L159">                    data.getNode().parentProperty().addListener((obs, oldParent, newParent) -&gt; {</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">                        if (newParent != null) {</span>
<span class="nc" id="L161">                            ((javafx.scene.layout.StackPane) data.getNode()).getChildren().add(label);</span>
                        }
<span class="nc" id="L163">                    });</span>
                }
<span class="nc" id="L165">            }</span>
<span class="nc" id="L166">        });</span>
<span class="nc" id="L167">    }</span>

    @FXML
    private Label lblAlertasClientes;
    @FXML
    private Button btnPaginaAnterior;
    @FXML
    private Button btnPaginaSiguiente;
    @FXML
    private Label lblPaginaActual;
    @FXML
    private ComboBox&lt;Integer&gt; cmbTamanoPagina;
<span class="nc" id="L179">    private int paginaActual = 1;</span>
<span class="nc" id="L180">    private int totalPaginas = 1;</span>
<span class="nc" id="L181">    private int tamanoPagina = -1; // -1 significa mostrar todos</span>

    @FXML
    private ComboBox&lt;String&gt; cmbEstado; // Se mantiene pero se elimina su funcionalidad de filtro

    // Handler para filtrar por estado (Actualizado para eliminar lógica de
    // Frecuente/No frecuente)
    @FXML
    private void onFiltrarEstado() {
<span class="nc bnc" id="L190" title="All 4 branches missed.">        String filtro = cmbEstado != null &amp;&amp; cmbEstado.getValue() != null ? cmbEstado.getValue() : &quot;Todos&quot;;</span>
<span class="nc bnc" id="L191" title="All 4 branches missed.">        if (filtro == null || filtro.equalsIgnoreCase(&quot;Todos&quot;)) {</span>
            javafx.collections.ObservableList&lt;com.farmaciavictoria.proyectopharmavictoria.model.Cliente.Cliente&gt; filtrados = javafx.collections.FXCollections
<span class="nc" id="L193">                    .observableArrayList();</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">            for (com.farmaciavictoria.proyectopharmavictoria.model.Cliente.Cliente c : clientesList) {</span>
<span class="nc bnc" id="L195" title="All 4 branches missed.">                if (c.getDocumento() == null || !c.getDocumento().equals(&quot;00000000&quot;)) {</span>
<span class="nc" id="L196">                    filtrados.add(c);</span>
                }
<span class="nc" id="L198">            }</span>
<span class="nc" id="L199">            tablaClientes.setItems(filtrados);</span>
<span class="nc" id="L200">            return;</span>
        }
        // Lógica de &quot;Frecuente&quot; / &quot;No frecuente&quot; eliminada. Si el filtro no es &quot;Todos&quot;,
        // no se filtra nada.
        // Para mantener la consistencia visual si un usuario selecciona un valor,
        // simplemente no hacemos nada
        // y mostramos todos los clientes (excepto genérico).
<span class="nc" id="L207">        onRefrescar(); // O simplemente forzamos a refrescar o buscar sin el filtro de estado</span>
<span class="nc" id="L208">    }</span>

    // Handler para el botón Actualizar
    @FXML
    private void onRefrescar() {
<span class="nc" id="L213">        refrescarDatos();</span>
<span class="nc" id="L214">    }</span>

    @FXML
    private TextField txtBuscar;
    // Eliminados ComboBox y CheckBox redundantes: cbFiltroTipo, cbOrdenar,
    // chkSoloFrecuentes
    @FXML
    private TableView&lt;com.farmaciavictoria.proyectopharmavictoria.model.Cliente.Cliente&gt; tablaClientes;
    @FXML
    private TableColumn&lt;com.farmaciavictoria.proyectopharmavictoria.model.Cliente.Cliente, String&gt; colTipoCliente;
    @FXML
    private TableColumn&lt;com.farmaciavictoria.proyectopharmavictoria.model.Cliente.Cliente, String&gt; colDocumento;
    @FXML
    private TableColumn&lt;com.farmaciavictoria.proyectopharmavictoria.model.Cliente.Cliente, String&gt; colNombreRazonSocial;
    @FXML
    private TableColumn&lt;com.farmaciavictoria.proyectopharmavictoria.model.Cliente.Cliente, String&gt; colTelefono;
    @FXML
    private TableColumn&lt;com.farmaciavictoria.proyectopharmavictoria.model.Cliente.Cliente, String&gt; colEmail;
    @FXML
    private TableColumn&lt;com.farmaciavictoria.proyectopharmavictoria.model.Cliente.Cliente, String&gt; colDireccion;
    @FXML
    private TableColumn&lt;com.farmaciavictoria.proyectopharmavictoria.model.Cliente.Cliente, Void&gt; colAcciones;
    @FXML
    private Label lblTotalClientes;
    @FXML
    private Label lblClientesFrecuentes; // Eliminado
    @FXML
    private Label lblNuevosEsteMes;
    @FXML
    private Label lblPuntosPromedio;
    // Eliminado lblUltimaActualizacion

    @FXML
    private ComboBox&lt;String&gt; cbTipoBusqueda;

    private com.farmaciavictoria.proyectopharmavictoria.service.ClienteService clienteService;

    public void setClienteService(com.farmaciavictoria.proyectopharmavictoria.service.ClienteService clienteService) {
<span class="nc" id="L252">        this.clienteService = clienteService;</span>
<span class="nc" id="L253">        inicializarDatos();</span>
<span class="nc" id="L254">        cargarTopClientesConMasCompras();</span>
<span class="nc" id="L255">    }</span>

    // Permisos granulares del vendedor para Clientes
<span class="nc" id="L258">    private boolean permisoNuevoCliente = false;</span>
<span class="nc" id="L259">    private boolean permisoExportarCliente = false;</span>
<span class="nc" id="L260">    private boolean permisoEditarCliente = false;</span>
<span class="nc" id="L261">    private boolean permisoEliminarCliente = false;</span>
<span class="nc" id="L262">    private boolean permisoDashboardTop = false;</span>
<span class="nc" id="L263">    private boolean permisoGraficaEdad = false;</span>

    private void cargarPermisosVendedor() {
        com.farmaciavictoria.proyectopharmavictoria.model.Usuario.Usuario usuario = com.farmaciavictoria.proyectopharmavictoria.config.ServiceContainer
<span class="nc" id="L267">                .getInstance()</span>
<span class="nc" id="L268">                .getAuthenticationService().getUsuarioActual();</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">        if (usuario != null</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">                &amp;&amp; usuario.getRol() == com.farmaciavictoria.proyectopharmavictoria.model.Usuario.Usuario.Rol.VENDEDOR) {</span>
            com.farmaciavictoria.proyectopharmavictoria.service.UsuarioService usuarioService = com.farmaciavictoria.proyectopharmavictoria.service.UsuarioService
<span class="nc" id="L272">                    .getInstance();</span>
<span class="nc" id="L273">            permisoNuevoCliente = usuarioService.tienePermiso(usuario.getId(), &quot;clientes&quot;, &quot;nuevo&quot;);</span>
<span class="nc" id="L274">            permisoExportarCliente = usuarioService.tienePermiso(usuario.getId(), &quot;clientes&quot;, &quot;exportar&quot;);</span>
<span class="nc" id="L275">            permisoEditarCliente = usuarioService.tienePermiso(usuario.getId(), &quot;clientes&quot;, &quot;editar&quot;);</span>
<span class="nc" id="L276">            permisoEliminarCliente = usuarioService.tienePermiso(usuario.getId(), &quot;clientes&quot;, &quot;eliminar&quot;);</span>
<span class="nc" id="L277">            permisoDashboardTop = usuarioService.tienePermiso(usuario.getId(), &quot;clientes&quot;, &quot;dashboard_top&quot;);</span>
<span class="nc" id="L278">            permisoGraficaEdad = usuarioService.tienePermiso(usuario.getId(), &quot;clientes&quot;, &quot;grafica_edad&quot;);</span>
<span class="nc" id="L279">        } else {</span>
            // Si es admin, todos los permisos
<span class="nc" id="L281">            permisoNuevoCliente = true;</span>
<span class="nc" id="L282">            permisoExportarCliente = true;</span>
<span class="nc" id="L283">            permisoEditarCliente = true;</span>
<span class="nc" id="L284">            permisoEliminarCliente = true;</span>
<span class="nc" id="L285">            permisoDashboardTop = true;</span>
<span class="nc" id="L286">            permisoGraficaEdad = true;</span>
        }
<span class="nc" id="L288">    }</span>

    @Override
    public void initialize(URL location, ResourceBundle resources) {
<span class="nc" id="L292">        cargarPermisosVendedor();</span>
        // Refuerzo: ocultar botón Exportar si no tiene permiso
<span class="nc" id="L294">        javafx.application.Platform.runLater(() -&gt; {</span>
<span class="nc bnc" id="L295" title="All 4 branches missed.">            if (tablaClientes != null &amp;&amp; tablaClientes.getScene() != null) {</span>
<span class="nc" id="L296">                javafx.scene.control.Button btnExportarClientes = (javafx.scene.control.Button) tablaClientes.getScene()</span>
<span class="nc" id="L297">                        .lookup(&quot;#btnExportarClientes&quot;);</span>
<span class="nc bnc" id="L298" title="All 2 branches missed.">                if (btnExportarClientes != null) {</span>
<span class="nc" id="L299">                    btnExportarClientes.setVisible(permisoExportarCliente);</span>
<span class="nc" id="L300">                    btnExportarClientes.setManaged(permisoExportarCliente);</span>
<span class="nc bnc" id="L301" title="All 2 branches missed.">                    if (!permisoExportarCliente) {</span>
<span class="nc" id="L302">                        btnExportarClientes.setDisable(true);</span>
                    }
                }
            }
<span class="nc" id="L306">        });</span>
<span class="nc" id="L307">        colTipoCliente.setCellFactory(column -&gt; new TableCell&lt;&gt;() {</span>
            @Override
            protected void updateItem(String tipo, boolean empty) {
<span class="nc" id="L310">                super.updateItem(tipo, empty);</span>
<span class="nc bnc" id="L311" title="All 4 branches missed.">                if (empty || tipo == null) {</span>
<span class="nc" id="L312">                    setGraphic(null);</span>
                } else {
                    String iconPath;
<span class="nc bnc" id="L315" title="All 2 branches missed.">                    if (tipo.trim().replaceAll(&quot;\\s+&quot;, &quot;&quot;).equalsIgnoreCase(&quot;Empresa&quot;)) {</span>
<span class="nc" id="L316">                        iconPath = &quot;/icons/empresa.png&quot;;</span>
                    } else {
<span class="nc" id="L318">                        iconPath = &quot;/icons/persona.png&quot;;</span>
                    }
<span class="nc" id="L320">                    javafx.scene.image.ImageView imageView = new javafx.scene.image.ImageView();</span>
<span class="nc" id="L321">                    imageView.setImage(new javafx.scene.image.Image(getClass().getResourceAsStream(iconPath)));</span>
<span class="nc" id="L322">                    imageView.setFitWidth(20);</span>
<span class="nc" id="L323">                    imageView.setFitHeight(20);</span>
<span class="nc" id="L324">                    javafx.scene.layout.StackPane pane = new javafx.scene.layout.StackPane(imageView);</span>
<span class="nc" id="L325">                    pane.setPrefWidth(column.getWidth());</span>
<span class="nc" id="L326">                    pane.setAlignment(javafx.geometry.Pos.CENTER);</span>
<span class="nc" id="L327">                    setGraphic(pane);</span>
                }
<span class="nc" id="L329">            }</span>
        });
<span class="nc" id="L331">        colTipoCliente.setCellValueFactory(</span>
<span class="nc" id="L332">                cellData -&gt; new javafx.beans.property.SimpleStringProperty(cellData.getValue().getTipoCliente()));</span>
<span class="nc" id="L333">        colDocumento.setCellValueFactory(</span>
<span class="nc" id="L334">                cellData -&gt; new javafx.beans.property.SimpleStringProperty(cellData.getValue().getDocumento()));</span>
<span class="nc" id="L335">        colNombreRazonSocial.setCellValueFactory(</span>
<span class="nc" id="L336">                cellData -&gt; new javafx.beans.property.SimpleStringProperty(cellData.getValue().getNombreCompleto()));</span>
<span class="nc" id="L337">        colTelefono.setCellValueFactory(</span>
<span class="nc" id="L338">                cellData -&gt; new javafx.beans.property.SimpleStringProperty(cellData.getValue().getTelefono()));</span>
<span class="nc" id="L339">        colEmail.setCellValueFactory(</span>
<span class="nc" id="L340">                cellData -&gt; new javafx.beans.property.SimpleStringProperty(cellData.getValue().getEmail()));</span>
<span class="nc" id="L341">        colDireccion.setCellValueFactory(</span>
<span class="nc" id="L342">                cellData -&gt; new javafx.beans.property.SimpleStringProperty(cellData.getValue().getDireccion()));</span>
        // ...asignar acciones y demás columnas como ya estaban...

<span class="nc" id="L345">        inicializarDashboardGraficas();</span>
        // No inicializar datos aquí, esperar a que se inyecte el servicio
        // Control de visibilidad del botón 'Nuevo Cliente' según el rol
<span class="nc" id="L348">        javafx.application.Platform.runLater(() -&gt; {</span>
            com.farmaciavictoria.proyectopharmavictoria.model.Usuario.Usuario usuario = com.farmaciavictoria.proyectopharmavictoria.config.ServiceContainer
<span class="nc" id="L350">                    .getInstance()</span>
<span class="nc" id="L351">                    .getAuthenticationService().getUsuarioActual();</span>
            // boolean esAdmin = usuario != null &amp;&amp; usuario.isAdmin(); // No se usa
<span class="nc bnc" id="L353" title="All 4 branches missed.">            if (tablaClientes != null &amp;&amp; tablaClientes.getScene() != null) {</span>
<span class="nc" id="L354">                javafx.scene.control.Button btnNuevoCliente = (javafx.scene.control.Button) tablaClientes.getScene()</span>
<span class="nc" id="L355">                        .lookup(&quot;#btnNuevoCliente&quot;);</span>
<span class="nc bnc" id="L356" title="All 2 branches missed.">                if (btnNuevoCliente != null) {</span>
<span class="nc" id="L357">                    btnNuevoCliente.setVisible(permisoNuevoCliente);</span>
<span class="nc" id="L358">                    btnNuevoCliente.setManaged(permisoNuevoCliente);</span>
                }
<span class="nc" id="L360">                javafx.scene.control.Button btnExportarClientes = (javafx.scene.control.Button) tablaClientes.getScene()</span>
<span class="nc" id="L361">                        .lookup(&quot;#btnExportarClientes&quot;);</span>
<span class="nc bnc" id="L362" title="All 2 branches missed.">                if (btnExportarClientes != null) {</span>
<span class="nc" id="L363">                    btnExportarClientes.setVisible(permisoExportarCliente);</span>
<span class="nc" id="L364">                    btnExportarClientes.setManaged(permisoExportarCliente);</span>
                }
            }
            // Ocultar dashboards según permisos
<span class="nc bnc" id="L368" title="All 2 branches missed.">            if (barChartTopClientes != null) {</span>
<span class="nc" id="L369">                barChartTopClientes.setVisible(permisoDashboardTop);</span>
<span class="nc" id="L370">                barChartTopClientes.setManaged(permisoDashboardTop);</span>
            }
<span class="nc bnc" id="L372" title="All 2 branches missed.">            if (pieChartRangoEdad != null) {</span>
<span class="nc" id="L373">                pieChartRangoEdad.setVisible(permisoGraficaEdad);</span>
<span class="nc" id="L374">                pieChartRangoEdad.setManaged(permisoGraficaEdad);</span>
            }
<span class="nc bnc" id="L376" title="All 2 branches missed.">            if (lblDistribucionEdad != null) {</span>
<span class="nc" id="L377">                lblDistribucionEdad.setVisible(permisoGraficaEdad);</span>
<span class="nc" id="L378">                lblDistribucionEdad.setManaged(permisoGraficaEdad);</span>
            }
<span class="nc" id="L380">        });</span>
<span class="nc bnc" id="L381" title="All 4 branches missed.">        if (lblTotalClientes != null &amp;&amp; clienteService != null) {</span>
<span class="nc" id="L382">            int totalClientes = clienteService.obtenerTodos().size();</span>
<span class="nc" id="L383">            lblTotalClientes.setText(&quot;Total: &quot; + totalClientes + &quot; clientes&quot;);</span>
<span class="nc" id="L384">            lblTotalClientes.setStyle(&quot;-fx-text-fill: #1bb934; -fx-font-weight: bold;&quot;);</span>
        }
<span class="nc bnc" id="L386" title="All 2 branches missed.">        if (cmbEstado != null) {</span>
<span class="nc" id="L387">            cmbEstado.setItems(FXCollections.observableArrayList(&quot;Todos&quot;)); // Solo queda &quot;Todos&quot;</span>
<span class="nc" id="L388">            cmbEstado.setValue(&quot;Todos&quot;);</span>
        }
<span class="nc bnc" id="L390" title="All 2 branches missed.">        if (cbTipoBusqueda != null) {</span>
<span class="nc" id="L391">            cbTipoBusqueda.getItems().clear();</span>
<span class="nc" id="L392">            cbTipoBusqueda.getItems().addAll(</span>
                    &quot;Documento&quot;, // DNI o RUC
                    &quot;Nombre / Razón social&quot;,
                    &quot;Teléfono&quot;,
                    &quot;Email&quot;);
<span class="nc" id="L397">            cbTipoBusqueda.setValue(&quot;Nombre / Razón social&quot;);</span>
<span class="nc" id="L398">            cbTipoBusqueda.valueProperty().addListener((obs, oldVal, newVal) -&gt; onBuscar());</span>
        }
<span class="nc bnc" id="L400" title="All 2 branches missed.">        if (cmbTamanoPagina != null) {</span>
<span class="nc" id="L401">            cmbTamanoPagina.getItems().clear();</span>
<span class="nc" id="L402">            cmbTamanoPagina.getItems().addAll(-1, 5, 10, 20, 50); // -1 = Todos</span>
<span class="nc" id="L403">            cmbTamanoPagina.setValue(-1);</span>
<span class="nc" id="L404">            cmbTamanoPagina.setConverter(new javafx.util.StringConverter&lt;Integer&gt;() {</span>
                @Override
                public String toString(Integer value) {
<span class="nc bnc" id="L407" title="All 4 branches missed.">                    if (value == null || value == -1)</span>
<span class="nc" id="L408">                        return &quot;Todos&quot;;</span>
<span class="nc" id="L409">                    return value.toString();</span>
                }

                @Override
                public Integer fromString(String string) {
<span class="nc bnc" id="L414" title="All 2 branches missed.">                    if (&quot;Todos&quot;.equals(string))</span>
<span class="nc" id="L415">                        return -1;</span>
                    try {
<span class="nc" id="L417">                        return Integer.parseInt(string);</span>
<span class="nc" id="L418">                    } catch (Exception e) {</span>
<span class="nc" id="L419">                        return -1;</span>
                    }
                }
            });
            // CellFactory personalizada para mostrar correctamente el label en el menú
            // desplegable y el botón
<span class="nc" id="L425">            cmbTamanoPagina.setCellFactory(listView -&gt; new javafx.scene.control.ListCell&lt;Integer&gt;() {</span>
                @Override
                protected void updateItem(Integer item, boolean empty) {
<span class="nc" id="L428">                    super.updateItem(item, empty);</span>
<span class="nc bnc" id="L429" title="All 4 branches missed.">                    if (empty || item == null) {</span>
<span class="nc" id="L430">                        setText(null);</span>
                    } else {
<span class="nc bnc" id="L432" title="All 2 branches missed.">                        setText(item == -1 ? &quot;Todos&quot; : item.toString());</span>
                    }
<span class="nc" id="L434">                }</span>
            });
<span class="nc" id="L436">            cmbTamanoPagina.setButtonCell(new javafx.scene.control.ListCell&lt;Integer&gt;() {</span>
                @Override
                protected void updateItem(Integer item, boolean empty) {
<span class="nc" id="L439">                    super.updateItem(item, empty);</span>
<span class="nc bnc" id="L440" title="All 4 branches missed.">                    if (empty || item == null) {</span>
<span class="nc" id="L441">                        setText(null);</span>
                    } else {
<span class="nc bnc" id="L443" title="All 2 branches missed.">                        setText(item == -1 ? &quot;Todos&quot; : item.toString());</span>
                    }
<span class="nc" id="L445">                }</span>
            });
<span class="nc" id="L447">            cmbTamanoPagina.valueProperty().addListener((obs, oldVal, newVal) -&gt; {</span>
<span class="nc" id="L448">                tamanoPagina = newVal;</span>
<span class="nc" id="L449">                paginaActual = 1;</span>
<span class="nc" id="L450">                actualizarPaginacion();</span>
<span class="nc" id="L451">            });</span>
        }
<span class="nc bnc" id="L453" title="All 2 branches missed.">        if (btnPaginaAnterior != null) {</span>
<span class="nc" id="L454">            btnPaginaAnterior.setOnAction(e -&gt; onPaginaAnterior());</span>
        }
<span class="nc bnc" id="L456" title="All 2 branches missed.">        if (btnPaginaSiguiente != null) {</span>
<span class="nc" id="L457">            btnPaginaSiguiente.setOnAction(e -&gt; onPaginaSiguiente());</span>
        }
<span class="nc bnc" id="L459" title="All 4 branches missed.">        if (tablaClientes != null &amp;&amp; clientesList != null) {</span>
<span class="nc" id="L460">            tablaClientes.setItems(clientesList);</span>
        }
<span class="nc" id="L462">    }</span>

    private void inicializarDashboardGraficas() {

<span class="nc bnc" id="L466" title="All 4 branches missed.">        if (pieChartRangoEdad != null &amp;&amp; clienteService != null) {</span>
<span class="nc" id="L467">            pieChartRangoEdad.getData().clear();</span>
<span class="nc" id="L468">            java.util.List&lt;com.farmaciavictoria.proyectopharmavictoria.model.Cliente.Cliente&gt; clientes = clienteService</span>
<span class="nc" id="L469">                    .obtenerTodos();</span>
<span class="nc" id="L470">            int r18_25 = 0, r26_35 = 0, r36_50 = 0, r51 = 0;</span>
<span class="nc bnc" id="L471" title="All 2 branches missed.">            for (com.farmaciavictoria.proyectopharmavictoria.model.Cliente.Cliente c : clientes) {</span>
                // Incluir ambos tipos de clientes en la estadística de edad
<span class="nc" id="L473">                Integer edad = c.getEdad();</span>
<span class="nc bnc" id="L474" title="All 2 branches missed.">                if (edad == null)</span>
<span class="nc" id="L475">                    continue;</span>
<span class="nc bnc" id="L476" title="All 4 branches missed.">                if (edad &gt;= 18 &amp;&amp; edad &lt;= 25)</span>
<span class="nc" id="L477">                    r18_25++;</span>
<span class="nc bnc" id="L478" title="All 4 branches missed.">                else if (edad &gt;= 26 &amp;&amp; edad &lt;= 35)</span>
<span class="nc" id="L479">                    r26_35++;</span>
<span class="nc bnc" id="L480" title="All 4 branches missed.">                else if (edad &gt;= 36 &amp;&amp; edad &lt;= 50)</span>
<span class="nc" id="L481">                    r36_50++;</span>
<span class="nc bnc" id="L482" title="All 2 branches missed.">                else if (edad &gt;= 51)</span>
<span class="nc" id="L483">                    r51++;</span>
<span class="nc" id="L484">            }</span>
<span class="nc" id="L485">            javafx.scene.chart.PieChart.Data d1 = new javafx.scene.chart.PieChart.Data(&quot;18-25&quot;, r18_25);</span>
<span class="nc" id="L486">            javafx.scene.chart.PieChart.Data d2 = new javafx.scene.chart.PieChart.Data(&quot;26-35&quot;, r26_35);</span>
<span class="nc" id="L487">            javafx.scene.chart.PieChart.Data d3 = new javafx.scene.chart.PieChart.Data(&quot;36-50&quot;, r36_50);</span>
<span class="nc" id="L488">            javafx.scene.chart.PieChart.Data d4 = new javafx.scene.chart.PieChart.Data(&quot;51+&quot;, r51);</span>
<span class="nc" id="L489">            pieChartRangoEdad.getData().addAll(d1, d2, d3, d4);</span>
<span class="nc" id="L490">            pieChartRangoEdad.setLabelsVisible(true);</span>
<span class="nc" id="L491">            pieChartRangoEdad.setLegendVisible(true);</span>
<span class="nc" id="L492">            pieChartRangoEdad.setStyle(&quot;&quot;); // Elimina cualquier fondo</span>
        }
<span class="nc" id="L494">    }</span>

    @FXML
    private void onPaginaSiguiente() {
<span class="nc bnc" id="L498" title="All 2 branches missed.">        if (paginaActual &lt; totalPaginas) {</span>
<span class="nc" id="L499">            paginaActual++;</span>
<span class="nc" id="L500">            actualizarPaginacion();</span>
        }
<span class="nc" id="L502">    }</span>

    private void inicializarDatos() {
        // Eliminada llamada a mostrarAlertasClientes();
<span class="nc bnc" id="L506" title="All 2 branches missed.">        if (cbTipoBusqueda != null) {</span>
<span class="nc" id="L507">            cbTipoBusqueda.getItems().clear();</span>
<span class="nc" id="L508">            cbTipoBusqueda.getItems().addAll(</span>
                    &quot;Documento&quot;, // DNI o RUC
                    &quot;Nombre / Razón social&quot;,
                    &quot;Teléfono&quot;,
                    &quot;Email&quot;);
<span class="nc" id="L513">            cbTipoBusqueda.setValue(&quot;Nombre / Razón social&quot;);</span>
        }
        // No sobrescribir cell value factories, solo configurar acciones y refrescar
        // datos
<span class="nc" id="L517">        configurarColumnaAcciones();</span>
<span class="nc" id="L518">        refrescarDatos();</span>
<span class="nc" id="L519">    }</span>

    private void configurarColumnaAcciones() {
<span class="nc" id="L522">        colAcciones.setCellFactory(</span>
<span class="nc" id="L523">                col -&gt; new javafx.scene.control.TableCell&lt;com.farmaciavictoria.proyectopharmavictoria.model.Cliente.Cliente, Void&gt;() {</span>
<span class="nc" id="L524">                    private final javafx.scene.control.Button btnEditar = new javafx.scene.control.Button();</span>
<span class="nc" id="L525">                    private final javafx.scene.control.Button btnVer = new javafx.scene.control.Button();</span>
<span class="nc" id="L526">                    private final javafx.scene.control.Button btnEliminar = new javafx.scene.control.Button();</span>
<span class="nc" id="L527">                    private final javafx.scene.layout.HBox box = new javafx.scene.layout.HBox(5, btnEditar, btnVer,</span>
                            btnEliminar);
                    {
                        // Usar los mismos iconos que inventario
<span class="nc" id="L531">                        javafx.scene.image.ImageView iconEditar = new javafx.scene.image.ImageView(</span>
<span class="nc" id="L532">                                getClass().getResource(&quot;/icons/editar.png&quot;).toExternalForm());</span>
<span class="nc" id="L533">                        javafx.scene.image.ImageView iconVer = new javafx.scene.image.ImageView(</span>
<span class="nc" id="L534">                                getClass().getResource(&quot;/icons/ver.png&quot;).toExternalForm());</span>
<span class="nc" id="L535">                        javafx.scene.image.ImageView iconEliminar = new javafx.scene.image.ImageView(</span>
<span class="nc" id="L536">                                getClass().getResource(&quot;/icons/eliminar.png&quot;).toExternalForm());</span>
<span class="nc" id="L537">                        iconVer.setFitWidth(24);</span>
<span class="nc" id="L538">                        iconVer.setFitHeight(24);</span>
<span class="nc" id="L539">                        iconEditar.setFitWidth(24);</span>
<span class="nc" id="L540">                        iconEditar.setFitHeight(24);</span>
<span class="nc" id="L541">                        iconEliminar.setFitWidth(24);</span>
<span class="nc" id="L542">                        iconEliminar.setFitHeight(24);</span>
<span class="nc" id="L543">                        btnVer.setGraphic(iconVer);</span>
<span class="nc" id="L544">                        btnEditar.setGraphic(iconEditar);</span>
<span class="nc" id="L545">                        btnEliminar.setGraphic(iconEliminar);</span>
<span class="nc" id="L546">                        btnEditar.getStyleClass().setAll(&quot;btn-action&quot;, &quot;btn-edit&quot;);</span>
<span class="nc" id="L547">                        btnVer.getStyleClass().setAll(&quot;btn-action&quot;, &quot;btn-view&quot;);</span>
<span class="nc" id="L548">                        btnEliminar.getStyleClass().setAll(&quot;btn-action&quot;, &quot;btn-delete&quot;);</span>
<span class="nc" id="L549">                        btnEditar.setPrefWidth(35);</span>
<span class="nc" id="L550">                        btnEditar.setPrefHeight(35);</span>
<span class="nc" id="L551">                        btnVer.setPrefWidth(35);</span>
<span class="nc" id="L552">                        btnVer.setPrefHeight(35);</span>
<span class="nc" id="L553">                        btnEliminar.setPrefWidth(35);</span>
<span class="nc" id="L554">                        btnEliminar.setPrefHeight(35);</span>
<span class="nc" id="L555">                        btnEditar.setTooltip(new javafx.scene.control.Tooltip(&quot;Editar&quot;));</span>
<span class="nc" id="L556">                        btnVer.setTooltip(new javafx.scene.control.Tooltip(&quot;Ver detalles&quot;));</span>
<span class="nc" id="L557">                        btnEliminar.setTooltip(new javafx.scene.control.Tooltip(&quot;Eliminar&quot;));</span>
<span class="nc" id="L558">                        btnEditar.setOnAction(e -&gt; editarCliente(getTableView().getItems().get(getIndex())));</span>
<span class="nc" id="L559">                        btnEliminar.setOnAction(e -&gt; {</span>
<span class="nc" id="L560">                            btnEliminar.setDisable(true); // Evita dobles clics</span>
<span class="nc" id="L561">                            eliminarClienteConFeedback(getTableView().getItems().get(getIndex()), btnEliminar);</span>
<span class="nc" id="L562">                        });</span>
<span class="nc" id="L563">                        btnVer.setOnAction(e -&gt; verDetallesCliente(getTableView().getItems().get(getIndex())));</span>
<span class="nc" id="L564">                        box.setAlignment(javafx.geometry.Pos.CENTER);</span>
<span class="nc" id="L565">                    }</span>

                    @Override
                    protected void updateItem(Void item, boolean empty) {
<span class="nc" id="L569">                        super.updateItem(item, empty);</span>
<span class="nc bnc" id="L570" title="All 2 branches missed.">                        if (empty) {</span>
<span class="nc" id="L571">                            setGraphic(null);</span>
                        } else {
                            com.farmaciavictoria.proyectopharmavictoria.model.Usuario.Usuario usuario = com.farmaciavictoria.proyectopharmavictoria.config.ServiceContainer
<span class="nc" id="L574">                                    .getInstance()</span>
<span class="nc" id="L575">                                    .getAuthenticationService().getUsuarioActual();</span>
                            // boolean esAdmin = usuario != null &amp;&amp; usuario.isAdmin(); // No se usa
<span class="nc" id="L577">                            btnEditar.setVisible(permisoEditarCliente);</span>
<span class="nc" id="L578">                            btnEditar.setManaged(permisoEditarCliente);</span>
<span class="nc" id="L579">                            btnEliminar.setVisible(permisoEliminarCliente);</span>
<span class="nc" id="L580">                            btnEliminar.setManaged(permisoEliminarCliente);</span>
<span class="nc" id="L581">                            btnVer.setVisible(true); // Siempre visible</span>
<span class="nc" id="L582">                            btnVer.setManaged(true);</span>
<span class="nc" id="L583">                            setGraphic(box);</span>
<span class="nc" id="L584">                            btnEliminar.setDisable(false);</span>
                        }
<span class="nc" id="L586">                    }</span>
                });
<span class="nc" id="L588">    }</span>

    private void toggleActivoCliente(com.farmaciavictoria.proyectopharmavictoria.model.Cliente.Cliente cliente) {
<span class="nc" id="L591">    }</span>

    // Nuevo método para feedback visual y manejo de errores (Parte 2)
    private void eliminarClienteConFeedback(com.farmaciavictoria.proyectopharmavictoria.model.Cliente.Cliente cliente,
            javafx.scene.control.Button btnEliminar) {
<span class="nc" id="L596">        javafx.scene.control.Alert confirmacion = new javafx.scene.control.Alert(</span>
                javafx.scene.control.Alert.AlertType.CONFIRMATION);
<span class="nc" id="L598">        confirmacion.setTitle(&quot;Confirmar Eliminación&quot;);</span>
<span class="nc" id="L599">        confirmacion.setHeaderText(&quot;¿Eliminar cliente?&quot;);</span>
<span class="nc" id="L600">        confirmacion</span>
<span class="nc" id="L601">                .setContentText(&quot;¿Está seguro de que desea eliminar el cliente '&quot; + cliente.getNombreCompleto() + &quot;'?&quot;);</span>
<span class="nc" id="L602">        confirmacion.showAndWait().ifPresent(response -&gt; {</span>
<span class="nc bnc" id="L603" title="All 2 branches missed.">            if (response == javafx.scene.control.ButtonType.OK) {</span>
                try {
<span class="nc" id="L605">                    boolean eliminado = clienteService.eliminarCliente(cliente.getId());</span>
<span class="nc bnc" id="L606" title="All 2 branches missed.">                    if (eliminado) {</span>
<span class="nc" id="L607">                        javafx.scene.control.Alert ok = new javafx.scene.control.Alert(</span>
                                javafx.scene.control.Alert.AlertType.INFORMATION, &quot;Cliente eliminado correctamente.&quot;);
<span class="nc" id="L609">                        ok.setTitle(&quot;Éxito&quot;);</span>
<span class="nc" id="L610">                        ok.setHeaderText(null);</span>
<span class="nc" id="L611">                        ok.showAndWait();</span>
<span class="nc" id="L612">                        refrescarDatos();</span>
<span class="nc" id="L613">                    } else {</span>
<span class="nc" id="L614">                        javafx.scene.control.Alert error = new javafx.scene.control.Alert(</span>
                                javafx.scene.control.Alert.AlertType.ERROR, &quot;No se pudo eliminar el cliente.&quot;);
<span class="nc" id="L616">                        error.setTitle(&quot;Error&quot;);</span>
<span class="nc" id="L617">                        error.setHeaderText(null);</span>
<span class="nc" id="L618">                        error.showAndWait();</span>
                    }
<span class="nc" id="L620">                } catch (Exception e) {</span>
<span class="nc" id="L621">                    javafx.scene.control.Alert error = new javafx.scene.control.Alert(</span>
<span class="nc" id="L622">                            javafx.scene.control.Alert.AlertType.ERROR, &quot;Error al eliminar cliente: &quot; + e.getMessage());</span>
<span class="nc" id="L623">                    error.setTitle(&quot;Error&quot;);</span>
<span class="nc" id="L624">                    error.setHeaderText(null);</span>
<span class="nc" id="L625">                    error.showAndWait();</span>
<span class="nc" id="L626">                }</span>
            }
<span class="nc" id="L628">            btnEliminar.setDisable(false);</span>
<span class="nc" id="L629">        });</span>
<span class="nc" id="L630">    }</span>

    private void editarCliente(com.farmaciavictoria.proyectopharmavictoria.model.Cliente.Cliente cliente) {
<span class="nc" id="L633">        System.out.println(&quot;[EDITAR CLIENTE] Iniciando edición de cliente: tipo=&quot; + cliente.getTipoCliente()</span>
<span class="nc" id="L634">                + &quot; | documento=&quot; + cliente.getDocumento() + &quot; | razon_social=&quot; + cliente.getRazonSocial());</span>
        try {
<span class="nc" id="L636">            javafx.fxml.FXMLLoader loader = new javafx.fxml.FXMLLoader(</span>
<span class="nc" id="L637">                    getClass().getResource(&quot;/fxml/Cliente/cliente-form.fxml&quot;));</span>
<span class="nc" id="L638">            javafx.scene.Parent root = loader.load();</span>
<span class="nc" id="L639">            ClienteFormController formController = loader.getController();</span>
<span class="nc" id="L640">            formController.setCliente(cliente); // precargar datos</span>
<span class="nc" id="L641">            formController.setClientesExistentes(clientesList);</span>
<span class="nc" id="L642">            formController.setOnClienteEditado(editado -&gt; {</span>
<span class="nc bnc" id="L643" title="All 2 branches missed.">                if (editado != null) {</span>
<span class="nc bnc" id="L644" title="All 2 branches missed.">                    if (&quot;Empresa&quot;.equalsIgnoreCase(editado.getTipoCliente())) {</span>
<span class="nc" id="L645">                        System.out.println(&quot;[EDITAR CLIENTE EMPRESA] RUC=&quot; + editado.getRuc() + &quot; | Razón Social=&quot;</span>
<span class="nc" id="L646">                                + editado.getRazonSocial());</span>
<span class="nc bnc" id="L647" title="All 4 branches missed.">                        if (editado.getRuc() == null || editado.getRazonSocial() == null</span>
<span class="nc bnc" id="L648" title="All 2 branches missed.">                                || editado.getRazonSocial().trim().isEmpty()) {</span>
<span class="nc" id="L649">                            System.err.println(&quot;[ERROR EMPRESA] RUC o Razón Social vacíos al editar empresa&quot;);</span>
                        }
                    }
<span class="nc" id="L652">                    clienteService.actualizarCliente(editado);</span>
                }
<span class="nc" id="L654">                refrescarDatos();</span>
<span class="nc" id="L655">            });</span>

<span class="nc" id="L657">            javafx.scene.Scene scene = new javafx.scene.Scene(root);</span>
<span class="nc" id="L658">            javafx.stage.Stage stage = new javafx.stage.Stage();</span>
<span class="nc" id="L659">            stage.setTitle(&quot;Editar Cliente&quot;);</span>
<span class="nc" id="L660">            stage.setScene(scene);</span>
<span class="nc" id="L661">            stage.initModality(javafx.stage.Modality.APPLICATION_MODAL);</span>
<span class="nc" id="L662">            stage.setResizable(false);</span>
<span class="nc" id="L663">            stage.showAndWait();</span>
<span class="nc" id="L664">        } catch (Exception e) {</span>
<span class="nc" id="L665">            System.err.println(&quot;[ERROR FXML] No se pudo abrir el formulario de edición: &quot; + e.getMessage());</span>
<span class="nc" id="L666">            System.err.println(&quot;[ERROR FXML] Stacktrace:&quot;);</span>
<span class="nc" id="L667">            e.printStackTrace(System.err);</span>
<span class="nc" id="L668">        }</span>
<span class="nc" id="L669">    }</span>

    private void eliminarCliente(com.farmaciavictoria.proyectopharmavictoria.model.Cliente.Cliente cliente) {
<span class="nc" id="L672">        javafx.scene.control.Alert alert = new javafx.scene.control.Alert(</span>
                javafx.scene.control.Alert.AlertType.CONFIRMATION);
<span class="nc" id="L674">        alert.setTitle(&quot;Eliminar Cliente&quot;);</span>
<span class="nc" id="L675">        alert.setHeaderText(&quot;¿Estás seguro de eliminar este cliente?&quot;);</span>
<span class="nc" id="L676">        alert.setContentText(cliente.getNombreCompleto());</span>
<span class="nc" id="L677">        alert.showAndWait().ifPresent(result -&gt; {</span>
<span class="nc bnc" id="L678" title="All 2 branches missed.">            if (result == javafx.scene.control.ButtonType.OK) {</span>
<span class="nc" id="L679">                clienteService.eliminarCliente(cliente.getId());</span>
<span class="nc" id="L680">                refrescarDatos();</span>
            }
<span class="nc" id="L682">        });</span>
<span class="nc" id="L683">    }</span>

    private void verDetallesCliente(com.farmaciavictoria.proyectopharmavictoria.model.Cliente.Cliente cliente) {
        try {
<span class="nc" id="L687">            javafx.fxml.FXMLLoader loader = new javafx.fxml.FXMLLoader(</span>
<span class="nc" id="L688">                    getClass().getResource(&quot;/fxml/Cliente/cliente-detalles.fxml&quot;));</span>
<span class="nc" id="L689">            javafx.scene.Parent root = loader.load();</span>
<span class="nc" id="L690">            com.farmaciavictoria.proyectopharmavictoria.controller.Cliente.ClienteDetallesController detallesController = loader</span>
<span class="nc" id="L691">                    .getController();</span>
<span class="nc" id="L692">            detallesController.setCliente(cliente);</span>

<span class="nc" id="L694">            javafx.scene.Scene scene = new javafx.scene.Scene(root);</span>
<span class="nc" id="L695">            javafx.stage.Stage stage = new javafx.stage.Stage();</span>
<span class="nc" id="L696">            stage.setTitle(&quot;Detalles del Cliente&quot;);</span>
<span class="nc" id="L697">            stage.setScene(scene);</span>
<span class="nc" id="L698">            stage.initModality(javafx.stage.Modality.APPLICATION_MODAL);</span>
<span class="nc" id="L699">            stage.setResizable(false);</span>
<span class="nc" id="L700">            stage.showAndWait();</span>
<span class="nc" id="L701">        } catch (Exception e) {</span>
<span class="nc" id="L702">            e.printStackTrace();</span>
<span class="nc" id="L703">            javafx.scene.control.Alert alert = new javafx.scene.control.Alert(</span>
                    javafx.scene.control.Alert.AlertType.ERROR,
<span class="nc" id="L705">                    &quot;No se pudo abrir la vista de detalles: &quot; + e.getMessage());</span>
<span class="nc" id="L706">            alert.showAndWait();</span>
<span class="nc" id="L707">        }</span>
<span class="nc" id="L708">    }</span>

<span class="nc" id="L710">    private javafx.collections.ObservableList&lt;com.farmaciavictoria.proyectopharmavictoria.model.Cliente.Cliente&gt; clientesList = javafx.collections.FXCollections</span>
<span class="nc" id="L711">            .observableArrayList();</span>

    @FXML
    public void refrescarDatos() {
        // Recargar lista completa de clientes desde la base de datos
<span class="nc" id="L716">        int paginaAnterior = paginaActual;</span>
<span class="nc" id="L717">        java.util.List&lt;com.farmaciavictoria.proyectopharmavictoria.model.Cliente.Cliente&gt; actualizados = clienteService</span>
<span class="nc" id="L718">                .obtenerTodos();</span>
<span class="nc" id="L719">        clientesList.setAll(actualizados); // Actualiza la lista observable</span>
        // Mantener la página actual si es válida
<span class="nc bnc" id="L721" title="All 2 branches missed.">        if (paginaAnterior &gt; 0) {</span>
<span class="nc" id="L722">            paginaActual = paginaAnterior;</span>
        } else {
<span class="nc" id="L724">            paginaActual = 1;</span>
        }
<span class="nc" id="L726">        actualizarPaginacion();</span>
        // Eliminada lógica de última actualización
<span class="nc" id="L728">        inicializarDashboardGraficas(); // Actualiza las gráficas con los datos actuales</span>
<span class="nc" id="L729">    }</span>

    private void actualizarPaginacion() {
        // Filtrar clientes válidos (sin genéricos) antes de paginar
<span class="nc" id="L733">        java.util.List&lt;com.farmaciavictoria.proyectopharmavictoria.model.Cliente.Cliente&gt; clientesValidos = clientesList</span>
<span class="nc" id="L734">                .stream()</span>
<span class="nc bnc" id="L735" title="All 4 branches missed.">                .filter(c -&gt; c.getDocumento() == null || !c.getDocumento().equals(&quot;00000000&quot;))</span>
<span class="nc" id="L736">                .toList();</span>
<span class="nc" id="L737">        int total = clientesValidos.size();</span>
        javafx.collections.ObservableList&lt;com.farmaciavictoria.proyectopharmavictoria.model.Cliente.Cliente&gt; pagina = javafx.collections.FXCollections
<span class="nc" id="L739">                .observableArrayList();</span>
<span class="nc bnc" id="L740" title="All 2 branches missed.">        if (tamanoPagina == -1) {</span>
<span class="nc" id="L741">            pagina.addAll(clientesValidos);</span>
<span class="nc" id="L742">            tablaClientes.setItems(pagina);</span>
<span class="nc" id="L743">            configurarColumnaAcciones();</span>
<span class="nc bnc" id="L744" title="All 2 branches missed.">            if (lblPaginaActual != null) {</span>
<span class="nc" id="L745">                lblPaginaActual.setText(&quot;Mostrando todos&quot;);</span>
            }
<span class="nc bnc" id="L747" title="All 2 branches missed.">            if (btnPaginaAnterior != null)</span>
<span class="nc" id="L748">                btnPaginaAnterior.setDisable(true);</span>
<span class="nc bnc" id="L749" title="All 2 branches missed.">            if (btnPaginaSiguiente != null)</span>
<span class="nc" id="L750">                btnPaginaSiguiente.setDisable(true);</span>
        } else {
<span class="nc" id="L752">            totalPaginas = (int) Math.ceil((double) total / tamanoPagina);</span>
<span class="nc bnc" id="L753" title="All 2 branches missed.">            if (totalPaginas &lt; 1)</span>
<span class="nc" id="L754">                totalPaginas = 1;</span>
<span class="nc bnc" id="L755" title="All 2 branches missed.">            if (paginaActual &lt; 1)</span>
<span class="nc" id="L756">                paginaActual = 1;</span>
<span class="nc bnc" id="L757" title="All 2 branches missed.">            if (paginaActual &gt; totalPaginas)</span>
<span class="nc" id="L758">                paginaActual = totalPaginas;</span>
<span class="nc" id="L759">            int desde = (paginaActual - 1) * tamanoPagina;</span>
<span class="nc" id="L760">            int hasta = Math.min(desde + tamanoPagina, total);</span>
<span class="nc bnc" id="L761" title="All 2 branches missed.">            for (int i = desde; i &lt; hasta; i++) {</span>
<span class="nc" id="L762">                pagina.add(clientesValidos.get(i));</span>
            }
<span class="nc" id="L764">            tablaClientes.setItems(pagina);</span>
<span class="nc" id="L765">            configurarColumnaAcciones();</span>
<span class="nc bnc" id="L766" title="All 2 branches missed.">            if (lblPaginaActual != null) {</span>
<span class="nc" id="L767">                lblPaginaActual.setText(&quot;Página &quot; + paginaActual + &quot; de &quot; + totalPaginas);</span>
            }
<span class="nc bnc" id="L769" title="All 2 branches missed.">            if (btnPaginaAnterior != null)</span>
<span class="nc bnc" id="L770" title="All 2 branches missed.">                btnPaginaAnterior.setDisable(paginaActual &lt;= 1);</span>
<span class="nc bnc" id="L771" title="All 2 branches missed.">            if (btnPaginaSiguiente != null)</span>
<span class="nc bnc" id="L772" title="All 2 branches missed.">                btnPaginaSiguiente.setDisable(paginaActual &gt;= totalPaginas);</span>
        }
<span class="nc" id="L774">    }</span>

    @FXML
    private void onPaginaAnterior() {
<span class="nc bnc" id="L778" title="All 2 branches missed.">        if (paginaActual &gt; 1) {</span>
<span class="nc" id="L779">            paginaActual--;</span>
<span class="nc" id="L780">            actualizarPaginacion();</span>
        }
<span class="nc" id="L782">    }</span>

    @FXML
    private void onBuscar() {
<span class="nc" id="L786">        String criterio = txtBuscar.getText().trim().toLowerCase();</span>
<span class="nc bnc" id="L787" title="All 4 branches missed.">        String tipo = cbTipoBusqueda != null &amp;&amp; cbTipoBusqueda.getValue() != null ? cbTipoBusqueda.getValue()</span>
<span class="nc" id="L788">                : &quot;Nombre&quot;;</span>

        // Estrategia unificada para Documento y Nombre/Razón social
        com.farmaciavictoria.proyectopharmavictoria.strategy.Cliente.ClienteFilterStrategy strategy;
<span class="nc bnc" id="L792" title="All 5 branches missed.">        switch (tipo) {</span>
            case &quot;Documento&quot;:
<span class="nc" id="L794">                strategy = new com.farmaciavictoria.proyectopharmavictoria.strategy.Cliente.FiltroPorDocumento();</span>
<span class="nc" id="L795">                break;</span>
            case &quot;Nombre / Razón social&quot;:
<span class="nc" id="L797">                strategy = new com.farmaciavictoria.proyectopharmavictoria.strategy.Cliente.FiltroPorNombreRazonSocial();</span>
<span class="nc" id="L798">                break;</span>
            case &quot;Email&quot;:
<span class="nc" id="L800">                strategy = new com.farmaciavictoria.proyectopharmavictoria.strategy.Cliente.FiltroPorEmail();</span>
<span class="nc" id="L801">                break;</span>
            case &quot;Teléfono&quot;:
<span class="nc" id="L803">                strategy = new com.farmaciavictoria.proyectopharmavictoria.strategy.Cliente.FiltroPorTelefono();</span>
<span class="nc" id="L804">                break;</span>
            default:
<span class="nc" id="L806">                strategy = new com.farmaciavictoria.proyectopharmavictoria.strategy.Cliente.FiltroPorNombreRazonSocial();</span>
                break;
        }

        // Filtrar por tipo
<span class="nc" id="L811">        java.util.List&lt;com.farmaciavictoria.proyectopharmavictoria.model.Cliente.Cliente&gt; base = clientesList;</span>
<span class="nc" id="L812">        java.util.List&lt;com.farmaciavictoria.proyectopharmavictoria.model.Cliente.Cliente&gt; filtrados = strategy</span>
<span class="nc" id="L813">                .filtrar(base, criterio);</span>

        // Eliminación de lógica de filtro por estado / solo frecuentes:
        // if (&quot;Frecuente&quot;.equalsIgnoreCase(estado)) { ...
        // } else if (&quot;No frecuente&quot;.equalsIgnoreCase(estado)) { ...
        // }
        // if (soloFrecuentes) { ...
        // }

        // Filtrar cliente genérico
<span class="nc" id="L823">        java.util.List&lt;com.farmaciavictoria.proyectopharmavictoria.model.Cliente.Cliente&gt; filtradosSinGenerico = filtrados</span>
<span class="nc" id="L824">                .stream()</span>
<span class="nc bnc" id="L825" title="All 4 branches missed.">                .filter(c -&gt; c.getDocumento() == null || !c.getDocumento().equals(&quot;00000000&quot;))</span>
<span class="nc" id="L826">                .toList();</span>
<span class="nc" id="L827">        tablaClientes.setItems(javafx.collections.FXCollections.observableArrayList(filtradosSinGenerico));</span>
        // Mostrar total real de clientes en verde, igual que proveedores
<span class="nc bnc" id="L829" title="All 4 branches missed.">        if (lblTotalClientes != null &amp;&amp; clienteService != null) {</span>
<span class="nc" id="L830">            int totalClientes = clienteService.obtenerTodos().stream()</span>
<span class="nc bnc" id="L831" title="All 4 branches missed.">                    .filter(c -&gt; c.getDocumento() == null || !c.getDocumento().equals(&quot;00000000&quot;))</span>
<span class="nc" id="L832">                    .toList().size(); // Incluye NATURAL y EMPRESA</span>
<span class="nc" id="L833">            lblTotalClientes.setText(&quot;Total: &quot; + totalClientes + &quot; clientes&quot;);</span>
<span class="nc" id="L834">            lblTotalClientes.setStyle(&quot;-fx-text-fill: #1bb934; -fx-font-weight: bold;&quot;);</span>
        }
<span class="nc" id="L836">    }</span>

    // Nuevo método para mostrar historial de cambios (simulado)
    @FXML
    public void onVerHistorialCambios() {
<span class="nc" id="L841">        javafx.scene.control.Alert alert = new javafx.scene.control.Alert(</span>
                javafx.scene.control.Alert.AlertType.INFORMATION,
                &quot;Funcionalidad de historial de cambios en desarrollo.&quot;);
<span class="nc" id="L844">        alert.showAndWait();</span>
<span class="nc" id="L845">    }</span>

    // Nuevo método para exportar clientes (Excel/PDF)
    @FXML
    public void onExportarClientes() {
        try {
<span class="nc" id="L851">            javafx.fxml.FXMLLoader loader = new javafx.fxml.FXMLLoader(</span>
<span class="nc" id="L852">                    getClass().getResource(&quot;/fxml/Cliente/exportar-clientes-preview.fxml&quot;));</span>
<span class="nc" id="L853">            javafx.scene.Parent root = loader.load();</span>
<span class="nc" id="L854">            com.farmaciavictoria.proyectopharmavictoria.controller.Cliente.ExportarClientesController exportController = loader</span>
<span class="nc" id="L855">                    .getController();</span>
            // Siempre pasar el listado total de clientes, no solo la paginación actual
<span class="nc" id="L857">            java.util.List&lt;com.farmaciavictoria.proyectopharmavictoria.model.Cliente.Cliente&gt; listaExportar = clienteService</span>
<span class="nc" id="L858">                    .obtenerTodos();</span>
<span class="nc" id="L859">            exportController.setClientesFiltrados(listaExportar);</span>

<span class="nc" id="L861">            javafx.scene.Scene scene = new javafx.scene.Scene(root, 1100, 600); // tamaño más pequeño</span>
<span class="nc" id="L862">            javafx.stage.Stage stage = new javafx.stage.Stage();</span>
<span class="nc" id="L863">            stage.setTitle(&quot;Exportar Listado de Clientes&quot;);</span>
<span class="nc" id="L864">            stage.setScene(scene);</span>
<span class="nc" id="L865">            stage.initModality(javafx.stage.Modality.APPLICATION_MODAL);</span>
<span class="nc" id="L866">            stage.setResizable(false);</span>
<span class="nc" id="L867">            stage.showAndWait();</span>
<span class="nc" id="L868">        } catch (Exception e) {</span>
<span class="nc" id="L869">            e.printStackTrace();</span>
<span class="nc" id="L870">            javafx.scene.control.Alert alert = new javafx.scene.control.Alert(</span>
                    javafx.scene.control.Alert.AlertType.ERROR,
<span class="nc" id="L872">                    &quot;No se pudo abrir la vista de exportación: &quot; + e.getMessage());</span>
<span class="nc" id="L873">            alert.showAndWait();</span>
<span class="nc" id="L874">        }</span>
<span class="nc" id="L875">    }</span>

    // Nuevo método para mostrar alertas de clientes incompletos/inactivos
    // (simulado)
    @FXML
    public void onVerAlertasClientes() {
<span class="nc" id="L881">        javafx.scene.control.Alert alert = new javafx.scene.control.Alert(</span>
<span class="nc" id="L882">                javafx.scene.control.Alert.AlertType.INFORMATION, lblAlertasClientes.getText());</span>
<span class="nc" id="L883">        alert.showAndWait();</span>
<span class="nc" id="L884">    }</span>

    @FXML
    public void onNuevoCliente() {
        try {
<span class="nc" id="L889">            javafx.fxml.FXMLLoader loader = new javafx.fxml.FXMLLoader(</span>
<span class="nc" id="L890">                    getClass().getResource(&quot;/fxml/Cliente/cliente-form.fxml&quot;));</span>
<span class="nc" id="L891">            javafx.scene.Parent root = loader.load();</span>
<span class="nc" id="L892">            ClienteFormController formController = loader.getController();</span>

<span class="nc" id="L894">            javafx.scene.Scene scene = new javafx.scene.Scene(root);</span>
<span class="nc" id="L895">            javafx.stage.Stage stage = new javafx.stage.Stage();</span>
<span class="nc" id="L896">            stage.setTitle(&quot;Nuevo Cliente&quot;);</span>
<span class="nc" id="L897">            stage.setScene(scene);</span>
<span class="nc" id="L898">            stage.initModality(javafx.stage.Modality.APPLICATION_MODAL);</span>
<span class="nc" id="L899">            stage.setResizable(false);</span>

            // Inyectar lista de clientes para validaciones
<span class="nc" id="L902">            formController.setClientesExistentes(clientesList);</span>
            // Inyectar callback para guardar y refrescar
<span class="nc" id="L904">            formController.setOnClienteEditado(nuevo -&gt; {</span>
                try {
<span class="nc bnc" id="L906" title="All 6 branches missed.">                    if (nuevo != null &amp;&amp; nuevo.getTipoCliente() != null &amp;&amp; !nuevo.getTipoCliente().isEmpty()) {</span>
<span class="nc" id="L907">                        clienteService.guardarCliente(nuevo);</span>
<span class="nc" id="L908">                        refrescarDatos();</span>
<span class="nc" id="L909">                        javafx.scene.control.Alert ok = new javafx.scene.control.Alert(</span>
                                javafx.scene.control.Alert.AlertType.INFORMATION,
                                &quot;Cliente guardado correctamente.&quot;);
<span class="nc" id="L912">                        ok.setTitle(&quot;Éxito&quot;);</span>
<span class="nc" id="L913">                        ok.setHeaderText(null);</span>
<span class="nc" id="L914">                        ok.showAndWait();</span>
                        // Cerrar el formulario
<span class="nc" id="L916">                        javafx.stage.Stage s = (javafx.stage.Stage) root.getScene().getWindow();</span>
<span class="nc" id="L917">                        s.close();</span>
                    }
<span class="nc" id="L919">                } catch (Exception ex) {</span>
<span class="nc" id="L920">                    javafx.scene.control.Alert error = new javafx.scene.control.Alert(</span>
<span class="nc" id="L921">                            javafx.scene.control.Alert.AlertType.ERROR, &quot;Error al guardar cliente: &quot; + ex.getMessage());</span>
<span class="nc" id="L922">                    error.setTitle(&quot;Error&quot;);</span>
<span class="nc" id="L923">                    error.setHeaderText(null);</span>
<span class="nc" id="L924">                    error.showAndWait();</span>
<span class="nc" id="L925">                }</span>
<span class="nc" id="L926">            });</span>

<span class="nc" id="L928">            stage.showAndWait();</span>
<span class="nc" id="L929">        } catch (Exception e) {</span>
<span class="nc" id="L930">            e.printStackTrace();</span>
<span class="nc" id="L931">            javafx.scene.control.Alert alert = new javafx.scene.control.Alert(</span>
                    javafx.scene.control.Alert.AlertType.ERROR,
<span class="nc" id="L933">                    &quot;No se pudo abrir el formulario de cliente: &quot; + e.getMessage());</span>
<span class="nc" id="L934">            alert.showAndWait();</span>
<span class="nc" id="L935">        }</span>
<span class="nc" id="L936">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>